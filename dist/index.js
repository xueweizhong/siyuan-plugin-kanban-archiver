"use strict";var qn=Object.defineProperty;var Yn=(e,t,n)=>t in e?qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var We=(e,t,n)=>Yn(e,typeof t!="symbol"?t+"":t,n);const ht=require("siyuan");async function xe(e,t){let n=await ht.fetchSyncPost(e,t);return n.code===0?n.data:null}async function xn(){const t=await xe("/api/notebook/lsNotebooks","");try{t&&t.notebooks&&Array.isArray(t.notebooks)&&(t.notebooks=t.notebooks.filter(n=>n.closed===!1||n.closed===0||n.closed==="false"))}catch(n){console.error("Filter notebooks error:",n)}return t}async function Xn(e,t,n){return xe("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:n})}async function Gn(e,t,n){return xe("/api/block/appendBlock",{dataType:e,data:t,parentID:n})}async function Jn(e){return xe("/api/block/deleteBlock",{id:e})}async function Qn(e,t){return xe("/api/attr/setBlockAttrs",{id:e,attrs:t})}async function $e(e){return xe("/api/query/sql",{stmt:e})}async function _t(e,t=7e3){return xe("/api/notification/pushMsg",{msg:e,timeout:t})}async function Xe(e,t=7e3){return xe("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function Ut(e){return xe("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function Rt(e,t,n=9999999,l=1){return xe("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:l})}async function Pn(e,t,n,l){return xe("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:l})}async function Zn(e,t,n,l,o=!1){var s,a,u;try{const p=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${l}"`);const _=await $e(`SELECT id FROM blocks WHERE content LIKE '%${p}%' AND type = 'd' LIMIT 1`);if(!_||_.length===0)return console.log(`Kanban doc not found for keyword: ${p}`),[];const m=_[0].id,v=await $e(`SELECT id, markdown FROM blocks WHERE root_id = '${m}' AND type = 'av' LIMIT 1`);if(!v||v.length===0)return o&&Xe(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const k=v[0],f=k.markdown.match(/data-av-id="([^"]+)"/);if(!f)return[];const b=f[1],w=await Ut(b);if(!w)return[];let S=null,P=null,V=null;for(const R of w)if((R.type==="select"||R.type==="mSelect")&&R.options){const c=R.options.find(H=>H.name===n),C=R.options.find(H=>H.name===l);if(c&&C){S=R,P=c,V=C;break}}if(!S)return o&&Xe(`在 "${t.name}" 中未找到状态 "${n}" -> "${l}"`),[];const U=k.markdown.match(/data-view-id="([^"]+)"/);let D=U?U[1]:b,N=await Rt(b,D);const E=(R,c=0)=>{if(!R||c>5)return[];let C=[];const H=["rows","groups","blocks","children","items"];for(const W of H)if(Array.isArray(R[W]))for(const Q of R[W])Q.id&&Array.isArray(Q.cells)?C.push(Q):C=C.concat(E(Q,c+1));return R.view&&(C=C.concat(E(R.view,c+1))),C};let I=E(N);if(I.length===0&&(N!=null&&N.views)){const R=N.views.find(c=>c.type==="table");R&&(N=await Rt(b,R.id),I=E(N))}if(I.length===0)return[];let $=(((s=N.view)==null?void 0:s.columns)||N.columns||[]).findIndex(R=>R.id===S.id),K=[],M=0;for(const R of I){let c=!1;if($>=0&&R.cells&&R.cells[$]){const C=R.cells[$].value;C!=null&&C.mSelect?c=C.mSelect.some(H=>H.content===n):C!=null&&C.select&&(c=C.select.content===n)}else if(R.cells&&Array.isArray(R.cells))for(const C of R.cells){const H=C.value;if((a=H==null?void 0:H.mSelect)!=null&&a.some(W=>W.content===n)){c=!0;break}else if(((u=H==null?void 0:H.select)==null?void 0:u.content)===n){c=!0;break}}if(c){const C={mSelect:[{content:V.name,color:V.color}]};await Pn(b,S.id,R.id,C),K.push(R.id),M++}}return M>0&&_t(`[${t.name}] 已归档 ${M} 个任务`),K}catch(p){return console.error("Status switch failed:",p),o&&Xe(`[${t.name}] 出错: `+p.message),[]}}async function el(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let l=0;for(const o of n)try{const s=await $e(`SELECT id FROM blocks WHERE content LIKE '%${o.keyword}%' AND type = 'd' LIMIT 1`);if(!s||s.length===0)continue;const a=s[0].id,u=await $e(`SELECT id, markdown FROM blocks WHERE root_id = '${a}' AND type = 'av' LIMIT 1`);if(!u||u.length===0)continue;const _=u[0].markdown.match(/data-av-id="([^"]+)"/);if(!_)continue;const m=_[1],v=await Ut(m);if(!v)continue;let k=null,f=null;for(const w of v)if((w.type==="select"||w.type==="mSelect")&&w.options){const S=w.options.find(P=>P.name===o.completedStatus);if(S){k=w,f=S;break}}if(!k||!f)continue;const b={mSelect:[{content:f.name,color:f.color}]};for(const w of t)await Pn(m,k.id,w,b);l+=t.length}catch(s){console.warn("Restore attempted failed for profile",o.name,s)}return l>0?(_t("已尝试撤销恢复任务"),!0):!1}async function tl(e,t=!1){const n=e.config.profiles||[];let l=[];if(n.length===0)return t&&Xe("未配置任何归档规则，请在设置中添加"),[];for(const o of n){if(!o.keyword||o.enabled===!1)continue;const s=await Zn(e,o,o.completedStatus,o.archivedStatus,t);l=l.concat(s)}return l}let wt=null;function nl(e){wt=e}function T(e,t){let n=null;if(wt&&wt.i18n&&(n=wt.i18n),!n)try{const{i18n:s}=require("siyuan");n=s}catch(s){console.warn("无法获取i18n对象:",s)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let l=n;const o=e.split(".");for(const s of o)if(l&&typeof l=="object"&&s in l)l=l[s];else{l=void 0;break}return typeof l!="string"&&(console.warn("未找到i18n键:",e),l=e),l}function Qe(){}function Un(e){return e()}function nn(){return Object.create(null)}function Pe(e){e.forEach(Un)}function Bn(e){return typeof e=="function"}function ll(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function il(e){return Object.keys(e).length===0}function i(e,t){e.appendChild(t)}function se(e,t,n){e.insertBefore(t,n||null)}function ne(e){e.parentNode&&e.parentNode.removeChild(e)}function ct(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function d(e){return document.createElement(e)}function fe(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function j(e){return document.createTextNode(e)}function y(){return j(" ")}function ol(){return j("")}function F(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function Tt(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function r(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Ve(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function sl(e){return Array.from(e.childNodes)}function ze(e,t){t=""+t,e.data!==t&&(e.data=t)}function J(e,t){e.value=t??""}function g(e,t,n,l){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function yt(e,t,n){for(let l=0;l<e.options.length;l+=1){const o=e.options[l];if(o.__value===t){o.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function ln(e){const t=e.querySelector(":checked");return t&&t.__value}function Fe(e,t,n){e.classList.toggle(t,!!n)}let gt;function pt(e){gt=e}function al(){if(!gt)throw new Error("Function called outside component initialization");return gt}function cl(e){al().$$.on_mount.push(e)}function rl(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(l=>l.call(this,t))}const st=[],on=[];let at=[];const sn=[],ul=Promise.resolve();let Lt=!1;function dl(){Lt||(Lt=!0,ul.then(On))}function vt(e){at.push(e)}const Mt=new Set;let it=0;function On(){if(it!==0)return;const e=gt;do{try{for(;it<st.length;){const t=st[it];it++,pt(t),fl(t.$$)}}catch(t){throw st.length=0,it=0,t}for(pt(null),st.length=0,it=0;on.length;)on.pop()();for(let t=0;t<at.length;t+=1){const n=at[t];Mt.has(n)||(Mt.add(n),n())}at.length=0}while(st.length);for(;sn.length;)sn.pop()();Lt=!1,Mt.clear(),pt(e)}function fl(e){if(e.fragment!==null){e.update(),Pe(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(vt)}}function hl(e){const t=[],n=[];at.forEach(l=>e.indexOf(l)===-1?t.push(l):n.push(l)),n.forEach(l=>l()),at=t}const pl=new Set;function Fn(e,t){e&&e.i&&(pl.delete(e),e.i(t))}function he(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function $t(e,t){e.d(1),t.delete(e.key)}function xt(e,t,n,l,o,s,a,u,p,_,m,v){let k=e.length,f=s.length,b=k;const w={};for(;b--;)w[e[b].key]=b;const S=[],P=new Map,V=new Map,U=[];for(b=f;b--;){const I=v(o,s,b),x=n(I);let $=a.get(x);$?U.push(()=>$.p(I,t)):($=_(x,I),$.c()),P.set(x,S[b]=$),x in w&&V.set(x,Math.abs(b-w[x]))}const D=new Set,N=new Set;function E(I){Fn(I,1),I.m(u,m),a.set(I.key,I),m=I.first,f--}for(;k&&f;){const I=S[f-1],x=e[k-1],$=I.key,K=x.key;I===x?(m=I.first,k--,f--):P.has(K)?!a.has($)||D.has($)?E(I):N.has(K)?k--:V.get($)>V.get(K)?(N.add($),E(I)):(D.add(K),k--):(p(x,a),k--)}for(;k--;){const I=e[k];P.has(I.key)||p(I,a)}for(;f;)E(S[f-1]);return Pe(U),S}function ml(e,t,n){const{fragment:l,after_update:o}=e.$$;l&&l.m(t,n),vt(()=>{const s=e.$$.on_mount.map(Un).filter(Bn);e.$$.on_destroy?e.$$.on_destroy.push(...s):Pe(s),e.$$.on_mount=[]}),o.forEach(vt)}function gl(e,t){const n=e.$$;n.fragment!==null&&(hl(n.after_update),Pe(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function vl(e,t){e.$$.dirty[0]===-1&&(st.push(e),dl(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function _l(e,t,n,l,o,s,a=null,u=[-1]){const p=gt;pt(e);const _=e.$$={fragment:null,ctx:[],props:s,update:Qe,not_equal:o,bound:nn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(p?p.$$.context:[])),callbacks:nn(),dirty:u,skip_bound:!1,root:t.target||p.$$.root};a&&a(_.root);let m=!1;if(_.ctx=n?n(e,t.props||{},(v,k,...f)=>{const b=f.length?f[0]:k;return _.ctx&&o(_.ctx[v],_.ctx[v]=b)&&(!_.skip_bound&&_.bound[v]&&_.bound[v](b),m&&vl(e,v)),k}):[],_.update(),m=!0,Pe(_.before_update),_.fragment=l?l(_.ctx):!1,t.target){if(t.hydrate){const v=sl(t.target);_.fragment&&_.fragment.l(v),v.forEach(ne)}else _.fragment&&_.fragment.c();t.intro&&Fn(e.$$.fragment),ml(e,t.target,t.anchor),On()}pt(p)}class kl{constructor(){We(this,"$$");We(this,"$$set")}$destroy(){gl(this,1),this.$destroy=Qe}$on(t,n){if(!Bn(n))return Qe;const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(n),()=>{const o=l.indexOf(n);o!==-1&&l.splice(o,1)}}$set(t){this.$$set&&!il(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const bl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(bl);function an(e,t,n){const l=e.slice();return l[57]=t[n],l[58]=t,l[59]=n,l}function cn(e,t,n){const l=e.slice();return l[60]=t[n],l[61]=t,l[62]=n,l}function rn(e,t,n){const l=e.slice();return l[63]=t[n],l}function un(e,t,n){const l=e.slice();return l[63]=t[n],l}function dn(e,t,n){const l=e.slice();return l[68]=t[n],l}function fn(e,t,n){const l=e.slice();return l[71]=t[n],l}function hn(e,t,n){const l=e.slice();return l[74]=t[n],l[75]=t,l[76]=n,l}function pn(e,t,n){const l=e.slice();return l[77]=t[n],l}function mn(e,t,n){const l=e.slice();return l[80]=t[n],l}function gn(e){let t,n,l;return{c(){t=d("div"),r(t,"class","backdrop svelte-1plhmm3")},m(o,s){se(o,t,s),n||(l=F(t,"click",e[27]),n=!0)},p:Qe,d(o){o&&ne(t),n=!1,l()}}}function vn(e){let t,n,l,o,s,a,u=he(e[9]),p=[];for(let v=0;v<u.length;v+=1)p[v]=_n(mn(e,u,v));let _=he(e[10]),m=[];for(let v=0;v<_.length;v+=1)m[v]=kn(pn(e,_,v));return{c(){t=d("div"),n=d("div");for(let v=0;v<p.length;v+=1)p[v].c();l=y(),o=d("div"),s=y(),a=d("div");for(let v=0;v<m.length;v+=1)m[v].c();r(n,"class","time-col svelte-1plhmm3"),g(o,"width","1px"),g(o,"background","var(--b3-theme-surface-lighter)"),r(a,"class","time-col svelte-1plhmm3"),r(t,"class","time-picker-popover svelte-1plhmm3")},m(v,k){se(v,t,k),i(t,n);for(let f=0;f<p.length;f+=1)p[f]&&p[f].m(n,null);i(t,l),i(t,o),i(t,s),i(t,a);for(let f=0;f<m.length;f+=1)m[f]&&m[f].m(a,null)},p(v,k){if(k[0]&33284){u=he(v[9]);let f;for(f=0;f<u.length;f+=1){const b=mn(v,u,f);p[f]?p[f].p(b,k):(p[f]=_n(b),p[f].c(),p[f].m(n,null))}for(;f<p.length;f+=1)p[f].d(1);p.length=u.length}if(k[0]&66564){_=he(v[10]);let f;for(f=0;f<_.length;f+=1){const b=pn(v,_,f);m[f]?m[f].p(b,k):(m[f]=kn(b),m[f].c(),m[f].m(a,null))}for(;f<m.length;f+=1)m[f].d(1);m.length=_.length}},d(v){v&&ne(t),ct(p,v),ct(m,v)}}}function _n(e){let t,n=e[80]+"",l,o,s,a;function u(){return e[30](e[80])}return{c(){t=d("div"),l=j(n),o=y(),r(t,"id",`time-opt-h-${e[80]}`),r(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].startsWith(e[80]))},m(p,_){se(p,t,_),i(t,l),i(t,o),s||(a=F(t,"click",u),s=!0)},p(p,_){e=p,_[0]&516&&Fe(t,"selected",e[2].startsWith(e[80]))},d(p){p&&ne(t),s=!1,a()}}}function kn(e){let t,n=e[77]+"",l,o,s,a;function u(){return e[31](e[77])}return{c(){t=d("div"),l=j(n),o=y(),r(t,"id",`time-opt-m-${e[77]}`),r(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].endsWith(e[77]))},m(p,_){se(p,t,_),i(t,l),i(t,o),s||(a=F(t,"click",u),s=!0)},p(p,_){e=p,_[0]&1028&&Fe(t,"selected",e[2].endsWith(e[77]))},d(p){p&&ne(t),s=!1,a()}}}function bn(e){let t,n=e[74].keyword+"",l;return{c(){t=d("span"),l=j(n),r(t,"class","tag-preview svelte-1plhmm3")},m(o,s){se(o,t,s),i(t,l)},p(o,s){s[0]&2&&n!==(n=o[74].keyword+"")&&ze(l,n)},d(o){o&&ne(t)}}}function yn(e){let t,n,l,o,s,a,u,p,_,m,v,k,f,b,w,S,P,V,U,D,N,E,I;function x(){e[35].call(s,e[75],e[76])}function $(){e[36].call(m,e[75],e[76])}function K(){e[37].call(S,e[75],e[76])}function M(){e[38].call(N,e[75],e[76])}return{c(){t=d("div"),n=d("div"),l=d("div"),l.textContent=`${T("ruleNameLabel")}`,o=y(),s=d("input"),a=y(),u=d("div"),p=d("div"),p.textContent=`${T("keywordLabel")}`,_=y(),m=d("input"),v=y(),k=d("div"),f=d("div"),b=d("div"),b.textContent=`${T("completedStatusLabel")}`,w=y(),S=d("input"),P=y(),V=d("div"),U=d("div"),U.textContent=`${T("archivedStatusLabel")}`,D=y(),N=d("input"),r(l,"class","input-label svelte-1plhmm3"),r(s,"class","modern-input svelte-1plhmm3"),r(s,"type","text"),r(s,"placeholder",T("ruleNamePlaceholder")),r(n,"class","input-group svelte-1plhmm3"),r(p,"class","input-label svelte-1plhmm3"),r(m,"class","modern-input svelte-1plhmm3"),r(m,"type","text"),r(m,"placeholder",T("keywordPlaceholder")),r(u,"class","input-group svelte-1plhmm3"),r(b,"class","input-label svelte-1plhmm3"),r(S,"class","modern-input svelte-1plhmm3"),r(S,"type","text"),r(S,"placeholder",T("completedStatusPlaceholder")),r(f,"class","input-group fn__flex-1 svelte-1plhmm3"),r(U,"class","input-label svelte-1plhmm3"),r(N,"class","modern-input svelte-1plhmm3"),r(N,"type","text"),r(N,"placeholder",T("archivedStatusPlaceholder")),r(V,"class","input-group fn__flex-1 svelte-1plhmm3"),r(k,"class","fn__flex svelte-1plhmm3"),g(k,"gap","20px"),r(t,"class","card-content svelte-1plhmm3")},m(R,c){se(R,t,c),i(t,n),i(n,l),i(n,o),i(n,s),J(s,e[74].name),i(t,a),i(t,u),i(u,p),i(u,_),i(u,m),J(m,e[74].keyword),i(t,v),i(t,k),i(k,f),i(f,b),i(f,w),i(f,S),J(S,e[74].completedStatus),i(k,P),i(k,V),i(V,U),i(V,D),i(V,N),J(N,e[74].archivedStatus),E||(I=[F(s,"input",x),F(s,"change",e[11]),F(m,"input",$),F(m,"change",e[11]),F(S,"input",K),F(S,"change",e[11]),F(N,"input",M),F(N,"change",e[11])],E=!0)},p(R,c){e=R,c[0]&2&&s.value!==e[74].name&&J(s,e[74].name),c[0]&2&&m.value!==e[74].keyword&&J(m,e[74].keyword),c[0]&2&&S.value!==e[74].completedStatus&&J(S,e[74].completedStatus),c[0]&2&&N.value!==e[74].archivedStatus&&J(N,e[74].archivedStatus)},d(R){R&&ne(t),E=!1,Pe(I)}}}function wn(e,t){let n,l,o,s,a,u,p=(t[74].name||T("unnamedRule"))+"",_,m,v,k,f,b,w,S,P,V,U,D,N,E,I=t[74].keyword&&bn(t);function x(){t[32].call(b,t[75],t[76])}function $(){return t[33](t[74])}function K(){return t[34](t[74])}let M=t[3]===t[74].id&&yn(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),a=d("div"),u=d("span"),_=j(p),m=y(),I&&I.c(),v=y(),k=d("div"),f=d("label"),b=d("input"),w=y(),S=d("span"),S.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',V=y(),U=d("div"),U.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',D=y(),M&&M.c(),r(o,"class","chevron svelte-1plhmm3"),g(u,"font-weight","600"),g(u,"font-size","15px"),g(u,"color","var(--b3-theme-on-surface)"),r(a,"class","fn__flex-1 svelte-1plhmm3"),g(a,"margin-left","14px"),g(a,"display","flex"),g(a,"align-items","center"),r(b,"class","switch-input svelte-1plhmm3"),r(b,"type","checkbox"),r(S,"class","switch-track svelte-1plhmm3"),r(f,"class","switch-container svelte-1plhmm3"),r(f,"title",P=t[74].enabled?T("enabled"):T("disabled")),r(k,"class","fn__flex-center"),g(k,"margin-right","20px"),r(U,"class","icon-btn svelte-1plhmm3"),r(U,"title",T("deleteRule")),r(l,"class","card-header svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),g(n,"opacity",t[74].enabled?1:.75),Fe(n,"expanded",t[3]===t[74].id),this.first=n},m(R,c){se(R,n,c),i(n,l),i(l,o),i(l,s),i(l,a),i(a,u),i(u,_),i(a,m),I&&I.m(a,null),i(l,v),i(l,k),i(k,f),i(f,b),b.checked=t[74].enabled,i(f,w),i(f,S),i(l,V),i(l,U),i(n,D),M&&M.m(n,null),N||(E=[F(b,"change",x),F(b,"change",t[11]),F(k,"click",Tt(t[26])),F(U,"click",Tt($)),F(l,"click",K)],N=!0)},p(R,c){t=R,c[0]&2&&p!==(p=(t[74].name||T("unnamedRule"))+"")&&ze(_,p),t[74].keyword?I?I.p(t,c):(I=bn(t),I.c(),I.m(a,null)):I&&(I.d(1),I=null),c[0]&2&&(b.checked=t[74].enabled),c[0]&2&&P!==(P=t[74].enabled?T("enabled"):T("disabled"))&&r(f,"title",P),t[3]===t[74].id?M?M.p(t,c):(M=yn(t),M.c(),M.m(n,null)):M&&(M.d(1),M=null),c[0]&2&&g(n,"opacity",t[74].enabled?1:.75),c[0]&10&&Fe(n,"expanded",t[3]===t[74].id)},d(R){R&&ne(n),I&&I.d(),M&&M.d(),N=!1,Pe(E)}}}function Sn(e){let t;return{c(){t=d("div"),t.textContent=`${T("noRulesTip")}`,g(t,"text-align","center"),g(t,"padding","48px"),g(t,"color","var(--b3-theme-on-surface-light)"),g(t,"border","2px dashed var(--b3-border-color)"),g(t,"border-radius","16px")},m(n,l){se(n,t,l)},d(n){n&&ne(t)}}}function Tn(e){let t,n,l,o,s,a,u,p,_,m,v,k,f,b,w,S,P,V,U,D,N,E,I,x,$,K,M,R,c,C,H,W,Q,te,le,ge,ie,z,Ee,Se,oe,Me,ve,Ue,pe,Z,G,q,ce,Te,Ie,Ae,ee=[],Ge=new Map,Ke,Be,re,be,h;function A(){e[42].call(s,e[58],e[59])}function ue(){e[43].call(m,e[58],e[59])}let Ce=he(e[1]),me=[];for(let B=0;B<Ce.length;B+=1)me[B]=In(fn(e,Ce,B));let _e=e[1].length===0&&An(),He=he(e[6]),ae=[];for(let B=0;B<He.length;B+=1)ae[B]=Cn(dn(e,He,B));function rt(){e[45].call(K,e[58],e[59])}function Le(){e[46].call(W,e[58],e[59])}function je(){e[47].call(z,e[58],e[59])}function ut(){e[48].call(Z,e[58],e[59])}function dt(B,Y){return(B[7][B[57].id]||[]).length===0?wl:yl}let Ze=dt(e),De=Ze(e),Je=he(e[57].sections);const qe=B=>B[60].id;for(let B=0;B<Je.length;B+=1){let Y=cn(e,Je,B),L=qe(Y);Ge.set(L,ee[B]=En(L,Y))}function Re(){return e[52](e[57])}return{c(){t=d("div"),n=d("div"),l=d("div"),l.textContent=`${T("templateNameLabel")}`,o=y(),s=d("input"),a=y(),u=d("div"),p=d("div"),p.textContent=`${T("templatePeriodLabel")}`,_=y(),m=d("select"),v=d("option"),v.textContent=`${T("templatePeriod_none")}`,k=d("option"),k.textContent=`${T("templatePeriod_day")}`,f=d("option"),f.textContent=`${T("templatePeriod_week")}`,b=d("option"),b.textContent=`${T("templatePeriod_month")}`,w=d("option"),w.textContent=`${T("templatePeriod_year")}`,S=y(),P=d("div"),V=d("div"),V.textContent=`${T("templateRuleLabel")}`,U=y(),D=d("div");for(let B=0;B<me.length;B+=1)me[B].c();N=y(),_e&&_e.c(),E=y(),I=d("div"),x=d("div"),x.textContent=`${T("templateNotebookLabel")}`,$=y(),K=d("select"),M=d("option"),M.textContent=`${T("templateNotebookAuto")}`;for(let B=0;B<ae.length;B+=1)ae[B].c();R=y(),c=d("div"),C=d("div"),C.textContent=`${T("templatePathLabel")}`,H=y(),W=d("input"),Q=y(),te=d("div"),le=d("div"),le.textContent=`${T("reportClipboardOnlySections")}`,ge=y(),ie=d("label"),z=d("input"),Ee=y(),Se=d("span"),Se.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',Me=y(),ve=d("div"),Ue=d("div"),Ue.textContent=`${T("templateTitleLabel")}`,pe=y(),Z=d("input"),G=y(),q=d("div"),ce=d("div"),ce.textContent=`${T("templateSectionList")}`,Te=y(),Ie=d("div"),De.c(),Ae=y();for(let B=0;B<ee.length;B+=1)ee[B].c();Ke=y(),Be=d("div"),re=d("button"),re.textContent=`${T("templateSectionAdd")}`,r(l,"class","input-label svelte-1plhmm3"),r(s,"class","modern-input svelte-1plhmm3"),r(s,"type","text"),r(n,"class","input-group svelte-1plhmm3"),r(p,"class","input-label svelte-1plhmm3"),v.__value="none",J(v,v.__value),k.__value="day",J(k,k.__value),f.__value="week",J(f,f.__value),b.__value="month",J(b,b.__value),w.__value="year",J(w,w.__value),r(m,"class","modern-input svelte-1plhmm3"),e[57].period===void 0&&vt(ue),r(u,"class","input-group svelte-1plhmm3"),r(V,"class","input-label svelte-1plhmm3"),r(D,"class","fn__flex svelte-1plhmm3"),g(D,"flex-wrap","wrap"),g(D,"gap","12px"),r(P,"class","input-group svelte-1plhmm3"),r(x,"class","input-label svelte-1plhmm3"),M.__value="",J(M,M.__value),r(K,"class","modern-input svelte-1plhmm3"),e[57].notebookId===void 0&&vt(rt),r(I,"class","input-group svelte-1plhmm3"),r(C,"class","input-label svelte-1plhmm3"),r(W,"class","modern-input svelte-1plhmm3"),r(W,"type","text"),r(W,"placeholder",T("templatePathPlaceholder")),r(c,"class","input-group svelte-1plhmm3"),r(le,"class","input-label svelte-1plhmm3"),r(z,"class","switch-input svelte-1plhmm3"),r(z,"type","checkbox"),r(Se,"class","switch-track svelte-1plhmm3"),r(ie,"class","switch-container svelte-1plhmm3"),r(ie,"title",oe=e[57].clipboardOnlySections?T("enabled"):T("disabled")),r(te,"class","input-group svelte-1plhmm3"),r(Ue,"class","input-label svelte-1plhmm3"),r(Z,"class","modern-input svelte-1plhmm3"),r(Z,"type","text"),r(Z,"placeholder",T("templateTitlePlaceholder")),r(ve,"class","input-group svelte-1plhmm3"),r(ce,"class","input-label svelte-1plhmm3"),r(Ie,"class","fn__flex svelte-1plhmm3"),g(Ie,"flex-wrap","wrap"),g(Ie,"gap","8px"),g(Ie,"margin-bottom","8px"),r(re,"class","action-btn svelte-1plhmm3"),g(re,"width","132px"),g(re,"justify-content","center"),r(Be,"class","fn__flex svelte-1plhmm3"),g(Be,"justify-content","flex-start"),r(q,"class","input-group svelte-1plhmm3"),r(t,"class","card-content svelte-1plhmm3")},m(B,Y){se(B,t,Y),i(t,n),i(n,l),i(n,o),i(n,s),J(s,e[57].name),i(t,a),i(t,u),i(u,p),i(u,_),i(u,m),i(m,v),i(m,k),i(m,f),i(m,b),i(m,w),yt(m,e[57].period,!0),i(t,S),i(t,P),i(P,V),i(P,U),i(P,D);for(let L=0;L<me.length;L+=1)me[L]&&me[L].m(D,null);i(D,N),_e&&_e.m(D,null),i(t,E),i(t,I),i(I,x),i(I,$),i(I,K),i(K,M);for(let L=0;L<ae.length;L+=1)ae[L]&&ae[L].m(K,null);yt(K,e[57].notebookId,!0),i(t,R),i(t,c),i(c,C),i(c,H),i(c,W),J(W,e[57].pathTemplate),i(t,Q),i(t,te),i(te,le),i(te,ge),i(te,ie),i(ie,z),z.checked=e[57].clipboardOnlySections,i(ie,Ee),i(ie,Se),i(t,Me),i(t,ve),i(ve,Ue),i(ve,pe),i(ve,Z),J(Z,e[57].titleTemplate),i(t,G),i(t,q),i(q,ce),i(q,Te),i(q,Ie),De.m(Ie,null),i(q,Ae);for(let L=0;L<ee.length;L+=1)ee[L]&&ee[L].m(q,null);i(q,Ke),i(q,Be),i(Be,re),be||(h=[F(s,"input",A),F(s,"change",e[11]),F(m,"change",ue),F(m,"change",e[11]),F(K,"change",rt),F(K,"change",e[11]),F(W,"input",Le),F(W,"change",e[11]),F(z,"change",je),F(z,"change",e[11]),F(Z,"input",ut),F(Z,"change",e[11]),F(re,"click",Re)],be=!0)},p(B,Y){if(e=B,Y[0]&16&&s.value!==e[57].name&&J(s,e[57].name),Y[0]&16&&yt(m,e[57].period),Y[0]&4194322){Ce=he(e[1]);let L;for(L=0;L<Ce.length;L+=1){const de=fn(e,Ce,L);me[L]?me[L].p(de,Y):(me[L]=In(de),me[L].c(),me[L].m(D,N))}for(;L<me.length;L+=1)me[L].d(1);me.length=Ce.length}if(e[1].length===0?_e||(_e=An(),_e.c(),_e.m(D,null)):_e&&(_e.d(1),_e=null),Y[0]&64){He=he(e[6]);let L;for(L=0;L<He.length;L+=1){const de=dn(e,He,L);ae[L]?ae[L].p(de,Y):(ae[L]=Cn(de),ae[L].c(),ae[L].m(K,null))}for(;L<ae.length;L+=1)ae[L].d(1);ae.length=He.length}Y[0]&16&&yt(K,e[57].notebookId),Y[0]&16&&W.value!==e[57].pathTemplate&&J(W,e[57].pathTemplate),Y[0]&16&&(z.checked=e[57].clipboardOnlySections),Y[0]&16&&oe!==(oe=e[57].clipboardOnlySections?T("enabled"):T("disabled"))&&r(ie,"title",oe),Y[0]&16&&Z.value!==e[57].titleTemplate&&J(Z,e[57].titleTemplate),Ze===(Ze=dt(e))&&De?De.p(e,Y):(De.d(1),De=Ze(e),De&&(De.c(),De.m(Ie,null))),Y[0]&50333840&&(Je=he(e[57].sections),ee=xt(ee,Y,qe,1,e,Je,Ge,q,$t,En,Ke,cn))},d(B){B&&ne(t),ct(me,B),_e&&_e.d(),ct(ae,B),De.d();for(let Y=0;Y<ee.length;Y+=1)ee[Y].d();be=!1,Pe(h)}}}function In(e){let t,n,l,o,s,a=(e[71].name||e[71].keyword||e[71].id)+"",u,p,_;function m(){return e[44](e[57],e[71])}return{c(){var v;t=d("label"),n=d("input"),o=y(),s=d("span"),u=j(a),r(n,"type","checkbox"),n.checked=l=(v=e[57].ruleIds)==null?void 0:v.includes(e[71].id),g(s,"font-size","13px"),r(t,"class","fn__flex svelte-1plhmm3"),g(t,"align-items","center"),g(t,"gap","6px"),g(t,"padding","6px 10px"),g(t,"border","1px solid var(--b3-border-color)"),g(t,"border-radius","999px"),g(t,"background","var(--b3-theme-background)")},m(v,k){se(v,t,k),i(t,n),i(t,o),i(t,s),i(s,u),p||(_=F(n,"change",m),p=!0)},p(v,k){var f;e=v,k[0]&18&&l!==(l=(f=e[57].ruleIds)==null?void 0:f.includes(e[71].id))&&(n.checked=l),k[0]&2&&a!==(a=(e[71].name||e[71].keyword||e[71].id)+"")&&ze(u,a)},d(v){v&&ne(t),p=!1,_()}}}function An(e){let t;return{c(){t=d("div"),t.textContent=`${T("reportNoProfileTip")}`,g(t,"font-size","13px"),g(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){se(n,t,l)},d(n){n&&ne(t)}}}function Cn(e){let t,n=e[68].name+"",l,o;return{c(){t=d("option"),l=j(n),t.__value=o=e[68].id,J(t,t.__value)},m(s,a){se(s,t,a),i(t,l)},p(s,a){a[0]&64&&n!==(n=s[68].name+"")&&ze(l,n),a[0]&64&&o!==(o=s[68].id)&&(t.__value=o,J(t,t.__value))},d(s){s&&ne(t)}}}function yl(e){let t,n=he(e[7][e[57].id]),l=[];for(let o=0;o<n.length;o+=1)l[o]=Dn(un(e,n,o));return{c(){for(let o=0;o<l.length;o+=1)l[o].c();t=ol()},m(o,s){for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(o,s);se(o,t,s)},p(o,s){if(s[0]&144){n=he(o[7][o[57].id]);let a;for(a=0;a<n.length;a+=1){const u=un(o,n,a);l[a]?l[a].p(u,s):(l[a]=Dn(u),l[a].c(),l[a].m(t.parentNode,t))}for(;a<l.length;a+=1)l[a].d(1);l.length=n.length}},d(o){o&&ne(t),ct(l,o)}}}function wl(e){let t;return{c(){t=d("div"),t.textContent=`${T("templateStatusEmpty")}`,g(t,"font-size","13px"),g(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){se(n,t,l)},p:Qe,d(n){n&&ne(t)}}}function Dn(e){let t,n=e[63]+"",l;return{c(){t=d("span"),l=j(n),r(t,"class","tag-preview svelte-1plhmm3")},m(o,s){se(o,t,s),i(t,l)},p(o,s){s[0]&144&&n!==(n=o[63]+"")&&ze(l,n)},d(o){o&&ne(t)}}}function Nn(e){let t,n,l,o,s,a=e[63]+"",u,p,_,m;function v(){return e[50](e[60],e[63])}return{c(){t=d("label"),n=d("input"),o=y(),s=d("span"),u=j(a),p=y(),r(n,"class","dot-check svelte-1plhmm3"),r(n,"type","checkbox"),n.checked=l=(e[60].statuses||[]).includes(e[63]),g(s,"font-size","12px"),r(t,"class","fn__flex status-dot svelte-1plhmm3"),g(t,"align-items","center"),g(t,"gap","6px"),g(t,"padding","4px 8px"),g(t,"border","1px solid var(--b3-border-color)"),g(t,"border-radius","999px"),g(t,"background","var(--b3-theme-background)")},m(k,f){se(k,t,f),i(t,n),i(t,o),i(t,s),i(s,u),i(t,p),_||(m=F(n,"change",v),_=!0)},p(k,f){e=k,f[0]&144&&l!==(l=(e[60].statuses||[]).includes(e[63]))&&(n.checked=l),f[0]&144&&a!==(a=e[63]+"")&&ze(u,a)},d(k){k&&ne(t),_=!1,m()}}}function En(e,t){let n,l,o,s,a,u,p,_,m,v,k,f,b,w,S,P;function V(){t[49].call(u,t[61],t[62])}let U=he(t[7][t[57].id]||[]),D=[];for(let E=0;E<U.length;E+=1)D[E]=Nn(rn(t,U,E));function N(){return t[51](t[57],t[60])}return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),s=d("div"),s.textContent=`${T("templateSectionTitleLabel")}`,a=y(),u=d("input"),p=y(),_=d("div"),m=d("div"),m.textContent=`${T("templateSectionStatusLabel")}`,v=y(),k=d("div");for(let E=0;E<D.length;E+=1)D[E].c();f=y(),b=d("div"),w=d("div"),w.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',r(s,"class","input-label svelte-1plhmm3"),r(u,"class","modern-input svelte-1plhmm3"),r(u,"type","text"),r(o,"class","input-group svelte-1plhmm3"),r(m,"class","input-label svelte-1plhmm3"),r(k,"class","fn__flex svelte-1plhmm3"),g(k,"flex-wrap","wrap"),g(k,"gap","10px"),r(_,"class","input-group svelte-1plhmm3"),r(w,"class","icon-btn svelte-1plhmm3"),r(w,"title",T("templateSectionDelete")),r(b,"class","fn__flex svelte-1plhmm3"),g(b,"justify-content","flex-end"),r(l,"class","card-content svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),g(n,"margin-bottom","12px"),this.first=n},m(E,I){se(E,n,I),i(n,l),i(l,o),i(o,s),i(o,a),i(o,u),J(u,t[60].title),i(l,p),i(l,_),i(_,m),i(_,v),i(_,k);for(let x=0;x<D.length;x+=1)D[x]&&D[x].m(k,null);i(l,f),i(l,b),i(b,w),S||(P=[F(u,"input",V),F(u,"change",t[11]),F(w,"click",N)],S=!0)},p(E,I){if(t=E,I[0]&16&&u.value!==t[60].title&&J(u,t[60].title),I[0]&33554576){U=he(t[7][t[57].id]||[]);let x;for(x=0;x<U.length;x+=1){const $=rn(t,U,x);D[x]?D[x].p($,I):(D[x]=Nn($),D[x].c(),D[x].m(k,null))}for(;x<D.length;x+=1)D[x].d(1);D.length=U.length}},d(E){E&&ne(n),ct(D,E),S=!1,Pe(P)}}}function Mn(e,t){let n,l,o,s,a,u,p=t[57].name+"",_,m,v,k=T(`templatePeriod_${t[57].period||"none"}`)+"",f,b,w,S,P,V,U,D,N;function E(){return t[39](t[57])}function I(){return t[40](t[57])}function x(){return t[41](t[57])}let $=t[5]===t[57].id&&Tn(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),a=d("div"),u=d("span"),_=j(p),m=y(),v=d("span"),f=j(k),b=y(),w=d("button"),w.textContent=`${T("templateGenerate")}`,S=y(),P=d("div"),P.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',V=y(),$&&$.c(),U=y(),r(o,"class","chevron svelte-1plhmm3"),g(u,"font-weight","600"),g(u,"font-size","15px"),g(u,"color","var(--b3-theme-on-surface)"),r(v,"class","tag-preview svelte-1plhmm3"),r(a,"class","fn__flex-1 svelte-1plhmm3"),g(a,"margin-left","14px"),g(a,"display","flex"),g(a,"align-items","center"),r(w,"class","action-btn svelte-1plhmm3"),g(w,"height","28px"),g(w,"padding","0 12px"),g(w,"margin-right","8px"),r(P,"class","icon-btn svelte-1plhmm3"),r(P,"title",T("deleteRule")),r(l,"class","card-header svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),Fe(n,"expanded",t[5]===t[57].id),this.first=n},m(K,M){se(K,n,M),i(n,l),i(l,o),i(l,s),i(l,a),i(a,u),i(u,_),i(a,m),i(a,v),i(v,f),i(l,b),i(l,w),i(l,S),i(l,P),i(n,V),$&&$.m(n,null),i(n,U),D||(N=[F(w,"click",Tt(E)),F(P,"click",Tt(I)),F(l,"click",x)],D=!0)},p(K,M){t=K,M[0]&16&&p!==(p=t[57].name+"")&&ze(_,p),M[0]&16&&k!==(k=T(`templatePeriod_${t[57].period||"none"}`)+"")&&ze(f,k),t[5]===t[57].id?$?$.p(t,M):($=Tn(t),$.c(),$.m(n,U)):$&&($.d(1),$=null),M[0]&48&&Fe(n,"expanded",t[5]===t[57].id)},d(K){K&&ne(n),$&&$.d(),D=!1,Pe(N)}}}function Sl(e){let t,n,l,o,s,a,u,p=T("globalArchiveTime")+"",_,m,v,k,f,b,w,S,P=T("undoArchive")+"",V,U,D,N,E,I,x=T("archiveNow")+"",$,K,M,R,c,C,H,W,Q,te,le,ge,ie,z,Ee,Se=T("archiveRuleList")+"",oe,Me,ve,Ue,pe,Z,G,q,ce=T("addRule")+"",Te,Ie,Ae,ee=[],Ge=new Map,Ke,Be,re,be,h,A,ue,Ce,me=T("templateListTitle")+"",_e,He,ae,rt,Le,je,ut,dt,Ze=T("templateAdd")+"",De,Je,qe,Re=[],B=new Map,Y,L,de,ft,It,Ot,Hn=T("usageTipTitle")+"",Ft,Kt,Oe,et,At,Ht,Wn=T("usageTipGlobalDesc")+"",Wt,Vt,tt,Ct,zt,Vn=T("usageTipMatchDesc")+"",jt,qt,nt,Dt,Yt,zn=T("usageTipStatusDesc")+"",Xt,Gt,lt,Nt,Jt,jn=T("usageTipReportDesc")+"",Qt,Et,Zt,ye=e[8]&&gn(e),we=e[8]&&vn(e),kt=he(e[1]);const en=O=>O[74].id;for(let O=0;O<kt.length;O+=1){let X=hn(e,kt,O),ke=en(X);Ge.set(ke,ee[O]=wn(ke,X))}let Ne=e[1].length===0&&Sn(),bt=he(e[4]);const tn=O=>O[57].id;for(let O=0;O<bt.length;O+=1){let X=an(e,bt,O),ke=tn(X);B.set(ke,Re[O]=Mn(ke,X))}return{c(){ye&&ye.c(),t=y(),n=d("div"),l=d("div"),o=d("div"),s=fe("svg"),a=fe("use"),u=y(),_=j(p),m=y(),v=d("div"),k=y(),f=d("button"),b=fe("svg"),w=fe("use"),S=y(),V=j(P),U=y(),D=d("button"),N=fe("svg"),E=fe("use"),I=y(),$=j(x),K=y(),M=d("div"),R=j(e[2]),c=y(),C=fe("svg"),H=fe("use"),W=y(),we&&we.c(),Q=y(),te=d("div"),le=d("div"),ge=d("div"),ie=fe("svg"),z=fe("use"),Ee=y(),oe=j(Se),Me=y(),ve=d("div"),Ue=y(),pe=d("button"),Z=fe("svg"),G=fe("use"),q=y(),Te=j(ce),Ie=y(),Ae=d("div");for(let O=0;O<ee.length;O+=1)ee[O].c();Ke=y(),Ne&&Ne.c(),Be=y(),re=d("div"),be=d("div"),h=d("div"),A=fe("svg"),ue=fe("use"),Ce=y(),_e=j(me),He=y(),ae=d("div"),rt=y(),Le=d("button"),je=fe("svg"),ut=fe("use"),dt=y(),De=j(Ze),Je=y(),qe=d("div");for(let O=0;O<Re.length;O+=1)Re[O].c();Y=y(),L=d("div"),de=d("div"),ft=fe("svg"),It=fe("use"),Ot=y(),Ft=j(Hn),Kt=y(),Oe=d("ul"),et=d("li"),At=d("strong"),At.textContent=`${T("usageTipGlobal")}`,Ht=j("："),Wt=j(Wn),Vt=y(),tt=d("li"),Ct=d("strong"),Ct.textContent=`${T("usageTipMatch")}`,zt=j("："),jt=j(Vn),qt=y(),nt=d("li"),Dt=d("strong"),Dt.textContent=`${T("usageTipStatus")}`,Yt=j("："),Xt=j(zn),Gt=y(),lt=d("li"),Nt=d("strong"),Nt.textContent=`${T("usageTipReport")}`,Jt=j("："),Qt=j(jn),Ve(a,"xlink:href","#iconCalendar"),g(s,"width","18px"),g(s,"height","18px"),r(o,"class","section-title svelte-1plhmm3"),r(v,"class","fn__flex-1 svelte-1plhmm3"),Ve(w,"xlink:href","#iconUndo"),g(b,"width","14px"),g(b,"height","14px"),r(b,"class","svelte-1plhmm3"),r(f,"class","action-btn svelte-1plhmm3"),g(f,"background-color","transparent"),g(f,"color","var(--b3-theme-on-surface)"),g(f,"box-shadow","none"),g(f,"border","1px solid var(--b3-theme-surface-lighter)"),g(f,"margin-right","12px"),Ve(E,"xlink:href","#iconFiles"),g(N,"width","14px"),g(N,"height","14px"),r(N,"class","svelte-1plhmm3"),r(D,"class","action-btn svelte-1plhmm3"),g(D,"margin-right","32px"),Ve(H,"xlink:href","#iconClock"),g(C,"width","14px"),g(C,"height","14px"),g(C,"opacity","0.6"),r(M,"class","time-trigger svelte-1plhmm3"),Fe(M,"active",e[8]),r(l,"class","section-header svelte-1plhmm3"),Ve(z,"xlink:href","#iconSettings"),g(ie,"width","18px"),g(ie,"height","18px"),r(ge,"class","section-title svelte-1plhmm3"),r(ve,"class","fn__flex-1 svelte-1plhmm3"),Ve(G,"xlink:href","#iconAdd"),g(Z,"width","14px"),g(Z,"height","14px"),r(Z,"class","svelte-1plhmm3"),r(pe,"class","action-btn svelte-1plhmm3"),r(le,"class","section-header svelte-1plhmm3"),r(Ae,"class","profile-container svelte-1plhmm3"),g(te,"margin-top","20px"),g(te,"display","flex"),g(te,"flex-direction","column"),Ve(ue,"xlink:href","#iconCalendar"),g(A,"width","18px"),g(A,"height","18px"),r(h,"class","section-title svelte-1plhmm3"),r(ae,"class","fn__flex-1 svelte-1plhmm3"),Ve(ut,"xlink:href","#iconAdd"),g(je,"width","14px"),g(je,"height","14px"),r(je,"class","svelte-1plhmm3"),r(Le,"class","action-btn svelte-1plhmm3"),g(Le,"width","132px"),g(Le,"justify-content","center"),r(be,"class","section-header svelte-1plhmm3"),r(qe,"class","profile-container svelte-1plhmm3"),g(re,"margin-top","24px"),g(re,"display","flex"),g(re,"flex-direction","column"),Ve(It,"xlink:href","#iconInfo"),g(ft,"width","16px"),g(ft,"height","16px"),g(de,"font-weight","700"),g(de,"color","var(--b3-theme-primary)"),g(de,"display","flex"),g(de,"align-items","center"),g(de,"gap","8px"),g(de,"margin-bottom","8px"),g(de,"font-size","14px"),r(et,"class","svelte-1plhmm3"),r(tt,"class","svelte-1plhmm3"),r(nt,"class","svelte-1plhmm3"),r(lt,"class","svelte-1plhmm3"),r(Oe,"class","svelte-1plhmm3"),r(L,"class","info-footer svelte-1plhmm3"),r(n,"class","settings-container svelte-1plhmm3")},m(O,X){ye&&ye.m(O,X),se(O,t,X),se(O,n,X),i(n,l),i(l,o),i(o,s),i(s,a),i(o,u),i(o,_),i(l,m),i(l,v),i(l,k),i(l,f),i(f,b),i(b,w),i(f,S),i(f,V),i(l,U),i(l,D),i(D,N),i(N,E),i(D,I),i(D,$),i(l,K),i(l,M),i(M,R),i(M,c),i(M,C),i(C,H),i(l,W),we&&we.m(l,null),i(n,Q),i(n,te),i(te,le),i(le,ge),i(ge,ie),i(ie,z),i(ge,Ee),i(ge,oe),i(le,Me),i(le,ve),i(le,Ue),i(le,pe),i(pe,Z),i(Z,G),i(pe,q),i(pe,Te),i(te,Ie),i(te,Ae);for(let ke=0;ke<ee.length;ke+=1)ee[ke]&&ee[ke].m(Ae,null);i(Ae,Ke),Ne&&Ne.m(Ae,null),i(n,Be),i(n,re),i(re,be),i(be,h),i(h,A),i(A,ue),i(h,Ce),i(h,_e),i(be,He),i(be,ae),i(be,rt),i(be,Le),i(Le,je),i(je,ut),i(Le,dt),i(Le,De),i(re,Je),i(re,qe);for(let ke=0;ke<Re.length;ke+=1)Re[ke]&&Re[ke].m(qe,null);i(n,Y),i(n,L),i(L,de),i(de,ft),i(ft,It),i(de,Ot),i(de,Ft),i(L,Kt),i(L,Oe),i(Oe,et),i(et,At),i(et,Ht),i(et,Wt),i(Oe,Vt),i(Oe,tt),i(tt,Ct),i(tt,zt),i(tt,jt),i(Oe,qt),i(Oe,nt),i(nt,Dt),i(nt,Yt),i(nt,Xt),i(Oe,Gt),i(Oe,lt),i(lt,Nt),i(lt,Jt),i(lt,Qt),Et||(Zt=[F(f,"click",e[28]),F(D,"click",e[29]),F(M,"click",e[17]),F(pe,"click",e[12]),F(Le,"click",e[19])],Et=!0)},p(O,X){O[8]?ye?ye.p(O,X):(ye=gn(O),ye.c(),ye.m(t.parentNode,t)):ye&&(ye.d(1),ye=null),X[0]&4&&ze(R,O[2]),X[0]&256&&Fe(M,"active",O[8]),O[8]?we?we.p(O,X):(we=vn(O),we.c(),we.m(l,null)):we&&(we.d(1),we=null),X[0]&26634&&(kt=he(O[1]),ee=xt(ee,X,en,1,O,kt,Ge,Ae,$t,wn,Ke,hn)),O[1].length===0?Ne||(Ne=Sn(),Ne.c(),Ne.m(Ae,null)):Ne&&(Ne.d(1),Ne=null),X[0]&66324722&&(bt=he(O[4]),Re=xt(Re,X,tn,1,O,bt,B,qe,$t,Mn,null,an))},i:Qe,o:Qe,d(O){O&&(ne(t),ne(n)),ye&&ye.d(O),we&&we.d();for(let X=0;X<ee.length;X+=1)ee[X].d();Ne&&Ne.d();for(let X=0;X<Re.length;X+=1)Re[X].d();Et=!1,Pe(Zt)}}}function ot(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function Rn(e,t){const n=`time-opt-${e}-${t}`,l=document.getElementById(n);l&&l.scrollIntoView({block:"center",behavior:"smooth"})}function Tl(e,t,n){let{plugin:l}=t,o=[],s="00:00",a=null,u=[],p=null,_=[],m={},v=!1;const k=Array.from({length:24},(h,A)=>A.toString().padStart(2,"0")),f=Array.from({length:60},(h,A)=>A.toString().padStart(2,"0"));cl(()=>{b(),l.config.profiles&&l.config.profiles.length===1&&n(3,a=l.config.profiles[0].id),I()});function b(){n(1,o=l.config.profiles||[]),n(2,s=l.config.archiveTime||"00:00"),n(4,u=l.config.templates||[])}async function w(){n(0,l.config.archiveTime=s,l),n(0,l.config.templates=u,l),l.saveData("config.json",l.config),b()}function S(){l.config.profiles||n(0,l.config.profiles=[],l);const h={id:ot(),name:T("defaultNewRuleName")+" "+(l.config.profiles.length+1),keyword:"",completedStatus:T("defaultCompleted"),archivedStatus:T("defaultArchived"),enabled:!0};n(0,l.config.profiles=[...l.config.profiles,h],l),w(),n(3,a=h.id),setTimeout(()=>{const A=document.querySelector(".profile-container");A&&(A.scrollTop=A.scrollHeight)},50)}function P(h){n(0,l.config.profiles=l.config.profiles.filter(A=>A.id!==h),l),w(),a===h&&n(3,a=null)}function V(h){a===h?n(3,a=null):n(3,a=h)}function U(h){const A=s.split(":");n(2,s=`${h}:${A[1]||"00"}`),w()}function D(h){const A=s.split(":");n(2,s=`${A[0]||"00"}:${h}`),w()}function N(){n(8,v=!v),v&&setTimeout(()=>{const[h,A]=s.split(":");Rn("h",h),Rn("m",A)},10)}function E(h){l.generateTemplate&&l.generateTemplate(h)}async function I(){if(!l.getNotebooks)return;const h=await l.getNotebooks();n(6,_=(h==null?void 0:h.notebooks)||[])}function x(){const h={id:ot(),name:T("templateNewName"),period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:T("templateTitleDefault"),sections:[{id:ot(),title:T("templateSectionTodo"),statuses:[]},{id:ot(),title:T("templateSectionDoing"),statuses:[]},{id:ot(),title:T("templateSectionDone"),statuses:[]}]};n(4,u=[...u,h]),w(),n(5,p=h.id)}function $(h){n(4,u=u.filter(A=>A.id!==h)),w(),p===h&&n(5,p=null)}function K(h){if(p===h)n(5,p=null);else{n(5,p=h);const A=u.find(ue=>ue.id===h);A&&R(A)}}function M(h,A){const ue=h.ruleIds||[];h.ruleIds=ue.includes(A)?ue.filter(Ce=>Ce!==A):[...ue,A],w(),R(h)}async function R(h){l.getStatusOptions&&n(7,m[h.id]=await l.getStatusOptions(h.ruleIds||[]),m)}function c(h){h.sections=[...h.sections||[],{id:ot(),title:T("templateSectionNew"),statuses:[]}],w()}function C(h,A){h.sections=(h.sections||[]).filter(ue=>ue.id!==A),w()}function H(h,A){const ue=h.statuses||[];h.statuses=ue.includes(A)?ue.filter(Ce=>Ce!==A):[...ue,A],w()}function W(h){rl.call(this,e,h)}const Q=()=>n(8,v=!1),te=()=>l.undoArchiveNow(),le=()=>l.archiveNow(),ge=h=>U(h),ie=h=>D(h);function z(h,A){h[A].enabled=this.checked,n(1,o)}const Ee=h=>P(h.id),Se=h=>V(h.id);function oe(h,A){h[A].name=this.value,n(1,o)}function Me(h,A){h[A].keyword=this.value,n(1,o)}function ve(h,A){h[A].completedStatus=this.value,n(1,o)}function Ue(h,A){h[A].archivedStatus=this.value,n(1,o)}const pe=h=>E(h.id),Z=h=>$(h.id),G=h=>K(h.id);function q(h,A){h[A].name=this.value,n(4,u)}function ce(h,A){h[A].period=ln(this),n(4,u)}const Te=(h,A)=>M(h,A.id);function Ie(h,A){h[A].notebookId=ln(this),n(4,u)}function Ae(h,A){h[A].pathTemplate=this.value,n(4,u)}function ee(h,A){h[A].clipboardOnlySections=this.checked,n(4,u)}function Ge(h,A){h[A].titleTemplate=this.value,n(4,u)}function Ke(h,A){h[A].title=this.value,n(4,u)}const Be=(h,A)=>H(h,A),re=(h,A)=>C(h,A.id),be=h=>c(h);return e.$$set=h=>{"plugin"in h&&n(0,l=h.plugin)},[l,o,s,a,u,p,_,m,v,k,f,w,S,P,V,U,D,N,E,x,$,K,M,c,C,H,W,Q,te,le,ge,ie,z,Ee,Se,oe,Me,ve,Ue,pe,Z,G,q,ce,Te,Ie,Ae,ee,Ge,Ke,Be,re,be]}class Il extends kl{constructor(t){super(),_l(this,t,Tl,Sl,ll,{plugin:0},null,[-1,-1,-1])}}function Ye(e){var t,n,l,o,s;if(!e)return"";if(Array.isArray(e))return e.map(a=>Ye(a)).filter(Boolean).join(", ");if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(e.content!==void 0)return e.content;if(((t=e.text)==null?void 0:t.content)!==void 0)return e.text.content;if(((n=e.block)==null?void 0:n.content)!==void 0)return e.block.content;if(((l=e.date)==null?void 0:l.content)!==void 0)return e.date.content;if(((o=e.mSelect)==null?void 0:o.length)>0)return e.mSelect.map(a=>a.content).join(", ");if(((s=e.select)==null?void 0:s.content)!==void 0)return e.select.content;for(const a in e)if(typeof e[a]=="object"&&e[a]!==null){const u=Ye(e[a]);if(u)return u}return""}function Al(e){if(!e)return 0;const t=String(e).trim();if(t.match(/^\d{4}-\d{2}-\d{2}/))return new Date(t.substring(0,10).replace(/-/g,"/")+" 00:00:00").getTime();if(t.length===14&&/^\d+$/.test(t))return new Date(t.substring(0,4),parseInt(t.substring(4,6),10)-1,t.substring(6,8),t.substring(8,10),t.substring(10,12),t.substring(12,14)).getTime();const n=parseInt(t,10);return t.length===10?n*1e3:n}function Ln(e){const t=Al(e);if(t&&!Number.isNaN(t))return t;const n=Date.parse(e);return Number.isNaN(n)?0:n}function Cl(e){if(!e||typeof e!="object")return"";if(typeof e.name=="string")return e.name;if(typeof e.title=="string")return e.title;if(typeof e.label=="string")return e.label;if(e.value){const t=Ye(e.value);if(t)return t}if(e.key){const t=Ye(e.key);if(t)return t;if(typeof e.key.name=="string")return e.key.name}return""}function St(e,t=""){let n=[];if(!e||typeof e!="object")return n;e.id&&(Array.isArray(e.cells)||Array.isArray(e.values))&&(t&&(e.__groupStatus=t),n.push(e));for(const l in e)if(Object.prototype.hasOwnProperty.call(e,l)){const o=e[l];Array.isArray(o)?l==="groups"?o.forEach(s=>{const a=Cl(s)||t;n=n.concat(St(s,a))}):o.forEach(s=>n=n.concat(St(s,t))):typeof o=="object"&&!["columns","fields","keyValues"].includes(l)&&(n=n.concat(St(o,t)))}return n}function Dl(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));return t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7)),Math.ceil(((t.getTime()-new Date(Date.UTC(t.getUTCFullYear(),0,1)).getTime())/864e5+1)/7)}function Kn(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function Bt(e=""){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F1E6}-\u{1F1FF}]/gu,"")}function $n(e){return Bt(String(e||"")).toLowerCase().trim()}function Pt(e){return String(e??"").replace(/'/g,"''")}function mt(e,t=0){var n;if(!e||t>4)return"";if(Array.isArray(e)){for(const l of e){const o=mt(l,t+1);if(o)return o}return""}if(typeof e!="object")return"";if((n=e.block)!=null&&n.id)return e.block.id;if(e.blockID)return e.blockID;if(e.id&&typeof e.id=="string"&&e.id.length>=20)return e.id;for(const l of Object.keys(e)){const o=mt(e[l],t+1);if(o)return o}return""}async function Nl(e){const t={},n=Array.from(new Set(e)).filter(Boolean),l=100;for(let o=0;o<n.length;o+=l){const s=n.slice(o,o+l).map(u=>`'${Pt(u)}'`).join(",");if(!s)continue;const a=await $e(`SELECT id, content FROM blocks WHERE id IN (${s})`);a&&a.length>0&&a.forEach(u=>{u!=null&&u.id&&(u==null?void 0:u.content)!==void 0&&(t[u.id]=u.content)})}return t}function El(e=""){return e.replace(/^###\s+/gm,"").replace(/^####\s+/gm,"").replace(/^#####\s+/gm,"").replace(/^\*\s\[\s\]\s/gm,"• ").replace(/^\*\s\[x\]\s/gi,"• ").trim()}function Ml(e=""){const t=e.split(`
`);let n="",l=!1;const o=()=>{l&&(n+="</ul>",l=!1)};for(const s of t){if(/^###\s+/.test(s)){o(),n+=`<h3>${s.replace(/^###\s+/,"")}</h3>`;continue}if(/^####\s+/.test(s)){o(),n+=`<h4>${s.replace(/^####\s+/,"")}</h4>`;continue}if(/^#####\s+/.test(s)){o(),n+=`<h5>${s.replace(/^#####\s+/,"")}</h5>`;continue}const a=s.match(/^\*\s\[x\]\s(.+)/i),u=s.match(/^\*\s\[\s\]\s(.+)/);if(a||u){l||(n+="<ul>",l=!0);const p=a?a[1]:u[1];n+=`<li><input type="checkbox"${!!a?" checked":""} disabled /> <span>${p}</span></li>`;continue}if(s.trim()===""){o();continue}o(),n+=`<p>${s}</p>`}return o(),`<div>${n}</div>`}function Rl(e,t){return t?e.split(`
`).filter(o=>!/^###\s/.test(o)&&!/^####\s/.test(o)).join(`
`).replace(/\n{3,}/g,`

`).trim():e}async function Ll(e,t,n){var a;const l=Bt(Rl(n,t.clipboardOnlySections)),o=El(l),s=Ml(l);try{typeof ClipboardItem<"u"&&((a=navigator.clipboard)!=null&&a.write)?await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([s],{type:"text/html"}),"text/plain":new Blob([o],{type:"text/plain"})})]):await navigator.clipboard.writeText(o);const p=(e.i18n||{}).reportCopied||"内容已复制到剪切板";_t(p)}catch(u){console.error("Copy to clipboard failed:",u)}}function $l(e,t){const n=new Date(e);return t==="day"?(n.setHours(0,0,0,0),n.getTime()):t==="week"?(n.setDate(n.getDate()-(n.getDay()||7)+1),n.setHours(0,0,0,0),n.getTime()):t==="month"?(n.setDate(1),n.setHours(0,0,0,0),n.getTime()):t==="year"?(n.setMonth(0,1),n.setHours(0,0,0,0),n.getTime()):0}function xl(e,t){const n=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),o=Dl(t).toString().padStart(2,"0"),s=Kn(t),a=e.period||"none";let u=`/日常记录/${n}/${l}/${s}`;return a==="week"?u=`/周报/${n}/${n}-W${o}`:a==="month"?u=`/月报/${n}/${n}-${l}`:a==="year"&&(u=`/年报/${n}`),e.pathTemplate?e.pathTemplate.replace("{YYYY}",String(n)).replace("{MM}",l).replace("{date}",s).replace("{WW}",o):u}async function Pl(e,t,n,l,o,s){var b,w;const a=xl(t,n),u=Pt(a),p=Pt(a.substring(1));let _=await $e(`SELECT id FROM blocks WHERE (hpath = '${u}' OR hpath = '${p}') AND type='d' LIMIT 1`),m=_&&_.length>0?_[0].id:"";if(!m){const S=await xn(),P=t.notebookId||((w=(b=S==null?void 0:S.notebooks)==null?void 0:b[0])==null?void 0:w.id);if(!P){Xe("未找到可用笔记本，请在设置中选择目标笔记本");return}m=await Xn(P,a+".sy",""),await new Promise(V=>setTimeout(V,600))}const k=(await $e(`SELECT id FROM blocks WHERE root_id = '${m}'`)||[]).map(S=>S.id).filter(S=>S&&S!==m);for(const S of k)await Jn(S);k.length>0&&await new Promise(S=>setTimeout(S,300));const f=await Gn("markdown",l,m);if(f&&f.length>0){for(const S of f)S!=null&&S.id&&await Qn(S.id,{memo:o});_t("报表已就绪")}}async function Ul(e,t){var k;const l=(((k=e.config)==null?void 0:k.profiles)||[]).find(f=>f.id===t);if(!(l!=null&&l.keyword))return{avId:"",viewId:"",profileName:""};const o=await $e(`SELECT id FROM blocks WHERE content LIKE '%${l.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)return{avId:"",viewId:"",profileName:""};const s=o[0].id,a=await $e(`SELECT id, markdown FROM blocks WHERE root_id = '${s}' AND type = 'av' LIMIT 1`);if(!a||a.length===0)return{avId:"",viewId:"",profileName:""};const u=a[0],p=u.markdown.match(/data-av-id="([^"]+)"/);if(!p)return{avId:"",viewId:"",profileName:""};const _=p[1],m=u.markdown.match(/data-view-id="([^"]+)"/),v=m?m[1]:_;return{avId:_,viewId:v,profileName:l.name||l.keyword||l.id}}async function Bl(e,t){try{const n=e.i18n||{},l=(w,S)=>n[w]||S,o=t.ruleIds||[];if(!o||o.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const s=[];for(const w of o){const S=await Ul(e,w);if(!S.avId)continue;const P=await Rt(S.avId,S.viewId||S.avId,2e3,1);P&&s.push({profileName:S.profileName,avData:P})}if(s.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const a=new Date,u=Kn(a),p=t.period||"none",_=$l(a,p);let m="报表 ({date})";p==="day"?m="日报 ({date})":p==="week"?m="周报 ({date})":p==="month"?m="月报 ({date})":p==="year"&&(m="年报 ({date})");const k=(t.titleTemplate||m).replace("{date}",u);let f=`### ${k}

`;for(const w of s){const S=w.avData,P=S.view||S,U=(P.columns||P.fields||[]).map(c=>{const C=(c==null?void 0:c.key)??c;return C?{id:C.id,name:C.name||"",type:C.type||""}:null}).filter(Boolean),D=c=>U.findIndex(C=>c.some(H=>H(C))),N=D([c=>c.name.includes("内容"),c=>c.name.toLowerCase().includes("content"),c=>c.type==="block"]);let E=D([c=>c.name.includes("状态"),c=>c.name.toLowerCase().includes("status")]);E===-1&&(E=U.findIndex(c=>{const C=String(c.type||"").toLowerCase();return C==="select"||C==="mselect"||C==="multiselect"||C==="singleselect"}));let I=D([c=>c.name.includes("更新时间"),c=>c.name.toLowerCase().includes("update"),c=>c.name.includes("更新"),c=>c.name.includes("修改")]);I===-1&&(I=D([c=>c.name.includes("完成"),c=>c.name.includes("结束"),c=>c.name.includes("归档"),c=>c.name.toLowerCase().includes("done")])),I===-1&&(I=D([c=>c.name.includes("时间"),c=>c.name.toLowerCase().includes("time"),c=>c.type==="date"])),console.log("[KanbanWorkflow][Report] columns:",U.map(c=>`${c.name}(${c.type||"unknown"})`)),console.log("[KanbanWorkflow][Report] idx:",{cIdx:N,sIdx:E,tIdx:I});const x=St(S).map(c=>{var Se;let C=c.cells||[],H=[];c.values&&(H=U.map(oe=>{const Me=c.values.find(ve=>ve.keyID===oe.id);return Me?Me.value:null}));const W=(C||[]).map(oe=>Ye(oe)),Q=(H||[]).map(oe=>Ye(oe)),te=W.some(oe=>String(oe||"").trim()!==""),le=Q.some(oe=>String(oe||"").trim()!=="");!te&&le&&(C=H);const ge=C===H?Q:W,ie=N!==-1?C[N]:null,z=mt(ie)||mt(c==null?void 0:c.block)||mt(c),Ee=((Se=c==null?void 0:c.block)==null?void 0:Se.content)||(c==null?void 0:c.content)||(c==null?void 0:c.name)||"";return{id:c.id,cells:C,cellValues:ge,contentBlockId:z,contentFromRow:Ee,updatedAt:c.updatedAt||c.updated||0,groupStatus:c.__groupStatus||""}}),$=await Nl(x.map(c=>c.contentBlockId||"").filter(Boolean)),K=(t.sections||[]).map(c=>({id:c.id,title:c.title,statusesRaw:(c.statuses||[]).map(C=>String(C)),statuses:(c.statuses||[]).map(C=>$n(C)).filter(Boolean),items:[]})),M=K.flatMap(c=>c.statuses).filter(Boolean);console.log("[KanbanWorkflow][Report] statusCandidates:",M),x.forEach((c,C)=>{var Z;const H=c.cellValues||c.cells.map(G=>Ye(G));C===0&&console.log("[KanbanWorkflow][Report] sampleRow:",H);let W=N!==-1?H[N]:"";!W&&c.contentFromRow&&(W=c.contentFromRow),!W&&c.contentBlockId&&$[c.contentBlockId]&&(W=$[c.contentBlockId]),W||(W=H.find((q,ce)=>ce===E||ce===I?!1:String(q||"").trim()!=="")||""),W||(W=l("reportFallbackContent","无内容")),p==="week"&&(W=W.replace(/\b\d+(\.\d+)?\s*[hH]\b/gi,"").replace(/\((?:\d\.?)+[hH]\)/g,"").trim(),!W&&Array.isArray((Z=c.cells)==null?void 0:Z[N])&&c.cells[N].length>0&&(W=c.cells[N].map(G=>Ye(G)).join(", ")));let Q=E!==-1?H[E]:"";!Q&&c.groupStatus&&(Q=c.groupStatus),Q||(Q=H.find(q=>{const ce=String(q||"").toLowerCase();return M.some(Te=>ce.includes(Te))})||""),C===0&&console.log("[KanbanWorkflow][Report] sampleStatus:",Q);const te=I!==-1?H[I]:"",le=Ln(te),ge=Ln(c.updatedAt),ie=p!=="none"?le||ge||0:le||ge||Date.now(),z=$n(Q),Ee=z.includes("已完成")||z.includes("done")||z.includes("完成")||z.includes("finish")||z.includes("ok"),Se=z.includes("归档")||z.includes("archived")||z.includes("存档")||z.includes("archive");if(p!=="none"&&(Ee||Se)&&ie<_)return;const Me=`${Ee?"* [x]":"* [ ]"} ${W}`.trim(),ve=z.split(/[,，]/).map(G=>G.trim()).filter(Boolean);let pe=K.filter(G=>G.statuses.length>0&&G.statuses.some(q=>q?z.includes(q)?!0:ve.some(ce=>ce.includes(q)||q.includes(ce)):!1));if(pe.length===0){const G=String(Q||"").toLowerCase();pe=K.filter(q=>(q.statusesRaw||[]).some(ce=>{const Te=String(ce||"").toLowerCase();return Te?G.includes(Te)||Te.includes(G):!1}))}pe.length!==0&&pe.forEach(G=>G.items.push(Me))});const R=`${l("reportBoardTitle","看板")}: ${w.profileName}`;f+=`#### ${R}

`;for(const c of K)f+=`##### ${c.title}
`,c.items.length>0?f+=`${c.items.join(`
`)}

`:f+=`
`}const b=Bt(f);await Pl(e,t,a,b,`summary-${t.id}`,k),await Ll(e,t,b)}catch(n){console.error(n),Xe("生成过程中遇障")}}class Ol extends ht.Plugin{constructor(){super(...arguments);We(this,"timer");We(this,"isMobile");We(this,"config",{});We(this,"undoStack",[]);We(this,"MAX_UNDO_COUNT",30);We(this,"MAX_UNDO_DAYS",7)}async onload(){nl(this),console.log("Loading Kanban Workflow Plugin v0.1.0"),await this.loadAndNormalizeConfig();try{const o=await this.loadData("undo_history.json");o&&Array.isArray(o)&&(this.undoStack=o)}catch(o){console.error("Failed to load undo history",o)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板工作流",position:"right",callback:o=>{if(this.isMobile){this.showMobileMenu();return}let s;o&&o.currentTarget&&o.currentTarget.getBoundingClientRect?s=o.currentTarget.getBoundingClientRect():s=n.getBoundingClientRect();const a=new ht.Menu("kanban-archiver-menu");a.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(p=>{a.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${p.name}`,click:()=>{this.generateTemplate(p.id)}})}),a.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),a.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),a.open({x:s.left,y:s.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),(this.config.templates||[]).forEach(o=>{this.addCommand({langKey:`generateTemplate_${o.id}`,langText:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,hotkey:"",callback:()=>{this.generateTemplate(o.id)}})}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",templates:[],...n},this.ensureDefaultTemplates(),this.normalizeTemplates(),(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let l=!1;this.config.profiles.forEach(o=>{o.enabled===void 0&&(o.enabled=!0,l=!0)}),l&&this.saveData("config.json",this.config)}ensureDefaultTemplates(){(!this.config.templates||!Array.isArray(this.config.templates)||this.config.templates.length===0)&&(this.config.templates=[{id:this.generateUUID(),name:this.i18n.defaultDailyTemplate||"今日汇总",period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"日报 ({date})",sections:[{id:this.generateUUID(),title:"待办",statuses:["待办","todo","backlog","未开始"]},{id:this.generateUUID(),title:"进行中",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成",statuses:["已完成","done","完成","finish","ok","归档","archived"]}]},{id:this.generateUUID(),name:this.i18n.defaultWeeklyTemplate||"本周回顾",period:"week",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"周报 ({date})",sections:[{id:this.generateUUID(),title:"当前工作",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成及归档 (本周)",statuses:["已完成","done","完成","finish","ok","归档","archived"]},{id:this.generateUUID(),title:"下周工作计划",statuses:["待办","todo","backlog","未开始"]}]}],this.saveData("config.json",this.config))}normalizeTemplates(){if(!Array.isArray(this.config.templates))return;let n=!1;this.config.templates.forEach(l=>{!l.period&&l.type&&(l.period=l.type==="weekly"?"week":"day",n=!0),l.period||(l.period="none",n=!0),l.sections||(l.sections=[],n=!0)}),n&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Workflow Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Workflow Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new ht.Dialog({title:this.i18n.settingTitle||"看板工作流设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{l.$destroy()}}),l=new Il({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new ht.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(o=>{n.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,click:()=>{this.generateTemplate(o.id)}})}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,l=n.getHours(),o=n.getMinutes(),s=l*60+o;let a=0,u=0;try{const m=this.config.archiveTime.split(":").map(Number);m.length===2&&!isNaN(m[0])&&!isNaN(m[1])&&(a=m[0],u=m[1])}catch{return}const p=a*60+u,_=n.toLocaleDateString();this.config.lastRunDate!==_&&s>=p&&(this.config.lastRunDate=_,this.saveData("config.json",this.config),this.archiveNow(!1))}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(l=>l.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(n=!0){if(!(n&&!window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？")))try{const l=await tl(this,n);if(l&&l.length>0)this.undoStack.push({date:new Date().getTime(),ids:l}),await this.saveUndoHistory();else{const o=this.i18n.archiveEmpty||"未发现可归档任务";_t(o)}}catch(l){console.error("Archive task error:",l)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await el(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}async generateTemplate(n){const l=(this.config.templates||[]).find(o=>o.id===n);l&&await Bl(this,l)}async getNotebooks(){return await xn()}async getStatusOptions(n){const l=this.config.profiles||[],o=new Set;for(const s of n){const a=l.find(b=>b.id===s);if(!(a!=null&&a.keyword))continue;const u=await $e(`SELECT id FROM blocks WHERE content LIKE '%${a.keyword}%' AND type = 'd' LIMIT 1`);if(!u||u.length===0)continue;const p=u[0].id,_=await $e(`SELECT id, markdown FROM blocks WHERE root_id = '${p}' AND type = 'av' LIMIT 1`);if(!_||_.length===0)continue;const v=_[0].markdown.match(/data-av-id="([^"]+)"/);if(!v)continue;const k=v[1],f=await Ut(k);if(f)for(const b of f)(b.type==="select"||b.type==="mSelect")&&b.options&&b.options.forEach(w=>{w!=null&&w.name&&o.add(w.name)})}return Array.from(o)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var l=Math.random()*16|0,o=n=="x"?l:l&3|8;return o.toString(16)})}}module.exports=Ol;
