"use strict";var jt=Object.defineProperty;var Ht=(e,t,n)=>t in e?jt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var J=(e,t,n)=>Ht(e,typeof t!="symbol"?t+"":t,n);const Se=require("siyuan");async function we(e,t){let n=await Se.fetchSyncPost(e,t);return n.code===0?n.data:null}async function Me(e){return we("/api/query/sql",{stmt:e})}async function Mt(e,t=7e3){return we("/api/notification/pushMsg",{msg:e,timeout:t})}async function Te(e,t=7e3){return we("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function It(e){return we("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function dt(e,t,n=9999999,i=1){return we("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:i})}async function Ct(e,t,n,i){return we("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:i})}async function Ft(e,t,n,i,o=!1){var c,f,b;try{const u=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${i}"`);const h=await Me(`SELECT id FROM blocks WHERE content LIKE '%${u}%' AND type = 'd' LIMIT 1`);if(!h||h.length===0)return console.log(`Kanban doc not found for keyword: ${u}`),[];const p=h[0].id,r=await Me(`SELECT id, markdown FROM blocks WHERE root_id = '${p}' AND type = 'av' LIMIT 1`);if(!r||r.length===0)return o&&Te(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const _=r[0],s=_.markdown.match(/data-av-id="([^"]+)"/);if(!s)return[];const v=s[1],C=await It(v);if(!C)return[];let x=null,P=null,E=null;for(const k of C)if((k.type==="select"||k.type==="mSelect")&&k.options){const A=k.options.find(d=>d.name===n),N=k.options.find(d=>d.name===i);if(A&&N){x=k,P=A,E=N;break}}if(!x)return o&&Te(`在 "${t.name}" 中未找到状态 "${n}" -> "${i}"`),[];const R=_.markdown.match(/data-view-id="([^"]+)"/);let $=R?R[1]:v,S=await dt(v,$);const U=(k,A=0)=>{if(!k||A>5)return[];let N=[];const d=["rows","groups","blocks","children","items"];for(const q of d)if(Array.isArray(k[q]))for(const se of k[q])se.id&&Array.isArray(se.cells)?N.push(se):N=N.concat(U(se,A+1));return k.view&&(N=N.concat(U(k.view,A+1))),N};let w=U(S);if(w.length===0&&(S!=null&&S.views)){const k=S.views.find(A=>A.type==="table");k&&(S=await dt(v,k.id),w=U(S))}if(w.length===0)return[];let D=(((c=S.view)==null?void 0:c.columns)||S.columns||[]).findIndex(k=>k.id===x.id),j=[],T=0;for(const k of w){let A=!1;if(D>=0&&k.cells&&k.cells[D]){const N=k.cells[D].value;N!=null&&N.mSelect?A=N.mSelect.some(d=>d.content===n):N!=null&&N.select&&(A=N.select.content===n)}else if(k.cells&&Array.isArray(k.cells))for(const N of k.cells){const d=N.value;if((f=d==null?void 0:d.mSelect)!=null&&f.some(q=>q.content===n)){A=!0;break}else if(((b=d==null?void 0:d.select)==null?void 0:b.content)===n){A=!0;break}}if(A){const N={mSelect:[{content:E.name,color:E.color}]};await Ct(v,x.id,k.id,N),j.push(k.id),T++}}return T>0&&Mt(`[${t.name}] 已归档 ${T} 个任务`),j}catch(u){return console.error("Status switch failed:",u),o&&Te(`[${t.name}] 出错: `+u.message),[]}}async function Vt(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let i=0;for(const o of n)try{const c=await Me(`SELECT id FROM blocks WHERE content LIKE '%${o.keyword}%' AND type = 'd' LIMIT 1`);if(!c||c.length===0)continue;const f=c[0].id,b=await Me(`SELECT id, markdown FROM blocks WHERE root_id = '${f}' AND type = 'av' LIMIT 1`);if(!b||b.length===0)continue;const h=b[0].markdown.match(/data-av-id="([^"]+)"/);if(!h)continue;const p=h[1],r=await It(p);if(!r)continue;let _=null,s=null;for(const C of r)if((C.type==="select"||C.type==="mSelect")&&C.options){const x=C.options.find(P=>P.name===o.completedStatus);if(x){_=C,s=x;break}}if(!_||!s)continue;const v={mSelect:[{content:s.name,color:s.color}]};for(const C of t)await Ct(p,_.id,C,v);i+=t.length}catch(c){console.warn("Restore attempted failed for profile",o.name,c)}return i>0?(Mt("已尝试撤销恢复任务"),!0):!1}async function Wt(e,t=!1){const n=e.config.profiles||[];let i=[];if(n.length===0)return t&&Te("未配置任何归档规则，请在设置中添加"),[];for(const o of n){if(!o.keyword||o.enabled===!1)continue;const c=await Ft(e,o,o.completedStatus,o.archivedStatus,t);i=i.concat(c)}return i}let Ne=null;function zt(e){Ne=e}function M(e,t){let n=null;if(Ne&&Ne.i18n&&(n=Ne.i18n),!n)try{const{i18n:c}=require("siyuan");n=c}catch(c){console.warn("无法获取i18n对象:",c)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let i=n;const o=e.split(".");for(const c of o)if(i&&typeof i=="object"&&c in i)i=i[c];else{i=void 0;break}return typeof i!="string"&&(console.warn("未找到i18n键:",e),i=e),i}function _e(){}function Dt(e){return e()}function ft(){return Object.create(null)}function le(e){e.forEach(Dt)}function Et(e){return typeof e=="function"}function Xt(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Gt(e){return Object.keys(e).length===0}function l(e,t){e.appendChild(t)}function Y(e,t,n){e.insertBefore(t,n||null)}function X(e){e.parentNode&&e.parentNode.removeChild(e)}function ht(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function g(e){return document.createElement(e)}function V(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function O(e){return document.createTextNode(e)}function y(){return O(" ")}function L(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function pt(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function a(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function ae(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function Yt(e){return Array.from(e.childNodes)}function je(e,t){t=""+t,e.data!==t&&(e.data=t)}function ne(e,t){e.value=t??""}function m(e,t,n,i){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function ie(e,t,n){e.classList.toggle(t,!!n)}let xe;function Ae(e){xe=e}function Jt(){if(!xe)throw new Error("Function called outside component initialization");return xe}function Qt(e){Jt().$$.on_mount.push(e)}function Zt(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(i=>i.call(this,t))}const ve=[],gt=[];let be=[];const vt=[],en=Promise.resolve();let Oe=!1;function tn(){Oe||(Oe=!0,en.then(Rt))}function Be(e){be.push(e)}const Ke=new Set;let ge=0;function Rt(){if(ge!==0)return;const e=xe;do{try{for(;ge<ve.length;){const t=ve[ge];ge++,Ae(t),nn(t.$$)}}catch(t){throw ve.length=0,ge=0,t}for(Ae(null),ve.length=0,ge=0;gt.length;)gt.pop()();for(let t=0;t<be.length;t+=1){const n=be[t];Ke.has(n)||(Ke.add(n),n())}be.length=0}while(ve.length);for(;vt.length;)vt.pop()();Oe=!1,Ke.clear(),Ae(e)}function nn(e){if(e.fragment!==null){e.update(),le(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Be)}}function ln(e){const t=[],n=[];be.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),be=t}const sn=new Set;function $t(e,t){e&&e.i&&(sn.delete(e),e.i(t))}function me(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function on(e,t){e.d(1),t.delete(e.key)}function cn(e,t,n,i,o,c,f,b,u,h,p,r){let _=e.length,s=c.length,v=_;const C={};for(;v--;)C[e[v].key]=v;const x=[],P=new Map,E=new Map,R=[];for(v=s;v--;){const w=r(o,c,v),K=n(w);let D=f.get(K);D?R.push(()=>D.p(w,t)):(D=h(K,w),D.c()),P.set(K,x[v]=D),K in C&&E.set(K,Math.abs(v-C[K]))}const $=new Set,S=new Set;function U(w){$t(w,1),w.m(b,p),f.set(w.key,w),p=w.first,s--}for(;_&&s;){const w=x[s-1],K=e[_-1],D=w.key,j=K.key;w===K?(p=w.first,_--,s--):P.has(j)?!f.has(D)||$.has(D)?U(w):S.has(j)?_--:E.get(D)>E.get(j)?(S.add(D),U(w)):($.add(j),_--):(u(K,f),_--)}for(;_--;){const w=e[_];P.has(w.key)||u(w,f)}for(;s;)U(x[s-1]);return le(R),x}function an(e,t,n){const{fragment:i,after_update:o}=e.$$;i&&i.m(t,n),Be(()=>{const c=e.$$.on_mount.map(Dt).filter(Et);e.$$.on_destroy?e.$$.on_destroy.push(...c):le(c),e.$$.on_mount=[]}),o.forEach(Be)}function rn(e,t){const n=e.$$;n.fragment!==null&&(ln(n.after_update),le(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function un(e,t){e.$$.dirty[0]===-1&&(ve.push(e),tn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function dn(e,t,n,i,o,c,f=null,b=[-1]){const u=xe;Ae(e);const h=e.$$={fragment:null,ctx:[],props:c,update:_e,not_equal:o,bound:ft(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(u?u.$$.context:[])),callbacks:ft(),dirty:b,skip_bound:!1,root:t.target||u.$$.root};f&&f(h.root);let p=!1;if(h.ctx=n?n(e,t.props||{},(r,_,...s)=>{const v=s.length?s[0]:_;return h.ctx&&o(h.ctx[r],h.ctx[r]=v)&&(!h.skip_bound&&h.bound[r]&&h.bound[r](v),p&&un(e,r)),_}):[],h.update(),p=!0,le(h.before_update),h.fragment=i?i(h.ctx):!1,t.target){if(t.hydrate){const r=Yt(t.target);h.fragment&&h.fragment.l(r),r.forEach(X)}else h.fragment&&h.fragment.c();t.intro&&$t(e.$$.fragment),an(e,t.target,t.anchor),Rt()}Ae(u)}class fn{constructor(){J(this,"$$");J(this,"$$set")}$destroy(){rn(this,1),this.$destroy=_e}$on(t,n){if(!Et(n))return _e;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const o=i.indexOf(n);o!==-1&&i.splice(o,1)}}$set(t){this.$$set&&!Gt(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const hn="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(hn);function mt(e,t,n){const i=e.slice();return i[29]=t[n],i[30]=t,i[31]=n,i}function bt(e,t,n){const i=e.slice();return i[32]=t[n],i}function _t(e,t,n){const i=e.slice();return i[35]=t[n],i}function wt(e){let t,n,i;return{c(){t=g("div"),a(t,"class","backdrop svelte-1nqb995")},m(o,c){Y(o,t,c),n||(i=L(t,"click",e[15]),n=!0)},p:_e,d(o){o&&X(t),n=!1,i()}}}function kt(e){let t,n,i,o,c,f,b=me(e[5]),u=[];for(let r=0;r<b.length;r+=1)u[r]=yt(_t(e,b,r));let h=me(e[6]),p=[];for(let r=0;r<h.length;r+=1)p[r]=St(bt(e,h,r));return{c(){t=g("div"),n=g("div");for(let r=0;r<u.length;r+=1)u[r].c();i=y(),o=g("div"),c=y(),f=g("div");for(let r=0;r<p.length;r+=1)p[r].c();a(n,"class","time-col svelte-1nqb995"),m(o,"width","1px"),m(o,"background","var(--b3-theme-surface-lighter)"),a(f,"class","time-col svelte-1nqb995"),a(t,"class","time-picker-popover svelte-1nqb995")},m(r,_){Y(r,t,_),l(t,n);for(let s=0;s<u.length;s+=1)u[s]&&u[s].m(n,null);l(t,i),l(t,o),l(t,c),l(t,f);for(let s=0;s<p.length;s+=1)p[s]&&p[s].m(f,null)},p(r,_){if(_[0]&2084){b=me(r[5]);let s;for(s=0;s<b.length;s+=1){const v=_t(r,b,s);u[s]?u[s].p(v,_):(u[s]=yt(v),u[s].c(),u[s].m(n,null))}for(;s<u.length;s+=1)u[s].d(1);u.length=b.length}if(_[0]&4164){h=me(r[6]);let s;for(s=0;s<h.length;s+=1){const v=bt(r,h,s);p[s]?p[s].p(v,_):(p[s]=St(v),p[s].c(),p[s].m(f,null))}for(;s<p.length;s+=1)p[s].d(1);p.length=h.length}},d(r){r&&X(t),ht(u,r),ht(p,r)}}}function yt(e){let t,n=e[35]+"",i,o,c,f;function b(){return e[18](e[35])}return{c(){t=g("div"),i=O(n),o=y(),a(t,"id",`time-opt-h-${e[35]}`),a(t,"class","time-opt svelte-1nqb995"),ie(t,"selected",e[2].startsWith(e[35]))},m(u,h){Y(u,t,h),l(t,i),l(t,o),c||(f=L(t,"click",b),c=!0)},p(u,h){e=u,h[0]&36&&ie(t,"selected",e[2].startsWith(e[35]))},d(u){u&&X(t),c=!1,f()}}}function St(e){let t,n=e[32]+"",i,o,c,f;function b(){return e[19](e[32])}return{c(){t=g("div"),i=O(n),o=y(),a(t,"id",`time-opt-m-${e[32]}`),a(t,"class","time-opt svelte-1nqb995"),ie(t,"selected",e[2].endsWith(e[32]))},m(u,h){Y(u,t,h),l(t,i),l(t,o),c||(f=L(t,"click",b),c=!0)},p(u,h){e=u,h[0]&68&&ie(t,"selected",e[2].endsWith(e[32]))},d(u){u&&X(t),c=!1,f()}}}function At(e){let t,n=e[29].keyword+"",i;return{c(){t=g("span"),i=O(n),a(t,"class","tag-preview svelte-1nqb995")},m(o,c){Y(o,t,c),l(t,i)},p(o,c){c[0]&2&&n!==(n=o[29].keyword+"")&&je(i,n)},d(o){o&&X(t)}}}function xt(e){let t,n,i,o,c,f,b,u,h,p,r,_,s,v,C,x,P,E,R,$,S,U,w;function K(){e[23].call(c,e[30],e[31])}function D(){e[24].call(p,e[30],e[31])}function j(){e[25].call(x,e[30],e[31])}function T(){e[26].call(S,e[30],e[31])}return{c(){t=g("div"),n=g("div"),i=g("div"),i.textContent=`${M("ruleNameLabel")}`,o=y(),c=g("input"),f=y(),b=g("div"),u=g("div"),u.textContent=`${M("keywordLabel")}`,h=y(),p=g("input"),r=y(),_=g("div"),s=g("div"),v=g("div"),v.textContent=`${M("completedStatusLabel")}`,C=y(),x=g("input"),P=y(),E=g("div"),R=g("div"),R.textContent=`${M("archivedStatusLabel")}`,$=y(),S=g("input"),a(i,"class","input-label svelte-1nqb995"),a(c,"class","modern-input svelte-1nqb995"),a(c,"type","text"),a(c,"placeholder",M("ruleNamePlaceholder")),a(n,"class","input-group svelte-1nqb995"),a(u,"class","input-label svelte-1nqb995"),a(p,"class","modern-input svelte-1nqb995"),a(p,"type","text"),a(p,"placeholder",M("keywordPlaceholder")),a(b,"class","input-group svelte-1nqb995"),a(v,"class","input-label svelte-1nqb995"),a(x,"class","modern-input svelte-1nqb995"),a(x,"type","text"),a(x,"placeholder",M("completedStatusPlaceholder")),a(s,"class","input-group fn__flex-1 svelte-1nqb995"),a(R,"class","input-label svelte-1nqb995"),a(S,"class","modern-input svelte-1nqb995"),a(S,"type","text"),a(S,"placeholder",M("archivedStatusPlaceholder")),a(E,"class","input-group fn__flex-1 svelte-1nqb995"),a(_,"class","fn__flex svelte-1nqb995"),m(_,"gap","20px"),a(t,"class","card-content svelte-1nqb995")},m(k,A){Y(k,t,A),l(t,n),l(n,i),l(n,o),l(n,c),ne(c,e[29].name),l(t,f),l(t,b),l(b,u),l(b,h),l(b,p),ne(p,e[29].keyword),l(t,r),l(t,_),l(_,s),l(s,v),l(s,C),l(s,x),ne(x,e[29].completedStatus),l(_,P),l(_,E),l(E,R),l(E,$),l(E,S),ne(S,e[29].archivedStatus),U||(w=[L(c,"input",K),L(c,"change",e[7]),L(p,"input",D),L(p,"change",e[7]),L(x,"input",j),L(x,"change",e[7]),L(S,"input",T),L(S,"change",e[7])],U=!0)},p(k,A){e=k,A[0]&2&&c.value!==e[29].name&&ne(c,e[29].name),A[0]&2&&p.value!==e[29].keyword&&ne(p,e[29].keyword),A[0]&2&&x.value!==e[29].completedStatus&&ne(x,e[29].completedStatus),A[0]&2&&S.value!==e[29].archivedStatus&&ne(S,e[29].archivedStatus)},d(k){k&&X(t),U=!1,le(w)}}}function qt(e,t){let n,i,o,c,f,b,u=(t[29].name||M("unnamedRule"))+"",h,p,r,_,s,v,C,x,P,E,R,$,S,U,w=t[29].keyword&&At(t);function K(){t[20].call(v,t[30],t[31])}function D(){return t[21](t[29])}function j(){return t[22](t[29])}let T=t[3]===t[29].id&&xt(t);return{key:e,first:null,c(){n=g("div"),i=g("div"),o=g("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',c=y(),f=g("div"),b=g("span"),h=O(u),p=y(),w&&w.c(),r=y(),_=g("div"),s=g("label"),v=g("input"),C=y(),x=g("span"),x.innerHTML='<span class="switch-thumb svelte-1nqb995"></span>',E=y(),R=g("div"),R.innerHTML='<svg class="svelte-1nqb995"><use xlink:href="#iconTrashcan"></use></svg>',$=y(),T&&T.c(),a(o,"class","chevron svelte-1nqb995"),m(b,"font-weight","600"),m(b,"font-size","15px"),m(b,"color","var(--b3-theme-on-surface)"),a(f,"class","fn__flex-1 svelte-1nqb995"),m(f,"margin-left","14px"),m(f,"display","flex"),m(f,"align-items","center"),a(v,"class","switch-input svelte-1nqb995"),a(v,"type","checkbox"),a(x,"class","switch-track svelte-1nqb995"),a(s,"class","switch-container svelte-1nqb995"),a(s,"title",P=t[29].enabled?M("enabled"):M("disabled")),a(_,"class","fn__flex-center"),m(_,"margin-right","20px"),a(R,"class","icon-btn svelte-1nqb995"),a(R,"title",M("deleteRule")),a(i,"class","card-header svelte-1nqb995"),a(n,"class","card svelte-1nqb995"),m(n,"opacity",t[29].enabled?1:.75),ie(n,"expanded",t[3]===t[29].id),this.first=n},m(k,A){Y(k,n,A),l(n,i),l(i,o),l(i,c),l(i,f),l(f,b),l(b,h),l(f,p),w&&w.m(f,null),l(i,r),l(i,_),l(_,s),l(s,v),v.checked=t[29].enabled,l(s,C),l(s,x),l(i,E),l(i,R),l(n,$),T&&T.m(n,null),S||(U=[L(v,"change",K),L(v,"change",t[7]),L(_,"click",pt(t[14])),L(R,"click",pt(D)),L(i,"click",j)],S=!0)},p(k,A){t=k,A[0]&2&&u!==(u=(t[29].name||M("unnamedRule"))+"")&&je(h,u),t[29].keyword?w?w.p(t,A):(w=At(t),w.c(),w.m(f,null)):w&&(w.d(1),w=null),A[0]&2&&(v.checked=t[29].enabled),A[0]&2&&P!==(P=t[29].enabled?M("enabled"):M("disabled"))&&a(s,"title",P),t[3]===t[29].id?T?T.p(t,A):(T=xt(t),T.c(),T.m(n,null)):T&&(T.d(1),T=null),A[0]&2&&m(n,"opacity",t[29].enabled?1:.75),A[0]&10&&ie(n,"expanded",t[3]===t[29].id)},d(k){k&&X(n),w&&w.d(),T&&T.d(),S=!1,le(U)}}}function Tt(e){let t;return{c(){t=g("div"),t.textContent=`${M("noRulesTip")}`,m(t,"text-align","center"),m(t,"padding","48px"),m(t,"color","var(--b3-theme-on-surface-light)"),m(t,"border","2px dashed var(--b3-border-color)"),m(t,"border-radius","16px")},m(n,i){Y(n,t,i)},d(n){n&&X(t)}}}function pn(e){let t,n,i,o,c,f,b,u=M("globalArchiveTime")+"",h,p,r,_,s,v,C,x,P=M("undoArchive")+"",E,R,$,S,U,w,K=M("archiveNow")+"",D,j,T,k,A,N,d,q,se,Q,Z,re,ke,Ie,He,Ut=M("archiveRuleList")+"",Fe,Ve,Ce,We,oe,ue,De,ze,Lt=M("addRule")+"",Xe,Ge,ee,G=[],Ye=new Map,Ee,Je,de,z,ye,Re,Qe,Pt=M("usageTipTitle")+"",Ze,et,te,fe,$e,tt,Kt=M("usageTipGlobalDesc")+"",nt,it,he,Ue,lt,Ot=M("usageTipMatchDesc")+"",st,ot,pe,Le,ct,Bt=M("usageTipStatusDesc")+"",at,Pe,rt,H=e[4]&&wt(e),F=e[4]&&kt(e),qe=me(e[1]);const ut=I=>I[29].id;for(let I=0;I<qe.length;I+=1){let B=mt(e,qe,I),ce=ut(B);Ye.set(ce,G[I]=qt(ce,B))}let W=e[1].length===0&&Tt();return{c(){H&&H.c(),t=y(),n=g("div"),i=g("div"),o=g("div"),c=V("svg"),f=V("use"),b=y(),h=O(u),p=y(),r=g("div"),_=y(),s=g("button"),v=V("svg"),C=V("use"),x=y(),E=O(P),R=y(),$=g("button"),S=V("svg"),U=V("use"),w=y(),D=O(K),j=y(),T=g("div"),k=O(e[2]),A=y(),N=V("svg"),d=V("use"),q=y(),F&&F.c(),se=y(),Q=g("div"),Z=g("div"),re=g("div"),ke=V("svg"),Ie=V("use"),He=y(),Fe=O(Ut),Ve=y(),Ce=g("div"),We=y(),oe=g("button"),ue=V("svg"),De=V("use"),ze=y(),Xe=O(Lt),Ge=y(),ee=g("div");for(let I=0;I<G.length;I+=1)G[I].c();Ee=y(),W&&W.c(),Je=y(),de=g("div"),z=g("div"),ye=V("svg"),Re=V("use"),Qe=y(),Ze=O(Pt),et=y(),te=g("ul"),fe=g("li"),$e=g("strong"),$e.textContent=`${M("usageTipGlobal")}`,tt=O("："),nt=O(Kt),it=y(),he=g("li"),Ue=g("strong"),Ue.textContent=`${M("usageTipMatch")}`,lt=O("："),st=O(Ot),ot=y(),pe=g("li"),Le=g("strong"),Le.textContent=`${M("usageTipStatus")}`,ct=O("："),at=O(Bt),ae(f,"xlink:href","#iconCalendar"),m(c,"width","18px"),m(c,"height","18px"),a(o,"class","section-title svelte-1nqb995"),a(r,"class","fn__flex-1 svelte-1nqb995"),ae(C,"xlink:href","#iconUndo"),m(v,"width","14px"),m(v,"height","14px"),a(v,"class","svelte-1nqb995"),a(s,"class","action-btn svelte-1nqb995"),m(s,"background-color","transparent"),m(s,"color","var(--b3-theme-on-surface)"),m(s,"box-shadow","none"),m(s,"border","1px solid var(--b3-theme-surface-lighter)"),m(s,"margin-right","12px"),ae(U,"xlink:href","#iconFiles"),m(S,"width","14px"),m(S,"height","14px"),a(S,"class","svelte-1nqb995"),a($,"class","action-btn svelte-1nqb995"),m($,"margin-right","32px"),ae(d,"xlink:href","#iconClock"),m(N,"width","14px"),m(N,"height","14px"),m(N,"opacity","0.6"),a(T,"class","time-trigger svelte-1nqb995"),ie(T,"active",e[4]),a(i,"class","section-header svelte-1nqb995"),ae(Ie,"xlink:href","#iconSettings"),m(ke,"width","18px"),m(ke,"height","18px"),a(re,"class","section-title svelte-1nqb995"),a(Ce,"class","fn__flex-1 svelte-1nqb995"),ae(De,"xlink:href","#iconAdd"),m(ue,"width","14px"),m(ue,"height","14px"),a(ue,"class","svelte-1nqb995"),a(oe,"class","action-btn svelte-1nqb995"),a(Z,"class","section-header svelte-1nqb995"),a(ee,"class","profile-container svelte-1nqb995"),m(Q,"margin-top","20px"),m(Q,"display","flex"),m(Q,"flex-direction","column"),ae(Re,"xlink:href","#iconInfo"),m(ye,"width","16px"),m(ye,"height","16px"),m(z,"font-weight","700"),m(z,"color","var(--b3-theme-primary)"),m(z,"display","flex"),m(z,"align-items","center"),m(z,"gap","8px"),m(z,"margin-bottom","8px"),m(z,"font-size","14px"),a(fe,"class","svelte-1nqb995"),a(he,"class","svelte-1nqb995"),a(pe,"class","svelte-1nqb995"),a(te,"class","svelte-1nqb995"),a(de,"class","info-footer svelte-1nqb995"),a(n,"class","settings-container svelte-1nqb995")},m(I,B){H&&H.m(I,B),Y(I,t,B),Y(I,n,B),l(n,i),l(i,o),l(o,c),l(c,f),l(o,b),l(o,h),l(i,p),l(i,r),l(i,_),l(i,s),l(s,v),l(v,C),l(s,x),l(s,E),l(i,R),l(i,$),l($,S),l(S,U),l($,w),l($,D),l(i,j),l(i,T),l(T,k),l(T,A),l(T,N),l(N,d),l(i,q),F&&F.m(i,null),l(n,se),l(n,Q),l(Q,Z),l(Z,re),l(re,ke),l(ke,Ie),l(re,He),l(re,Fe),l(Z,Ve),l(Z,Ce),l(Z,We),l(Z,oe),l(oe,ue),l(ue,De),l(oe,ze),l(oe,Xe),l(Q,Ge),l(Q,ee);for(let ce=0;ce<G.length;ce+=1)G[ce]&&G[ce].m(ee,null);l(ee,Ee),W&&W.m(ee,null),l(n,Je),l(n,de),l(de,z),l(z,ye),l(ye,Re),l(z,Qe),l(z,Ze),l(de,et),l(de,te),l(te,fe),l(fe,$e),l(fe,tt),l(fe,nt),l(te,it),l(te,he),l(he,Ue),l(he,lt),l(he,st),l(te,ot),l(te,pe),l(pe,Le),l(pe,ct),l(pe,at),Pe||(rt=[L(s,"click",e[16]),L($,"click",e[17]),L(T,"click",e[13]),L(oe,"click",e[8])],Pe=!0)},p(I,B){I[4]?H?H.p(I,B):(H=wt(I),H.c(),H.m(t.parentNode,t)):H&&(H.d(1),H=null),B[0]&4&&je(k,I[2]),B[0]&16&&ie(T,"active",I[4]),I[4]?F?F.p(I,B):(F=kt(I),F.c(),F.m(i,null)):F&&(F.d(1),F=null),B[0]&1674&&(qe=me(I[1]),G=cn(G,B,ut,1,I,qe,Ye,ee,on,qt,Ee,mt)),I[1].length===0?W||(W=Tt(),W.c(),W.m(ee,null)):W&&(W.d(1),W=null)},i:_e,o:_e,d(I){I&&(X(t),X(n)),H&&H.d(I),F&&F.d();for(let B=0;B<G.length;B+=1)G[B].d();W&&W.d(),Pe=!1,le(rt)}}}function gn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function Nt(e,t){const n=`time-opt-${e}-${t}`,i=document.getElementById(n);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}function vn(e,t,n){let{plugin:i}=t,o=[],c="00:00",f=null,b=!1;const u=Array.from({length:24},(d,q)=>q.toString().padStart(2,"0")),h=Array.from({length:60},(d,q)=>q.toString().padStart(2,"0"));Qt(()=>{p(),i.config.profiles&&i.config.profiles.length===1&&n(3,f=i.config.profiles[0].id)});function p(){n(1,o=i.config.profiles||[]),n(2,c=i.config.archiveTime||"00:00")}async function r(){n(0,i.config.archiveTime=c,i),i.saveData("config.json",i.config),p()}function _(){i.config.profiles||n(0,i.config.profiles=[],i);const d={id:gn(),name:M("defaultNewRuleName")+" "+(i.config.profiles.length+1),keyword:"",completedStatus:M("defaultCompleted"),archivedStatus:M("defaultArchived"),enabled:!0};n(0,i.config.profiles=[...i.config.profiles,d],i),r(),n(3,f=d.id),setTimeout(()=>{const q=document.querySelector(".profile-container");q&&(q.scrollTop=q.scrollHeight)},50)}function s(d){n(0,i.config.profiles=i.config.profiles.filter(q=>q.id!==d),i),r(),f===d&&n(3,f=null)}function v(d){f===d?n(3,f=null):n(3,f=d)}function C(d){const q=c.split(":");n(2,c=`${d}:${q[1]||"00"}`),r()}function x(d){const q=c.split(":");n(2,c=`${q[0]||"00"}:${d}`),r()}function P(){n(4,b=!b),b&&setTimeout(()=>{const[d,q]=c.split(":");Nt("h",d),Nt("m",q)},10)}function E(d){Zt.call(this,e,d)}const R=()=>n(4,b=!1),$=()=>i.undoArchiveNow(),S=()=>i.archiveNow(),U=d=>C(d),w=d=>x(d);function K(d,q){d[q].enabled=this.checked,n(1,o)}const D=d=>s(d.id),j=d=>v(d.id);function T(d,q){d[q].name=this.value,n(1,o)}function k(d,q){d[q].keyword=this.value,n(1,o)}function A(d,q){d[q].completedStatus=this.value,n(1,o)}function N(d,q){d[q].archivedStatus=this.value,n(1,o)}return e.$$set=d=>{"plugin"in d&&n(0,i=d.plugin)},[i,o,c,f,b,u,h,r,_,s,v,C,x,P,E,R,$,S,U,w,K,D,j,T,k,A,N]}class mn extends fn{constructor(t){super(),dn(this,t,vn,pn,Xt,{plugin:0},null,[-1,-1])}}class bn extends Se.Plugin{constructor(){super(...arguments);J(this,"timer");J(this,"isMobile");J(this,"config",{});J(this,"undoStack",[]);J(this,"MAX_UNDO_COUNT",30);J(this,"MAX_UNDO_DAYS",7)}async onload(){zt(this),console.log("Loading Kanban Archiver Plugin v0.3.20"),await this.loadAndNormalizeConfig();try{const i=await this.loadData("undo_history.json");i&&Array.isArray(i)&&(this.undoStack=i)}catch(i){console.error("Failed to load undo history",i)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板自动归档",position:"right",callback:i=>{if(this.isMobile){this.showMobileMenu();return}let o;i&&i.currentTarget&&i.currentTarget.getBoundingClientRect?o=i.currentTarget.getBoundingClientRect():o=n.getBoundingClientRect();const c=new Se.Menu("kanban-archiver-menu");c.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),c.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),c.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),c.open({x:o.left,y:o.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",...n},(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let i=!1;this.config.profiles.forEach(o=>{o.enabled===void 0&&(o.enabled=!0,i=!0)}),i&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Archiver Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Archiver Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new Se.Dialog({title:this.i18n.settingTitle||"看板自动归档设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{i.$destroy()}}),i=new mn({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new Se.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,i=n.getHours(),o=n.getMinutes(),c=i*60+o;let f=0,b=0;try{const p=this.config.archiveTime.split(":").map(Number);p.length===2&&!isNaN(p[0])&&!isNaN(p[1])&&(f=p[0],b=p[1])}catch{return}const u=f*60+b,h=n.toLocaleDateString();this.config.lastRunDate!==h&&c>=u&&(this.config.lastRunDate=h,this.saveData("config.json",this.config),this.archiveNow())}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(i=>i.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(){try{const n=await Wt(this,!0);n&&n.length>0&&(this.undoStack.push({date:new Date().getTime(),ids:n}),await this.saveUndoHistory())}catch(n){console.error("Archive task error:",n)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await Vt(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=Math.random()*16|0,o=n=="x"?i:i&3|8;return o.toString(16)})}}module.exports=bn;
