"use strict";var jn=Object.defineProperty;var zn=(t,e,n)=>e in t?jn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Fe=(t,e,n)=>zn(t,typeof e!="symbol"?e+"":e,n);const ft=require("siyuan");async function Me(t,e){let n=await ft.fetchSyncPost(t,e);return n.code===0?n.data:null}async function Mn(){const e=await Me("/api/notebook/lsNotebooks","");try{e&&e.notebooks&&Array.isArray(e.notebooks)&&(e.notebooks=e.notebooks.filter(n=>n.closed===!1||n.closed===0||n.closed==="false"))}catch(n){console.error("Filter notebooks error:",n)}return e}async function Vn(t,e,n){return Me("/api/filetree/createDocWithMd",{notebook:t,path:e,markdown:n})}async function qn(t,e,n){return Me("/api/block/appendBlock",{dataType:t,data:e,parentID:n})}async function Yn(t){return Me("/api/block/deleteBlock",{id:t})}async function Xn(t,e){return Me("/api/attr/setBlockAttrs",{id:t,attrs:e})}async function De(t){return Me("/api/query/sql",{stmt:t})}async function wt(t,e=7e3){return Me("/api/notification/pushMsg",{msg:t,timeout:e})}async function qe(t,e=7e3){return Me("/api/notification/pushErrMsg",{msg:t,timeout:e})}async function xt(t){return Me("/api/av/getAttributeViewKeysByAvID",{avID:t})}async function Nt(t,e,n=9999999,l=1){return Me("/api/av/renderAttributeView",{id:t,viewID:e,pageSize:n,page:l})}async function Rn(t,e,n,l){return Me("/api/av/setAttributeViewBlockAttr",{avID:t,keyID:e,itemID:n,value:l})}async function Gn(t,e,n,l,s=!1){var o,a,u;try{const f=e.keyword;console.log(`Starting Kanban status switch for profile "${e.name}": "${n}" -> "${l}"`);const _=await De(`SELECT id FROM blocks WHERE content LIKE '%${f}%' AND type = 'd' LIMIT 1`);if(!_||_.length===0)return console.log(`Kanban doc not found for keyword: ${f}`),[];const g=_[0].id,m=await De(`SELECT id, markdown FROM blocks WHERE root_id = '${g}' AND type = 'av' LIMIT 1`);if(!m||m.length===0)return s&&qe(`文档中未找到数据库视图 (Profile: ${e.name})`),[];const k=m[0],d=k.markdown.match(/data-av-id="([^"]+)"/);if(!d)return[];const b=d[1],y=await xt(b);if(!y)return[];let T=null,M=null,H=null;for(const D of y)if((D.type==="select"||D.type==="mSelect")&&D.options){const E=D.options.find(j=>j.name===n),U=D.options.find(j=>j.name===l);if(E&&U){T=D,M=E,H=U;break}}if(!T)return s&&qe(`在 "${e.name}" 中未找到状态 "${n}" -> "${l}"`),[];const P=k.markdown.match(/data-view-id="([^"]+)"/);let C=P?P[1]:b,N=await Nt(b,C);const $=(D,E=0)=>{if(!D||E>5)return[];let U=[];const j=["rows","groups","blocks","children","items"];for(const Y of j)if(Array.isArray(D[Y]))for(const fe of D[Y])fe.id&&Array.isArray(fe.cells)?U.push(fe):U=U.concat($(fe,E+1));return D.view&&(U=U.concat($(D.view,E+1))),U};let I=$(N);if(I.length===0&&(N!=null&&N.views)){const D=N.views.find(E=>E.type==="table");D&&(N=await Nt(b,D.id),I=$(N))}if(I.length===0)return[];let L=(((o=N.view)==null?void 0:o.columns)||N.columns||[]).findIndex(D=>D.id===T.id),K=[],p=0;for(const D of I){let E=!1;if(L>=0&&D.cells&&D.cells[L]){const U=D.cells[L].value;U!=null&&U.mSelect?E=U.mSelect.some(j=>j.content===n):U!=null&&U.select&&(E=U.select.content===n)}else if(D.cells&&Array.isArray(D.cells))for(const U of D.cells){const j=U.value;if((a=j==null?void 0:j.mSelect)!=null&&a.some(Y=>Y.content===n)){E=!0;break}else if(((u=j==null?void 0:j.select)==null?void 0:u.content)===n){E=!0;break}}if(E){const U={mSelect:[{content:H.name,color:H.color}]};await Rn(b,T.id,D.id,U),K.push(D.id),p++}}return p>0&&wt(`[${e.name}] 已归档 ${p} 个任务`),K}catch(f){return console.error("Status switch failed:",f),s&&qe(`[${e.name}] 出错: `+f.message),[]}}async function Jn(t,e){if(!e||e.length===0)return!1;const n=t.config.profiles||[];let l=0;for(const s of n)try{const o=await De(`SELECT id FROM blocks WHERE content LIKE '%${s.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)continue;const a=o[0].id,u=await De(`SELECT id, markdown FROM blocks WHERE root_id = '${a}' AND type = 'av' LIMIT 1`);if(!u||u.length===0)continue;const _=u[0].markdown.match(/data-av-id="([^"]+)"/);if(!_)continue;const g=_[1],m=await xt(g);if(!m)continue;let k=null,d=null;for(const y of m)if((y.type==="select"||y.type==="mSelect")&&y.options){const T=y.options.find(M=>M.name===s.completedStatus);if(T){k=y,d=T;break}}if(!k||!d)continue;const b={mSelect:[{content:d.name,color:d.color}]};for(const y of e)await Rn(g,k.id,y,b);l+=e.length}catch(o){console.warn("Restore attempted failed for profile",s.name,o)}return l>0?(wt("已尝试撤销恢复任务"),!0):!1}async function Qn(t,e=!1){const n=t.config.profiles||[];let l=[];if(n.length===0)return e&&qe("未配置任何归档规则，请在设置中添加"),[];for(const s of n){if(!s.keyword||s.enabled===!1)continue;const o=await Gn(t,s,s.completedStatus,s.archivedStatus,e);l=l.concat(o)}return l}let kt=null;function Zn(t){kt=t}function S(t,e){let n=null;if(kt&&kt.i18n&&(n=kt.i18n),!n)try{const{i18n:o}=require("siyuan");n=o}catch(o){console.warn("无法获取i18n对象:",o)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",t),t;let l=n;const s=t.split(".");for(const o of s)if(l&&typeof l=="object"&&o in l)l=l[o];else{l=void 0;break}return typeof l!="string"&&(console.warn("未找到i18n键:",t),l=t),l}function Je(){}function $n(t){return t()}function Zt(){return Object.create(null)}function Re(t){t.forEach($n)}function Ln(t){return typeof t=="function"}function el(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function tl(t){return Object.keys(t).length===0}function i(t,e){t.appendChild(e)}function Z(t,e,n){t.insertBefore(e,n||null)}function J(t){t.parentNode&&t.parentNode.removeChild(t)}function at(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function r(t){return document.createElement(t)}function oe(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function W(t){return document.createTextNode(t)}function w(){return W(" ")}function nl(){return W("")}function F(t,e,n,l){return t.addEventListener(e,n,l),()=>t.removeEventListener(e,n,l)}function bt(t){return function(e){return e.stopPropagation(),t.call(this,e)}}function c(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function He(t,e,n){t.setAttributeNS("http://www.w3.org/1999/xlink",e,n)}function ll(t){return Array.from(t.childNodes)}function Ke(t,e){e=""+e,t.data!==e&&(t.data=e)}function X(t,e){t.value=e??""}function v(t,e,n,l){n==null?t.style.removeProperty(e):t.style.setProperty(e,n,"")}function _t(t,e,n){for(let l=0;l<t.options.length;l+=1){const s=t.options[l];if(s.__value===e){s.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function en(t){const e=t.querySelector(":checked");return e&&e.__value}function xe(t,e,n){t.classList.toggle(e,!!n)}let pt;function ht(t){pt=t}function il(){if(!pt)throw new Error("Function called outside component initialization");return pt}function sl(t){il().$$.on_mount.push(t)}function ol(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(l=>l.call(this,e))}const st=[],tn=[];let ot=[];const nn=[],al=Promise.resolve();let Et=!1;function cl(){Et||(Et=!0,al.then(xn))}function mt(t){ot.push(t)}const Dt=new Set;let lt=0;function xn(){if(lt!==0)return;const t=pt;do{try{for(;lt<st.length;){const e=st[lt];lt++,ht(e),rl(e.$$)}}catch(e){throw st.length=0,lt=0,e}for(ht(null),st.length=0,lt=0;tn.length;)tn.pop()();for(let e=0;e<ot.length;e+=1){const n=ot[e];Dt.has(n)||(Dt.add(n),n())}ot.length=0}while(st.length);for(;nn.length;)nn.pop()();Et=!1,Dt.clear(),ht(t)}function rl(t){if(t.fragment!==null){t.update(),Re(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(mt)}}function dl(t){const e=[],n=[];ot.forEach(l=>t.indexOf(l)===-1?e.push(l):n.push(l)),n.forEach(l=>l()),ot=e}const ul=new Set;function Pn(t,e){t&&t.i&&(ul.delete(t),t.i(e))}function ae(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function Mt(t,e){t.d(1),e.delete(t.key)}function Rt(t,e,n,l,s,o,a,u,f,_,g,m){let k=t.length,d=o.length,b=k;const y={};for(;b--;)y[t[b].key]=b;const T=[],M=new Map,H=new Map,P=[];for(b=d;b--;){const I=m(s,o,b),x=n(I);let L=a.get(x);L?P.push(()=>L.p(I,e)):(L=_(x,I),L.c()),M.set(x,T[b]=L),x in y&&H.set(x,Math.abs(b-y[x]))}const C=new Set,N=new Set;function $(I){Pn(I,1),I.m(u,g),a.set(I.key,I),g=I.first,d--}for(;k&&d;){const I=T[d-1],x=t[k-1],L=I.key,K=x.key;I===x?(g=I.first,k--,d--):M.has(K)?!a.has(L)||C.has(L)?$(I):N.has(K)?k--:H.get(L)>H.get(K)?(N.add(L),$(I)):(C.add(K),k--):(f(x,a),k--)}for(;k--;){const I=t[k];M.has(I.key)||f(I,a)}for(;d;)$(T[d-1]);return Re(P),T}function fl(t,e,n){const{fragment:l,after_update:s}=t.$$;l&&l.m(e,n),mt(()=>{const o=t.$$.on_mount.map($n).filter(Ln);t.$$.on_destroy?t.$$.on_destroy.push(...o):Re(o),t.$$.on_mount=[]}),s.forEach(mt)}function hl(t,e){const n=t.$$;n.fragment!==null&&(dl(n.after_update),Re(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function pl(t,e){t.$$.dirty[0]===-1&&(st.push(t),cl(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ml(t,e,n,l,s,o,a=null,u=[-1]){const f=pt;ht(t);const _=t.$$={fragment:null,ctx:[],props:o,update:Je,not_equal:s,bound:Zt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(f?f.$$.context:[])),callbacks:Zt(),dirty:u,skip_bound:!1,root:e.target||f.$$.root};a&&a(_.root);let g=!1;if(_.ctx=n?n(t,e.props||{},(m,k,...d)=>{const b=d.length?d[0]:k;return _.ctx&&s(_.ctx[m],_.ctx[m]=b)&&(!_.skip_bound&&_.bound[m]&&_.bound[m](b),g&&pl(t,m)),k}):[],_.update(),g=!0,Re(_.before_update),_.fragment=l?l(_.ctx):!1,e.target){if(e.hydrate){const m=ll(e.target);_.fragment&&_.fragment.l(m),m.forEach(J)}else _.fragment&&_.fragment.c();e.intro&&Pn(t.$$.fragment),fl(t,e.target,e.anchor),xn()}ht(f)}class gl{constructor(){Fe(this,"$$");Fe(this,"$$set")}$destroy(){hl(this,1),this.$destroy=Je}$on(e,n){if(!Ln(n))return Je;const l=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return l.push(n),()=>{const s=l.indexOf(n);s!==-1&&l.splice(s,1)}}$set(e){this.$$set&&!tl(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const vl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(vl);function ln(t,e,n){const l=t.slice();return l[57]=e[n],l[58]=e,l[59]=n,l}function sn(t,e,n){const l=t.slice();return l[60]=e[n],l[61]=e,l[62]=n,l}function on(t,e,n){const l=t.slice();return l[63]=e[n],l}function an(t,e,n){const l=t.slice();return l[63]=e[n],l}function cn(t,e,n){const l=t.slice();return l[68]=e[n],l}function rn(t,e,n){const l=t.slice();return l[71]=e[n],l}function dn(t,e,n){const l=t.slice();return l[74]=e[n],l[75]=e,l[76]=n,l}function un(t,e,n){const l=t.slice();return l[77]=e[n],l}function fn(t,e,n){const l=t.slice();return l[80]=e[n],l}function hn(t){let e,n,l;return{c(){e=r("div"),c(e,"class","backdrop svelte-1plhmm3")},m(s,o){Z(s,e,o),n||(l=F(e,"click",t[27]),n=!0)},p:Je,d(s){s&&J(e),n=!1,l()}}}function pn(t){let e,n,l,s,o,a,u=ae(t[9]),f=[];for(let m=0;m<u.length;m+=1)f[m]=mn(fn(t,u,m));let _=ae(t[10]),g=[];for(let m=0;m<_.length;m+=1)g[m]=gn(un(t,_,m));return{c(){e=r("div"),n=r("div");for(let m=0;m<f.length;m+=1)f[m].c();l=w(),s=r("div"),o=w(),a=r("div");for(let m=0;m<g.length;m+=1)g[m].c();c(n,"class","time-col svelte-1plhmm3"),v(s,"width","1px"),v(s,"background","var(--b3-theme-surface-lighter)"),c(a,"class","time-col svelte-1plhmm3"),c(e,"class","time-picker-popover svelte-1plhmm3")},m(m,k){Z(m,e,k),i(e,n);for(let d=0;d<f.length;d+=1)f[d]&&f[d].m(n,null);i(e,l),i(e,s),i(e,o),i(e,a);for(let d=0;d<g.length;d+=1)g[d]&&g[d].m(a,null)},p(m,k){if(k[0]&33284){u=ae(m[9]);let d;for(d=0;d<u.length;d+=1){const b=fn(m,u,d);f[d]?f[d].p(b,k):(f[d]=mn(b),f[d].c(),f[d].m(n,null))}for(;d<f.length;d+=1)f[d].d(1);f.length=u.length}if(k[0]&66564){_=ae(m[10]);let d;for(d=0;d<_.length;d+=1){const b=un(m,_,d);g[d]?g[d].p(b,k):(g[d]=gn(b),g[d].c(),g[d].m(a,null))}for(;d<g.length;d+=1)g[d].d(1);g.length=_.length}},d(m){m&&J(e),at(f,m),at(g,m)}}}function mn(t){let e,n=t[80]+"",l,s,o,a;function u(){return t[30](t[80])}return{c(){e=r("div"),l=W(n),s=w(),c(e,"id",`time-opt-h-${t[80]}`),c(e,"class","time-opt svelte-1plhmm3"),xe(e,"selected",t[2].startsWith(t[80]))},m(f,_){Z(f,e,_),i(e,l),i(e,s),o||(a=F(e,"click",u),o=!0)},p(f,_){t=f,_[0]&516&&xe(e,"selected",t[2].startsWith(t[80]))},d(f){f&&J(e),o=!1,a()}}}function gn(t){let e,n=t[77]+"",l,s,o,a;function u(){return t[31](t[77])}return{c(){e=r("div"),l=W(n),s=w(),c(e,"id",`time-opt-m-${t[77]}`),c(e,"class","time-opt svelte-1plhmm3"),xe(e,"selected",t[2].endsWith(t[77]))},m(f,_){Z(f,e,_),i(e,l),i(e,s),o||(a=F(e,"click",u),o=!0)},p(f,_){t=f,_[0]&1028&&xe(e,"selected",t[2].endsWith(t[77]))},d(f){f&&J(e),o=!1,a()}}}function vn(t){let e,n=t[74].keyword+"",l;return{c(){e=r("span"),l=W(n),c(e,"class","tag-preview svelte-1plhmm3")},m(s,o){Z(s,e,o),i(e,l)},p(s,o){o[0]&2&&n!==(n=s[74].keyword+"")&&Ke(l,n)},d(s){s&&J(e)}}}function _n(t){let e,n,l,s,o,a,u,f,_,g,m,k,d,b,y,T,M,H,P,C,N,$,I;function x(){t[35].call(o,t[75],t[76])}function L(){t[36].call(g,t[75],t[76])}function K(){t[37].call(T,t[75],t[76])}function p(){t[38].call(N,t[75],t[76])}return{c(){e=r("div"),n=r("div"),l=r("div"),l.textContent=`${S("ruleNameLabel")}`,s=w(),o=r("input"),a=w(),u=r("div"),f=r("div"),f.textContent=`${S("keywordLabel")}`,_=w(),g=r("input"),m=w(),k=r("div"),d=r("div"),b=r("div"),b.textContent=`${S("completedStatusLabel")}`,y=w(),T=r("input"),M=w(),H=r("div"),P=r("div"),P.textContent=`${S("archivedStatusLabel")}`,C=w(),N=r("input"),c(l,"class","input-label svelte-1plhmm3"),c(o,"class","modern-input svelte-1plhmm3"),c(o,"type","text"),c(o,"placeholder",S("ruleNamePlaceholder")),c(n,"class","input-group svelte-1plhmm3"),c(f,"class","input-label svelte-1plhmm3"),c(g,"class","modern-input svelte-1plhmm3"),c(g,"type","text"),c(g,"placeholder",S("keywordPlaceholder")),c(u,"class","input-group svelte-1plhmm3"),c(b,"class","input-label svelte-1plhmm3"),c(T,"class","modern-input svelte-1plhmm3"),c(T,"type","text"),c(T,"placeholder",S("completedStatusPlaceholder")),c(d,"class","input-group fn__flex-1 svelte-1plhmm3"),c(P,"class","input-label svelte-1plhmm3"),c(N,"class","modern-input svelte-1plhmm3"),c(N,"type","text"),c(N,"placeholder",S("archivedStatusPlaceholder")),c(H,"class","input-group fn__flex-1 svelte-1plhmm3"),c(k,"class","fn__flex svelte-1plhmm3"),v(k,"gap","20px"),c(e,"class","card-content svelte-1plhmm3")},m(D,E){Z(D,e,E),i(e,n),i(n,l),i(n,s),i(n,o),X(o,t[74].name),i(e,a),i(e,u),i(u,f),i(u,_),i(u,g),X(g,t[74].keyword),i(e,m),i(e,k),i(k,d),i(d,b),i(d,y),i(d,T),X(T,t[74].completedStatus),i(k,M),i(k,H),i(H,P),i(H,C),i(H,N),X(N,t[74].archivedStatus),$||(I=[F(o,"input",x),F(o,"change",t[11]),F(g,"input",L),F(g,"change",t[11]),F(T,"input",K),F(T,"change",t[11]),F(N,"input",p),F(N,"change",t[11])],$=!0)},p(D,E){t=D,E[0]&2&&o.value!==t[74].name&&X(o,t[74].name),E[0]&2&&g.value!==t[74].keyword&&X(g,t[74].keyword),E[0]&2&&T.value!==t[74].completedStatus&&X(T,t[74].completedStatus),E[0]&2&&N.value!==t[74].archivedStatus&&X(N,t[74].archivedStatus)},d(D){D&&J(e),$=!1,Re(I)}}}function kn(t,e){let n,l,s,o,a,u,f=(e[74].name||S("unnamedRule"))+"",_,g,m,k,d,b,y,T,M,H,P,C,N,$,I=e[74].keyword&&vn(e);function x(){e[32].call(b,e[75],e[76])}function L(){return e[33](e[74])}function K(){return e[34](e[74])}let p=e[3]===e[74].id&&_n(e);return{key:t,first:null,c(){n=r("div"),l=r("div"),s=r("div"),s.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',o=w(),a=r("div"),u=r("span"),_=W(f),g=w(),I&&I.c(),m=w(),k=r("div"),d=r("label"),b=r("input"),y=w(),T=r("span"),T.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',H=w(),P=r("div"),P.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',C=w(),p&&p.c(),c(s,"class","chevron svelte-1plhmm3"),v(u,"font-weight","600"),v(u,"font-size","15px"),v(u,"color","var(--b3-theme-on-surface)"),c(a,"class","fn__flex-1 svelte-1plhmm3"),v(a,"margin-left","14px"),v(a,"display","flex"),v(a,"align-items","center"),c(b,"class","switch-input svelte-1plhmm3"),c(b,"type","checkbox"),c(T,"class","switch-track svelte-1plhmm3"),c(d,"class","switch-container svelte-1plhmm3"),c(d,"title",M=e[74].enabled?S("enabled"):S("disabled")),c(k,"class","fn__flex-center"),v(k,"margin-right","20px"),c(P,"class","icon-btn svelte-1plhmm3"),c(P,"title",S("deleteRule")),c(l,"class","card-header svelte-1plhmm3"),c(n,"class","card svelte-1plhmm3"),v(n,"opacity",e[74].enabled?1:.75),xe(n,"expanded",e[3]===e[74].id),this.first=n},m(D,E){Z(D,n,E),i(n,l),i(l,s),i(l,o),i(l,a),i(a,u),i(u,_),i(a,g),I&&I.m(a,null),i(l,m),i(l,k),i(k,d),i(d,b),b.checked=e[74].enabled,i(d,y),i(d,T),i(l,H),i(l,P),i(n,C),p&&p.m(n,null),N||($=[F(b,"change",x),F(b,"change",e[11]),F(k,"click",bt(e[26])),F(P,"click",bt(L)),F(l,"click",K)],N=!0)},p(D,E){e=D,E[0]&2&&f!==(f=(e[74].name||S("unnamedRule"))+"")&&Ke(_,f),e[74].keyword?I?I.p(e,E):(I=vn(e),I.c(),I.m(a,null)):I&&(I.d(1),I=null),E[0]&2&&(b.checked=e[74].enabled),E[0]&2&&M!==(M=e[74].enabled?S("enabled"):S("disabled"))&&c(d,"title",M),e[3]===e[74].id?p?p.p(e,E):(p=_n(e),p.c(),p.m(n,null)):p&&(p.d(1),p=null),E[0]&2&&v(n,"opacity",e[74].enabled?1:.75),E[0]&10&&xe(n,"expanded",e[3]===e[74].id)},d(D){D&&J(n),I&&I.d(),p&&p.d(),N=!1,Re($)}}}function bn(t){let e;return{c(){e=r("div"),e.textContent=`${S("noRulesTip")}`,v(e,"text-align","center"),v(e,"padding","48px"),v(e,"color","var(--b3-theme-on-surface-light)"),v(e,"border","2px dashed var(--b3-border-color)"),v(e,"border-radius","16px")},m(n,l){Z(n,e,l)},d(n){n&&J(e)}}}function wn(t){let e,n,l,s,o,a,u,f,_,g,m,k,d,b,y,T,M,H,P,C,N,$,I,x,L,K,p,D,E,U,j,Y,fe,ee,V,pe,ne,re,Pe,Ne,Ie,me,ge,Ue,Ae,Q,We,de,je,Ye,be,we,G=[],Xe=new Map,Oe,$e,le,ve,h;function A(){t[42].call(o,t[58],t[59])}function ie(){t[43].call(g,t[58],t[59])}let ye=ae(t[1]),ce=[];for(let O=0;O<ye.length;O+=1)ce[O]=yn(rn(t,ye,O));let ue=t[1].length===0&&Tn(),Be=ae(t[6]),te=[];for(let O=0;O<Be.length;O+=1)te[O]=Sn(cn(t,Be,O));function ct(){t[45].call(K,t[58],t[59])}function Ee(){t[46].call(Y,t[58],t[59])}function ze(){t[47].call(re,t[58],t[59])}function rt(){t[48].call(Q,t[58],t[59])}function dt(O,z){return(O[7][O[57].id]||[]).length===0?kl:_l}let Qe=dt(t),Te=Qe(t),Ge=ae(t[57].sections);const Ve=O=>O[60].id;for(let O=0;O<Ge.length;O+=1){let z=sn(t,Ge,O),R=Ve(z);Xe.set(R,G[O]=Cn(R,z))}function Ce(){return t[52](t[57])}return{c(){e=r("div"),n=r("div"),l=r("div"),l.textContent=`${S("templateNameLabel")}`,s=w(),o=r("input"),a=w(),u=r("div"),f=r("div"),f.textContent=`${S("templatePeriodLabel")}`,_=w(),g=r("select"),m=r("option"),m.textContent=`${S("templatePeriod_none")}`,k=r("option"),k.textContent=`${S("templatePeriod_day")}`,d=r("option"),d.textContent=`${S("templatePeriod_week")}`,b=r("option"),b.textContent=`${S("templatePeriod_month")}`,y=r("option"),y.textContent=`${S("templatePeriod_year")}`,T=w(),M=r("div"),H=r("div"),H.textContent=`${S("templateRuleLabel")}`,P=w(),C=r("div");for(let O=0;O<ce.length;O+=1)ce[O].c();N=w(),ue&&ue.c(),$=w(),I=r("div"),x=r("div"),x.textContent=`${S("templateNotebookLabel")}`,L=w(),K=r("select"),p=r("option"),p.textContent=`${S("templateNotebookAuto")}`;for(let O=0;O<te.length;O+=1)te[O].c();D=w(),E=r("div"),U=r("div"),U.textContent=`${S("templatePathLabel")}`,j=w(),Y=r("input"),fe=w(),ee=r("div"),V=r("div"),V.textContent=`${S("reportClipboardOnlySections")}`,pe=w(),ne=r("label"),re=r("input"),Pe=w(),Ne=r("span"),Ne.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',me=w(),ge=r("div"),Ue=r("div"),Ue.textContent=`${S("templateTitleLabel")}`,Ae=w(),Q=r("input"),We=w(),de=r("div"),je=r("div"),je.textContent=`${S("templateSectionList")}`,Ye=w(),be=r("div"),Te.c(),we=w();for(let O=0;O<G.length;O+=1)G[O].c();Oe=w(),$e=r("div"),le=r("button"),le.textContent=`${S("templateSectionAdd")}`,c(l,"class","input-label svelte-1plhmm3"),c(o,"class","modern-input svelte-1plhmm3"),c(o,"type","text"),c(n,"class","input-group svelte-1plhmm3"),c(f,"class","input-label svelte-1plhmm3"),m.__value="none",X(m,m.__value),k.__value="day",X(k,k.__value),d.__value="week",X(d,d.__value),b.__value="month",X(b,b.__value),y.__value="year",X(y,y.__value),c(g,"class","modern-input svelte-1plhmm3"),t[57].period===void 0&&mt(ie),c(u,"class","input-group svelte-1plhmm3"),c(H,"class","input-label svelte-1plhmm3"),c(C,"class","fn__flex svelte-1plhmm3"),v(C,"flex-wrap","wrap"),v(C,"gap","12px"),c(M,"class","input-group svelte-1plhmm3"),c(x,"class","input-label svelte-1plhmm3"),p.__value="",X(p,p.__value),c(K,"class","modern-input svelte-1plhmm3"),t[57].notebookId===void 0&&mt(ct),c(I,"class","input-group svelte-1plhmm3"),c(U,"class","input-label svelte-1plhmm3"),c(Y,"class","modern-input svelte-1plhmm3"),c(Y,"type","text"),c(Y,"placeholder",S("templatePathPlaceholder")),c(E,"class","input-group svelte-1plhmm3"),c(V,"class","input-label svelte-1plhmm3"),c(re,"class","switch-input svelte-1plhmm3"),c(re,"type","checkbox"),c(Ne,"class","switch-track svelte-1plhmm3"),c(ne,"class","switch-container svelte-1plhmm3"),c(ne,"title",Ie=t[57].clipboardOnlySections?S("enabled"):S("disabled")),c(ee,"class","input-group svelte-1plhmm3"),c(Ue,"class","input-label svelte-1plhmm3"),c(Q,"class","modern-input svelte-1plhmm3"),c(Q,"type","text"),c(Q,"placeholder",S("templateTitlePlaceholder")),c(ge,"class","input-group svelte-1plhmm3"),c(je,"class","input-label svelte-1plhmm3"),c(be,"class","fn__flex svelte-1plhmm3"),v(be,"flex-wrap","wrap"),v(be,"gap","8px"),v(be,"margin-bottom","8px"),c(le,"class","action-btn svelte-1plhmm3"),v(le,"width","132px"),v(le,"justify-content","center"),c($e,"class","fn__flex svelte-1plhmm3"),v($e,"justify-content","flex-start"),c(de,"class","input-group svelte-1plhmm3"),c(e,"class","card-content svelte-1plhmm3")},m(O,z){Z(O,e,z),i(e,n),i(n,l),i(n,s),i(n,o),X(o,t[57].name),i(e,a),i(e,u),i(u,f),i(u,_),i(u,g),i(g,m),i(g,k),i(g,d),i(g,b),i(g,y),_t(g,t[57].period,!0),i(e,T),i(e,M),i(M,H),i(M,P),i(M,C);for(let R=0;R<ce.length;R+=1)ce[R]&&ce[R].m(C,null);i(C,N),ue&&ue.m(C,null),i(e,$),i(e,I),i(I,x),i(I,L),i(I,K),i(K,p);for(let R=0;R<te.length;R+=1)te[R]&&te[R].m(K,null);_t(K,t[57].notebookId,!0),i(e,D),i(e,E),i(E,U),i(E,j),i(E,Y),X(Y,t[57].pathTemplate),i(e,fe),i(e,ee),i(ee,V),i(ee,pe),i(ee,ne),i(ne,re),re.checked=t[57].clipboardOnlySections,i(ne,Pe),i(ne,Ne),i(e,me),i(e,ge),i(ge,Ue),i(ge,Ae),i(ge,Q),X(Q,t[57].titleTemplate),i(e,We),i(e,de),i(de,je),i(de,Ye),i(de,be),Te.m(be,null),i(de,we);for(let R=0;R<G.length;R+=1)G[R]&&G[R].m(de,null);i(de,Oe),i(de,$e),i($e,le),ve||(h=[F(o,"input",A),F(o,"change",t[11]),F(g,"change",ie),F(g,"change",t[11]),F(K,"change",ct),F(K,"change",t[11]),F(Y,"input",Ee),F(Y,"change",t[11]),F(re,"change",ze),F(re,"change",t[11]),F(Q,"input",rt),F(Q,"change",t[11]),F(le,"click",Ce)],ve=!0)},p(O,z){if(t=O,z[0]&16&&o.value!==t[57].name&&X(o,t[57].name),z[0]&16&&_t(g,t[57].period),z[0]&4194322){ye=ae(t[1]);let R;for(R=0;R<ye.length;R+=1){const se=rn(t,ye,R);ce[R]?ce[R].p(se,z):(ce[R]=yn(se),ce[R].c(),ce[R].m(C,N))}for(;R<ce.length;R+=1)ce[R].d(1);ce.length=ye.length}if(t[1].length===0?ue||(ue=Tn(),ue.c(),ue.m(C,null)):ue&&(ue.d(1),ue=null),z[0]&64){Be=ae(t[6]);let R;for(R=0;R<Be.length;R+=1){const se=cn(t,Be,R);te[R]?te[R].p(se,z):(te[R]=Sn(se),te[R].c(),te[R].m(K,null))}for(;R<te.length;R+=1)te[R].d(1);te.length=Be.length}z[0]&16&&_t(K,t[57].notebookId),z[0]&16&&Y.value!==t[57].pathTemplate&&X(Y,t[57].pathTemplate),z[0]&16&&(re.checked=t[57].clipboardOnlySections),z[0]&16&&Ie!==(Ie=t[57].clipboardOnlySections?S("enabled"):S("disabled"))&&c(ne,"title",Ie),z[0]&16&&Q.value!==t[57].titleTemplate&&X(Q,t[57].titleTemplate),Qe===(Qe=dt(t))&&Te?Te.p(t,z):(Te.d(1),Te=Qe(t),Te&&(Te.c(),Te.m(be,null))),z[0]&50333840&&(Ge=ae(t[57].sections),G=Rt(G,z,Ve,1,t,Ge,Xe,de,Mt,Cn,Oe,sn))},d(O){O&&J(e),at(ce,O),ue&&ue.d(),at(te,O),Te.d();for(let z=0;z<G.length;z+=1)G[z].d();ve=!1,Re(h)}}}function yn(t){let e,n,l,s,o,a=(t[71].name||t[71].keyword||t[71].id)+"",u,f,_;function g(){return t[44](t[57],t[71])}return{c(){var m;e=r("label"),n=r("input"),s=w(),o=r("span"),u=W(a),c(n,"type","checkbox"),n.checked=l=(m=t[57].ruleIds)==null?void 0:m.includes(t[71].id),v(o,"font-size","13px"),c(e,"class","fn__flex svelte-1plhmm3"),v(e,"align-items","center"),v(e,"gap","6px"),v(e,"padding","6px 10px"),v(e,"border","1px solid var(--b3-border-color)"),v(e,"border-radius","999px"),v(e,"background","var(--b3-theme-background)")},m(m,k){Z(m,e,k),i(e,n),i(e,s),i(e,o),i(o,u),f||(_=F(n,"change",g),f=!0)},p(m,k){var d;t=m,k[0]&18&&l!==(l=(d=t[57].ruleIds)==null?void 0:d.includes(t[71].id))&&(n.checked=l),k[0]&2&&a!==(a=(t[71].name||t[71].keyword||t[71].id)+"")&&Ke(u,a)},d(m){m&&J(e),f=!1,_()}}}function Tn(t){let e;return{c(){e=r("div"),e.textContent=`${S("reportNoProfileTip")}`,v(e,"font-size","13px"),v(e,"color","var(--b3-theme-on-surface-light)")},m(n,l){Z(n,e,l)},d(n){n&&J(e)}}}function Sn(t){let e,n=t[68].name+"",l,s;return{c(){e=r("option"),l=W(n),e.__value=s=t[68].id,X(e,e.__value)},m(o,a){Z(o,e,a),i(e,l)},p(o,a){a[0]&64&&n!==(n=o[68].name+"")&&Ke(l,n),a[0]&64&&s!==(s=o[68].id)&&(e.__value=s,X(e,e.__value))},d(o){o&&J(e)}}}function _l(t){let e,n=ae(t[7][t[57].id]),l=[];for(let s=0;s<n.length;s+=1)l[s]=In(an(t,n,s));return{c(){for(let s=0;s<l.length;s+=1)l[s].c();e=nl()},m(s,o){for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(s,o);Z(s,e,o)},p(s,o){if(o[0]&144){n=ae(s[7][s[57].id]);let a;for(a=0;a<n.length;a+=1){const u=an(s,n,a);l[a]?l[a].p(u,o):(l[a]=In(u),l[a].c(),l[a].m(e.parentNode,e))}for(;a<l.length;a+=1)l[a].d(1);l.length=n.length}},d(s){s&&J(e),at(l,s)}}}function kl(t){let e;return{c(){e=r("div"),e.textContent=`${S("templateStatusEmpty")}`,v(e,"font-size","13px"),v(e,"color","var(--b3-theme-on-surface-light)")},m(n,l){Z(n,e,l)},p:Je,d(n){n&&J(e)}}}function In(t){let e,n=t[63]+"",l;return{c(){e=r("span"),l=W(n),c(e,"class","tag-preview svelte-1plhmm3")},m(s,o){Z(s,e,o),i(e,l)},p(s,o){o[0]&144&&n!==(n=s[63]+"")&&Ke(l,n)},d(s){s&&J(e)}}}function An(t){let e,n,l,s,o,a=t[63]+"",u,f,_,g;function m(){return t[50](t[60],t[63])}return{c(){e=r("label"),n=r("input"),s=w(),o=r("span"),u=W(a),f=w(),c(n,"class","dot-check svelte-1plhmm3"),c(n,"type","checkbox"),n.checked=l=(t[60].statuses||[]).includes(t[63]),v(o,"font-size","12px"),c(e,"class","fn__flex status-dot svelte-1plhmm3"),v(e,"align-items","center"),v(e,"gap","6px"),v(e,"padding","4px 8px"),v(e,"border","1px solid var(--b3-border-color)"),v(e,"border-radius","999px"),v(e,"background","var(--b3-theme-background)")},m(k,d){Z(k,e,d),i(e,n),i(e,s),i(e,o),i(o,u),i(e,f),_||(g=F(n,"change",m),_=!0)},p(k,d){t=k,d[0]&144&&l!==(l=(t[60].statuses||[]).includes(t[63]))&&(n.checked=l),d[0]&144&&a!==(a=t[63]+"")&&Ke(u,a)},d(k){k&&J(e),_=!1,g()}}}function Cn(t,e){let n,l,s,o,a,u,f,_,g,m,k,d,b,y,T,M;function H(){e[49].call(u,e[61],e[62])}let P=ae(e[7][e[57].id]||[]),C=[];for(let $=0;$<P.length;$+=1)C[$]=An(on(e,P,$));function N(){return e[51](e[57],e[60])}return{key:t,first:null,c(){n=r("div"),l=r("div"),s=r("div"),o=r("div"),o.textContent=`${S("templateSectionTitleLabel")}`,a=w(),u=r("input"),f=w(),_=r("div"),g=r("div"),g.textContent=`${S("templateSectionStatusLabel")}`,m=w(),k=r("div");for(let $=0;$<C.length;$+=1)C[$].c();d=w(),b=r("div"),y=r("div"),y.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',c(o,"class","input-label svelte-1plhmm3"),c(u,"class","modern-input svelte-1plhmm3"),c(u,"type","text"),c(s,"class","input-group svelte-1plhmm3"),c(g,"class","input-label svelte-1plhmm3"),c(k,"class","fn__flex svelte-1plhmm3"),v(k,"flex-wrap","wrap"),v(k,"gap","10px"),c(_,"class","input-group svelte-1plhmm3"),c(y,"class","icon-btn svelte-1plhmm3"),c(y,"title",S("templateSectionDelete")),c(b,"class","fn__flex svelte-1plhmm3"),v(b,"justify-content","flex-end"),c(l,"class","card-content svelte-1plhmm3"),c(n,"class","card svelte-1plhmm3"),v(n,"margin-bottom","12px"),this.first=n},m($,I){Z($,n,I),i(n,l),i(l,s),i(s,o),i(s,a),i(s,u),X(u,e[60].title),i(l,f),i(l,_),i(_,g),i(_,m),i(_,k);for(let x=0;x<C.length;x+=1)C[x]&&C[x].m(k,null);i(l,d),i(l,b),i(b,y),T||(M=[F(u,"input",H),F(u,"change",e[11]),F(y,"click",N)],T=!0)},p($,I){if(e=$,I[0]&16&&u.value!==e[60].title&&X(u,e[60].title),I[0]&33554576){P=ae(e[7][e[57].id]||[]);let x;for(x=0;x<P.length;x+=1){const L=on(e,P,x);C[x]?C[x].p(L,I):(C[x]=An(L),C[x].c(),C[x].m(k,null))}for(;x<C.length;x+=1)C[x].d(1);C.length=P.length}},d($){$&&J(n),at(C,$),T=!1,Re(M)}}}function Dn(t,e){let n,l,s,o,a,u,f=e[57].name+"",_,g,m,k=S(`templatePeriod_${e[57].period||"none"}`)+"",d,b,y,T,M,H,P,C,N;function $(){return e[39](e[57])}function I(){return e[40](e[57])}function x(){return e[41](e[57])}let L=e[5]===e[57].id&&wn(e);return{key:t,first:null,c(){n=r("div"),l=r("div"),s=r("div"),s.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',o=w(),a=r("div"),u=r("span"),_=W(f),g=w(),m=r("span"),d=W(k),b=w(),y=r("button"),y.textContent=`${S("templateGenerate")}`,T=w(),M=r("div"),M.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',H=w(),L&&L.c(),P=w(),c(s,"class","chevron svelte-1plhmm3"),v(u,"font-weight","600"),v(u,"font-size","15px"),v(u,"color","var(--b3-theme-on-surface)"),c(m,"class","tag-preview svelte-1plhmm3"),c(a,"class","fn__flex-1 svelte-1plhmm3"),v(a,"margin-left","14px"),v(a,"display","flex"),v(a,"align-items","center"),c(y,"class","action-btn svelte-1plhmm3"),v(y,"height","28px"),v(y,"padding","0 12px"),v(y,"margin-right","8px"),c(M,"class","icon-btn svelte-1plhmm3"),c(M,"title",S("deleteRule")),c(l,"class","card-header svelte-1plhmm3"),c(n,"class","card svelte-1plhmm3"),xe(n,"expanded",e[5]===e[57].id),this.first=n},m(K,p){Z(K,n,p),i(n,l),i(l,s),i(l,o),i(l,a),i(a,u),i(u,_),i(a,g),i(a,m),i(m,d),i(l,b),i(l,y),i(l,T),i(l,M),i(n,H),L&&L.m(n,null),i(n,P),C||(N=[F(y,"click",bt($)),F(M,"click",bt(I)),F(l,"click",x)],C=!0)},p(K,p){e=K,p[0]&16&&f!==(f=e[57].name+"")&&Ke(_,f),p[0]&16&&k!==(k=S(`templatePeriod_${e[57].period||"none"}`)+"")&&Ke(d,k),e[5]===e[57].id?L?L.p(e,p):(L=wn(e),L.c(),L.m(n,P)):L&&(L.d(1),L=null),p[0]&48&&xe(n,"expanded",e[5]===e[57].id)},d(K){K&&J(n),L&&L.d(),C=!1,Re(N)}}}function bl(t){let e,n,l,s,o,a,u,f=S("globalArchiveTime")+"",_,g,m,k,d,b,y,T,M=S("undoArchive")+"",H,P,C,N,$,I,x=S("archiveNow")+"",L,K,p,D,E,U,j,Y,fe,ee,V,pe,ne,re,Pe,Ne=S("archiveRuleList")+"",Ie,me,ge,Ue,Ae,Q,We,de,je=S("addRule")+"",Ye,be,we,G=[],Xe=new Map,Oe,$e,le,ve,h,A,ie,ye,ce=S("templateListTitle")+"",ue,Be,te,ct,Ee,ze,rt,dt,Qe=S("templateAdd")+"",Te,Ge,Ve,Ce=[],O=new Map,z,R,se,ut,yt,Pt,Bn=S("usageTipTitle")+"",Ut,Ot,Le,Ze,Tt,Bt,Fn=S("usageTipGlobalDesc")+"",Ft,Ht,et,St,Kt,Hn=S("usageTipMatchDesc")+"",Wt,jt,tt,It,zt,Kn=S("usageTipStatusDesc")+"",Vt,qt,nt,At,Yt,Wn=S("usageTipReportDesc")+"",Xt,Ct,Gt,_e=t[8]&&hn(t),ke=t[8]&&pn(t),gt=ae(t[1]);const Jt=B=>B[74].id;for(let B=0;B<gt.length;B+=1){let q=dn(t,gt,B),he=Jt(q);Xe.set(he,G[B]=kn(he,q))}let Se=t[1].length===0&&bn(),vt=ae(t[4]);const Qt=B=>B[57].id;for(let B=0;B<vt.length;B+=1){let q=ln(t,vt,B),he=Qt(q);O.set(he,Ce[B]=Dn(he,q))}return{c(){_e&&_e.c(),e=w(),n=r("div"),l=r("div"),s=r("div"),o=oe("svg"),a=oe("use"),u=w(),_=W(f),g=w(),m=r("div"),k=w(),d=r("button"),b=oe("svg"),y=oe("use"),T=w(),H=W(M),P=w(),C=r("button"),N=oe("svg"),$=oe("use"),I=w(),L=W(x),K=w(),p=r("div"),D=W(t[2]),E=w(),U=oe("svg"),j=oe("use"),Y=w(),ke&&ke.c(),fe=w(),ee=r("div"),V=r("div"),pe=r("div"),ne=oe("svg"),re=oe("use"),Pe=w(),Ie=W(Ne),me=w(),ge=r("div"),Ue=w(),Ae=r("button"),Q=oe("svg"),We=oe("use"),de=w(),Ye=W(je),be=w(),we=r("div");for(let B=0;B<G.length;B+=1)G[B].c();Oe=w(),Se&&Se.c(),$e=w(),le=r("div"),ve=r("div"),h=r("div"),A=oe("svg"),ie=oe("use"),ye=w(),ue=W(ce),Be=w(),te=r("div"),ct=w(),Ee=r("button"),ze=oe("svg"),rt=oe("use"),dt=w(),Te=W(Qe),Ge=w(),Ve=r("div");for(let B=0;B<Ce.length;B+=1)Ce[B].c();z=w(),R=r("div"),se=r("div"),ut=oe("svg"),yt=oe("use"),Pt=w(),Ut=W(Bn),Ot=w(),Le=r("ul"),Ze=r("li"),Tt=r("strong"),Tt.textContent=`${S("usageTipGlobal")}`,Bt=W("："),Ft=W(Fn),Ht=w(),et=r("li"),St=r("strong"),St.textContent=`${S("usageTipMatch")}`,Kt=W("："),Wt=W(Hn),jt=w(),tt=r("li"),It=r("strong"),It.textContent=`${S("usageTipStatus")}`,zt=W("："),Vt=W(Kn),qt=w(),nt=r("li"),At=r("strong"),At.textContent=`${S("usageTipReport")}`,Yt=W("："),Xt=W(Wn),He(a,"xlink:href","#iconCalendar"),v(o,"width","18px"),v(o,"height","18px"),c(s,"class","section-title svelte-1plhmm3"),c(m,"class","fn__flex-1 svelte-1plhmm3"),He(y,"xlink:href","#iconUndo"),v(b,"width","14px"),v(b,"height","14px"),c(b,"class","svelte-1plhmm3"),c(d,"class","action-btn svelte-1plhmm3"),v(d,"background-color","transparent"),v(d,"color","var(--b3-theme-on-surface)"),v(d,"box-shadow","none"),v(d,"border","1px solid var(--b3-theme-surface-lighter)"),v(d,"margin-right","12px"),He($,"xlink:href","#iconFiles"),v(N,"width","14px"),v(N,"height","14px"),c(N,"class","svelte-1plhmm3"),c(C,"class","action-btn svelte-1plhmm3"),v(C,"margin-right","32px"),He(j,"xlink:href","#iconClock"),v(U,"width","14px"),v(U,"height","14px"),v(U,"opacity","0.6"),c(p,"class","time-trigger svelte-1plhmm3"),xe(p,"active",t[8]),c(l,"class","section-header svelte-1plhmm3"),He(re,"xlink:href","#iconSettings"),v(ne,"width","18px"),v(ne,"height","18px"),c(pe,"class","section-title svelte-1plhmm3"),c(ge,"class","fn__flex-1 svelte-1plhmm3"),He(We,"xlink:href","#iconAdd"),v(Q,"width","14px"),v(Q,"height","14px"),c(Q,"class","svelte-1plhmm3"),c(Ae,"class","action-btn svelte-1plhmm3"),c(V,"class","section-header svelte-1plhmm3"),c(we,"class","profile-container svelte-1plhmm3"),v(ee,"margin-top","20px"),v(ee,"display","flex"),v(ee,"flex-direction","column"),He(ie,"xlink:href","#iconCalendar"),v(A,"width","18px"),v(A,"height","18px"),c(h,"class","section-title svelte-1plhmm3"),c(te,"class","fn__flex-1 svelte-1plhmm3"),He(rt,"xlink:href","#iconAdd"),v(ze,"width","14px"),v(ze,"height","14px"),c(ze,"class","svelte-1plhmm3"),c(Ee,"class","action-btn svelte-1plhmm3"),v(Ee,"width","132px"),v(Ee,"justify-content","center"),c(ve,"class","section-header svelte-1plhmm3"),c(Ve,"class","profile-container svelte-1plhmm3"),v(le,"margin-top","24px"),v(le,"display","flex"),v(le,"flex-direction","column"),He(yt,"xlink:href","#iconInfo"),v(ut,"width","16px"),v(ut,"height","16px"),v(se,"font-weight","700"),v(se,"color","var(--b3-theme-primary)"),v(se,"display","flex"),v(se,"align-items","center"),v(se,"gap","8px"),v(se,"margin-bottom","8px"),v(se,"font-size","14px"),c(Ze,"class","svelte-1plhmm3"),c(et,"class","svelte-1plhmm3"),c(tt,"class","svelte-1plhmm3"),c(nt,"class","svelte-1plhmm3"),c(Le,"class","svelte-1plhmm3"),c(R,"class","info-footer svelte-1plhmm3"),c(n,"class","settings-container svelte-1plhmm3")},m(B,q){_e&&_e.m(B,q),Z(B,e,q),Z(B,n,q),i(n,l),i(l,s),i(s,o),i(o,a),i(s,u),i(s,_),i(l,g),i(l,m),i(l,k),i(l,d),i(d,b),i(b,y),i(d,T),i(d,H),i(l,P),i(l,C),i(C,N),i(N,$),i(C,I),i(C,L),i(l,K),i(l,p),i(p,D),i(p,E),i(p,U),i(U,j),i(l,Y),ke&&ke.m(l,null),i(n,fe),i(n,ee),i(ee,V),i(V,pe),i(pe,ne),i(ne,re),i(pe,Pe),i(pe,Ie),i(V,me),i(V,ge),i(V,Ue),i(V,Ae),i(Ae,Q),i(Q,We),i(Ae,de),i(Ae,Ye),i(ee,be),i(ee,we);for(let he=0;he<G.length;he+=1)G[he]&&G[he].m(we,null);i(we,Oe),Se&&Se.m(we,null),i(n,$e),i(n,le),i(le,ve),i(ve,h),i(h,A),i(A,ie),i(h,ye),i(h,ue),i(ve,Be),i(ve,te),i(ve,ct),i(ve,Ee),i(Ee,ze),i(ze,rt),i(Ee,dt),i(Ee,Te),i(le,Ge),i(le,Ve);for(let he=0;he<Ce.length;he+=1)Ce[he]&&Ce[he].m(Ve,null);i(n,z),i(n,R),i(R,se),i(se,ut),i(ut,yt),i(se,Pt),i(se,Ut),i(R,Ot),i(R,Le),i(Le,Ze),i(Ze,Tt),i(Ze,Bt),i(Ze,Ft),i(Le,Ht),i(Le,et),i(et,St),i(et,Kt),i(et,Wt),i(Le,jt),i(Le,tt),i(tt,It),i(tt,zt),i(tt,Vt),i(Le,qt),i(Le,nt),i(nt,At),i(nt,Yt),i(nt,Xt),Ct||(Gt=[F(d,"click",t[28]),F(C,"click",t[29]),F(p,"click",t[17]),F(Ae,"click",t[12]),F(Ee,"click",t[19])],Ct=!0)},p(B,q){B[8]?_e?_e.p(B,q):(_e=hn(B),_e.c(),_e.m(e.parentNode,e)):_e&&(_e.d(1),_e=null),q[0]&4&&Ke(D,B[2]),q[0]&256&&xe(p,"active",B[8]),B[8]?ke?ke.p(B,q):(ke=pn(B),ke.c(),ke.m(l,null)):ke&&(ke.d(1),ke=null),q[0]&26634&&(gt=ae(B[1]),G=Rt(G,q,Jt,1,B,gt,Xe,we,Mt,kn,Oe,dn)),B[1].length===0?Se||(Se=bn(),Se.c(),Se.m(we,null)):Se&&(Se.d(1),Se=null),q[0]&66324722&&(vt=ae(B[4]),Ce=Rt(Ce,q,Qt,1,B,vt,O,Ve,Mt,Dn,null,ln))},i:Je,o:Je,d(B){B&&(J(e),J(n)),_e&&_e.d(B),ke&&ke.d();for(let q=0;q<G.length;q+=1)G[q].d();Se&&Se.d();for(let q=0;q<Ce.length;q+=1)Ce[q].d();Ct=!1,Re(Gt)}}}function it(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0,n=t=="x"?e:e&3|8;return n.toString(16)})}function Nn(t,e){const n=`time-opt-${t}-${e}`,l=document.getElementById(n);l&&l.scrollIntoView({block:"center",behavior:"smooth"})}function wl(t,e,n){let{plugin:l}=e,s=[],o="00:00",a=null,u=[],f=null,_=[],g={},m=!1;const k=Array.from({length:24},(h,A)=>A.toString().padStart(2,"0")),d=Array.from({length:60},(h,A)=>A.toString().padStart(2,"0"));sl(()=>{b(),l.config.profiles&&l.config.profiles.length===1&&n(3,a=l.config.profiles[0].id),I()});function b(){n(1,s=l.config.profiles||[]),n(2,o=l.config.archiveTime||"00:00"),n(4,u=l.config.templates||[])}async function y(){n(0,l.config.archiveTime=o,l),n(0,l.config.templates=u,l),l.saveData("config.json",l.config),b()}function T(){l.config.profiles||n(0,l.config.profiles=[],l);const h={id:it(),name:S("defaultNewRuleName")+" "+(l.config.profiles.length+1),keyword:"",completedStatus:S("defaultCompleted"),archivedStatus:S("defaultArchived"),enabled:!0};n(0,l.config.profiles=[...l.config.profiles,h],l),y(),n(3,a=h.id),setTimeout(()=>{const A=document.querySelector(".profile-container");A&&(A.scrollTop=A.scrollHeight)},50)}function M(h){n(0,l.config.profiles=l.config.profiles.filter(A=>A.id!==h),l),y(),a===h&&n(3,a=null)}function H(h){a===h?n(3,a=null):n(3,a=h)}function P(h){const A=o.split(":");n(2,o=`${h}:${A[1]||"00"}`),y()}function C(h){const A=o.split(":");n(2,o=`${A[0]||"00"}:${h}`),y()}function N(){n(8,m=!m),m&&setTimeout(()=>{const[h,A]=o.split(":");Nn("h",h),Nn("m",A)},10)}function $(h){l.generateTemplate&&l.generateTemplate(h)}async function I(){if(!l.getNotebooks)return;const h=await l.getNotebooks();n(6,_=(h==null?void 0:h.notebooks)||[])}function x(){const h={id:it(),name:S("templateNewName"),period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:S("templateTitleDefault"),sections:[{id:it(),title:S("templateSectionTodo"),statuses:[]},{id:it(),title:S("templateSectionDoing"),statuses:[]},{id:it(),title:S("templateSectionDone"),statuses:[]}]};n(4,u=[...u,h]),y(),n(5,f=h.id)}function L(h){n(4,u=u.filter(A=>A.id!==h)),y(),f===h&&n(5,f=null)}function K(h){if(f===h)n(5,f=null);else{n(5,f=h);const A=u.find(ie=>ie.id===h);A&&D(A)}}function p(h,A){const ie=h.ruleIds||[];h.ruleIds=ie.includes(A)?ie.filter(ye=>ye!==A):[...ie,A],y(),D(h)}async function D(h){l.getStatusOptions&&n(7,g[h.id]=await l.getStatusOptions(h.ruleIds||[]),g)}function E(h){h.sections=[...h.sections||[],{id:it(),title:S("templateSectionNew"),statuses:[]}],y()}function U(h,A){h.sections=(h.sections||[]).filter(ie=>ie.id!==A),y()}function j(h,A){const ie=h.statuses||[];h.statuses=ie.includes(A)?ie.filter(ye=>ye!==A):[...ie,A],y()}function Y(h){ol.call(this,t,h)}const fe=()=>n(8,m=!1),ee=()=>l.undoArchiveNow(),V=()=>l.archiveNow(),pe=h=>P(h),ne=h=>C(h);function re(h,A){h[A].enabled=this.checked,n(1,s)}const Pe=h=>M(h.id),Ne=h=>H(h.id);function Ie(h,A){h[A].name=this.value,n(1,s)}function me(h,A){h[A].keyword=this.value,n(1,s)}function ge(h,A){h[A].completedStatus=this.value,n(1,s)}function Ue(h,A){h[A].archivedStatus=this.value,n(1,s)}const Ae=h=>$(h.id),Q=h=>L(h.id),We=h=>K(h.id);function de(h,A){h[A].name=this.value,n(4,u)}function je(h,A){h[A].period=en(this),n(4,u)}const Ye=(h,A)=>p(h,A.id);function be(h,A){h[A].notebookId=en(this),n(4,u)}function we(h,A){h[A].pathTemplate=this.value,n(4,u)}function G(h,A){h[A].clipboardOnlySections=this.checked,n(4,u)}function Xe(h,A){h[A].titleTemplate=this.value,n(4,u)}function Oe(h,A){h[A].title=this.value,n(4,u)}const $e=(h,A)=>j(h,A),le=(h,A)=>U(h,A.id),ve=h=>E(h);return t.$$set=h=>{"plugin"in h&&n(0,l=h.plugin)},[l,s,o,a,u,f,_,g,m,k,d,y,T,M,H,P,C,N,$,x,L,K,p,E,U,j,Y,fe,ee,V,pe,ne,re,Pe,Ne,Ie,me,ge,Ue,Ae,Q,We,de,je,Ye,be,we,G,Xe,Oe,$e,le,ve]}class yl extends gl{constructor(e){super(),ml(this,e,wl,bl,el,{plugin:0},null,[-1,-1,-1])}}function $t(t){var e,n,l,s,o;if(!t)return"";if(typeof t=="string")return t;if(typeof t=="number")return t.toString();if(t.content!==void 0)return t.content;if(((e=t.text)==null?void 0:e.content)!==void 0)return t.text.content;if(((n=t.block)==null?void 0:n.content)!==void 0)return t.block.content;if(((l=t.date)==null?void 0:l.content)!==void 0)return t.date.content;if(((s=t.mSelect)==null?void 0:s.length)>0)return t.mSelect.map(a=>a.content).join(", ");if(((o=t.select)==null?void 0:o.content)!==void 0)return t.select.content;for(const a in t)if(typeof t[a]=="object"&&t[a]!==null){const u=$t(t[a]);if(u)return u}return""}function Tl(t){if(!t)return 0;const e=String(t).trim();if(e.match(/^\d{4}-\d{2}-\d{2}/))return new Date(e.substring(0,10).replace(/-/g,"/")+" 00:00:00").getTime();if(e.length===14&&/^\d+$/.test(e))return new Date(e.substring(0,4),parseInt(e.substring(4,6),10)-1,e.substring(6,8),e.substring(8,10),e.substring(10,12),e.substring(12,14)).getTime();const n=parseInt(e,10);return e.length===10?n*1e3:n}function En(t){const e=Tl(t);if(e&&!Number.isNaN(e))return e;const n=Date.parse(t);return Number.isNaN(n)?0:n}function Lt(t){let e=[];if(!t||typeof t!="object")return e;t.id&&(Array.isArray(t.cells)||Array.isArray(t.values))&&e.push(t);for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Array.isArray(t[n])?t[n].forEach(l=>e=e.concat(Lt(l))):typeof t[n]=="object"&&!["columns","fields","keyValues"].includes(n)&&(e=e.concat(Lt(t[n]))));return e}function Sl(t){const e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()));return e.setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7)),Math.ceil(((e.getTime()-new Date(Date.UTC(e.getUTCFullYear(),0,1)).getTime())/864e5+1)/7)}function Un(t){return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`}function On(t=""){return t.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F1E6}-\u{1F1FF}]/gu,"")}function Il(t=""){return t.replace(/^###\s+/gm,"").replace(/^####\s+/gm,"").replace(/^#####\s+/gm,"").replace(/^\*\s\[\s\]\s/gm,"• ").replace(/^\*\s\[x\]\s/gi,"• ").trim()}function Al(t=""){const e=t.split(`
`);let n="",l=!1;const s=()=>{l&&(n+="</ul>",l=!1)};for(const o of e){if(/^###\s+/.test(o)){s(),n+=`<h3>${o.replace(/^###\s+/,"")}</h3>`;continue}if(/^####\s+/.test(o)){s(),n+=`<h4>${o.replace(/^####\s+/,"")}</h4>`;continue}if(/^#####\s+/.test(o)){s(),n+=`<h5>${o.replace(/^#####\s+/,"")}</h5>`;continue}const a=o.match(/^\*\s\[x\]\s(.+)/i),u=o.match(/^\*\s\[\s\]\s(.+)/);if(a||u){l||(n+="<ul>",l=!0);const f=a?a[1]:u[1];n+=`<li><input type="checkbox"${!!a?" checked":""} disabled /> <span>${f}</span></li>`;continue}if(o.trim()===""){s();continue}s(),n+=`<p>${o}</p>`}return s(),`<div>${n}</div>`}function Cl(t,e){return e?t.split(`
`).filter(s=>!/^###\s/.test(s)&&!/^####\s/.test(s)).join(`
`).replace(/\n{3,}/g,`

`).trim():t}async function Dl(t,e,n){var a;const l=On(Cl(n,e.clipboardOnlySections)),s=Il(l),o=Al(l);try{typeof ClipboardItem<"u"&&((a=navigator.clipboard)!=null&&a.write)?await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([o],{type:"text/html"}),"text/plain":new Blob([s],{type:"text/plain"})})]):await navigator.clipboard.writeText(s);const f=(t.i18n||{}).reportCopied||"内容已复制到剪切板";wt(f)}catch(u){console.error("Copy to clipboard failed:",u)}}function Nl(t,e){const n=new Date(t);return e==="day"?(n.setHours(0,0,0,0),n.getTime()):e==="week"?(n.setDate(n.getDate()-(n.getDay()||7)+1),n.setHours(0,0,0,0),n.getTime()):e==="month"?(n.setDate(1),n.setHours(0,0,0,0),n.getTime()):e==="year"?(n.setMonth(0,1),n.setHours(0,0,0,0),n.getTime()):0}function El(t,e){const n=e.getFullYear(),l=(e.getMonth()+1).toString().padStart(2,"0"),s=Sl(e).toString().padStart(2,"0"),o=Un(e),a=t.period||"none";let u=`/日常记录/${n}/${l}/${o}`;return a==="week"?u=`/周报/${n}/${n}-W${s}`:a==="month"?u=`/月报/${n}/${n}-${l}`:a==="year"&&(u=`/年报/${n}`),t.pathTemplate?t.pathTemplate.replace("{YYYY}",String(n)).replace("{MM}",l).replace("{date}",o).replace("{WW}",s):u}async function Ml(t,e,n,l,s,o){var b,y;const a=El(e,n);let u=await De(`SELECT id FROM blocks WHERE (hpath = '${a}' OR hpath = '${a.substring(1)}') AND type='d' LIMIT 1`),f=u&&u.length>0?u[0].id:"";if(!f){const T=await Mn(),M=e.notebookId||((y=(b=T==null?void 0:T.notebooks)==null?void 0:b[0])==null?void 0:y.id);if(!M){qe("未找到可用笔记本，请在设置中选择目标笔记本");return}f=await Vn(M,a+".sy",""),await new Promise(H=>setTimeout(H,600))}const _=[],g=await De(`SELECT id FROM blocks WHERE memo = '${s}' AND root_id = '${f}'`);g&&_.push(...g);const m=await De(`SELECT id, parent_id, content FROM blocks WHERE root_id = '${f}' AND content LIKE '%${o}%' AND type='h'`);if(m&&m.length>0){const M=await De(`SELECT id, content, type FROM blocks WHERE root_id = '${f}' ORDER BY sort ASC`)||[],H=new Map(M.map((P,C)=>[P.id,C]));for(const P of m){const C=H.has(P.id)?H.get(P.id):-1;if(C!==-1)for(let N=C;N<M.length;N++){const $=M[N];if(N>C&&$.type==="h")break;_.push($)}}}const k=Array.from(new Set(_.map(T=>T.id))).filter(Boolean);for(const T of k)await Yn(T);k.length>0&&await new Promise(T=>setTimeout(T,300));const d=await qn("markdown",l,f);if(d&&d.length>0){for(const T of d)T!=null&&T.id&&await Xn(T.id,{memo:s});wt("报表已就绪")}}async function Rl(t,e){var k;const l=(((k=t.config)==null?void 0:k.profiles)||[]).find(d=>d.id===e);if(!(l!=null&&l.keyword))return{avId:"",viewId:"",profileName:""};const s=await De(`SELECT id FROM blocks WHERE content LIKE '%${l.keyword}%' AND type = 'd' LIMIT 1`);if(!s||s.length===0)return{avId:"",viewId:"",profileName:""};const o=s[0].id,a=await De(`SELECT id, markdown FROM blocks WHERE root_id = '${o}' AND type = 'av' LIMIT 1`);if(!a||a.length===0)return{avId:"",viewId:"",profileName:""};const u=a[0],f=u.markdown.match(/data-av-id="([^"]+)"/);if(!f)return{avId:"",viewId:"",profileName:""};const _=f[1],g=u.markdown.match(/data-view-id="([^"]+)"/),m=g?g[1]:_;return{avId:_,viewId:m,profileName:l.name||l.keyword||l.id}}async function $l(t,e){try{const n=t.i18n||{},l=(y,T)=>n[y]||T,s=e.ruleIds||[];if(!s||s.length===0){qe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const o=[];for(const y of s){const T=await Rl(t,y);if(!T.avId)continue;const M=await Nt(T.avId,T.viewId||T.avId,2e3,1);M&&o.push({profileName:T.profileName,avData:M})}if(o.length===0){qe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const a=new Date,u=Un(a),f=e.period||"none",_=Nl(a,f);let g="报表 ({date})";f==="day"?g="日报 ({date})":f==="week"?g="周报 ({date})":f==="month"?g="月报 ({date})":f==="year"&&(g="年报 ({date})");const k=(e.titleTemplate||g).replace("{date}",u);let d=`### ${k}

`;for(const y of o){const T=y.avData,M=T.view||T,P=(M.columns||M.fields||[]).map(p=>{const D=p.key||p;return{id:D.id,name:D.name||"",type:D.type||""}}),C=p=>P.findIndex(D=>p.some(E=>E(D))),N=C([p=>p.name.includes("内容"),p=>p.name.toLowerCase().includes("content"),p=>p.type==="block"]),$=C([p=>p.name.includes("状态"),p=>p.name.toLowerCase().includes("status")]);let I=C([p=>p.name.includes("更新时间"),p=>p.name.toLowerCase().includes("update"),p=>p.name.includes("更新"),p=>p.name.includes("修改")]);I===-1&&(I=C([p=>p.name.includes("完成"),p=>p.name.includes("结束"),p=>p.name.includes("归档"),p=>p.name.toLowerCase().includes("done")])),I===-1&&(I=C([p=>p.name.includes("时间"),p=>p.name.toLowerCase().includes("time"),p=>p.type==="date"]));const x=Lt(T).map(p=>{let D=p.cells||[];return!p.cells&&p.values&&(D=P.map(E=>{const U=p.values.find(j=>j.keyID===E.id);return U?U.value:null})),{id:p.id,cells:D,updatedAt:p.updatedAt||p.updated||0}}),L=(e.sections||[]).map(p=>({id:p.id,title:p.title,statuses:(p.statuses||[]).map(D=>String(D).toLowerCase()),items:[]}));x.forEach(p=>{var Ie;const D=p.cells.map(me=>$t(me));let E=N!==-1?D[N]:l("reportFallbackContent","无内容");f==="week"&&(E=E.replace(/\b\d+(\.\d+)?\s*[hH]\b/gi,"").replace(/\((?:\d\.?)+[hH]\)/g,"").trim(),!E&&Array.isArray((Ie=p.cells)==null?void 0:Ie[N])&&p.cells[N].length>0&&(E=p.cells[N].map(me=>$t(me)).join(", ")));const U=$!==-1?D[$]:"",j=I!==-1?D[I]:"",Y=En(j),fe=En(p.updatedAt),ee=f!=="none"?Y||fe||0:Y||fe||Date.now(),V=(U||"").toLowerCase(),pe=V.includes("已完成")||V.includes("done")||V.includes("完成")||V.includes("finish")||V.includes("ok"),ne=V.includes("归档")||V.includes("archived")||V.includes("存档")||V.includes("archive");if(f!=="none"&&(pe||ne)&&ee<_)return;const Pe=`${pe?"* [x]":"* [ ]"} ${E}`,Ne=L.filter(me=>me.statuses.length>0&&me.statuses.some(ge=>V.includes(ge)));Ne.length!==0&&Ne[0].items.push(Pe)});const K=`${l("reportBoardTitle","看板")}: ${y.profileName}`;d+=`#### ${K}

`;for(const p of L)d+=`##### ${p.title}
`,p.items.length>0?d+=`${p.items.join(`
`)}

`:d+=`
`}const b=On(d);await Ml(t,e,a,b,`summary-${e.id}`,k),await Dl(t,e,b)}catch(n){console.error(n),qe("生成过程中遇障")}}class Ll extends ft.Plugin{constructor(){super(...arguments);Fe(this,"timer");Fe(this,"isMobile");Fe(this,"config",{});Fe(this,"undoStack",[]);Fe(this,"MAX_UNDO_COUNT",30);Fe(this,"MAX_UNDO_DAYS",7)}async onload(){Zn(this),console.log("Loading Kanban Workflow Plugin v0.1.0"),await this.loadAndNormalizeConfig();try{const s=await this.loadData("undo_history.json");s&&Array.isArray(s)&&(this.undoStack=s)}catch(s){console.error("Failed to load undo history",s)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板工作流",position:"right",callback:s=>{if(this.isMobile){this.showMobileMenu();return}let o;s&&s.currentTarget&&s.currentTarget.getBoundingClientRect?o=s.currentTarget.getBoundingClientRect():o=n.getBoundingClientRect();const a=new ft.Menu("kanban-archiver-menu");a.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(f=>{a.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${f.name}`,click:()=>{this.generateTemplate(f.id)}})}),a.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),a.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),a.open({x:o.left,y:o.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),(this.config.templates||[]).forEach(s=>{this.addCommand({langKey:`generateTemplate_${s.id}`,langText:`${this.i18n.generateTemplatePrefix||"生成"}：${s.name}`,hotkey:"",callback:()=>{this.generateTemplate(s.id)}})}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",templates:[],...n},this.ensureDefaultTemplates(),this.normalizeTemplates(),(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let l=!1;this.config.profiles.forEach(s=>{s.enabled===void 0&&(s.enabled=!0,l=!0)}),l&&this.saveData("config.json",this.config)}ensureDefaultTemplates(){(!this.config.templates||!Array.isArray(this.config.templates)||this.config.templates.length===0)&&(this.config.templates=[{id:this.generateUUID(),name:this.i18n.defaultDailyTemplate||"今日汇总",period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"日报 ({date})",sections:[{id:this.generateUUID(),title:"待办",statuses:["待办","todo","backlog","未开始"]},{id:this.generateUUID(),title:"进行中",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成",statuses:["已完成","done","完成","finish","ok","归档","archived"]}]},{id:this.generateUUID(),name:this.i18n.defaultWeeklyTemplate||"本周回顾",period:"week",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"周报 ({date})",sections:[{id:this.generateUUID(),title:"当前工作",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成及归档 (本周)",statuses:["已完成","done","完成","finish","ok","归档","archived"]},{id:this.generateUUID(),title:"下周工作计划",statuses:["待办","todo","backlog","未开始"]}]}],this.saveData("config.json",this.config))}normalizeTemplates(){if(!Array.isArray(this.config.templates))return;let n=!1;this.config.templates.forEach(l=>{!l.period&&l.type&&(l.period=l.type==="weekly"?"week":"day",n=!0),l.period||(l.period="none",n=!0),l.sections||(l.sections=[],n=!0)}),n&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Workflow Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Workflow Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new ft.Dialog({title:this.i18n.settingTitle||"看板工作流设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{l.$destroy()}}),l=new yl({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new ft.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(s=>{n.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${s.name}`,click:()=>{this.generateTemplate(s.id)}})}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,l=n.getHours(),s=n.getMinutes(),o=l*60+s;let a=0,u=0;try{const g=this.config.archiveTime.split(":").map(Number);g.length===2&&!isNaN(g[0])&&!isNaN(g[1])&&(a=g[0],u=g[1])}catch{return}const f=a*60+u,_=n.toLocaleDateString();this.config.lastRunDate!==_&&o>=f&&(this.config.lastRunDate=_,this.saveData("config.json",this.config),this.archiveNow())}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(l=>l.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(){if(window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？"))try{const n=await Qn(this,!0);n&&n.length>0&&(this.undoStack.push({date:new Date().getTime(),ids:n}),await this.saveUndoHistory())}catch(n){console.error("Archive task error:",n)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await Jn(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}async generateTemplate(n){const l=(this.config.templates||[]).find(s=>s.id===n);l&&await $l(this,l)}async getNotebooks(){return await Mn()}async getStatusOptions(n){const l=this.config.profiles||[],s=new Set;for(const o of n){const a=l.find(b=>b.id===o);if(!(a!=null&&a.keyword))continue;const u=await De(`SELECT id FROM blocks WHERE content LIKE '%${a.keyword}%' AND type = 'd' LIMIT 1`);if(!u||u.length===0)continue;const f=u[0].id,_=await De(`SELECT id, markdown FROM blocks WHERE root_id = '${f}' AND type = 'av' LIMIT 1`);if(!_||_.length===0)continue;const m=_[0].markdown.match(/data-av-id="([^"]+)"/);if(!m)continue;const k=m[1],d=await xt(k);if(d)for(const b of d)(b.type==="select"||b.type==="mSelect")&&b.options&&b.options.forEach(y=>{y!=null&&y.name&&s.add(y.name)})}return Array.from(s)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var l=Math.random()*16|0,s=n=="x"?l:l&3|8;return s.toString(16)})}}module.exports=Ll;
