"use strict";var Mt=Object.defineProperty;var Nt=(e,t,n)=>t in e?Mt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var J=(e,t,n)=>Nt(e,typeof t!="symbol"?t+"":t,n);const me=require("siyuan");async function pe(e,t){let n=await me.fetchSyncPost(e,t);return n.code===0?n.data:null}async function Se(e){return pe("/api/query/sql",{stmt:e})}async function vt(e,t=7e3){return pe("/api/notification/pushMsg",{msg:e,timeout:t})}async function ke(e,t=7e3){return pe("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function mt(e){return pe("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function Qe(e,t,n=9999999,i=1){return pe("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:i})}async function bt(e,t,n,i){return pe("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:i})}async function It(e,t,n,i,c=!1){var s,u,v;try{const f=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${i}"`);const h=await Se(`SELECT id FROM blocks WHERE content LIKE '%${f}%' AND type = 'd' LIMIT 1`);if(!h||h.length===0)return console.log(`Kanban doc not found for keyword: ${f}`),[];const p=h[0].id,r=await Se(`SELECT id, markdown FROM blocks WHERE root_id = '${p}' AND type = 'av' LIMIT 1`);if(!r||r.length===0)return c&&ke(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const w=r[0],o=w.markdown.match(/data-av-id="([^"]+)"/);if(!o)return[];const _=o[1],M=await mt(_);if(!M)return[];let y=null,C=null,E=null;for(const k of M)if((k.type==="select"||k.type==="mSelect")&&k.options){const a=k.options.find($=>$.name===n),m=k.options.find($=>$.name===i);if(a&&m){y=k,C=a,E=m;break}}if(!y)return c&&ke(`在 "${t.name}" 中未找到状态 "${n}" -> "${i}"`),[];const R=w.markdown.match(/data-view-id="([^"]+)"/);let L=R?R[1]:_,S=await Qe(_,L);const I=(k,a=0)=>{if(!k||a>5)return[];let m=[];const $=["rows","groups","blocks","children","items"];for(const W of $)if(Array.isArray(k[W]))for(const Q of k[W])Q.id&&Array.isArray(Q.cells)?m.push(Q):m=m.concat(I(Q,a+1));return k.view&&(m=m.concat(I(k.view,a+1))),m};let b=I(S);if(b.length===0&&(S!=null&&S.views)){const k=S.views.find(a=>a.type==="table");k&&(S=await Qe(_,k.id),b=I(S))}if(b.length===0)return[];let D=(((s=S.view)==null?void 0:s.columns)||S.columns||[]).findIndex(k=>k.id===y.id),B=[],N=0;for(const k of b){let a=!1;if(D>=0&&k.cells&&k.cells[D]){const m=k.cells[D].value;m!=null&&m.mSelect?a=m.mSelect.some($=>$.content===n):m!=null&&m.select&&(a=m.select.content===n)}else if(k.cells&&Array.isArray(k.cells))for(const m of k.cells){const $=m.value;if((u=$==null?void 0:$.mSelect)!=null&&u.some(W=>W.content===n)){a=!0;break}else if(((v=$==null?void 0:$.select)==null?void 0:v.content)===n){a=!0;break}}if(a){const m={mSelect:[{content:E.name,color:E.color}]};await bt(_,y.id,k.id,m),B.push(k.id),N++}}return N>0&&vt(`[${t.name}] 已归档 ${N} 个任务`),B}catch(f){return console.error("Status switch failed:",f),c&&ke(`[${t.name}] 出错: `+f.message),[]}}async function Dt(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let i=0;for(const c of n)try{const s=await Se(`SELECT id FROM blocks WHERE content LIKE '%${c.keyword}%' AND type = 'd' LIMIT 1`);if(!s||s.length===0)continue;const u=s[0].id,v=await Se(`SELECT id, markdown FROM blocks WHERE root_id = '${u}' AND type = 'av' LIMIT 1`);if(!v||v.length===0)continue;const h=v[0].markdown.match(/data-av-id="([^"]+)"/);if(!h)continue;const p=h[1],r=await mt(p);if(!r)continue;let w=null,o=null;for(const M of r)if((M.type==="select"||M.type==="mSelect")&&M.options){const y=M.options.find(C=>C.name===c.completedStatus);if(y){w=M,o=y;break}}if(!w||!o)continue;const _={mSelect:[{content:o.name,color:o.color}]};for(const M of t)await bt(p,w.id,M,_);i+=t.length}catch(s){console.warn("Restore attempted failed for profile",c.name,s)}return i>0?(vt("已尝试撤销恢复任务"),!0):!1}async function Et(e,t=!1){const n=e.config.profiles||[];let i=[];if(n.length===0)return t&&ke("未配置任何归档规则，请在设置中添加"),[];for(const c of n){if(!c.keyword||c.enabled===!1)continue;const s=await It(e,c,c.completedStatus,c.archivedStatus,t);i=i.concat(s)}return i}let ye=null;function Rt(e){ye=e}function T(e,t){let n=null;if(ye&&ye.i18n&&(n=ye.i18n),!n)try{const{i18n:s}=require("siyuan");n=s}catch(s){console.warn("无法获取i18n对象:",s)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let i=n;const c=e.split(".");for(const s of c)if(i&&typeof i=="object"&&s in i)i=i[s];else{i=void 0;break}return typeof i!="string"&&(console.warn("未找到i18n键:",e),i=e),i}function he(){}function _t(e){return e()}function Ze(){return Object.create(null)}function ie(e){e.forEach(_t)}function wt(e){return typeof e=="function"}function $t(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Ct(e){return Object.keys(e).length===0}function l(e,t){e.appendChild(t)}function Y(e,t,n){e.insertBefore(t,n||null)}function X(e){e.parentNode&&e.parentNode.removeChild(e)}function et(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function g(e){return document.createElement(e)}function G(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function O(e){return document.createTextNode(e)}function x(){return O(" ")}function P(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function tt(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function d(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function ve(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function Lt(e){return Array.from(e.childNodes)}function Re(e,t){t=""+t,e.data!==t&&(e.data=t)}function te(e,t){e.value=t??""}function A(e,t,n,i){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function ne(e,t,n){e.classList.toggle(t,!!n)}let _e;function be(e){_e=e}function Ut(){if(!_e)throw new Error("Function called outside component initialization");return _e}function Pt(e){Ut().$$.on_mount.push(e)}function Kt(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(i=>i.call(this,t))}const ue=[],nt=[];let fe=[];const it=[],Ot=Promise.resolve();let De=!1;function Bt(){De||(De=!0,Ot.then(kt))}function Ee(e){fe.push(e)}const Ie=new Set;let re=0;function kt(){if(re!==0)return;const e=_e;do{try{for(;re<ue.length;){const t=ue[re];re++,be(t),jt(t.$$)}}catch(t){throw ue.length=0,re=0,t}for(be(null),ue.length=0,re=0;nt.length;)nt.pop()();for(let t=0;t<fe.length;t+=1){const n=fe[t];Ie.has(n)||(Ie.add(n),n())}fe.length=0}while(ue.length);for(;it.length;)it.pop()();De=!1,Ie.clear(),be(e)}function jt(e){if(e.fragment!==null){e.update(),ie(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Ee)}}function Ht(e){const t=[],n=[];fe.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),fe=t}const Ft=new Set;function yt(e,t){e&&e.i&&(Ft.delete(e),e.i(t))}function de(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function Vt(e,t){e.d(1),t.delete(e.key)}function Wt(e,t,n,i,c,s,u,v,f,h,p,r){let w=e.length,o=s.length,_=w;const M={};for(;_--;)M[e[_].key]=_;const y=[],C=new Map,E=new Map,R=[];for(_=o;_--;){const b=r(c,s,_),U=n(b);let D=u.get(U);D?R.push(()=>D.p(b,t)):(D=h(U,b),D.c()),C.set(U,y[_]=D),U in M&&E.set(U,Math.abs(_-M[U]))}const L=new Set,S=new Set;function I(b){yt(b,1),b.m(v,p),u.set(b.key,b),p=b.first,o--}for(;w&&o;){const b=y[o-1],U=e[w-1],D=b.key,B=U.key;b===U?(p=b.first,w--,o--):C.has(B)?!u.has(D)||L.has(D)?I(b):S.has(B)?w--:E.get(D)>E.get(B)?(S.add(D),I(b)):(L.add(B),w--):(f(U,u),w--)}for(;w--;){const b=e[w];C.has(b.key)||f(b,u)}for(;o;)I(y[o-1]);return ie(R),y}function Xt(e,t,n){const{fragment:i,after_update:c}=e.$$;i&&i.m(t,n),Ee(()=>{const s=e.$$.on_mount.map(_t).filter(wt);e.$$.on_destroy?e.$$.on_destroy.push(...s):ie(s),e.$$.on_mount=[]}),c.forEach(Ee)}function zt(e,t){const n=e.$$;n.fragment!==null&&(Ht(n.after_update),ie(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Gt(e,t){e.$$.dirty[0]===-1&&(ue.push(e),Bt(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function Yt(e,t,n,i,c,s,u=null,v=[-1]){const f=_e;be(e);const h=e.$$={fragment:null,ctx:[],props:s,update:he,not_equal:c,bound:Ze(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(f?f.$$.context:[])),callbacks:Ze(),dirty:v,skip_bound:!1,root:t.target||f.$$.root};u&&u(h.root);let p=!1;if(h.ctx=n?n(e,t.props||{},(r,w,...o)=>{const _=o.length?o[0]:w;return h.ctx&&c(h.ctx[r],h.ctx[r]=_)&&(!h.skip_bound&&h.bound[r]&&h.bound[r](_),p&&Gt(e,r)),w}):[],h.update(),p=!0,ie(h.before_update),h.fragment=i?i(h.ctx):!1,t.target){if(t.hydrate){const r=Lt(t.target);h.fragment&&h.fragment.l(r),r.forEach(X)}else h.fragment&&h.fragment.c();t.intro&&yt(e.$$.fragment),Xt(e,t.target,t.anchor),kt()}be(f)}class Jt{constructor(){J(this,"$$");J(this,"$$set")}$destroy(){zt(this,1),this.$destroy=he}$on(t,n){if(!wt(n))return he;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const c=i.indexOf(n);c!==-1&&i.splice(c,1)}}$set(t){this.$$set&&!Ct(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const Qt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Qt);function lt(e,t,n){const i=e.slice();return i[26]=t[n],i[27]=t,i[28]=n,i}function st(e,t,n){const i=e.slice();return i[29]=t[n],i}function ot(e,t,n){const i=e.slice();return i[32]=t[n],i}function ct(e){let t,n,i;return{c(){t=g("div"),d(t,"class","backdrop svelte-1nqb995")},m(c,s){Y(c,t,s),n||(i=P(t,"click",e[15]),n=!0)},p:he,d(c){c&&X(t),n=!1,i()}}}function at(e){let t,n,i,c,s,u,v=de(e[4]),f=[];for(let r=0;r<v.length;r+=1)f[r]=rt(ot(e,v,r));let h=de(e[5]),p=[];for(let r=0;r<h.length;r+=1)p[r]=ut(st(e,h,r));return{c(){t=g("div"),n=g("div");for(let r=0;r<f.length;r+=1)f[r].c();i=x(),c=g("div"),s=x(),u=g("div");for(let r=0;r<p.length;r+=1)p[r].c();d(n,"class","time-col svelte-1nqb995"),A(c,"width","1px"),A(c,"background","var(--b3-theme-surface-lighter)"),d(u,"class","time-col svelte-1nqb995"),d(t,"class","time-picker-popover svelte-1nqb995")},m(r,w){Y(r,t,w),l(t,n);for(let o=0;o<f.length;o+=1)f[o]&&f[o].m(n,null);l(t,i),l(t,c),l(t,s),l(t,u);for(let o=0;o<p.length;o+=1)p[o]&&p[o].m(u,null)},p(r,w){if(w[0]&1042){v=de(r[4]);let o;for(o=0;o<v.length;o+=1){const _=ot(r,v,o);f[o]?f[o].p(_,w):(f[o]=rt(_),f[o].c(),f[o].m(n,null))}for(;o<f.length;o+=1)f[o].d(1);f.length=v.length}if(w[0]&2082){h=de(r[5]);let o;for(o=0;o<h.length;o+=1){const _=st(r,h,o);p[o]?p[o].p(_,w):(p[o]=ut(_),p[o].c(),p[o].m(u,null))}for(;o<p.length;o+=1)p[o].d(1);p.length=h.length}},d(r){r&&X(t),et(f,r),et(p,r)}}}function rt(e){let t,n=e[32]+"",i,c,s,u;function v(){return e[16](e[32])}return{c(){t=g("div"),i=O(n),c=x(),d(t,"id",`time-opt-h-${e[32]}`),d(t,"class","time-opt svelte-1nqb995"),ne(t,"selected",e[1].startsWith(e[32]))},m(f,h){Y(f,t,h),l(t,i),l(t,c),s||(u=P(t,"click",v),s=!0)},p(f,h){e=f,h[0]&18&&ne(t,"selected",e[1].startsWith(e[32]))},d(f){f&&X(t),s=!1,u()}}}function ut(e){let t,n=e[29]+"",i,c,s,u;function v(){return e[17](e[29])}return{c(){t=g("div"),i=O(n),c=x(),d(t,"id",`time-opt-m-${e[29]}`),d(t,"class","time-opt svelte-1nqb995"),ne(t,"selected",e[1].endsWith(e[29]))},m(f,h){Y(f,t,h),l(t,i),l(t,c),s||(u=P(t,"click",v),s=!0)},p(f,h){e=f,h[0]&34&&ne(t,"selected",e[1].endsWith(e[29]))},d(f){f&&X(t),s=!1,u()}}}function dt(e){let t,n=e[26].keyword+"",i;return{c(){t=g("span"),i=O(n),d(t,"class","tag-preview svelte-1nqb995")},m(c,s){Y(c,t,s),l(t,i)},p(c,s){s[0]&1&&n!==(n=c[26].keyword+"")&&Re(i,n)},d(c){c&&X(t)}}}function ft(e){let t,n,i,c,s,u,v,f,h,p,r,w,o,_,M,y,C,E,R,L,S,I,b;function U(){e[21].call(s,e[27],e[28])}function D(){e[22].call(p,e[27],e[28])}function B(){e[23].call(y,e[27],e[28])}function N(){e[24].call(S,e[27],e[28])}return{c(){t=g("div"),n=g("div"),i=g("div"),i.textContent=`${T("ruleNameLabel")}`,c=x(),s=g("input"),u=x(),v=g("div"),f=g("div"),f.textContent=`${T("keywordLabel")}`,h=x(),p=g("input"),r=x(),w=g("div"),o=g("div"),_=g("div"),_.textContent=`${T("completedStatusLabel")}`,M=x(),y=g("input"),C=x(),E=g("div"),R=g("div"),R.textContent=`${T("archivedStatusLabel")}`,L=x(),S=g("input"),d(i,"class","input-label svelte-1nqb995"),d(s,"class","modern-input svelte-1nqb995"),d(s,"type","text"),d(s,"placeholder",T("ruleNamePlaceholder")),d(n,"class","input-group svelte-1nqb995"),d(f,"class","input-label svelte-1nqb995"),d(p,"class","modern-input svelte-1nqb995"),d(p,"type","text"),d(p,"placeholder",T("keywordPlaceholder")),d(v,"class","input-group svelte-1nqb995"),d(_,"class","input-label svelte-1nqb995"),d(y,"class","modern-input svelte-1nqb995"),d(y,"type","text"),d(y,"placeholder",T("completedStatusPlaceholder")),d(o,"class","input-group fn__flex-1 svelte-1nqb995"),d(R,"class","input-label svelte-1nqb995"),d(S,"class","modern-input svelte-1nqb995"),d(S,"type","text"),d(S,"placeholder",T("archivedStatusPlaceholder")),d(E,"class","input-group fn__flex-1 svelte-1nqb995"),d(w,"class","fn__flex svelte-1nqb995"),A(w,"gap","20px"),d(t,"class","card-content svelte-1nqb995")},m(k,a){Y(k,t,a),l(t,n),l(n,i),l(n,c),l(n,s),te(s,e[26].name),l(t,u),l(t,v),l(v,f),l(v,h),l(v,p),te(p,e[26].keyword),l(t,r),l(t,w),l(w,o),l(o,_),l(o,M),l(o,y),te(y,e[26].completedStatus),l(w,C),l(w,E),l(E,R),l(E,L),l(E,S),te(S,e[26].archivedStatus),I||(b=[P(s,"input",U),P(s,"change",e[6]),P(p,"input",D),P(p,"change",e[6]),P(y,"input",B),P(y,"change",e[6]),P(S,"input",N),P(S,"change",e[6])],I=!0)},p(k,a){e=k,a[0]&1&&s.value!==e[26].name&&te(s,e[26].name),a[0]&1&&p.value!==e[26].keyword&&te(p,e[26].keyword),a[0]&1&&y.value!==e[26].completedStatus&&te(y,e[26].completedStatus),a[0]&1&&S.value!==e[26].archivedStatus&&te(S,e[26].archivedStatus)},d(k){k&&X(t),I=!1,ie(b)}}}function ht(e,t){let n,i,c,s,u,v,f=(t[26].name||T("unnamedRule"))+"",h,p,r,w,o,_,M,y,C,E,R,L,S,I,b=t[26].keyword&&dt(t);function U(){t[18].call(_,t[27],t[28])}function D(){return t[19](t[26])}function B(){return t[20](t[26])}let N=t[2]===t[26].id&&ft(t);return{key:e,first:null,c(){n=g("div"),i=g("div"),c=g("div"),c.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=x(),u=g("div"),v=g("span"),h=O(f),p=x(),b&&b.c(),r=x(),w=g("div"),o=g("label"),_=g("input"),M=x(),y=g("span"),y.innerHTML='<span class="switch-thumb svelte-1nqb995"></span>',E=x(),R=g("div"),R.innerHTML='<svg class="svelte-1nqb995"><use xlink:href="#iconTrashcan"></use></svg>',L=x(),N&&N.c(),d(c,"class","chevron svelte-1nqb995"),A(v,"font-weight","600"),A(v,"font-size","15px"),A(v,"color","var(--b3-theme-on-surface)"),d(u,"class","fn__flex-1 svelte-1nqb995"),A(u,"margin-left","14px"),A(u,"display","flex"),A(u,"align-items","center"),d(_,"class","switch-input svelte-1nqb995"),d(_,"type","checkbox"),d(y,"class","switch-track svelte-1nqb995"),d(o,"class","switch-container svelte-1nqb995"),d(o,"title",C=t[26].enabled?T("enabled"):T("disabled")),d(w,"class","fn__flex-center"),A(w,"margin-right","20px"),d(R,"class","icon-btn svelte-1nqb995"),d(R,"title",T("deleteRule")),d(i,"class","card-header svelte-1nqb995"),d(n,"class","card svelte-1nqb995"),A(n,"opacity",t[26].enabled?1:.75),ne(n,"expanded",t[2]===t[26].id),this.first=n},m(k,a){Y(k,n,a),l(n,i),l(i,c),l(i,s),l(i,u),l(u,v),l(v,h),l(u,p),b&&b.m(u,null),l(i,r),l(i,w),l(w,o),l(o,_),_.checked=t[26].enabled,l(o,M),l(o,y),l(i,E),l(i,R),l(n,L),N&&N.m(n,null),S||(I=[P(_,"change",U),P(_,"change",t[6]),P(w,"click",tt(t[14])),P(R,"click",tt(D)),P(i,"click",B)],S=!0)},p(k,a){t=k,a[0]&1&&f!==(f=(t[26].name||T("unnamedRule"))+"")&&Re(h,f),t[26].keyword?b?b.p(t,a):(b=dt(t),b.c(),b.m(u,null)):b&&(b.d(1),b=null),a[0]&1&&(_.checked=t[26].enabled),a[0]&1&&C!==(C=t[26].enabled?T("enabled"):T("disabled"))&&d(o,"title",C),t[2]===t[26].id?N?N.p(t,a):(N=ft(t),N.c(),N.m(n,null)):N&&(N.d(1),N=null),a[0]&1&&A(n,"opacity",t[26].enabled?1:.75),a[0]&5&&ne(n,"expanded",t[2]===t[26].id)},d(k){k&&X(n),b&&b.d(),N&&N.d(),S=!1,ie(I)}}}function pt(e){let t;return{c(){t=g("div"),t.textContent=`${T("noRulesTip")}`,A(t,"text-align","center"),A(t,"padding","48px"),A(t,"color","var(--b3-theme-on-surface-light)"),A(t,"border","2px dashed var(--b3-border-color)"),A(t,"border-radius","16px")},m(n,i){Y(n,t,i)},d(n){n&&X(t)}}}function Zt(e){let t,n,i,c,s,u,v,f=T("globalArchiveTime")+"",h,p,r,w,o,_,M,y,C,E,R,L,S,I,b,U,D,B=T("archiveRuleList")+"",N,k,a,m,$,W,Q,$e,St=T("addRule")+"",Ce,Le,Z,z=[],Ue=new Map,Ae,Pe,se,V,ge,xe,Ke,At=T("usageTipTitle")+"",Oe,Be,ee,oe,qe,je,xt=T("usageTipGlobalDesc")+"",He,Fe,ce,Te,Ve,qt=T("usageTipMatchDesc")+"",We,Xe,ae,Me,ze,Tt=T("usageTipStatusDesc")+"",Ge,Ne,Ye,j=e[3]&&ct(e),H=e[3]&&at(e),we=de(e[0]);const Je=q=>q[26].id;for(let q=0;q<we.length;q+=1){let K=lt(e,we,q),le=Je(K);Ue.set(le,z[q]=ht(le,K))}let F=e[0].length===0&&pt();return{c(){j&&j.c(),t=x(),n=g("div"),i=g("div"),c=g("div"),s=G("svg"),u=G("use"),v=x(),h=O(f),p=x(),r=g("div"),w=x(),o=g("div"),_=O(e[1]),M=x(),y=G("svg"),C=G("use"),E=x(),H&&H.c(),R=x(),L=g("div"),S=g("div"),I=g("div"),b=G("svg"),U=G("use"),D=x(),N=O(B),k=x(),a=g("div"),m=x(),$=g("button"),W=G("svg"),Q=G("use"),$e=x(),Ce=O(St),Le=x(),Z=g("div");for(let q=0;q<z.length;q+=1)z[q].c();Ae=x(),F&&F.c(),Pe=x(),se=g("div"),V=g("div"),ge=G("svg"),xe=G("use"),Ke=x(),Oe=O(At),Be=x(),ee=g("ul"),oe=g("li"),qe=g("strong"),qe.textContent=`${T("usageTipGlobal")}`,je=O("："),He=O(xt),Fe=x(),ce=g("li"),Te=g("strong"),Te.textContent=`${T("usageTipMatch")}`,Ve=O("："),We=O(qt),Xe=x(),ae=g("li"),Me=g("strong"),Me.textContent=`${T("usageTipStatus")}`,ze=O("："),Ge=O(Tt),ve(u,"xlink:href","#iconCalendar"),A(s,"width","18px"),A(s,"height","18px"),d(c,"class","section-title svelte-1nqb995"),d(r,"class","fn__flex-1 svelte-1nqb995"),ve(C,"xlink:href","#iconClock"),A(y,"width","14px"),A(y,"height","14px"),A(y,"opacity","0.6"),d(o,"class","time-trigger svelte-1nqb995"),ne(o,"active",e[3]),d(i,"class","section-header svelte-1nqb995"),ve(U,"xlink:href","#iconSettings"),A(b,"width","18px"),A(b,"height","18px"),d(I,"class","section-title svelte-1nqb995"),d(a,"class","fn__flex-1 svelte-1nqb995"),ve(Q,"xlink:href","#iconAdd"),A(W,"width","14px"),A(W,"height","14px"),d(W,"class","svelte-1nqb995"),d($,"class","action-btn svelte-1nqb995"),d(S,"class","section-header svelte-1nqb995"),d(Z,"class","profile-container svelte-1nqb995"),A(L,"margin-top","20px"),A(L,"display","flex"),A(L,"flex-direction","column"),ve(xe,"xlink:href","#iconInfo"),A(ge,"width","16px"),A(ge,"height","16px"),A(V,"font-weight","700"),A(V,"color","var(--b3-theme-primary)"),A(V,"display","flex"),A(V,"align-items","center"),A(V,"gap","8px"),A(V,"margin-bottom","8px"),A(V,"font-size","14px"),d(oe,"class","svelte-1nqb995"),d(ce,"class","svelte-1nqb995"),d(ae,"class","svelte-1nqb995"),d(ee,"class","svelte-1nqb995"),d(se,"class","info-footer svelte-1nqb995"),d(n,"class","settings-container svelte-1nqb995")},m(q,K){j&&j.m(q,K),Y(q,t,K),Y(q,n,K),l(n,i),l(i,c),l(c,s),l(s,u),l(c,v),l(c,h),l(i,p),l(i,r),l(i,w),l(i,o),l(o,_),l(o,M),l(o,y),l(y,C),l(i,E),H&&H.m(i,null),l(n,R),l(n,L),l(L,S),l(S,I),l(I,b),l(b,U),l(I,D),l(I,N),l(S,k),l(S,a),l(S,m),l(S,$),l($,W),l(W,Q),l($,$e),l($,Ce),l(L,Le),l(L,Z);for(let le=0;le<z.length;le+=1)z[le]&&z[le].m(Z,null);l(Z,Ae),F&&F.m(Z,null),l(n,Pe),l(n,se),l(se,V),l(V,ge),l(ge,xe),l(V,Ke),l(V,Oe),l(se,Be),l(se,ee),l(ee,oe),l(oe,qe),l(oe,je),l(oe,He),l(ee,Fe),l(ee,ce),l(ce,Te),l(ce,Ve),l(ce,We),l(ee,Xe),l(ee,ae),l(ae,Me),l(ae,ze),l(ae,Ge),Ne||(Ye=[P(o,"click",e[12]),P($,"click",e[7])],Ne=!0)},p(q,K){q[3]?j?j.p(q,K):(j=ct(q),j.c(),j.m(t.parentNode,t)):j&&(j.d(1),j=null),K[0]&2&&Re(_,q[1]),K[0]&8&&ne(o,"active",q[3]),q[3]?H?H.p(q,K):(H=at(q),H.c(),H.m(i,null)):H&&(H.d(1),H=null),K[0]&837&&(we=de(q[0]),z=Wt(z,K,Je,1,q,we,Ue,Z,Vt,ht,Ae,lt)),q[0].length===0?F||(F=pt(),F.c(),F.m(Z,null)):F&&(F.d(1),F=null)},i:he,o:he,d(q){q&&(X(t),X(n)),j&&j.d(q),H&&H.d();for(let K=0;K<z.length;K+=1)z[K].d();F&&F.d(),Ne=!1,ie(Ye)}}}function en(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function gt(e,t){const n=`time-opt-${e}-${t}`,i=document.getElementById(n);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}function tn(e,t,n){let{plugin:i}=t,c=[],s="00:00",u=null,v=!1;const f=Array.from({length:24},(a,m)=>m.toString().padStart(2,"0")),h=Array.from({length:60},(a,m)=>m.toString().padStart(2,"0"));Pt(()=>{p(),i.config.profiles&&i.config.profiles.length===1&&n(2,u=i.config.profiles[0].id)});function p(){n(0,c=i.config.profiles||[]),n(1,s=i.config.archiveTime||"00:00")}async function r(){n(13,i.config.archiveTime=s,i),i.saveData("config.json",i.config),p()}function w(){i.config.profiles||n(13,i.config.profiles=[],i);const a={id:en(),name:T("defaultNewRuleName")+" "+(i.config.profiles.length+1),keyword:"",completedStatus:T("defaultCompleted"),archivedStatus:T("defaultArchived"),enabled:!0};n(13,i.config.profiles=[...i.config.profiles,a],i),r(),n(2,u=a.id),setTimeout(()=>{const m=document.querySelector(".profile-container");m&&(m.scrollTop=m.scrollHeight)},50)}function o(a){n(13,i.config.profiles=i.config.profiles.filter(m=>m.id!==a),i),r(),u===a&&n(2,u=null)}function _(a){u===a?n(2,u=null):n(2,u=a)}function M(a){const m=s.split(":");n(1,s=`${a}:${m[1]||"00"}`),r()}function y(a){const m=s.split(":");n(1,s=`${m[0]||"00"}:${a}`),r()}function C(){n(3,v=!v),v&&setTimeout(()=>{const[a,m]=s.split(":");gt("h",a),gt("m",m)},10)}function E(a){Kt.call(this,e,a)}const R=()=>n(3,v=!1),L=a=>M(a),S=a=>y(a);function I(a,m){a[m].enabled=this.checked,n(0,c)}const b=a=>o(a.id),U=a=>_(a.id);function D(a,m){a[m].name=this.value,n(0,c)}function B(a,m){a[m].keyword=this.value,n(0,c)}function N(a,m){a[m].completedStatus=this.value,n(0,c)}function k(a,m){a[m].archivedStatus=this.value,n(0,c)}return e.$$set=a=>{"plugin"in a&&n(13,i=a.plugin)},[c,s,u,v,f,h,r,w,o,_,M,y,C,i,E,R,L,S,I,b,U,D,B,N,k]}class nn extends Jt{constructor(t){super(),Yt(this,t,tn,Zt,$t,{plugin:13},null,[-1,-1])}}class ln extends me.Plugin{constructor(){super(...arguments);J(this,"timer");J(this,"isMobile");J(this,"config",{});J(this,"undoStack",[]);J(this,"MAX_UNDO_COUNT",30);J(this,"MAX_UNDO_DAYS",7)}async onload(){Rt(this),console.log("Loading Kanban Archiver Plugin v0.3.11");const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",...n},(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let i=!1;this.config.profiles.forEach(s=>{s.enabled===void 0&&(s.enabled=!0,i=!0)}),i&&this.saveData("config.json",this.config);try{const s=await this.loadData("undo_history.json");s&&Array.isArray(s)&&(this.undoStack=s)}catch(s){console.error("Failed to load undo history",s)}const c=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板自动归档",position:"right",callback:s=>{if(this.isMobile){this.showMobileMenu();return}let u;s&&s.currentTarget&&s.currentTarget.getBoundingClientRect?u=s.currentTarget.getBoundingClientRect():u=c.getBoundingClientRect();const v=new me.Menu("kanban-archiver-menu");v.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),v.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),v.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),v.open({x:u.left,y:u.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),this.initScheduler()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Archiver Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Archiver Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new me.Dialog({title:this.i18n.settingTitle||"看板自动归档设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{i.$destroy()}}),i=new nn({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new me.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,i=n.getHours(),c=n.getMinutes(),s=i*60+c;let u=0,v=0;try{const p=this.config.archiveTime.split(":").map(Number);p.length===2&&!isNaN(p[0])&&!isNaN(p[1])&&(u=p[0],v=p[1])}catch{return}const f=u*60+v,h=n.toLocaleDateString();this.config.lastRunDate!==h&&s>=f&&(this.config.lastRunDate=h,this.saveData("config.json",this.config),this.archiveNow())}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(i=>i.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(){try{const n=await Et(this,!0);n&&n.length>0&&(this.undoStack.push({date:new Date().getTime(),ids:n}),await this.saveUndoHistory())}catch(n){console.error("Archive task error:",n)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await Dt(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=Math.random()*16|0,c=n=="x"?i:i&3|8;return c.toString(16)})}}module.exports=ln;
