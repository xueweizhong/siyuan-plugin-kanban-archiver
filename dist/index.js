"use strict";var qn=Object.defineProperty;var Yn=(e,t,n)=>t in e?qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ve=(e,t,n)=>Yn(e,typeof t!="symbol"?t+"":t,n);const ht=require("siyuan");async function Le(e,t){let n=await ht.fetchSyncPost(e,t);return n.code===0?n.data:null}async function xn(){const t=await Le("/api/notebook/lsNotebooks","");try{t&&t.notebooks&&Array.isArray(t.notebooks)&&(t.notebooks=t.notebooks.filter(n=>n.closed===!1||n.closed===0||n.closed==="false"))}catch(n){console.error("Filter notebooks error:",n)}return t}async function Xn(e,t,n){return Le("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:n})}async function Gn(e,t,n){return Le("/api/block/appendBlock",{dataType:e,data:t,parentID:n})}async function Jn(e){return Le("/api/block/deleteBlock",{id:e})}async function Qn(e,t){return Le("/api/attr/setBlockAttrs",{id:e,attrs:t})}async function Be(e){return Le("/api/query/sql",{stmt:e})}async function _t(e,t=7e3){return Le("/api/notification/pushMsg",{msg:e,timeout:t})}async function Xe(e,t=7e3){return Le("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function Pt(e){return Le("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function Mt(e,t,n=9999999,l=1){return Le("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:l})}async function Bn(e,t,n,l){return Le("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:l})}async function Zn(e,t){return Le("/api/av/getAttributeViewBoundBlockIDsByItemIDs",{avID:e,itemIDs:t})}async function el(e,t,n,l,o=!1){var s,c,u;try{const m=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${l}"`);const h=await Be(`SELECT id FROM blocks WHERE content LIKE '%${m}%' AND type = 'd' LIMIT 1`);if(!h||h.length===0)return console.log(`Kanban doc not found for keyword: ${m}`),[];const r=h[0].id,v=await Be(`SELECT id, markdown FROM blocks WHERE root_id = '${r}' AND type = 'av' LIMIT 1`);if(!v||v.length===0)return o&&Xe(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const _=v[0],p=_.markdown.match(/data-av-id="([^"]+)"/);if(!p)return[];const b=p[1],w=await Pt(b);if(!w)return[];let I=null,B=null,j=null;for(const N of w)if((N.type==="select"||N.type==="mSelect")&&N.options){const P=N.options.find($=>$.name===n),a=N.options.find($=>$.name===l);if(P&&a){I=N,B=P,j=a;break}}if(!I)return o&&Xe(`在 "${t.name}" 中未找到状态 "${n}" -> "${l}"`),[];const O=_.markdown.match(/data-view-id="([^"]+)"/);let D=O?O[1]:b,C=await Mt(b,D);const M=(N,P=0)=>{if(!N||P>5)return[];let a=[];const $=["rows","groups","blocks","children","items"];for(const z of $)if(Array.isArray(N[z]))for(const q of N[z])q.id&&Array.isArray(q.cells)?a.push(q):a=a.concat(M(q,P+1));return N.view&&(a=a.concat(M(N.view,P+1))),a};let T=M(C);if(T.length===0&&(C!=null&&C.views)){const N=C.views.find(P=>P.type==="table");N&&(C=await Mt(b,N.id),T=M(C))}if(T.length===0)return[];let E=(((s=C.view)==null?void 0:s.columns)||C.columns||[]).findIndex(N=>N.id===I.id),U=[],R=0;for(const N of T){let P=!1;if(E>=0&&N.cells&&N.cells[E]){const a=N.cells[E].value;a!=null&&a.mSelect?P=a.mSelect.some($=>$.content===n):a!=null&&a.select&&(P=a.select.content===n)}else if(N.cells&&Array.isArray(N.cells))for(const a of N.cells){const $=a.value;if((c=$==null?void 0:$.mSelect)!=null&&c.some(z=>z.content===n)){P=!0;break}else if(((u=$==null?void 0:$.select)==null?void 0:u.content)===n){P=!0;break}}if(P){const a={mSelect:[{content:j.name,color:j.color}]};await Bn(b,I.id,N.id,a),U.push(N.id),R++}}return R>0&&_t(`[${t.name}] 已归档 ${R} 个任务`),U}catch(m){return console.error("Status switch failed:",m),o&&Xe(`[${t.name}] 出错: `+m.message),[]}}async function tl(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let l=0;for(const o of n)try{const s=await Be(`SELECT id FROM blocks WHERE content LIKE '%${o.keyword}%' AND type = 'd' LIMIT 1`);if(!s||s.length===0)continue;const c=s[0].id,u=await Be(`SELECT id, markdown FROM blocks WHERE root_id = '${c}' AND type = 'av' LIMIT 1`);if(!u||u.length===0)continue;const h=u[0].markdown.match(/data-av-id="([^"]+)"/);if(!h)continue;const r=h[1],v=await Pt(r);if(!v)continue;let _=null,p=null;for(const w of v)if((w.type==="select"||w.type==="mSelect")&&w.options){const I=w.options.find(B=>B.name===o.completedStatus);if(I){_=w,p=I;break}}if(!_||!p)continue;const b={mSelect:[{content:p.name,color:p.color}]};for(const w of t)await Bn(r,_.id,w,b);l+=t.length}catch(s){console.warn("Restore attempted failed for profile",o.name,s)}return l>0?(_t("已尝试撤销恢复任务"),!0):!1}async function nl(e,t=!1){const n=e.config.profiles||[];let l=[];if(n.length===0)return t&&Xe("未配置任何归档规则，请在设置中添加"),[];for(const o of n){if(!o.keyword||o.enabled===!1)continue;const s=await el(e,o,o.completedStatus,o.archivedStatus,t);l=l.concat(s)}return l}let wt=null;function ll(e){wt=e}function S(e,t){let n=null;if(wt&&wt.i18n&&(n=wt.i18n),!n)try{const{i18n:s}=require("siyuan");n=s}catch(s){console.warn("无法获取i18n对象:",s)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let l=n;const o=e.split(".");for(const s of o)if(l&&typeof l=="object"&&s in l)l=l[s];else{l=void 0;break}return typeof l!="string"&&(console.warn("未找到i18n键:",e),l=e),l}function Qe(){}function Pn(e){return e()}function nn(){return Object.create(null)}function Pe(e){e.forEach(Pn)}function On(e){return typeof e=="function"}function il(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function ol(e){return Object.keys(e).length===0}function i(e,t){e.appendChild(t)}function se(e,t,n){e.insertBefore(t,n||null)}function le(e){e.parentNode&&e.parentNode.removeChild(e)}function rt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function f(e){return document.createElement(e)}function pe(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Y(e){return document.createTextNode(e)}function y(){return Y(" ")}function sl(){return Y("")}function W(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function St(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function d(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function je(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function al(e){return Array.from(e.childNodes)}function ze(e,t){t=""+t,e.data!==t&&(e.data=t)}function Z(e,t){e.value=t??""}function k(e,t,n,l){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function yt(e,t,n){for(let l=0;l<e.options.length;l+=1){const o=e.options[l];if(o.__value===t){o.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function ln(e){const t=e.querySelector(":checked");return t&&t.__value}function Fe(e,t,n){e.classList.toggle(t,!!n)}let gt;function mt(e){gt=e}function cl(){if(!gt)throw new Error("Function called outside component initialization");return gt}function rl(e){cl().$$.on_mount.push(e)}function ul(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(l=>l.call(this,t))}const st=[],on=[];let ct=[];const sn=[],dl=Promise.resolve();let Lt=!1;function fl(){Lt||(Lt=!0,dl.then(Un))}function vt(e){ct.push(e)}const Nt=new Set;let it=0;function Un(){if(it!==0)return;const e=gt;do{try{for(;it<st.length;){const t=st[it];it++,mt(t),pl(t.$$)}}catch(t){throw st.length=0,it=0,t}for(mt(null),st.length=0,it=0;on.length;)on.pop()();for(let t=0;t<ct.length;t+=1){const n=ct[t];Nt.has(n)||(Nt.add(n),n())}ct.length=0}while(st.length);for(;sn.length;)sn.pop()();Lt=!1,Nt.clear(),mt(e)}function pl(e){if(e.fragment!==null){e.update(),Pe(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(vt)}}function hl(e){const t=[],n=[];ct.forEach(l=>e.indexOf(l)===-1?t.push(l):n.push(l)),n.forEach(l=>l()),ct=t}const ml=new Set;function Kn(e,t){e&&e.i&&(ml.delete(e),e.i(t))}function he(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function $t(e,t){e.d(1),t.delete(e.key)}function xt(e,t,n,l,o,s,c,u,m,h,r,v){let _=e.length,p=s.length,b=_;const w={};for(;b--;)w[e[b].key]=b;const I=[],B=new Map,j=new Map,O=[];for(b=p;b--;){const T=v(o,s,b),x=n(T);let E=c.get(x);E?O.push(()=>E.p(T,t)):(E=h(x,T),E.c()),B.set(x,I[b]=E),x in w&&j.set(x,Math.abs(b-w[x]))}const D=new Set,C=new Set;function M(T){Kn(T,1),T.m(u,r),c.set(T.key,T),r=T.first,p--}for(;_&&p;){const T=I[p-1],x=e[_-1],E=T.key,U=x.key;T===x?(r=T.first,_--,p--):B.has(U)?!c.has(E)||D.has(E)?M(T):C.has(U)?_--:j.get(E)>j.get(U)?(C.add(E),M(T)):(D.add(U),_--):(m(x,c),_--)}for(;_--;){const T=e[_];B.has(T.key)||m(T,c)}for(;p;)M(I[p-1]);return Pe(O),I}function gl(e,t,n){const{fragment:l,after_update:o}=e.$$;l&&l.m(t,n),vt(()=>{const s=e.$$.on_mount.map(Pn).filter(On);e.$$.on_destroy?e.$$.on_destroy.push(...s):Pe(s),e.$$.on_mount=[]}),o.forEach(vt)}function vl(e,t){const n=e.$$;n.fragment!==null&&(hl(n.after_update),Pe(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function _l(e,t){e.$$.dirty[0]===-1&&(st.push(e),fl(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function kl(e,t,n,l,o,s,c=null,u=[-1]){const m=gt;mt(e);const h=e.$$={fragment:null,ctx:[],props:s,update:Qe,not_equal:o,bound:nn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(m?m.$$.context:[])),callbacks:nn(),dirty:u,skip_bound:!1,root:t.target||m.$$.root};c&&c(h.root);let r=!1;if(h.ctx=n?n(e,t.props||{},(v,_,...p)=>{const b=p.length?p[0]:_;return h.ctx&&o(h.ctx[v],h.ctx[v]=b)&&(!h.skip_bound&&h.bound[v]&&h.bound[v](b),r&&_l(e,v)),_}):[],h.update(),r=!0,Pe(h.before_update),h.fragment=l?l(h.ctx):!1,t.target){if(t.hydrate){const v=al(t.target);h.fragment&&h.fragment.l(v),v.forEach(le)}else h.fragment&&h.fragment.c();t.intro&&Kn(e.$$.fragment),gl(e,t.target,t.anchor),Un()}mt(m)}class bl{constructor(){Ve(this,"$$");Ve(this,"$$set")}$destroy(){vl(this,1),this.$destroy=Qe}$on(t,n){if(!On(n))return Qe;const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(n),()=>{const o=l.indexOf(n);o!==-1&&l.splice(o,1)}}$set(t){this.$$set&&!ol(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const yl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(yl);function an(e,t,n){const l=e.slice();return l[57]=t[n],l[58]=t,l[59]=n,l}function cn(e,t,n){const l=e.slice();return l[60]=t[n],l[61]=t,l[62]=n,l}function rn(e,t,n){const l=e.slice();return l[63]=t[n],l}function un(e,t,n){const l=e.slice();return l[63]=t[n],l}function dn(e,t,n){const l=e.slice();return l[68]=t[n],l}function fn(e,t,n){const l=e.slice();return l[71]=t[n],l}function pn(e,t,n){const l=e.slice();return l[74]=t[n],l[75]=t,l[76]=n,l}function hn(e,t,n){const l=e.slice();return l[77]=t[n],l}function mn(e,t,n){const l=e.slice();return l[80]=t[n],l}function gn(e){let t,n,l;return{c(){t=f("div"),d(t,"class","backdrop svelte-1plhmm3")},m(o,s){se(o,t,s),n||(l=W(t,"click",e[27]),n=!0)},p:Qe,d(o){o&&le(t),n=!1,l()}}}function vn(e){let t,n,l,o,s,c,u=he(e[9]),m=[];for(let v=0;v<u.length;v+=1)m[v]=_n(mn(e,u,v));let h=he(e[10]),r=[];for(let v=0;v<h.length;v+=1)r[v]=kn(hn(e,h,v));return{c(){t=f("div"),n=f("div");for(let v=0;v<m.length;v+=1)m[v].c();l=y(),o=f("div"),s=y(),c=f("div");for(let v=0;v<r.length;v+=1)r[v].c();d(n,"class","time-col svelte-1plhmm3"),k(o,"width","1px"),k(o,"background","var(--b3-theme-surface-lighter)"),d(c,"class","time-col svelte-1plhmm3"),d(t,"class","time-picker-popover svelte-1plhmm3")},m(v,_){se(v,t,_),i(t,n);for(let p=0;p<m.length;p+=1)m[p]&&m[p].m(n,null);i(t,l),i(t,o),i(t,s),i(t,c);for(let p=0;p<r.length;p+=1)r[p]&&r[p].m(c,null)},p(v,_){if(_[0]&33284){u=he(v[9]);let p;for(p=0;p<u.length;p+=1){const b=mn(v,u,p);m[p]?m[p].p(b,_):(m[p]=_n(b),m[p].c(),m[p].m(n,null))}for(;p<m.length;p+=1)m[p].d(1);m.length=u.length}if(_[0]&66564){h=he(v[10]);let p;for(p=0;p<h.length;p+=1){const b=hn(v,h,p);r[p]?r[p].p(b,_):(r[p]=kn(b),r[p].c(),r[p].m(c,null))}for(;p<r.length;p+=1)r[p].d(1);r.length=h.length}},d(v){v&&le(t),rt(m,v),rt(r,v)}}}function _n(e){let t,n=e[80]+"",l,o,s,c;function u(){return e[30](e[80])}return{c(){t=f("div"),l=Y(n),o=y(),d(t,"id",`time-opt-h-${e[80]}`),d(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].startsWith(e[80]))},m(m,h){se(m,t,h),i(t,l),i(t,o),s||(c=W(t,"click",u),s=!0)},p(m,h){e=m,h[0]&516&&Fe(t,"selected",e[2].startsWith(e[80]))},d(m){m&&le(t),s=!1,c()}}}function kn(e){let t,n=e[77]+"",l,o,s,c;function u(){return e[31](e[77])}return{c(){t=f("div"),l=Y(n),o=y(),d(t,"id",`time-opt-m-${e[77]}`),d(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].endsWith(e[77]))},m(m,h){se(m,t,h),i(t,l),i(t,o),s||(c=W(t,"click",u),s=!0)},p(m,h){e=m,h[0]&1028&&Fe(t,"selected",e[2].endsWith(e[77]))},d(m){m&&le(t),s=!1,c()}}}function bn(e){let t,n=e[74].keyword+"",l;return{c(){t=f("span"),l=Y(n),d(t,"class","tag-preview svelte-1plhmm3")},m(o,s){se(o,t,s),i(t,l)},p(o,s){s[0]&2&&n!==(n=o[74].keyword+"")&&ze(l,n)},d(o){o&&le(t)}}}function yn(e){let t,n,l,o,s,c,u,m,h,r,v,_,p,b,w,I,B,j,O,D,C,M,T;function x(){e[35].call(s,e[75],e[76])}function E(){e[36].call(r,e[75],e[76])}function U(){e[37].call(I,e[75],e[76])}function R(){e[38].call(C,e[75],e[76])}return{c(){t=f("div"),n=f("div"),l=f("div"),l.textContent=`${S("ruleNameLabel")}`,o=y(),s=f("input"),c=y(),u=f("div"),m=f("div"),m.textContent=`${S("keywordLabel")}`,h=y(),r=f("input"),v=y(),_=f("div"),p=f("div"),b=f("div"),b.textContent=`${S("completedStatusLabel")}`,w=y(),I=f("input"),B=y(),j=f("div"),O=f("div"),O.textContent=`${S("archivedStatusLabel")}`,D=y(),C=f("input"),d(l,"class","input-label svelte-1plhmm3"),d(s,"class","modern-input svelte-1plhmm3"),d(s,"type","text"),d(s,"placeholder",S("ruleNamePlaceholder")),d(n,"class","input-group svelte-1plhmm3"),d(m,"class","input-label svelte-1plhmm3"),d(r,"class","modern-input svelte-1plhmm3"),d(r,"type","text"),d(r,"placeholder",S("keywordPlaceholder")),d(u,"class","input-group svelte-1plhmm3"),d(b,"class","input-label svelte-1plhmm3"),d(I,"class","modern-input svelte-1plhmm3"),d(I,"type","text"),d(I,"placeholder",S("completedStatusPlaceholder")),d(p,"class","input-group fn__flex-1 svelte-1plhmm3"),d(O,"class","input-label svelte-1plhmm3"),d(C,"class","modern-input svelte-1plhmm3"),d(C,"type","text"),d(C,"placeholder",S("archivedStatusPlaceholder")),d(j,"class","input-group fn__flex-1 svelte-1plhmm3"),d(_,"class","fn__flex svelte-1plhmm3"),k(_,"gap","20px"),d(t,"class","card-content svelte-1plhmm3")},m(N,P){se(N,t,P),i(t,n),i(n,l),i(n,o),i(n,s),Z(s,e[74].name),i(t,c),i(t,u),i(u,m),i(u,h),i(u,r),Z(r,e[74].keyword),i(t,v),i(t,_),i(_,p),i(p,b),i(p,w),i(p,I),Z(I,e[74].completedStatus),i(_,B),i(_,j),i(j,O),i(j,D),i(j,C),Z(C,e[74].archivedStatus),M||(T=[W(s,"input",x),W(s,"change",e[11]),W(r,"input",E),W(r,"change",e[11]),W(I,"input",U),W(I,"change",e[11]),W(C,"input",R),W(C,"change",e[11])],M=!0)},p(N,P){e=N,P[0]&2&&s.value!==e[74].name&&Z(s,e[74].name),P[0]&2&&r.value!==e[74].keyword&&Z(r,e[74].keyword),P[0]&2&&I.value!==e[74].completedStatus&&Z(I,e[74].completedStatus),P[0]&2&&C.value!==e[74].archivedStatus&&Z(C,e[74].archivedStatus)},d(N){N&&le(t),M=!1,Pe(T)}}}function wn(e,t){let n,l,o,s,c,u,m=(t[74].name||S("unnamedRule"))+"",h,r,v,_,p,b,w,I,B,j,O,D,C,M,T=t[74].keyword&&bn(t);function x(){t[32].call(b,t[75],t[76])}function E(){return t[33](t[74])}function U(){return t[34](t[74])}let R=t[3]===t[74].id&&yn(t);return{key:e,first:null,c(){n=f("div"),l=f("div"),o=f("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),c=f("div"),u=f("span"),h=Y(m),r=y(),T&&T.c(),v=y(),_=f("div"),p=f("label"),b=f("input"),w=y(),I=f("span"),I.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',j=y(),O=f("div"),O.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',D=y(),R&&R.c(),d(o,"class","chevron svelte-1plhmm3"),k(u,"font-weight","600"),k(u,"font-size","15px"),k(u,"color","var(--b3-theme-on-surface)"),d(c,"class","fn__flex-1 svelte-1plhmm3"),k(c,"margin-left","14px"),k(c,"display","flex"),k(c,"align-items","center"),d(b,"class","switch-input svelte-1plhmm3"),d(b,"type","checkbox"),d(I,"class","switch-track svelte-1plhmm3"),d(p,"class","switch-container svelte-1plhmm3"),d(p,"title",B=t[74].enabled?S("enabled"):S("disabled")),d(_,"class","fn__flex-center"),k(_,"margin-right","20px"),d(O,"class","icon-btn svelte-1plhmm3"),d(O,"title",S("deleteRule")),d(l,"class","card-header svelte-1plhmm3"),d(n,"class","card svelte-1plhmm3"),k(n,"opacity",t[74].enabled?1:.75),Fe(n,"expanded",t[3]===t[74].id),this.first=n},m(N,P){se(N,n,P),i(n,l),i(l,o),i(l,s),i(l,c),i(c,u),i(u,h),i(c,r),T&&T.m(c,null),i(l,v),i(l,_),i(_,p),i(p,b),b.checked=t[74].enabled,i(p,w),i(p,I),i(l,j),i(l,O),i(n,D),R&&R.m(n,null),C||(M=[W(b,"change",x),W(b,"change",t[11]),W(_,"click",St(t[26])),W(O,"click",St(E)),W(l,"click",U)],C=!0)},p(N,P){t=N,P[0]&2&&m!==(m=(t[74].name||S("unnamedRule"))+"")&&ze(h,m),t[74].keyword?T?T.p(t,P):(T=bn(t),T.c(),T.m(c,null)):T&&(T.d(1),T=null),P[0]&2&&(b.checked=t[74].enabled),P[0]&2&&B!==(B=t[74].enabled?S("enabled"):S("disabled"))&&d(p,"title",B),t[3]===t[74].id?R?R.p(t,P):(R=yn(t),R.c(),R.m(n,null)):R&&(R.d(1),R=null),P[0]&2&&k(n,"opacity",t[74].enabled?1:.75),P[0]&10&&Fe(n,"expanded",t[3]===t[74].id)},d(N){N&&le(n),T&&T.d(),R&&R.d(),C=!1,Pe(M)}}}function In(e){let t;return{c(){t=f("div"),t.textContent=`${S("noRulesTip")}`,k(t,"text-align","center"),k(t,"padding","48px"),k(t,"color","var(--b3-theme-on-surface-light)"),k(t,"border","2px dashed var(--b3-border-color)"),k(t,"border-radius","16px")},m(n,l){se(n,t,l)},d(n){n&&le(t)}}}function Sn(e){let t,n,l,o,s,c,u,m,h,r,v,_,p,b,w,I,B,j,O,D,C,M,T,x,E,U,R,N,P,a,$,z,q,X,ie,_e,te,ae,ne,Ae,De,$e,me,we,ke,V,ge,H,Q,oe,ce,Ce,ee=[],Ge=new Map,We,Oe,ue,Ie,g;function A(){e[42].call(s,e[58],e[59])}function de(){e[43].call(r,e[58],e[59])}let Ee=he(e[1]),ve=[];for(let K=0;K<Ee.length;K+=1)ve[K]=Tn(fn(e,Ee,K));let be=e[1].length===0&&An(),He=he(e[6]),re=[];for(let K=0;K<He.length;K+=1)re[K]=Dn(dn(e,He,K));function ut(){e[45].call(U,e[58],e[59])}function xe(){e[46].call(z,e[58],e[59])}function qe(){e[47].call(ae,e[58],e[59])}function dt(){e[48].call(V,e[58],e[59])}function ft(K,G){return(K[7][K[57].id]||[]).length===0?Il:wl}let Ze=ft(e),Re=Ze(e),Je=he(e[57].sections);const Ye=K=>K[60].id;for(let K=0;K<Je.length;K+=1){let G=cn(e,Je,K),L=Ye(G);Ge.set(L,ee[K]=Rn(L,G))}function Me(){return e[52](e[57])}return{c(){t=f("div"),n=f("div"),l=f("div"),l.textContent=`${S("templateNameLabel")}`,o=y(),s=f("input"),c=y(),u=f("div"),m=f("div"),m.textContent=`${S("templatePeriodLabel")}`,h=y(),r=f("select"),v=f("option"),v.textContent=`${S("templatePeriod_none")}`,_=f("option"),_.textContent=`${S("templatePeriod_day")}`,p=f("option"),p.textContent=`${S("templatePeriod_week")}`,b=f("option"),b.textContent=`${S("templatePeriod_month")}`,w=f("option"),w.textContent=`${S("templatePeriod_year")}`,I=y(),B=f("div"),j=f("div"),j.textContent=`${S("templateRuleLabel")}`,O=y(),D=f("div");for(let K=0;K<ve.length;K+=1)ve[K].c();C=y(),be&&be.c(),M=y(),T=f("div"),x=f("div"),x.textContent=`${S("templateNotebookLabel")}`,E=y(),U=f("select"),R=f("option"),R.textContent=`${S("templateNotebookAuto")}`;for(let K=0;K<re.length;K+=1)re[K].c();N=y(),P=f("div"),a=f("div"),a.textContent=`${S("templatePathLabel")}`,$=y(),z=f("input"),q=y(),X=f("div"),ie=f("div"),ie.textContent=`${S("reportClipboardOnlySections")}`,_e=y(),te=f("label"),ae=f("input"),ne=y(),Ae=f("span"),Ae.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',$e=y(),me=f("div"),we=f("div"),we.textContent=`${S("templateTitleLabel")}`,ke=y(),V=f("input"),ge=y(),H=f("div"),Q=f("div"),Q.textContent=`${S("templateSectionList")}`,oe=y(),ce=f("div"),Re.c(),Ce=y();for(let K=0;K<ee.length;K+=1)ee[K].c();We=y(),Oe=f("div"),ue=f("button"),ue.textContent=`${S("templateSectionAdd")}`,d(l,"class","input-label svelte-1plhmm3"),d(s,"class","modern-input svelte-1plhmm3"),d(s,"type","text"),d(n,"class","input-group svelte-1plhmm3"),d(m,"class","input-label svelte-1plhmm3"),v.__value="none",Z(v,v.__value),_.__value="day",Z(_,_.__value),p.__value="week",Z(p,p.__value),b.__value="month",Z(b,b.__value),w.__value="year",Z(w,w.__value),d(r,"class","modern-input svelte-1plhmm3"),e[57].period===void 0&&vt(de),d(u,"class","input-group svelte-1plhmm3"),d(j,"class","input-label svelte-1plhmm3"),d(D,"class","fn__flex svelte-1plhmm3"),k(D,"flex-wrap","wrap"),k(D,"gap","12px"),d(B,"class","input-group svelte-1plhmm3"),d(x,"class","input-label svelte-1plhmm3"),R.__value="",Z(R,R.__value),d(U,"class","modern-input svelte-1plhmm3"),e[57].notebookId===void 0&&vt(ut),d(T,"class","input-group svelte-1plhmm3"),d(a,"class","input-label svelte-1plhmm3"),d(z,"class","modern-input svelte-1plhmm3"),d(z,"type","text"),d(z,"placeholder",S("templatePathPlaceholder")),d(P,"class","input-group svelte-1plhmm3"),d(ie,"class","input-label svelte-1plhmm3"),d(ae,"class","switch-input svelte-1plhmm3"),d(ae,"type","checkbox"),d(Ae,"class","switch-track svelte-1plhmm3"),d(te,"class","switch-container svelte-1plhmm3"),d(te,"title",De=e[57].clipboardOnlySections?S("enabled"):S("disabled")),d(X,"class","input-group svelte-1plhmm3"),d(we,"class","input-label svelte-1plhmm3"),d(V,"class","modern-input svelte-1plhmm3"),d(V,"type","text"),d(V,"placeholder",S("templateTitlePlaceholder")),d(me,"class","input-group svelte-1plhmm3"),d(Q,"class","input-label svelte-1plhmm3"),d(ce,"class","fn__flex svelte-1plhmm3"),k(ce,"flex-wrap","wrap"),k(ce,"gap","8px"),k(ce,"margin-bottom","8px"),d(ue,"class","action-btn svelte-1plhmm3"),k(ue,"width","132px"),k(ue,"justify-content","center"),d(Oe,"class","fn__flex svelte-1plhmm3"),k(Oe,"justify-content","flex-start"),d(H,"class","input-group svelte-1plhmm3"),d(t,"class","card-content svelte-1plhmm3")},m(K,G){se(K,t,G),i(t,n),i(n,l),i(n,o),i(n,s),Z(s,e[57].name),i(t,c),i(t,u),i(u,m),i(u,h),i(u,r),i(r,v),i(r,_),i(r,p),i(r,b),i(r,w),yt(r,e[57].period,!0),i(t,I),i(t,B),i(B,j),i(B,O),i(B,D);for(let L=0;L<ve.length;L+=1)ve[L]&&ve[L].m(D,null);i(D,C),be&&be.m(D,null),i(t,M),i(t,T),i(T,x),i(T,E),i(T,U),i(U,R);for(let L=0;L<re.length;L+=1)re[L]&&re[L].m(U,null);yt(U,e[57].notebookId,!0),i(t,N),i(t,P),i(P,a),i(P,$),i(P,z),Z(z,e[57].pathTemplate),i(t,q),i(t,X),i(X,ie),i(X,_e),i(X,te),i(te,ae),ae.checked=e[57].clipboardOnlySections,i(te,ne),i(te,Ae),i(t,$e),i(t,me),i(me,we),i(me,ke),i(me,V),Z(V,e[57].titleTemplate),i(t,ge),i(t,H),i(H,Q),i(H,oe),i(H,ce),Re.m(ce,null),i(H,Ce);for(let L=0;L<ee.length;L+=1)ee[L]&&ee[L].m(H,null);i(H,We),i(H,Oe),i(Oe,ue),Ie||(g=[W(s,"input",A),W(s,"change",e[11]),W(r,"change",de),W(r,"change",e[11]),W(U,"change",ut),W(U,"change",e[11]),W(z,"input",xe),W(z,"change",e[11]),W(ae,"change",qe),W(ae,"change",e[11]),W(V,"input",dt),W(V,"change",e[11]),W(ue,"click",Me)],Ie=!0)},p(K,G){if(e=K,G[0]&16&&s.value!==e[57].name&&Z(s,e[57].name),G[0]&16&&yt(r,e[57].period),G[0]&4194322){Ee=he(e[1]);let L;for(L=0;L<Ee.length;L+=1){const fe=fn(e,Ee,L);ve[L]?ve[L].p(fe,G):(ve[L]=Tn(fe),ve[L].c(),ve[L].m(D,C))}for(;L<ve.length;L+=1)ve[L].d(1);ve.length=Ee.length}if(e[1].length===0?be||(be=An(),be.c(),be.m(D,null)):be&&(be.d(1),be=null),G[0]&64){He=he(e[6]);let L;for(L=0;L<He.length;L+=1){const fe=dn(e,He,L);re[L]?re[L].p(fe,G):(re[L]=Dn(fe),re[L].c(),re[L].m(U,null))}for(;L<re.length;L+=1)re[L].d(1);re.length=He.length}G[0]&16&&yt(U,e[57].notebookId),G[0]&16&&z.value!==e[57].pathTemplate&&Z(z,e[57].pathTemplate),G[0]&16&&(ae.checked=e[57].clipboardOnlySections),G[0]&16&&De!==(De=e[57].clipboardOnlySections?S("enabled"):S("disabled"))&&d(te,"title",De),G[0]&16&&V.value!==e[57].titleTemplate&&Z(V,e[57].titleTemplate),Ze===(Ze=ft(e))&&Re?Re.p(e,G):(Re.d(1),Re=Ze(e),Re&&(Re.c(),Re.m(ce,null))),G[0]&50333840&&(Je=he(e[57].sections),ee=xt(ee,G,Ye,1,e,Je,Ge,H,$t,Rn,We,cn))},d(K){K&&le(t),rt(ve,K),be&&be.d(),rt(re,K),Re.d();for(let G=0;G<ee.length;G+=1)ee[G].d();Ie=!1,Pe(g)}}}function Tn(e){let t,n,l,o,s,c=(e[71].name||e[71].keyword||e[71].id)+"",u,m,h;function r(){return e[44](e[57],e[71])}return{c(){var v;t=f("label"),n=f("input"),o=y(),s=f("span"),u=Y(c),d(n,"type","checkbox"),n.checked=l=(v=e[57].ruleIds)==null?void 0:v.includes(e[71].id),k(s,"font-size","13px"),d(t,"class","fn__flex svelte-1plhmm3"),k(t,"align-items","center"),k(t,"gap","6px"),k(t,"padding","6px 10px"),k(t,"border","1px solid var(--b3-border-color)"),k(t,"border-radius","999px"),k(t,"background","var(--b3-theme-background)")},m(v,_){se(v,t,_),i(t,n),i(t,o),i(t,s),i(s,u),m||(h=W(n,"change",r),m=!0)},p(v,_){var p;e=v,_[0]&18&&l!==(l=(p=e[57].ruleIds)==null?void 0:p.includes(e[71].id))&&(n.checked=l),_[0]&2&&c!==(c=(e[71].name||e[71].keyword||e[71].id)+"")&&ze(u,c)},d(v){v&&le(t),m=!1,h()}}}function An(e){let t;return{c(){t=f("div"),t.textContent=`${S("reportNoProfileTip")}`,k(t,"font-size","13px"),k(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){se(n,t,l)},d(n){n&&le(t)}}}function Dn(e){let t,n=e[68].name+"",l,o;return{c(){t=f("option"),l=Y(n),t.__value=o=e[68].id,Z(t,t.__value)},m(s,c){se(s,t,c),i(t,l)},p(s,c){c[0]&64&&n!==(n=s[68].name+"")&&ze(l,n),c[0]&64&&o!==(o=s[68].id)&&(t.__value=o,Z(t,t.__value))},d(s){s&&le(t)}}}function wl(e){let t,n=he(e[7][e[57].id]),l=[];for(let o=0;o<n.length;o+=1)l[o]=Cn(un(e,n,o));return{c(){for(let o=0;o<l.length;o+=1)l[o].c();t=sl()},m(o,s){for(let c=0;c<l.length;c+=1)l[c]&&l[c].m(o,s);se(o,t,s)},p(o,s){if(s[0]&144){n=he(o[7][o[57].id]);let c;for(c=0;c<n.length;c+=1){const u=un(o,n,c);l[c]?l[c].p(u,s):(l[c]=Cn(u),l[c].c(),l[c].m(t.parentNode,t))}for(;c<l.length;c+=1)l[c].d(1);l.length=n.length}},d(o){o&&le(t),rt(l,o)}}}function Il(e){let t;return{c(){t=f("div"),t.textContent=`${S("templateStatusEmpty")}`,k(t,"font-size","13px"),k(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){se(n,t,l)},p:Qe,d(n){n&&le(t)}}}function Cn(e){let t,n=e[63]+"",l;return{c(){t=f("span"),l=Y(n),d(t,"class","tag-preview svelte-1plhmm3")},m(o,s){se(o,t,s),i(t,l)},p(o,s){s[0]&144&&n!==(n=o[63]+"")&&ze(l,n)},d(o){o&&le(t)}}}function En(e){let t,n,l,o,s,c=e[63]+"",u,m,h,r;function v(){return e[50](e[60],e[63])}return{c(){t=f("label"),n=f("input"),o=y(),s=f("span"),u=Y(c),m=y(),d(n,"class","dot-check svelte-1plhmm3"),d(n,"type","checkbox"),n.checked=l=(e[60].statuses||[]).includes(e[63]),k(s,"font-size","12px"),d(t,"class","fn__flex status-dot svelte-1plhmm3"),k(t,"align-items","center"),k(t,"gap","6px"),k(t,"padding","4px 8px"),k(t,"border","1px solid var(--b3-border-color)"),k(t,"border-radius","999px"),k(t,"background","var(--b3-theme-background)")},m(_,p){se(_,t,p),i(t,n),i(t,o),i(t,s),i(s,u),i(t,m),h||(r=W(n,"change",v),h=!0)},p(_,p){e=_,p[0]&144&&l!==(l=(e[60].statuses||[]).includes(e[63]))&&(n.checked=l),p[0]&144&&c!==(c=e[63]+"")&&ze(u,c)},d(_){_&&le(t),h=!1,r()}}}function Rn(e,t){let n,l,o,s,c,u,m,h,r,v,_,p,b,w,I,B;function j(){t[49].call(u,t[61],t[62])}let O=he(t[7][t[57].id]||[]),D=[];for(let M=0;M<O.length;M+=1)D[M]=En(rn(t,O,M));function C(){return t[51](t[57],t[60])}return{key:e,first:null,c(){n=f("div"),l=f("div"),o=f("div"),s=f("div"),s.textContent=`${S("templateSectionTitleLabel")}`,c=y(),u=f("input"),m=y(),h=f("div"),r=f("div"),r.textContent=`${S("templateSectionStatusLabel")}`,v=y(),_=f("div");for(let M=0;M<D.length;M+=1)D[M].c();p=y(),b=f("div"),w=f("div"),w.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',d(s,"class","input-label svelte-1plhmm3"),d(u,"class","modern-input svelte-1plhmm3"),d(u,"type","text"),d(o,"class","input-group svelte-1plhmm3"),d(r,"class","input-label svelte-1plhmm3"),d(_,"class","fn__flex svelte-1plhmm3"),k(_,"flex-wrap","wrap"),k(_,"gap","10px"),d(h,"class","input-group svelte-1plhmm3"),d(w,"class","icon-btn svelte-1plhmm3"),d(w,"title",S("templateSectionDelete")),d(b,"class","fn__flex svelte-1plhmm3"),k(b,"justify-content","flex-end"),d(l,"class","card-content svelte-1plhmm3"),d(n,"class","card svelte-1plhmm3"),k(n,"margin-bottom","12px"),this.first=n},m(M,T){se(M,n,T),i(n,l),i(l,o),i(o,s),i(o,c),i(o,u),Z(u,t[60].title),i(l,m),i(l,h),i(h,r),i(h,v),i(h,_);for(let x=0;x<D.length;x+=1)D[x]&&D[x].m(_,null);i(l,p),i(l,b),i(b,w),I||(B=[W(u,"input",j),W(u,"change",t[11]),W(w,"click",C)],I=!0)},p(M,T){if(t=M,T[0]&16&&u.value!==t[60].title&&Z(u,t[60].title),T[0]&33554576){O=he(t[7][t[57].id]||[]);let x;for(x=0;x<O.length;x+=1){const E=rn(t,O,x);D[x]?D[x].p(E,T):(D[x]=En(E),D[x].c(),D[x].m(_,null))}for(;x<D.length;x+=1)D[x].d(1);D.length=O.length}},d(M){M&&le(n),rt(D,M),I=!1,Pe(B)}}}function Nn(e,t){let n,l,o,s,c,u,m=t[57].name+"",h,r,v,_=S(`templatePeriod_${t[57].period||"none"}`)+"",p,b,w,I,B,j,O,D,C;function M(){return t[39](t[57])}function T(){return t[40](t[57])}function x(){return t[41](t[57])}let E=t[5]===t[57].id&&Sn(t);return{key:e,first:null,c(){n=f("div"),l=f("div"),o=f("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),c=f("div"),u=f("span"),h=Y(m),r=y(),v=f("span"),p=Y(_),b=y(),w=f("button"),w.textContent=`${S("templateGenerate")}`,I=y(),B=f("div"),B.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',j=y(),E&&E.c(),O=y(),d(o,"class","chevron svelte-1plhmm3"),k(u,"font-weight","600"),k(u,"font-size","15px"),k(u,"color","var(--b3-theme-on-surface)"),d(v,"class","tag-preview svelte-1plhmm3"),d(c,"class","fn__flex-1 svelte-1plhmm3"),k(c,"margin-left","14px"),k(c,"display","flex"),k(c,"align-items","center"),d(w,"class","action-btn svelte-1plhmm3"),k(w,"height","28px"),k(w,"padding","0 12px"),k(w,"margin-right","8px"),d(B,"class","icon-btn svelte-1plhmm3"),d(B,"title",S("deleteRule")),d(l,"class","card-header svelte-1plhmm3"),d(n,"class","card svelte-1plhmm3"),Fe(n,"expanded",t[5]===t[57].id),this.first=n},m(U,R){se(U,n,R),i(n,l),i(l,o),i(l,s),i(l,c),i(c,u),i(u,h),i(c,r),i(c,v),i(v,p),i(l,b),i(l,w),i(l,I),i(l,B),i(n,j),E&&E.m(n,null),i(n,O),D||(C=[W(w,"click",St(M)),W(B,"click",St(T)),W(l,"click",x)],D=!0)},p(U,R){t=U,R[0]&16&&m!==(m=t[57].name+"")&&ze(h,m),R[0]&16&&_!==(_=S(`templatePeriod_${t[57].period||"none"}`)+"")&&ze(p,_),t[5]===t[57].id?E?E.p(t,R):(E=Sn(t),E.c(),E.m(n,O)):E&&(E.d(1),E=null),R[0]&48&&Fe(n,"expanded",t[5]===t[57].id)},d(U){U&&le(n),E&&E.d(),D=!1,Pe(C)}}}function Sl(e){let t,n,l,o,s,c,u,m=S("globalArchiveTime")+"",h,r,v,_,p,b,w,I,B=S("undoArchive")+"",j,O,D,C,M,T,x=S("archiveNow")+"",E,U,R,N,P,a,$,z,q,X,ie,_e,te,ae,ne,Ae=S("archiveRuleList")+"",De,$e,me,we,ke,V,ge,H,Q=S("addRule")+"",oe,ce,Ce,ee=[],Ge=new Map,We,Oe,ue,Ie,g,A,de,Ee,ve=S("templateListTitle")+"",be,He,re,ut,xe,qe,dt,ft,Ze=S("templateAdd")+"",Re,Je,Ye,Me=[],K=new Map,G,L,fe,pt,Tt,Ut,Wn=S("usageTipTitle")+"",Kt,Ft,Ue,et,At,Wt,Hn=S("usageTipGlobalDesc")+"",Ht,Vt,tt,Dt,jt,Vn=S("usageTipMatchDesc")+"",zt,qt,nt,Ct,Yt,jn=S("usageTipStatusDesc")+"",Xt,Gt,lt,Et,Jt,zn=S("usageTipReportDesc")+"",Qt,Rt,Zt,Se=e[8]&&gn(e),Te=e[8]&&vn(e),kt=he(e[1]);const en=F=>F[74].id;for(let F=0;F<kt.length;F+=1){let J=pn(e,kt,F),ye=en(J);Ge.set(ye,ee[F]=wn(ye,J))}let Ne=e[1].length===0&&In(),bt=he(e[4]);const tn=F=>F[57].id;for(let F=0;F<bt.length;F+=1){let J=an(e,bt,F),ye=tn(J);K.set(ye,Me[F]=Nn(ye,J))}return{c(){Se&&Se.c(),t=y(),n=f("div"),l=f("div"),o=f("div"),s=pe("svg"),c=pe("use"),u=y(),h=Y(m),r=y(),v=f("div"),_=y(),p=f("button"),b=pe("svg"),w=pe("use"),I=y(),j=Y(B),O=y(),D=f("button"),C=pe("svg"),M=pe("use"),T=y(),E=Y(x),U=y(),R=f("div"),N=Y(e[2]),P=y(),a=pe("svg"),$=pe("use"),z=y(),Te&&Te.c(),q=y(),X=f("div"),ie=f("div"),_e=f("div"),te=pe("svg"),ae=pe("use"),ne=y(),De=Y(Ae),$e=y(),me=f("div"),we=y(),ke=f("button"),V=pe("svg"),ge=pe("use"),H=y(),oe=Y(Q),ce=y(),Ce=f("div");for(let F=0;F<ee.length;F+=1)ee[F].c();We=y(),Ne&&Ne.c(),Oe=y(),ue=f("div"),Ie=f("div"),g=f("div"),A=pe("svg"),de=pe("use"),Ee=y(),be=Y(ve),He=y(),re=f("div"),ut=y(),xe=f("button"),qe=pe("svg"),dt=pe("use"),ft=y(),Re=Y(Ze),Je=y(),Ye=f("div");for(let F=0;F<Me.length;F+=1)Me[F].c();G=y(),L=f("div"),fe=f("div"),pt=pe("svg"),Tt=pe("use"),Ut=y(),Kt=Y(Wn),Ft=y(),Ue=f("ul"),et=f("li"),At=f("strong"),At.textContent=`${S("usageTipGlobal")}`,Wt=Y("："),Ht=Y(Hn),Vt=y(),tt=f("li"),Dt=f("strong"),Dt.textContent=`${S("usageTipMatch")}`,jt=Y("："),zt=Y(Vn),qt=y(),nt=f("li"),Ct=f("strong"),Ct.textContent=`${S("usageTipStatus")}`,Yt=Y("："),Xt=Y(jn),Gt=y(),lt=f("li"),Et=f("strong"),Et.textContent=`${S("usageTipReport")}`,Jt=Y("："),Qt=Y(zn),je(c,"xlink:href","#iconCalendar"),k(s,"width","18px"),k(s,"height","18px"),d(o,"class","section-title svelte-1plhmm3"),d(v,"class","fn__flex-1 svelte-1plhmm3"),je(w,"xlink:href","#iconUndo"),k(b,"width","14px"),k(b,"height","14px"),d(b,"class","svelte-1plhmm3"),d(p,"class","action-btn svelte-1plhmm3"),k(p,"background-color","transparent"),k(p,"color","var(--b3-theme-on-surface)"),k(p,"box-shadow","none"),k(p,"border","1px solid var(--b3-theme-surface-lighter)"),k(p,"margin-right","12px"),je(M,"xlink:href","#iconFiles"),k(C,"width","14px"),k(C,"height","14px"),d(C,"class","svelte-1plhmm3"),d(D,"class","action-btn svelte-1plhmm3"),k(D,"margin-right","32px"),je($,"xlink:href","#iconClock"),k(a,"width","14px"),k(a,"height","14px"),k(a,"opacity","0.6"),d(R,"class","time-trigger svelte-1plhmm3"),Fe(R,"active",e[8]),d(l,"class","section-header svelte-1plhmm3"),je(ae,"xlink:href","#iconSettings"),k(te,"width","18px"),k(te,"height","18px"),d(_e,"class","section-title svelte-1plhmm3"),d(me,"class","fn__flex-1 svelte-1plhmm3"),je(ge,"xlink:href","#iconAdd"),k(V,"width","14px"),k(V,"height","14px"),d(V,"class","svelte-1plhmm3"),d(ke,"class","action-btn svelte-1plhmm3"),d(ie,"class","section-header svelte-1plhmm3"),d(Ce,"class","profile-container svelte-1plhmm3"),k(X,"margin-top","20px"),k(X,"display","flex"),k(X,"flex-direction","column"),je(de,"xlink:href","#iconCalendar"),k(A,"width","18px"),k(A,"height","18px"),d(g,"class","section-title svelte-1plhmm3"),d(re,"class","fn__flex-1 svelte-1plhmm3"),je(dt,"xlink:href","#iconAdd"),k(qe,"width","14px"),k(qe,"height","14px"),d(qe,"class","svelte-1plhmm3"),d(xe,"class","action-btn svelte-1plhmm3"),k(xe,"width","132px"),k(xe,"justify-content","center"),d(Ie,"class","section-header svelte-1plhmm3"),d(Ye,"class","profile-container svelte-1plhmm3"),k(ue,"margin-top","24px"),k(ue,"display","flex"),k(ue,"flex-direction","column"),je(Tt,"xlink:href","#iconInfo"),k(pt,"width","16px"),k(pt,"height","16px"),k(fe,"font-weight","700"),k(fe,"color","var(--b3-theme-primary)"),k(fe,"display","flex"),k(fe,"align-items","center"),k(fe,"gap","8px"),k(fe,"margin-bottom","8px"),k(fe,"font-size","14px"),d(et,"class","svelte-1plhmm3"),d(tt,"class","svelte-1plhmm3"),d(nt,"class","svelte-1plhmm3"),d(lt,"class","svelte-1plhmm3"),d(Ue,"class","svelte-1plhmm3"),d(L,"class","info-footer svelte-1plhmm3"),d(n,"class","settings-container svelte-1plhmm3")},m(F,J){Se&&Se.m(F,J),se(F,t,J),se(F,n,J),i(n,l),i(l,o),i(o,s),i(s,c),i(o,u),i(o,h),i(l,r),i(l,v),i(l,_),i(l,p),i(p,b),i(b,w),i(p,I),i(p,j),i(l,O),i(l,D),i(D,C),i(C,M),i(D,T),i(D,E),i(l,U),i(l,R),i(R,N),i(R,P),i(R,a),i(a,$),i(l,z),Te&&Te.m(l,null),i(n,q),i(n,X),i(X,ie),i(ie,_e),i(_e,te),i(te,ae),i(_e,ne),i(_e,De),i(ie,$e),i(ie,me),i(ie,we),i(ie,ke),i(ke,V),i(V,ge),i(ke,H),i(ke,oe),i(X,ce),i(X,Ce);for(let ye=0;ye<ee.length;ye+=1)ee[ye]&&ee[ye].m(Ce,null);i(Ce,We),Ne&&Ne.m(Ce,null),i(n,Oe),i(n,ue),i(ue,Ie),i(Ie,g),i(g,A),i(A,de),i(g,Ee),i(g,be),i(Ie,He),i(Ie,re),i(Ie,ut),i(Ie,xe),i(xe,qe),i(qe,dt),i(xe,ft),i(xe,Re),i(ue,Je),i(ue,Ye);for(let ye=0;ye<Me.length;ye+=1)Me[ye]&&Me[ye].m(Ye,null);i(n,G),i(n,L),i(L,fe),i(fe,pt),i(pt,Tt),i(fe,Ut),i(fe,Kt),i(L,Ft),i(L,Ue),i(Ue,et),i(et,At),i(et,Wt),i(et,Ht),i(Ue,Vt),i(Ue,tt),i(tt,Dt),i(tt,jt),i(tt,zt),i(Ue,qt),i(Ue,nt),i(nt,Ct),i(nt,Yt),i(nt,Xt),i(Ue,Gt),i(Ue,lt),i(lt,Et),i(lt,Jt),i(lt,Qt),Rt||(Zt=[W(p,"click",e[28]),W(D,"click",e[29]),W(R,"click",e[17]),W(ke,"click",e[12]),W(xe,"click",e[19])],Rt=!0)},p(F,J){F[8]?Se?Se.p(F,J):(Se=gn(F),Se.c(),Se.m(t.parentNode,t)):Se&&(Se.d(1),Se=null),J[0]&4&&ze(N,F[2]),J[0]&256&&Fe(R,"active",F[8]),F[8]?Te?Te.p(F,J):(Te=vn(F),Te.c(),Te.m(l,null)):Te&&(Te.d(1),Te=null),J[0]&26634&&(kt=he(F[1]),ee=xt(ee,J,en,1,F,kt,Ge,Ce,$t,wn,We,pn)),F[1].length===0?Ne||(Ne=In(),Ne.c(),Ne.m(Ce,null)):Ne&&(Ne.d(1),Ne=null),J[0]&66324722&&(bt=he(F[4]),Me=xt(Me,J,tn,1,F,bt,K,Ye,$t,Nn,null,an))},i:Qe,o:Qe,d(F){F&&(le(t),le(n)),Se&&Se.d(F),Te&&Te.d();for(let J=0;J<ee.length;J+=1)ee[J].d();Ne&&Ne.d();for(let J=0;J<Me.length;J+=1)Me[J].d();Rt=!1,Pe(Zt)}}}function ot(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function Mn(e,t){const n=`time-opt-${e}-${t}`,l=document.getElementById(n);l&&l.scrollIntoView({block:"center",behavior:"smooth"})}function Tl(e,t,n){let{plugin:l}=t,o=[],s="00:00",c=null,u=[],m=null,h=[],r={},v=!1;const _=Array.from({length:24},(g,A)=>A.toString().padStart(2,"0")),p=Array.from({length:60},(g,A)=>A.toString().padStart(2,"0"));rl(()=>{b(),l.config.profiles&&l.config.profiles.length===1&&n(3,c=l.config.profiles[0].id),T()});function b(){n(1,o=l.config.profiles||[]),n(2,s=l.config.archiveTime||"00:00"),n(4,u=l.config.templates||[])}async function w(){n(0,l.config.archiveTime=s,l),n(0,l.config.templates=u,l),l.saveData("config.json",l.config),b()}function I(){l.config.profiles||n(0,l.config.profiles=[],l);const g={id:ot(),name:S("defaultNewRuleName")+" "+(l.config.profiles.length+1),keyword:"",completedStatus:S("defaultCompleted"),archivedStatus:S("defaultArchived"),enabled:!0};n(0,l.config.profiles=[...l.config.profiles,g],l),w(),n(3,c=g.id),setTimeout(()=>{const A=document.querySelector(".profile-container");A&&(A.scrollTop=A.scrollHeight)},50)}function B(g){n(0,l.config.profiles=l.config.profiles.filter(A=>A.id!==g),l),w(),c===g&&n(3,c=null)}function j(g){c===g?n(3,c=null):n(3,c=g)}function O(g){const A=s.split(":");n(2,s=`${g}:${A[1]||"00"}`),w()}function D(g){const A=s.split(":");n(2,s=`${A[0]||"00"}:${g}`),w()}function C(){n(8,v=!v),v&&setTimeout(()=>{const[g,A]=s.split(":");Mn("h",g),Mn("m",A)},10)}function M(g){l.generateTemplate&&l.generateTemplate(g)}async function T(){if(!l.getNotebooks)return;const g=await l.getNotebooks();n(6,h=(g==null?void 0:g.notebooks)||[])}function x(){const g={id:ot(),name:S("templateNewName"),period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:S("templateTitleDefault"),sections:[{id:ot(),title:S("templateSectionTodo"),statuses:[]},{id:ot(),title:S("templateSectionDoing"),statuses:[]},{id:ot(),title:S("templateSectionDone"),statuses:[]}]};n(4,u=[...u,g]),w(),n(5,m=g.id)}function E(g){n(4,u=u.filter(A=>A.id!==g)),w(),m===g&&n(5,m=null)}function U(g){if(m===g)n(5,m=null);else{n(5,m=g);const A=u.find(de=>de.id===g);A&&N(A)}}function R(g,A){const de=g.ruleIds||[];g.ruleIds=de.includes(A)?de.filter(Ee=>Ee!==A):[...de,A],w(),N(g)}async function N(g){l.getStatusOptions&&n(7,r[g.id]=await l.getStatusOptions(g.ruleIds||[]),r)}function P(g){g.sections=[...g.sections||[],{id:ot(),title:S("templateSectionNew"),statuses:[]}],w()}function a(g,A){g.sections=(g.sections||[]).filter(de=>de.id!==A),w()}function $(g,A){const de=g.statuses||[];g.statuses=de.includes(A)?de.filter(Ee=>Ee!==A):[...de,A],w()}function z(g){ul.call(this,e,g)}const q=()=>n(8,v=!1),X=()=>l.undoArchiveNow(),ie=()=>l.archiveNow(),_e=g=>O(g),te=g=>D(g);function ae(g,A){g[A].enabled=this.checked,n(1,o)}const ne=g=>B(g.id),Ae=g=>j(g.id);function De(g,A){g[A].name=this.value,n(1,o)}function $e(g,A){g[A].keyword=this.value,n(1,o)}function me(g,A){g[A].completedStatus=this.value,n(1,o)}function we(g,A){g[A].archivedStatus=this.value,n(1,o)}const ke=g=>M(g.id),V=g=>E(g.id),ge=g=>U(g.id);function H(g,A){g[A].name=this.value,n(4,u)}function Q(g,A){g[A].period=ln(this),n(4,u)}const oe=(g,A)=>R(g,A.id);function ce(g,A){g[A].notebookId=ln(this),n(4,u)}function Ce(g,A){g[A].pathTemplate=this.value,n(4,u)}function ee(g,A){g[A].clipboardOnlySections=this.checked,n(4,u)}function Ge(g,A){g[A].titleTemplate=this.value,n(4,u)}function We(g,A){g[A].title=this.value,n(4,u)}const Oe=(g,A)=>$(g,A),ue=(g,A)=>a(g,A.id),Ie=g=>P(g);return e.$$set=g=>{"plugin"in g&&n(0,l=g.plugin)},[l,o,s,c,u,m,h,r,v,_,p,w,I,B,j,O,D,C,M,x,E,U,R,P,a,$,z,q,X,ie,_e,te,ae,ne,Ae,De,$e,me,we,ke,V,ge,H,Q,oe,ce,Ce,ee,Ge,We,Oe,ue,Ie]}class Al extends bl{constructor(t){super(),kl(this,t,Tl,Sl,il,{plugin:0},null,[-1,-1,-1])}}function Ke(e){var t,n,l,o,s;if(!e)return"";if(Array.isArray(e))return e.map(c=>Ke(c)).filter(Boolean).join(", ");if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(e.content!==void 0)return e.content;if(((t=e.text)==null?void 0:t.content)!==void 0)return e.text.content;if(((n=e.block)==null?void 0:n.content)!==void 0)return e.block.content;if(((l=e.date)==null?void 0:l.content)!==void 0)return e.date.content;if(((o=e.mSelect)==null?void 0:o.length)>0)return e.mSelect.map(c=>c.content).join(", ");if(((s=e.select)==null?void 0:s.content)!==void 0)return e.select.content;for(const c in e)if(typeof e[c]=="object"&&e[c]!==null){const u=Ke(e[c]);if(u)return u}return""}function Dl(e){if(!e)return 0;const t=String(e).trim();if(t.match(/^\d{4}-\d{2}-\d{2}/))return new Date(t.substring(0,10).replace(/-/g,"/")+" 00:00:00").getTime();if(t.length===14&&/^\d+$/.test(t))return new Date(t.substring(0,4),parseInt(t.substring(4,6),10)-1,t.substring(6,8),t.substring(8,10),t.substring(10,12),t.substring(12,14)).getTime();const n=parseInt(t,10);return t.length===10?n*1e3:n}function Ln(e){const t=Dl(e);if(t&&!Number.isNaN(t))return t;const n=Date.parse(e);return Number.isNaN(n)?0:n}function Cl(e){if(!e||typeof e!="object")return"";if(typeof e.name=="string")return e.name;if(typeof e.title=="string")return e.title;if(typeof e.label=="string")return e.label;if(e.value){const t=Ke(e.value);if(t)return t}if(e.key){const t=Ke(e.key);if(t)return t;if(typeof e.key.name=="string")return e.key.name}return""}function It(e,t=""){let n=[];if(!e||typeof e!="object")return n;e.id&&(Array.isArray(e.cells)||Array.isArray(e.values))&&(t&&(e.__groupStatus=t),n.push(e));for(const l in e)if(Object.prototype.hasOwnProperty.call(e,l)){const o=e[l];Array.isArray(o)?l==="groups"?o.forEach(s=>{const c=Cl(s)||t;n=n.concat(It(s,c))}):o.forEach(s=>n=n.concat(It(s,t))):typeof o=="object"&&!["columns","fields","keyValues"].includes(l)&&(n=n.concat(It(o,t)))}return n}function El(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));return t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7)),Math.ceil(((t.getTime()-new Date(Date.UTC(t.getUTCFullYear(),0,1)).getTime())/864e5+1)/7)}function Fn(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function Ot(e=""){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F1E6}-\u{1F1FF}]/gu,"")}function $n(e){return Ot(String(e||"")).toLowerCase().trim()}function Bt(e){return String(e??"").replace(/'/g,"''")}function at(e,t=0){var n;if(!e||t>4)return"";if(Array.isArray(e)){for(const l of e){const o=at(l,t+1);if(o)return o}return""}if(typeof e!="object"){if(typeof e=="string"){const l=e.match(/\d{14}-[a-z0-9]{7}/i);if(l)return l[0]}return""}if((n=e.block)!=null&&n.id)return e.block.id;if(e.blockID)return e.blockID;if(e.blockId)return e.blockId;if(e.block_id)return e.block_id;if(e.refID)return e.refID;if(e.id&&typeof e.id=="string"&&e.id.length>=20)return e.id;for(const l of Object.keys(e)){const o=e[l];if(typeof o=="string"&&/block/i.test(l)){const c=o.match(/\d{14}-[a-z0-9]{7}/i);if(c)return c[0]}const s=at(e[l],t+1);if(s)return s}return""}async function Rl(e){const t={},n=Array.from(new Set(e)).filter(Boolean),l=100;for(let o=0;o<n.length;o+=l){const s=n.slice(o,o+l).map(u=>`'${Bt(u)}'`).join(",");if(!s)continue;const c=await Be(`SELECT id, content FROM blocks WHERE id IN (${s})`);c&&c.length>0&&c.forEach(u=>{u!=null&&u.id&&(u==null?void 0:u.content)!==void 0&&(t[u.id]=u.content)})}return t}async function Nl(e,t){var s,c;const n={},l=Array.from(new Set(t)).filter(Boolean),o=100;for(let u=0;u<l.length;u+=o){const m=l.slice(u,u+o);if(m.length===0)continue;const h=await Zn(e,m);Array.isArray(h)?h.forEach(r=>{r!=null&&r.itemID&&(r!=null&&r.blockID)&&(n[r.itemID]=r.blockID),r!=null&&r.itemId&&(r!=null&&r.blockId)&&(n[r.itemId]=r.blockId),r!=null&&r.id&&(r!=null&&r.blockID)&&(n[r.id]=r.blockID)}):Array.isArray(h==null?void 0:h.data)?h.data.forEach(r=>{r!=null&&r.itemID&&(r!=null&&r.blockID)&&(n[r.itemID]=r.blockID),r!=null&&r.itemId&&(r!=null&&r.blockId)&&(n[r.itemId]=r.blockId),r!=null&&r.id&&(r!=null&&r.blockID)&&(n[r.id]=r.blockID)}):h!=null&&h.blockIDs&&Array.isArray(h.blockIDs)&&Array.isArray(h.itemIDs)?h.itemIDs.forEach((r,v)=>{const _=h.blockIDs[v];r&&_&&(n[r]=_)}):(s=h==null?void 0:h.data)!=null&&s.blockIDs&&Array.isArray(h.data.blockIDs)&&Array.isArray(h.data.itemIDs)?h.data.itemIDs.forEach((r,v)=>{const _=h.data.blockIDs[v];r&&_&&(n[r]=_)}):(c=h==null?void 0:h.data)!=null&&c.blockIDs&&Array.isArray(h.data.blockIDs)&&Array.isArray(h.data.itemId)&&h.data.itemId.forEach((r,v)=>{const _=h.data.blockIDs[v];r&&_&&(n[r]=_)})}return n}function Ml(e=""){return e.replace(/^###\s+/gm,"").replace(/^####\s+/gm,"").replace(/^#####\s+/gm,"").replace(/^\*\s\[\s\]\s/gm,"• ").replace(/^\*\s\[x\]\s/gi,"• ").trim()}function Ll(e=""){const t=e.split(`
`);let n="",l=!1;const o=()=>{l&&(n+="</ul>",l=!1)};for(const s of t){if(/^###\s+/.test(s)){o(),n+=`<h3>${s.replace(/^###\s+/,"")}</h3>`;continue}if(/^####\s+/.test(s)){o(),n+=`<h4>${s.replace(/^####\s+/,"")}</h4>`;continue}if(/^#####\s+/.test(s)){o(),n+=`<h5>${s.replace(/^#####\s+/,"")}</h5>`;continue}const c=s.match(/^\*\s\[x\]\s(.+)/i),u=s.match(/^\*\s\[\s\]\s(.+)/);if(c||u){l||(n+="<ul>",l=!0);const m=c?c[1]:u[1];n+=`<li><input type="checkbox"${!!c?" checked":""} disabled /> <span>${m}</span></li>`;continue}if(s.trim()===""){o();continue}o(),n+=`<p>${s}</p>`}return o(),`<div>${n}</div>`}function $l(e,t){return t?e.split(`
`).filter(o=>!/^###\s/.test(o)&&!/^####\s/.test(o)).join(`
`).replace(/\n{3,}/g,`

`).trim():e}async function xl(e,t,n){var c;const l=Ot($l(n,t.clipboardOnlySections)),o=Ml(l),s=Ll(l);try{typeof ClipboardItem<"u"&&((c=navigator.clipboard)!=null&&c.write)?await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([s],{type:"text/html"}),"text/plain":new Blob([o],{type:"text/plain"})})]):await navigator.clipboard.writeText(o);const m=(e.i18n||{}).reportCopied||"内容已复制到剪切板";_t(m)}catch(u){console.error("Copy to clipboard failed:",u)}}function Bl(e,t){const n=new Date(e);return t==="day"?(n.setHours(0,0,0,0),n.getTime()):t==="week"?(n.setDate(n.getDate()-(n.getDay()||7)+1),n.setHours(0,0,0,0),n.getTime()):t==="month"?(n.setDate(1),n.setHours(0,0,0,0),n.getTime()):t==="year"?(n.setMonth(0,1),n.setHours(0,0,0,0),n.getTime()):0}function Pl(e,t){const n=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),o=El(t).toString().padStart(2,"0"),s=Fn(t),c=e.period||"none";let u=`/日常记录/${n}/${l}/${s}`;return c==="week"?u=`/周报/${n}/${n}-W${o}`:c==="month"?u=`/月报/${n}/${n}-${l}`:c==="year"&&(u=`/年报/${n}`),e.pathTemplate?e.pathTemplate.replace("{YYYY}",String(n)).replace("{MM}",l).replace("{date}",s).replace("{WW}",o):u}async function Ol(e,t,n,l,o,s){var b,w;const c=Pl(t,n),u=Bt(c),m=Bt(c.substring(1));let h=await Be(`SELECT id FROM blocks WHERE (hpath = '${u}' OR hpath = '${m}') AND type='d' LIMIT 1`),r=h&&h.length>0?h[0].id:"";if(!r){const I=await xn(),B=t.notebookId||((w=(b=I==null?void 0:I.notebooks)==null?void 0:b[0])==null?void 0:w.id);if(!B){Xe("未找到可用笔记本，请在设置中选择目标笔记本");return}r=await Xn(B,c+".sy",""),await new Promise(j=>setTimeout(j,600))}const _=(await Be(`SELECT id FROM blocks WHERE root_id = '${r}'`)||[]).map(I=>I.id).filter(I=>I&&I!==r);for(const I of _)await Jn(I);_.length>0&&await new Promise(I=>setTimeout(I,300));const p=await Gn("markdown",l,r);if(p&&p.length>0){for(const I of p)I!=null&&I.id&&await Qn(I.id,{memo:o});_t("报表已就绪")}}async function Ul(e,t){var _;const l=(((_=e.config)==null?void 0:_.profiles)||[]).find(p=>p.id===t);if(!(l!=null&&l.keyword))return{avId:"",viewId:"",profileName:""};const o=await Be(`SELECT id FROM blocks WHERE content LIKE '%${l.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)return{avId:"",viewId:"",profileName:""};const s=o[0].id,c=await Be(`SELECT id, markdown FROM blocks WHERE root_id = '${s}' AND type = 'av' LIMIT 1`);if(!c||c.length===0)return{avId:"",viewId:"",profileName:""};const u=c[0],m=u.markdown.match(/data-av-id="([^"]+)"/);if(!m)return{avId:"",viewId:"",profileName:""};const h=m[1],r=u.markdown.match(/data-view-id="([^"]+)"/),v=r?r[1]:h;return{avId:h,viewId:v,profileName:l.name||l.keyword||l.id}}async function Kl(e,t){try{const n=e.i18n||{},l=(w,I)=>n[w]||I,o=t.ruleIds||[];if(!o||o.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const s=[];for(const w of o){const I=await Ul(e,w);if(!I.avId)continue;const B=await Mt(I.avId,I.viewId||I.avId,2e3,1);B&&s.push({profileName:I.profileName,avData:B,avId:I.avId})}if(s.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const c=new Date,u=Fn(c),m=t.period||"none",h=Bl(c,m);let r="报表 ({date})";m==="day"?r="日报 ({date})":m==="week"?r="周报 ({date})":m==="month"?r="月报 ({date})":m==="year"&&(r="年报 ({date})");const _=(t.titleTemplate||r).replace("{date}",u);let p=`### ${_}

`;for(const w of s){const I=w.avData,B=I.view||I,O=(B.columns||B.fields||[]).map(a=>{const $=(a==null?void 0:a.key)??a;return $?{id:$.id,name:$.name||"",type:$.type||""}:null}).filter(Boolean),D=a=>O.findIndex($=>a.some(z=>z($))),C=D([a=>a.name.includes("内容"),a=>a.name.toLowerCase().includes("content"),a=>a.type==="block"]);let M=D([a=>a.name.includes("状态"),a=>a.name.toLowerCase().includes("status")]);M===-1&&(M=O.findIndex(a=>{const $=String(a.type||"").toLowerCase();return $==="select"||$==="mselect"||$==="multiselect"||$==="singleselect"}));let T=D([a=>a.name.includes("更新时间"),a=>a.name.toLowerCase().includes("update"),a=>a.name.includes("更新"),a=>a.name.includes("修改")]);T===-1&&(T=D([a=>a.name.includes("完成"),a=>a.name.includes("结束"),a=>a.name.includes("归档"),a=>a.name.toLowerCase().includes("done")])),T===-1&&(T=D([a=>a.name.includes("时间"),a=>a.name.toLowerCase().includes("time"),a=>a.type==="date"])),console.log("[KanbanWorkflow][Report] columns:",O.map(a=>`${a.name}(${a.type||"unknown"})`)),console.log("[KanbanWorkflow][Report] idx:",{cIdx:C,sIdx:M,tIdx:T});const x=It(I).map(a=>{var $e,me,we,ke;let $=a.cells||[],z=[],q=null;a.values&&(z=O.map(V=>{var H;const ge=a.values.find(Q=>{var oe;return Q.keyID===V.id||((oe=Q==null?void 0:Q.value)==null?void 0:oe.keyID)===V.id});return C!==-1&&V.id===((H=O[C])==null?void 0:H.id)&&(q=(ge==null?void 0:ge.value)??null),ge?ge.value:null}));const X=($||[]).map(V=>Ke(V)),ie=(z||[]).map(V=>Ke(V)),_e=X.some(V=>String(V||"").trim()!==""),te=ie.some(V=>String(V||"").trim()!=="");!_e&&te&&($=z);const ae=$===z?ie:X,ne=C!==-1?$[C]:null,Ae=at(ne)||at(q)||at(a==null?void 0:a.block)||at(a),De=(($e=a==null?void 0:a.block)==null?void 0:$e.content)||(a==null?void 0:a.content)||(a==null?void 0:a.name)||((me=a==null?void 0:a.title)==null?void 0:me.content)||(a==null?void 0:a.title)||((we=a==null?void 0:a.text)==null?void 0:we.content)||(a==null?void 0:a.text)||((ke=a==null?void 0:a.value)==null?void 0:ke.content)||(q?Ke(q):"")||"";return{id:a.id,cells:$,cellValues:ae,contentBlockId:Ae,contentFromRow:De,contentValueObj:q,rawPreview:a,updatedAt:a.updatedAt||a.updated||0,groupStatus:a.__groupStatus||""}}),E=await Nl(w.avId,x.map(a=>a.id||"").filter(Boolean)),U=await Rl(x.map(a=>a.contentBlockId||"").filter(Boolean).concat(Object.values(E))),R=(t.sections||[]).map(a=>({id:a.id,title:a.title,statusesRaw:(a.statuses||[]).map($=>String($)),statuses:(a.statuses||[]).map($=>$n($)).filter(Boolean),items:[]})),N=R.flatMap(a=>a.statuses).filter(Boolean);console.log("[KanbanWorkflow][Report] statusCandidates:",N),x.forEach((a,$)=>{var ge;const z=a.cellValues||a.cells.map(H=>Ke(H));if($===0){console.log("[KanbanWorkflow][Report] sampleRow:",z);const H=a.rawPreview||{};console.log("[KanbanWorkflow][Report] sampleRowKeys:",Object.keys(H)),!z.length&&!a.contentFromRow&&console.log("[KanbanWorkflow][Report] sampleRowRaw:",H),!a.contentFromRow&&a.contentBlockId&&console.log("[KanbanWorkflow][Report] sampleContentBlockId:",a.contentBlockId),a.contentValueObj&&(console.log("[KanbanWorkflow][Report] sampleContentValueObj:",a.contentValueObj),console.log("[KanbanWorkflow][Report] sampleContentValueExtract:",Ke(a.contentValueObj))),a.id&&E[a.id]&&console.log("[KanbanWorkflow][Report] sampleItemToBlock:",a.id,"->",E[a.id]),H.values&&(console.log("[KanbanWorkflow][Report] sampleRowValues:",H.values),console.log("[KanbanWorkflow][Report] sampleColumns:",O))}let q=C!==-1?z[C]:"";!q&&a.contentFromRow&&(q=a.contentFromRow),!q&&a.contentBlockId&&E[a.contentBlockId]&&U[E[a.contentBlockId]]&&(q=U[E[a.contentBlockId]]),!q&&a.contentBlockId&&U[a.contentBlockId]&&(q=U[a.contentBlockId]),!q&&a.id&&E[a.id]&&U[E[a.id]]&&(q=U[E[a.id]]),q||(q=z.find((Q,oe)=>oe===M||oe===T?!1:String(Q||"").trim()!=="")||""),q||(q=l("reportFallbackContent","无内容")),m==="week"&&(q=q.replace(/\b\d+(\.\d+)?\s*[hH]\b/gi,"").replace(/\((?:\d\.?)+[hH]\)/g,"").trim(),!q&&Array.isArray((ge=a.cells)==null?void 0:ge[C])&&a.cells[C].length>0&&(q=a.cells[C].map(H=>Ke(H)).join(", ")));let X=M!==-1?z[M]:"";!X&&a.groupStatus&&(X=a.groupStatus),X||(X=z.find(Q=>{const oe=String(Q||"").toLowerCase();return N.some(ce=>oe.includes(ce))})||""),$===0&&console.log("[KanbanWorkflow][Report] sampleStatus:",X);const ie=T!==-1?z[T]:"",_e=Ln(ie),te=Ln(a.updatedAt),ae=m!=="none"?_e||te||0:_e||te||Date.now(),ne=$n(X),Ae=ne.includes("已完成")||ne.includes("done")||ne.includes("完成")||ne.includes("finish")||ne.includes("ok"),De=ne.includes("归档")||ne.includes("archived")||ne.includes("存档")||ne.includes("archive");if(m!=="none"&&(Ae||De)&&ae<h)return;const me=`${Ae?"* [x]":"* [ ]"} ${q}`.trim(),we=ne.split(/[,，]/).map(H=>H.trim()).filter(Boolean);let V=R.filter(H=>H.statuses.length>0&&H.statuses.some(Q=>Q?ne.includes(Q)?!0:we.some(oe=>oe.includes(Q)||Q.includes(oe)):!1));if(V.length===0){const H=String(X||"").toLowerCase();V=R.filter(Q=>(Q.statusesRaw||[]).some(oe=>{const ce=String(oe||"").toLowerCase();return ce?H.includes(ce)||ce.includes(H):!1}))}V.length!==0&&V.forEach(H=>H.items.push(me))});const P=`${l("reportBoardTitle","看板")}: ${w.profileName}`;p+=`#### ${P}

`;for(const a of R)p+=`##### ${a.title}
`,a.items.length>0?p+=`${a.items.join(`
`)}

`:p+=`
`}const b=Ot(p);await Ol(e,t,c,b,`summary-${t.id}`,_),await xl(e,t,b)}catch(n){console.error(n),Xe("生成过程中遇障")}}class Fl extends ht.Plugin{constructor(){super(...arguments);Ve(this,"timer");Ve(this,"isMobile");Ve(this,"config",{});Ve(this,"undoStack",[]);Ve(this,"MAX_UNDO_COUNT",30);Ve(this,"MAX_UNDO_DAYS",7)}async onload(){ll(this),console.log("Loading Kanban Workflow Plugin v0.1.0"),await this.loadAndNormalizeConfig();try{const o=await this.loadData("undo_history.json");o&&Array.isArray(o)&&(this.undoStack=o)}catch(o){console.error("Failed to load undo history",o)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板工作流",position:"right",callback:o=>{if(this.isMobile){this.showMobileMenu();return}let s;o&&o.currentTarget&&o.currentTarget.getBoundingClientRect?s=o.currentTarget.getBoundingClientRect():s=n.getBoundingClientRect();const c=new ht.Menu("kanban-archiver-menu");c.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(m=>{c.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${m.name}`,click:()=>{this.generateTemplate(m.id)}})}),c.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),c.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),c.open({x:s.left,y:s.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),(this.config.templates||[]).forEach(o=>{this.addCommand({langKey:`generateTemplate_${o.id}`,langText:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,hotkey:"",callback:()=>{this.generateTemplate(o.id)}})}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",templates:[],...n},this.ensureDefaultTemplates(),this.normalizeTemplates(),(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let l=!1;this.config.profiles.forEach(o=>{o.enabled===void 0&&(o.enabled=!0,l=!0)}),l&&this.saveData("config.json",this.config)}ensureDefaultTemplates(){(!this.config.templates||!Array.isArray(this.config.templates)||this.config.templates.length===0)&&(this.config.templates=[{id:this.generateUUID(),name:this.i18n.defaultDailyTemplate||"今日汇总",period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"日报 ({date})",sections:[{id:this.generateUUID(),title:"待办",statuses:["待办","todo","backlog","未开始"]},{id:this.generateUUID(),title:"进行中",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成",statuses:["已完成","done","完成","finish","ok","归档","archived"]}]},{id:this.generateUUID(),name:this.i18n.defaultWeeklyTemplate||"本周回顾",period:"week",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"周报 ({date})",sections:[{id:this.generateUUID(),title:"当前工作",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成及归档 (本周)",statuses:["已完成","done","完成","finish","ok","归档","archived"]},{id:this.generateUUID(),title:"下周工作计划",statuses:["待办","todo","backlog","未开始"]}]}],this.saveData("config.json",this.config))}normalizeTemplates(){if(!Array.isArray(this.config.templates))return;let n=!1;this.config.templates.forEach(l=>{!l.period&&l.type&&(l.period=l.type==="weekly"?"week":"day",n=!0),l.period||(l.period="none",n=!0),l.sections||(l.sections=[],n=!0)}),n&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Workflow Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Workflow Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new ht.Dialog({title:this.i18n.settingTitle||"看板工作流设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{l.$destroy()}}),l=new Al({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new ht.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(o=>{n.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,click:()=>{this.generateTemplate(o.id)}})}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,l=n.getHours(),o=n.getMinutes(),s=l*60+o;let c=0,u=0;try{const r=this.config.archiveTime.split(":").map(Number);r.length===2&&!isNaN(r[0])&&!isNaN(r[1])&&(c=r[0],u=r[1])}catch{return}const m=c*60+u,h=n.toLocaleDateString();this.config.lastRunDate!==h&&s>=m&&(this.config.lastRunDate=h,this.saveData("config.json",this.config),this.archiveNow(!1))}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(l=>l.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(n=!0){if(!(n&&!window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？")))try{const l=await nl(this,n);if(l&&l.length>0)this.undoStack.push({date:new Date().getTime(),ids:l}),await this.saveUndoHistory();else{const o=this.i18n.archiveEmpty||"未发现可归档任务";_t(o)}}catch(l){console.error("Archive task error:",l)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await tl(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}async generateTemplate(n){const l=(this.config.templates||[]).find(o=>o.id===n);l&&await Kl(this,l)}async getNotebooks(){return await xn()}async getStatusOptions(n){const l=this.config.profiles||[],o=new Set;for(const s of n){const c=l.find(b=>b.id===s);if(!(c!=null&&c.keyword))continue;const u=await Be(`SELECT id FROM blocks WHERE content LIKE '%${c.keyword}%' AND type = 'd' LIMIT 1`);if(!u||u.length===0)continue;const m=u[0].id,h=await Be(`SELECT id, markdown FROM blocks WHERE root_id = '${m}' AND type = 'av' LIMIT 1`);if(!h||h.length===0)continue;const v=h[0].markdown.match(/data-av-id="([^"]+)"/);if(!v)continue;const _=v[1],p=await Pt(_);if(p)for(const b of p)(b.type==="select"||b.type==="mSelect")&&b.options&&b.options.forEach(w=>{w!=null&&w.name&&o.add(w.name)})}return Array.from(o)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var l=Math.random()*16|0,o=n=="x"?l:l&3|8;return o.toString(16)})}}module.exports=Fl;
