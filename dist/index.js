"use strict";var qn=Object.defineProperty;var Yn=(e,t,n)=>t in e?qn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var He=(e,t,n)=>Yn(e,typeof t!="symbol"?t+"":t,n);const ht=require("siyuan");async function Pe(e,t){let n=await ht.fetchSyncPost(e,t);return n.code===0?n.data:null}async function xn(){const t=await Pe("/api/notebook/lsNotebooks","");try{t&&t.notebooks&&Array.isArray(t.notebooks)&&(t.notebooks=t.notebooks.filter(n=>n.closed===!1||n.closed===0||n.closed==="false"))}catch(n){console.error("Filter notebooks error:",n)}return t}async function Xn(e,t,n){return Pe("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:n})}async function Gn(e,t,n){return Pe("/api/block/appendBlock",{dataType:e,data:t,parentID:n})}async function Jn(e){return Pe("/api/block/deleteBlock",{id:e})}async function Qn(e,t){return Pe("/api/attr/setBlockAttrs",{id:e,attrs:t})}async function xe(e){return Pe("/api/query/sql",{stmt:e})}async function _t(e,t=7e3){return Pe("/api/notification/pushMsg",{msg:e,timeout:t})}async function Xe(e,t=7e3){return Pe("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function Ut(e){return Pe("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function Rt(e,t,n=9999999,l=1){return Pe("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:l})}async function Pn(e,t,n,l){return Pe("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:l})}async function Zn(e,t,n,l,o=!1){var s,c,u;try{const p=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${l}"`);const _=await xe(`SELECT id FROM blocks WHERE content LIKE '%${p}%' AND type = 'd' LIMIT 1`);if(!_||_.length===0)return console.log(`Kanban doc not found for keyword: ${p}`),[];const m=_[0].id,v=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${m}' AND type = 'av' LIMIT 1`);if(!v||v.length===0)return o&&Xe(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const k=v[0],f=k.markdown.match(/data-av-id="([^"]+)"/);if(!f)return[];const b=f[1],w=await Ut(b);if(!w)return[];let S=null,P=null,z=null;for(const R of w)if((R.type==="select"||R.type==="mSelect")&&R.options){const a=R.options.find(W=>W.name===n),C=R.options.find(W=>W.name===l);if(a&&C){S=R,P=a,z=C;break}}if(!S)return o&&Xe(`在 "${t.name}" 中未找到状态 "${n}" -> "${l}"`),[];const U=k.markdown.match(/data-view-id="([^"]+)"/);let D=U?U[1]:b,N=await Rt(b,D);const E=(R,a=0)=>{if(!R||a>5)return[];let C=[];const W=["rows","groups","blocks","children","items"];for(const H of W)if(Array.isArray(R[H]))for(const Z of R[H])Z.id&&Array.isArray(Z.cells)?C.push(Z):C=C.concat(E(Z,a+1));return R.view&&(C=C.concat(E(R.view,a+1))),C};let I=E(N);if(I.length===0&&(N!=null&&N.views)){const R=N.views.find(a=>a.type==="table");R&&(N=await Rt(b,R.id),I=E(N))}if(I.length===0)return[];let x=(((s=N.view)==null?void 0:s.columns)||N.columns||[]).findIndex(R=>R.id===S.id),K=[],M=0;for(const R of I){let a=!1;if(x>=0&&R.cells&&R.cells[x]){const C=R.cells[x].value;C!=null&&C.mSelect?a=C.mSelect.some(W=>W.content===n):C!=null&&C.select&&(a=C.select.content===n)}else if(R.cells&&Array.isArray(R.cells))for(const C of R.cells){const W=C.value;if((c=W==null?void 0:W.mSelect)!=null&&c.some(H=>H.content===n)){a=!0;break}else if(((u=W==null?void 0:W.select)==null?void 0:u.content)===n){a=!0;break}}if(a){const C={mSelect:[{content:z.name,color:z.color}]};await Pn(b,S.id,R.id,C),K.push(R.id),M++}}return M>0&&_t(`[${t.name}] 已归档 ${M} 个任务`),K}catch(p){return console.error("Status switch failed:",p),o&&Xe(`[${t.name}] 出错: `+p.message),[]}}async function el(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let l=0;for(const o of n)try{const s=await xe(`SELECT id FROM blocks WHERE content LIKE '%${o.keyword}%' AND type = 'd' LIMIT 1`);if(!s||s.length===0)continue;const c=s[0].id,u=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${c}' AND type = 'av' LIMIT 1`);if(!u||u.length===0)continue;const _=u[0].markdown.match(/data-av-id="([^"]+)"/);if(!_)continue;const m=_[1],v=await Ut(m);if(!v)continue;let k=null,f=null;for(const w of v)if((w.type==="select"||w.type==="mSelect")&&w.options){const S=w.options.find(P=>P.name===o.completedStatus);if(S){k=w,f=S;break}}if(!k||!f)continue;const b={mSelect:[{content:f.name,color:f.color}]};for(const w of t)await Pn(m,k.id,w,b);l+=t.length}catch(s){console.warn("Restore attempted failed for profile",o.name,s)}return l>0?(_t("已尝试撤销恢复任务"),!0):!1}async function tl(e,t=!1){const n=e.config.profiles||[];let l=[];if(n.length===0)return t&&Xe("未配置任何归档规则，请在设置中添加"),[];for(const o of n){if(!o.keyword||o.enabled===!1)continue;const s=await Zn(e,o,o.completedStatus,o.archivedStatus,t);l=l.concat(s)}return l}let wt=null;function nl(e){wt=e}function T(e,t){let n=null;if(wt&&wt.i18n&&(n=wt.i18n),!n)try{const{i18n:s}=require("siyuan");n=s}catch(s){console.warn("无法获取i18n对象:",s)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let l=n;const o=e.split(".");for(const s of o)if(l&&typeof l=="object"&&s in l)l=l[s];else{l=void 0;break}return typeof l!="string"&&(console.warn("未找到i18n键:",e),l=e),l}function Qe(){}function Un(e){return e()}function nn(){return Object.create(null)}function Ue(e){e.forEach(Un)}function Bn(e){return typeof e=="function"}function ll(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function il(e){return Object.keys(e).length===0}function i(e,t){e.appendChild(t)}function ae(e,t,n){e.insertBefore(t,n||null)}function ne(e){e.parentNode&&e.parentNode.removeChild(e)}function ct(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function d(e){return document.createElement(e)}function he(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function j(e){return document.createTextNode(e)}function y(){return j(" ")}function ol(){return j("")}function F(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function Tt(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function r(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function ze(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function sl(e){return Array.from(e.childNodes)}function Ve(e,t){t=""+t,e.data!==t&&(e.data=t)}function Q(e,t){e.value=t??""}function g(e,t,n,l){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function yt(e,t,n){for(let l=0;l<e.options.length;l+=1){const o=e.options[l];if(o.__value===t){o.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function ln(e){const t=e.querySelector(":checked");return t&&t.__value}function Fe(e,t,n){e.classList.toggle(t,!!n)}let gt;function pt(e){gt=e}function al(){if(!gt)throw new Error("Function called outside component initialization");return gt}function cl(e){al().$$.on_mount.push(e)}function rl(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(l=>l.call(this,t))}const st=[],on=[];let at=[];const sn=[],ul=Promise.resolve();let Lt=!1;function dl(){Lt||(Lt=!0,ul.then(On))}function vt(e){at.push(e)}const Mt=new Set;let it=0;function On(){if(it!==0)return;const e=gt;do{try{for(;it<st.length;){const t=st[it];it++,pt(t),fl(t.$$)}}catch(t){throw st.length=0,it=0,t}for(pt(null),st.length=0,it=0;on.length;)on.pop()();for(let t=0;t<at.length;t+=1){const n=at[t];Mt.has(n)||(Mt.add(n),n())}at.length=0}while(st.length);for(;sn.length;)sn.pop()();Lt=!1,Mt.clear(),pt(e)}function fl(e){if(e.fragment!==null){e.update(),Ue(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(vt)}}function hl(e){const t=[],n=[];at.forEach(l=>e.indexOf(l)===-1?t.push(l):n.push(l)),n.forEach(l=>l()),at=t}const pl=new Set;function Fn(e,t){e&&e.i&&(pl.delete(e),e.i(t))}function pe(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function $t(e,t){e.d(1),t.delete(e.key)}function xt(e,t,n,l,o,s,c,u,p,_,m,v){let k=e.length,f=s.length,b=k;const w={};for(;b--;)w[e[b].key]=b;const S=[],P=new Map,z=new Map,U=[];for(b=f;b--;){const I=v(o,s,b),$=n(I);let x=c.get($);x?U.push(()=>x.p(I,t)):(x=_($,I),x.c()),P.set($,S[b]=x),$ in w&&z.set($,Math.abs(b-w[$]))}const D=new Set,N=new Set;function E(I){Fn(I,1),I.m(u,m),c.set(I.key,I),m=I.first,f--}for(;k&&f;){const I=S[f-1],$=e[k-1],x=I.key,K=$.key;I===$?(m=I.first,k--,f--):P.has(K)?!c.has(x)||D.has(x)?E(I):N.has(K)?k--:z.get(x)>z.get(K)?(N.add(x),E(I)):(D.add(K),k--):(p($,c),k--)}for(;k--;){const I=e[k];P.has(I.key)||p(I,c)}for(;f;)E(S[f-1]);return Ue(U),S}function ml(e,t,n){const{fragment:l,after_update:o}=e.$$;l&&l.m(t,n),vt(()=>{const s=e.$$.on_mount.map(Un).filter(Bn);e.$$.on_destroy?e.$$.on_destroy.push(...s):Ue(s),e.$$.on_mount=[]}),o.forEach(vt)}function gl(e,t){const n=e.$$;n.fragment!==null&&(hl(n.after_update),Ue(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function vl(e,t){e.$$.dirty[0]===-1&&(st.push(e),dl(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function _l(e,t,n,l,o,s,c=null,u=[-1]){const p=gt;pt(e);const _=e.$$={fragment:null,ctx:[],props:s,update:Qe,not_equal:o,bound:nn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(p?p.$$.context:[])),callbacks:nn(),dirty:u,skip_bound:!1,root:t.target||p.$$.root};c&&c(_.root);let m=!1;if(_.ctx=n?n(e,t.props||{},(v,k,...f)=>{const b=f.length?f[0]:k;return _.ctx&&o(_.ctx[v],_.ctx[v]=b)&&(!_.skip_bound&&_.bound[v]&&_.bound[v](b),m&&vl(e,v)),k}):[],_.update(),m=!0,Ue(_.before_update),_.fragment=l?l(_.ctx):!1,t.target){if(t.hydrate){const v=sl(t.target);_.fragment&&_.fragment.l(v),v.forEach(ne)}else _.fragment&&_.fragment.c();t.intro&&Fn(e.$$.fragment),ml(e,t.target,t.anchor),On()}pt(p)}class kl{constructor(){He(this,"$$");He(this,"$$set")}$destroy(){gl(this,1),this.$destroy=Qe}$on(t,n){if(!Bn(n))return Qe;const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(n),()=>{const o=l.indexOf(n);o!==-1&&l.splice(o,1)}}$set(t){this.$$set&&!il(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const bl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(bl);function an(e,t,n){const l=e.slice();return l[57]=t[n],l[58]=t,l[59]=n,l}function cn(e,t,n){const l=e.slice();return l[60]=t[n],l[61]=t,l[62]=n,l}function rn(e,t,n){const l=e.slice();return l[63]=t[n],l}function un(e,t,n){const l=e.slice();return l[63]=t[n],l}function dn(e,t,n){const l=e.slice();return l[68]=t[n],l}function fn(e,t,n){const l=e.slice();return l[71]=t[n],l}function hn(e,t,n){const l=e.slice();return l[74]=t[n],l[75]=t,l[76]=n,l}function pn(e,t,n){const l=e.slice();return l[77]=t[n],l}function mn(e,t,n){const l=e.slice();return l[80]=t[n],l}function gn(e){let t,n,l;return{c(){t=d("div"),r(t,"class","backdrop svelte-1plhmm3")},m(o,s){ae(o,t,s),n||(l=F(t,"click",e[27]),n=!0)},p:Qe,d(o){o&&ne(t),n=!1,l()}}}function vn(e){let t,n,l,o,s,c,u=pe(e[9]),p=[];for(let v=0;v<u.length;v+=1)p[v]=_n(mn(e,u,v));let _=pe(e[10]),m=[];for(let v=0;v<_.length;v+=1)m[v]=kn(pn(e,_,v));return{c(){t=d("div"),n=d("div");for(let v=0;v<p.length;v+=1)p[v].c();l=y(),o=d("div"),s=y(),c=d("div");for(let v=0;v<m.length;v+=1)m[v].c();r(n,"class","time-col svelte-1plhmm3"),g(o,"width","1px"),g(o,"background","var(--b3-theme-surface-lighter)"),r(c,"class","time-col svelte-1plhmm3"),r(t,"class","time-picker-popover svelte-1plhmm3")},m(v,k){ae(v,t,k),i(t,n);for(let f=0;f<p.length;f+=1)p[f]&&p[f].m(n,null);i(t,l),i(t,o),i(t,s),i(t,c);for(let f=0;f<m.length;f+=1)m[f]&&m[f].m(c,null)},p(v,k){if(k[0]&33284){u=pe(v[9]);let f;for(f=0;f<u.length;f+=1){const b=mn(v,u,f);p[f]?p[f].p(b,k):(p[f]=_n(b),p[f].c(),p[f].m(n,null))}for(;f<p.length;f+=1)p[f].d(1);p.length=u.length}if(k[0]&66564){_=pe(v[10]);let f;for(f=0;f<_.length;f+=1){const b=pn(v,_,f);m[f]?m[f].p(b,k):(m[f]=kn(b),m[f].c(),m[f].m(c,null))}for(;f<m.length;f+=1)m[f].d(1);m.length=_.length}},d(v){v&&ne(t),ct(p,v),ct(m,v)}}}function _n(e){let t,n=e[80]+"",l,o,s,c;function u(){return e[30](e[80])}return{c(){t=d("div"),l=j(n),o=y(),r(t,"id",`time-opt-h-${e[80]}`),r(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].startsWith(e[80]))},m(p,_){ae(p,t,_),i(t,l),i(t,o),s||(c=F(t,"click",u),s=!0)},p(p,_){e=p,_[0]&516&&Fe(t,"selected",e[2].startsWith(e[80]))},d(p){p&&ne(t),s=!1,c()}}}function kn(e){let t,n=e[77]+"",l,o,s,c;function u(){return e[31](e[77])}return{c(){t=d("div"),l=j(n),o=y(),r(t,"id",`time-opt-m-${e[77]}`),r(t,"class","time-opt svelte-1plhmm3"),Fe(t,"selected",e[2].endsWith(e[77]))},m(p,_){ae(p,t,_),i(t,l),i(t,o),s||(c=F(t,"click",u),s=!0)},p(p,_){e=p,_[0]&1028&&Fe(t,"selected",e[2].endsWith(e[77]))},d(p){p&&ne(t),s=!1,c()}}}function bn(e){let t,n=e[74].keyword+"",l;return{c(){t=d("span"),l=j(n),r(t,"class","tag-preview svelte-1plhmm3")},m(o,s){ae(o,t,s),i(t,l)},p(o,s){s[0]&2&&n!==(n=o[74].keyword+"")&&Ve(l,n)},d(o){o&&ne(t)}}}function yn(e){let t,n,l,o,s,c,u,p,_,m,v,k,f,b,w,S,P,z,U,D,N,E,I;function $(){e[35].call(s,e[75],e[76])}function x(){e[36].call(m,e[75],e[76])}function K(){e[37].call(S,e[75],e[76])}function M(){e[38].call(N,e[75],e[76])}return{c(){t=d("div"),n=d("div"),l=d("div"),l.textContent=`${T("ruleNameLabel")}`,o=y(),s=d("input"),c=y(),u=d("div"),p=d("div"),p.textContent=`${T("keywordLabel")}`,_=y(),m=d("input"),v=y(),k=d("div"),f=d("div"),b=d("div"),b.textContent=`${T("completedStatusLabel")}`,w=y(),S=d("input"),P=y(),z=d("div"),U=d("div"),U.textContent=`${T("archivedStatusLabel")}`,D=y(),N=d("input"),r(l,"class","input-label svelte-1plhmm3"),r(s,"class","modern-input svelte-1plhmm3"),r(s,"type","text"),r(s,"placeholder",T("ruleNamePlaceholder")),r(n,"class","input-group svelte-1plhmm3"),r(p,"class","input-label svelte-1plhmm3"),r(m,"class","modern-input svelte-1plhmm3"),r(m,"type","text"),r(m,"placeholder",T("keywordPlaceholder")),r(u,"class","input-group svelte-1plhmm3"),r(b,"class","input-label svelte-1plhmm3"),r(S,"class","modern-input svelte-1plhmm3"),r(S,"type","text"),r(S,"placeholder",T("completedStatusPlaceholder")),r(f,"class","input-group fn__flex-1 svelte-1plhmm3"),r(U,"class","input-label svelte-1plhmm3"),r(N,"class","modern-input svelte-1plhmm3"),r(N,"type","text"),r(N,"placeholder",T("archivedStatusPlaceholder")),r(z,"class","input-group fn__flex-1 svelte-1plhmm3"),r(k,"class","fn__flex svelte-1plhmm3"),g(k,"gap","20px"),r(t,"class","card-content svelte-1plhmm3")},m(R,a){ae(R,t,a),i(t,n),i(n,l),i(n,o),i(n,s),Q(s,e[74].name),i(t,c),i(t,u),i(u,p),i(u,_),i(u,m),Q(m,e[74].keyword),i(t,v),i(t,k),i(k,f),i(f,b),i(f,w),i(f,S),Q(S,e[74].completedStatus),i(k,P),i(k,z),i(z,U),i(z,D),i(z,N),Q(N,e[74].archivedStatus),E||(I=[F(s,"input",$),F(s,"change",e[11]),F(m,"input",x),F(m,"change",e[11]),F(S,"input",K),F(S,"change",e[11]),F(N,"input",M),F(N,"change",e[11])],E=!0)},p(R,a){e=R,a[0]&2&&s.value!==e[74].name&&Q(s,e[74].name),a[0]&2&&m.value!==e[74].keyword&&Q(m,e[74].keyword),a[0]&2&&S.value!==e[74].completedStatus&&Q(S,e[74].completedStatus),a[0]&2&&N.value!==e[74].archivedStatus&&Q(N,e[74].archivedStatus)},d(R){R&&ne(t),E=!1,Ue(I)}}}function wn(e,t){let n,l,o,s,c,u,p=(t[74].name||T("unnamedRule"))+"",_,m,v,k,f,b,w,S,P,z,U,D,N,E,I=t[74].keyword&&bn(t);function $(){t[32].call(b,t[75],t[76])}function x(){return t[33](t[74])}function K(){return t[34](t[74])}let M=t[3]===t[74].id&&yn(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),c=d("div"),u=d("span"),_=j(p),m=y(),I&&I.c(),v=y(),k=d("div"),f=d("label"),b=d("input"),w=y(),S=d("span"),S.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',z=y(),U=d("div"),U.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',D=y(),M&&M.c(),r(o,"class","chevron svelte-1plhmm3"),g(u,"font-weight","600"),g(u,"font-size","15px"),g(u,"color","var(--b3-theme-on-surface)"),r(c,"class","fn__flex-1 svelte-1plhmm3"),g(c,"margin-left","14px"),g(c,"display","flex"),g(c,"align-items","center"),r(b,"class","switch-input svelte-1plhmm3"),r(b,"type","checkbox"),r(S,"class","switch-track svelte-1plhmm3"),r(f,"class","switch-container svelte-1plhmm3"),r(f,"title",P=t[74].enabled?T("enabled"):T("disabled")),r(k,"class","fn__flex-center"),g(k,"margin-right","20px"),r(U,"class","icon-btn svelte-1plhmm3"),r(U,"title",T("deleteRule")),r(l,"class","card-header svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),g(n,"opacity",t[74].enabled?1:.75),Fe(n,"expanded",t[3]===t[74].id),this.first=n},m(R,a){ae(R,n,a),i(n,l),i(l,o),i(l,s),i(l,c),i(c,u),i(u,_),i(c,m),I&&I.m(c,null),i(l,v),i(l,k),i(k,f),i(f,b),b.checked=t[74].enabled,i(f,w),i(f,S),i(l,z),i(l,U),i(n,D),M&&M.m(n,null),N||(E=[F(b,"change",$),F(b,"change",t[11]),F(k,"click",Tt(t[26])),F(U,"click",Tt(x)),F(l,"click",K)],N=!0)},p(R,a){t=R,a[0]&2&&p!==(p=(t[74].name||T("unnamedRule"))+"")&&Ve(_,p),t[74].keyword?I?I.p(t,a):(I=bn(t),I.c(),I.m(c,null)):I&&(I.d(1),I=null),a[0]&2&&(b.checked=t[74].enabled),a[0]&2&&P!==(P=t[74].enabled?T("enabled"):T("disabled"))&&r(f,"title",P),t[3]===t[74].id?M?M.p(t,a):(M=yn(t),M.c(),M.m(n,null)):M&&(M.d(1),M=null),a[0]&2&&g(n,"opacity",t[74].enabled?1:.75),a[0]&10&&Fe(n,"expanded",t[3]===t[74].id)},d(R){R&&ne(n),I&&I.d(),M&&M.d(),N=!1,Ue(E)}}}function Sn(e){let t;return{c(){t=d("div"),t.textContent=`${T("noRulesTip")}`,g(t,"text-align","center"),g(t,"padding","48px"),g(t,"color","var(--b3-theme-on-surface-light)"),g(t,"border","2px dashed var(--b3-border-color)"),g(t,"border-radius","16px")},m(n,l){ae(n,t,l)},d(n){n&&ne(t)}}}function Tn(e){let t,n,l,o,s,c,u,p,_,m,v,k,f,b,w,S,P,z,U,D,N,E,I,$,x,K,M,R,a,C,W,H,Z,te,le,ve,ie,V,Me,Se,Te,Re,me,oe,se,J,q,Y,re,Ie,Ae,Ce,ee=[],Ge=new Map,Ke,Be,ue,be,h;function A(){e[42].call(s,e[58],e[59])}function de(){e[43].call(m,e[58],e[59])}let De=pe(e[1]),ge=[];for(let B=0;B<De.length;B+=1)ge[B]=In(fn(e,De,B));let _e=e[1].length===0&&An(),We=pe(e[6]),ce=[];for(let B=0;B<We.length;B+=1)ce[B]=Cn(dn(e,We,B));function rt(){e[45].call(K,e[58],e[59])}function $e(){e[46].call(H,e[58],e[59])}function je(){e[47].call(V,e[58],e[59])}function ut(){e[48].call(J,e[58],e[59])}function dt(B,X){return(B[7][B[57].id]||[]).length===0?wl:yl}let Ze=dt(e),Ne=Ze(e),Je=pe(e[57].sections);const qe=B=>B[60].id;for(let B=0;B<Je.length;B+=1){let X=cn(e,Je,B),L=qe(X);Ge.set(L,ee[B]=En(L,X))}function Le(){return e[52](e[57])}return{c(){t=d("div"),n=d("div"),l=d("div"),l.textContent=`${T("templateNameLabel")}`,o=y(),s=d("input"),c=y(),u=d("div"),p=d("div"),p.textContent=`${T("templatePeriodLabel")}`,_=y(),m=d("select"),v=d("option"),v.textContent=`${T("templatePeriod_none")}`,k=d("option"),k.textContent=`${T("templatePeriod_day")}`,f=d("option"),f.textContent=`${T("templatePeriod_week")}`,b=d("option"),b.textContent=`${T("templatePeriod_month")}`,w=d("option"),w.textContent=`${T("templatePeriod_year")}`,S=y(),P=d("div"),z=d("div"),z.textContent=`${T("templateRuleLabel")}`,U=y(),D=d("div");for(let B=0;B<ge.length;B+=1)ge[B].c();N=y(),_e&&_e.c(),E=y(),I=d("div"),$=d("div"),$.textContent=`${T("templateNotebookLabel")}`,x=y(),K=d("select"),M=d("option"),M.textContent=`${T("templateNotebookAuto")}`;for(let B=0;B<ce.length;B+=1)ce[B].c();R=y(),a=d("div"),C=d("div"),C.textContent=`${T("templatePathLabel")}`,W=y(),H=d("input"),Z=y(),te=d("div"),le=d("div"),le.textContent=`${T("reportClipboardOnlySections")}`,ve=y(),ie=d("label"),V=d("input"),Me=y(),Se=d("span"),Se.innerHTML='<span class="switch-thumb svelte-1plhmm3"></span>',Re=y(),me=d("div"),oe=d("div"),oe.textContent=`${T("templateTitleLabel")}`,se=y(),J=d("input"),q=y(),Y=d("div"),re=d("div"),re.textContent=`${T("templateSectionList")}`,Ie=y(),Ae=d("div"),Ne.c(),Ce=y();for(let B=0;B<ee.length;B+=1)ee[B].c();Ke=y(),Be=d("div"),ue=d("button"),ue.textContent=`${T("templateSectionAdd")}`,r(l,"class","input-label svelte-1plhmm3"),r(s,"class","modern-input svelte-1plhmm3"),r(s,"type","text"),r(n,"class","input-group svelte-1plhmm3"),r(p,"class","input-label svelte-1plhmm3"),v.__value="none",Q(v,v.__value),k.__value="day",Q(k,k.__value),f.__value="week",Q(f,f.__value),b.__value="month",Q(b,b.__value),w.__value="year",Q(w,w.__value),r(m,"class","modern-input svelte-1plhmm3"),e[57].period===void 0&&vt(de),r(u,"class","input-group svelte-1plhmm3"),r(z,"class","input-label svelte-1plhmm3"),r(D,"class","fn__flex svelte-1plhmm3"),g(D,"flex-wrap","wrap"),g(D,"gap","12px"),r(P,"class","input-group svelte-1plhmm3"),r($,"class","input-label svelte-1plhmm3"),M.__value="",Q(M,M.__value),r(K,"class","modern-input svelte-1plhmm3"),e[57].notebookId===void 0&&vt(rt),r(I,"class","input-group svelte-1plhmm3"),r(C,"class","input-label svelte-1plhmm3"),r(H,"class","modern-input svelte-1plhmm3"),r(H,"type","text"),r(H,"placeholder",T("templatePathPlaceholder")),r(a,"class","input-group svelte-1plhmm3"),r(le,"class","input-label svelte-1plhmm3"),r(V,"class","switch-input svelte-1plhmm3"),r(V,"type","checkbox"),r(Se,"class","switch-track svelte-1plhmm3"),r(ie,"class","switch-container svelte-1plhmm3"),r(ie,"title",Te=e[57].clipboardOnlySections?T("enabled"):T("disabled")),r(te,"class","input-group svelte-1plhmm3"),r(oe,"class","input-label svelte-1plhmm3"),r(J,"class","modern-input svelte-1plhmm3"),r(J,"type","text"),r(J,"placeholder",T("templateTitlePlaceholder")),r(me,"class","input-group svelte-1plhmm3"),r(re,"class","input-label svelte-1plhmm3"),r(Ae,"class","fn__flex svelte-1plhmm3"),g(Ae,"flex-wrap","wrap"),g(Ae,"gap","8px"),g(Ae,"margin-bottom","8px"),r(ue,"class","action-btn svelte-1plhmm3"),g(ue,"width","132px"),g(ue,"justify-content","center"),r(Be,"class","fn__flex svelte-1plhmm3"),g(Be,"justify-content","flex-start"),r(Y,"class","input-group svelte-1plhmm3"),r(t,"class","card-content svelte-1plhmm3")},m(B,X){ae(B,t,X),i(t,n),i(n,l),i(n,o),i(n,s),Q(s,e[57].name),i(t,c),i(t,u),i(u,p),i(u,_),i(u,m),i(m,v),i(m,k),i(m,f),i(m,b),i(m,w),yt(m,e[57].period,!0),i(t,S),i(t,P),i(P,z),i(P,U),i(P,D);for(let L=0;L<ge.length;L+=1)ge[L]&&ge[L].m(D,null);i(D,N),_e&&_e.m(D,null),i(t,E),i(t,I),i(I,$),i(I,x),i(I,K),i(K,M);for(let L=0;L<ce.length;L+=1)ce[L]&&ce[L].m(K,null);yt(K,e[57].notebookId,!0),i(t,R),i(t,a),i(a,C),i(a,W),i(a,H),Q(H,e[57].pathTemplate),i(t,Z),i(t,te),i(te,le),i(te,ve),i(te,ie),i(ie,V),V.checked=e[57].clipboardOnlySections,i(ie,Me),i(ie,Se),i(t,Re),i(t,me),i(me,oe),i(me,se),i(me,J),Q(J,e[57].titleTemplate),i(t,q),i(t,Y),i(Y,re),i(Y,Ie),i(Y,Ae),Ne.m(Ae,null),i(Y,Ce);for(let L=0;L<ee.length;L+=1)ee[L]&&ee[L].m(Y,null);i(Y,Ke),i(Y,Be),i(Be,ue),be||(h=[F(s,"input",A),F(s,"change",e[11]),F(m,"change",de),F(m,"change",e[11]),F(K,"change",rt),F(K,"change",e[11]),F(H,"input",$e),F(H,"change",e[11]),F(V,"change",je),F(V,"change",e[11]),F(J,"input",ut),F(J,"change",e[11]),F(ue,"click",Le)],be=!0)},p(B,X){if(e=B,X[0]&16&&s.value!==e[57].name&&Q(s,e[57].name),X[0]&16&&yt(m,e[57].period),X[0]&4194322){De=pe(e[1]);let L;for(L=0;L<De.length;L+=1){const fe=fn(e,De,L);ge[L]?ge[L].p(fe,X):(ge[L]=In(fe),ge[L].c(),ge[L].m(D,N))}for(;L<ge.length;L+=1)ge[L].d(1);ge.length=De.length}if(e[1].length===0?_e||(_e=An(),_e.c(),_e.m(D,null)):_e&&(_e.d(1),_e=null),X[0]&64){We=pe(e[6]);let L;for(L=0;L<We.length;L+=1){const fe=dn(e,We,L);ce[L]?ce[L].p(fe,X):(ce[L]=Cn(fe),ce[L].c(),ce[L].m(K,null))}for(;L<ce.length;L+=1)ce[L].d(1);ce.length=We.length}X[0]&16&&yt(K,e[57].notebookId),X[0]&16&&H.value!==e[57].pathTemplate&&Q(H,e[57].pathTemplate),X[0]&16&&(V.checked=e[57].clipboardOnlySections),X[0]&16&&Te!==(Te=e[57].clipboardOnlySections?T("enabled"):T("disabled"))&&r(ie,"title",Te),X[0]&16&&J.value!==e[57].titleTemplate&&Q(J,e[57].titleTemplate),Ze===(Ze=dt(e))&&Ne?Ne.p(e,X):(Ne.d(1),Ne=Ze(e),Ne&&(Ne.c(),Ne.m(Ae,null))),X[0]&50333840&&(Je=pe(e[57].sections),ee=xt(ee,X,qe,1,e,Je,Ge,Y,$t,En,Ke,cn))},d(B){B&&ne(t),ct(ge,B),_e&&_e.d(),ct(ce,B),Ne.d();for(let X=0;X<ee.length;X+=1)ee[X].d();be=!1,Ue(h)}}}function In(e){let t,n,l,o,s,c=(e[71].name||e[71].keyword||e[71].id)+"",u,p,_;function m(){return e[44](e[57],e[71])}return{c(){var v;t=d("label"),n=d("input"),o=y(),s=d("span"),u=j(c),r(n,"type","checkbox"),n.checked=l=(v=e[57].ruleIds)==null?void 0:v.includes(e[71].id),g(s,"font-size","13px"),r(t,"class","fn__flex svelte-1plhmm3"),g(t,"align-items","center"),g(t,"gap","6px"),g(t,"padding","6px 10px"),g(t,"border","1px solid var(--b3-border-color)"),g(t,"border-radius","999px"),g(t,"background","var(--b3-theme-background)")},m(v,k){ae(v,t,k),i(t,n),i(t,o),i(t,s),i(s,u),p||(_=F(n,"change",m),p=!0)},p(v,k){var f;e=v,k[0]&18&&l!==(l=(f=e[57].ruleIds)==null?void 0:f.includes(e[71].id))&&(n.checked=l),k[0]&2&&c!==(c=(e[71].name||e[71].keyword||e[71].id)+"")&&Ve(u,c)},d(v){v&&ne(t),p=!1,_()}}}function An(e){let t;return{c(){t=d("div"),t.textContent=`${T("reportNoProfileTip")}`,g(t,"font-size","13px"),g(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){ae(n,t,l)},d(n){n&&ne(t)}}}function Cn(e){let t,n=e[68].name+"",l,o;return{c(){t=d("option"),l=j(n),t.__value=o=e[68].id,Q(t,t.__value)},m(s,c){ae(s,t,c),i(t,l)},p(s,c){c[0]&64&&n!==(n=s[68].name+"")&&Ve(l,n),c[0]&64&&o!==(o=s[68].id)&&(t.__value=o,Q(t,t.__value))},d(s){s&&ne(t)}}}function yl(e){let t,n=pe(e[7][e[57].id]),l=[];for(let o=0;o<n.length;o+=1)l[o]=Dn(un(e,n,o));return{c(){for(let o=0;o<l.length;o+=1)l[o].c();t=ol()},m(o,s){for(let c=0;c<l.length;c+=1)l[c]&&l[c].m(o,s);ae(o,t,s)},p(o,s){if(s[0]&144){n=pe(o[7][o[57].id]);let c;for(c=0;c<n.length;c+=1){const u=un(o,n,c);l[c]?l[c].p(u,s):(l[c]=Dn(u),l[c].c(),l[c].m(t.parentNode,t))}for(;c<l.length;c+=1)l[c].d(1);l.length=n.length}},d(o){o&&ne(t),ct(l,o)}}}function wl(e){let t;return{c(){t=d("div"),t.textContent=`${T("templateStatusEmpty")}`,g(t,"font-size","13px"),g(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){ae(n,t,l)},p:Qe,d(n){n&&ne(t)}}}function Dn(e){let t,n=e[63]+"",l;return{c(){t=d("span"),l=j(n),r(t,"class","tag-preview svelte-1plhmm3")},m(o,s){ae(o,t,s),i(t,l)},p(o,s){s[0]&144&&n!==(n=o[63]+"")&&Ve(l,n)},d(o){o&&ne(t)}}}function Nn(e){let t,n,l,o,s,c=e[63]+"",u,p,_,m;function v(){return e[50](e[60],e[63])}return{c(){t=d("label"),n=d("input"),o=y(),s=d("span"),u=j(c),p=y(),r(n,"class","dot-check svelte-1plhmm3"),r(n,"type","checkbox"),n.checked=l=(e[60].statuses||[]).includes(e[63]),g(s,"font-size","12px"),r(t,"class","fn__flex status-dot svelte-1plhmm3"),g(t,"align-items","center"),g(t,"gap","6px"),g(t,"padding","4px 8px"),g(t,"border","1px solid var(--b3-border-color)"),g(t,"border-radius","999px"),g(t,"background","var(--b3-theme-background)")},m(k,f){ae(k,t,f),i(t,n),i(t,o),i(t,s),i(s,u),i(t,p),_||(m=F(n,"change",v),_=!0)},p(k,f){e=k,f[0]&144&&l!==(l=(e[60].statuses||[]).includes(e[63]))&&(n.checked=l),f[0]&144&&c!==(c=e[63]+"")&&Ve(u,c)},d(k){k&&ne(t),_=!1,m()}}}function En(e,t){let n,l,o,s,c,u,p,_,m,v,k,f,b,w,S,P;function z(){t[49].call(u,t[61],t[62])}let U=pe(t[7][t[57].id]||[]),D=[];for(let E=0;E<U.length;E+=1)D[E]=Nn(rn(t,U,E));function N(){return t[51](t[57],t[60])}return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),s=d("div"),s.textContent=`${T("templateSectionTitleLabel")}`,c=y(),u=d("input"),p=y(),_=d("div"),m=d("div"),m.textContent=`${T("templateSectionStatusLabel")}`,v=y(),k=d("div");for(let E=0;E<D.length;E+=1)D[E].c();f=y(),b=d("div"),w=d("div"),w.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',r(s,"class","input-label svelte-1plhmm3"),r(u,"class","modern-input svelte-1plhmm3"),r(u,"type","text"),r(o,"class","input-group svelte-1plhmm3"),r(m,"class","input-label svelte-1plhmm3"),r(k,"class","fn__flex svelte-1plhmm3"),g(k,"flex-wrap","wrap"),g(k,"gap","10px"),r(_,"class","input-group svelte-1plhmm3"),r(w,"class","icon-btn svelte-1plhmm3"),r(w,"title",T("templateSectionDelete")),r(b,"class","fn__flex svelte-1plhmm3"),g(b,"justify-content","flex-end"),r(l,"class","card-content svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),g(n,"margin-bottom","12px"),this.first=n},m(E,I){ae(E,n,I),i(n,l),i(l,o),i(o,s),i(o,c),i(o,u),Q(u,t[60].title),i(l,p),i(l,_),i(_,m),i(_,v),i(_,k);for(let $=0;$<D.length;$+=1)D[$]&&D[$].m(k,null);i(l,f),i(l,b),i(b,w),S||(P=[F(u,"input",z),F(u,"change",t[11]),F(w,"click",N)],S=!0)},p(E,I){if(t=E,I[0]&16&&u.value!==t[60].title&&Q(u,t[60].title),I[0]&33554576){U=pe(t[7][t[57].id]||[]);let $;for($=0;$<U.length;$+=1){const x=rn(t,U,$);D[$]?D[$].p(x,I):(D[$]=Nn(x),D[$].c(),D[$].m(k,null))}for(;$<D.length;$+=1)D[$].d(1);D.length=U.length}},d(E){E&&ne(n),ct(D,E),S=!1,Ue(P)}}}function Mn(e,t){let n,l,o,s,c,u,p=t[57].name+"",_,m,v,k=T(`templatePeriod_${t[57].period||"none"}`)+"",f,b,w,S,P,z,U,D,N;function E(){return t[39](t[57])}function I(){return t[40](t[57])}function $(){return t[41](t[57])}let x=t[5]===t[57].id&&Tn(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),o=d("div"),o.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',s=y(),c=d("div"),u=d("span"),_=j(p),m=y(),v=d("span"),f=j(k),b=y(),w=d("button"),w.textContent=`${T("templateGenerate")}`,S=y(),P=d("div"),P.innerHTML='<svg class="svelte-1plhmm3"><use xlink:href="#iconTrashcan"></use></svg>',z=y(),x&&x.c(),U=y(),r(o,"class","chevron svelte-1plhmm3"),g(u,"font-weight","600"),g(u,"font-size","15px"),g(u,"color","var(--b3-theme-on-surface)"),r(v,"class","tag-preview svelte-1plhmm3"),r(c,"class","fn__flex-1 svelte-1plhmm3"),g(c,"margin-left","14px"),g(c,"display","flex"),g(c,"align-items","center"),r(w,"class","action-btn svelte-1plhmm3"),g(w,"height","28px"),g(w,"padding","0 12px"),g(w,"margin-right","8px"),r(P,"class","icon-btn svelte-1plhmm3"),r(P,"title",T("deleteRule")),r(l,"class","card-header svelte-1plhmm3"),r(n,"class","card svelte-1plhmm3"),Fe(n,"expanded",t[5]===t[57].id),this.first=n},m(K,M){ae(K,n,M),i(n,l),i(l,o),i(l,s),i(l,c),i(c,u),i(u,_),i(c,m),i(c,v),i(v,f),i(l,b),i(l,w),i(l,S),i(l,P),i(n,z),x&&x.m(n,null),i(n,U),D||(N=[F(w,"click",Tt(E)),F(P,"click",Tt(I)),F(l,"click",$)],D=!0)},p(K,M){t=K,M[0]&16&&p!==(p=t[57].name+"")&&Ve(_,p),M[0]&16&&k!==(k=T(`templatePeriod_${t[57].period||"none"}`)+"")&&Ve(f,k),t[5]===t[57].id?x?x.p(t,M):(x=Tn(t),x.c(),x.m(n,U)):x&&(x.d(1),x=null),M[0]&48&&Fe(n,"expanded",t[5]===t[57].id)},d(K){K&&ne(n),x&&x.d(),D=!1,Ue(N)}}}function Sl(e){let t,n,l,o,s,c,u,p=T("globalArchiveTime")+"",_,m,v,k,f,b,w,S,P=T("undoArchive")+"",z,U,D,N,E,I,$=T("archiveNow")+"",x,K,M,R,a,C,W,H,Z,te,le,ve,ie,V,Me,Se=T("archiveRuleList")+"",Te,Re,me,oe,se,J,q,Y,re=T("addRule")+"",Ie,Ae,Ce,ee=[],Ge=new Map,Ke,Be,ue,be,h,A,de,De,ge=T("templateListTitle")+"",_e,We,ce,rt,$e,je,ut,dt,Ze=T("templateAdd")+"",Ne,Je,qe,Le=[],B=new Map,X,L,fe,ft,It,Ot,Wn=T("usageTipTitle")+"",Ft,Kt,Oe,et,At,Wt,Hn=T("usageTipGlobalDesc")+"",Ht,zt,tt,Ct,Vt,zn=T("usageTipMatchDesc")+"",jt,qt,nt,Dt,Yt,Vn=T("usageTipStatusDesc")+"",Xt,Gt,lt,Nt,Jt,jn=T("usageTipReportDesc")+"",Qt,Et,Zt,ye=e[8]&&gn(e),we=e[8]&&vn(e),kt=pe(e[1]);const en=O=>O[74].id;for(let O=0;O<kt.length;O+=1){let G=hn(e,kt,O),ke=en(G);Ge.set(ke,ee[O]=wn(ke,G))}let Ee=e[1].length===0&&Sn(),bt=pe(e[4]);const tn=O=>O[57].id;for(let O=0;O<bt.length;O+=1){let G=an(e,bt,O),ke=tn(G);B.set(ke,Le[O]=Mn(ke,G))}return{c(){ye&&ye.c(),t=y(),n=d("div"),l=d("div"),o=d("div"),s=he("svg"),c=he("use"),u=y(),_=j(p),m=y(),v=d("div"),k=y(),f=d("button"),b=he("svg"),w=he("use"),S=y(),z=j(P),U=y(),D=d("button"),N=he("svg"),E=he("use"),I=y(),x=j($),K=y(),M=d("div"),R=j(e[2]),a=y(),C=he("svg"),W=he("use"),H=y(),we&&we.c(),Z=y(),te=d("div"),le=d("div"),ve=d("div"),ie=he("svg"),V=he("use"),Me=y(),Te=j(Se),Re=y(),me=d("div"),oe=y(),se=d("button"),J=he("svg"),q=he("use"),Y=y(),Ie=j(re),Ae=y(),Ce=d("div");for(let O=0;O<ee.length;O+=1)ee[O].c();Ke=y(),Ee&&Ee.c(),Be=y(),ue=d("div"),be=d("div"),h=d("div"),A=he("svg"),de=he("use"),De=y(),_e=j(ge),We=y(),ce=d("div"),rt=y(),$e=d("button"),je=he("svg"),ut=he("use"),dt=y(),Ne=j(Ze),Je=y(),qe=d("div");for(let O=0;O<Le.length;O+=1)Le[O].c();X=y(),L=d("div"),fe=d("div"),ft=he("svg"),It=he("use"),Ot=y(),Ft=j(Wn),Kt=y(),Oe=d("ul"),et=d("li"),At=d("strong"),At.textContent=`${T("usageTipGlobal")}`,Wt=j("："),Ht=j(Hn),zt=y(),tt=d("li"),Ct=d("strong"),Ct.textContent=`${T("usageTipMatch")}`,Vt=j("："),jt=j(zn),qt=y(),nt=d("li"),Dt=d("strong"),Dt.textContent=`${T("usageTipStatus")}`,Yt=j("："),Xt=j(Vn),Gt=y(),lt=d("li"),Nt=d("strong"),Nt.textContent=`${T("usageTipReport")}`,Jt=j("："),Qt=j(jn),ze(c,"xlink:href","#iconCalendar"),g(s,"width","18px"),g(s,"height","18px"),r(o,"class","section-title svelte-1plhmm3"),r(v,"class","fn__flex-1 svelte-1plhmm3"),ze(w,"xlink:href","#iconUndo"),g(b,"width","14px"),g(b,"height","14px"),r(b,"class","svelte-1plhmm3"),r(f,"class","action-btn svelte-1plhmm3"),g(f,"background-color","transparent"),g(f,"color","var(--b3-theme-on-surface)"),g(f,"box-shadow","none"),g(f,"border","1px solid var(--b3-theme-surface-lighter)"),g(f,"margin-right","12px"),ze(E,"xlink:href","#iconFiles"),g(N,"width","14px"),g(N,"height","14px"),r(N,"class","svelte-1plhmm3"),r(D,"class","action-btn svelte-1plhmm3"),g(D,"margin-right","32px"),ze(W,"xlink:href","#iconClock"),g(C,"width","14px"),g(C,"height","14px"),g(C,"opacity","0.6"),r(M,"class","time-trigger svelte-1plhmm3"),Fe(M,"active",e[8]),r(l,"class","section-header svelte-1plhmm3"),ze(V,"xlink:href","#iconSettings"),g(ie,"width","18px"),g(ie,"height","18px"),r(ve,"class","section-title svelte-1plhmm3"),r(me,"class","fn__flex-1 svelte-1plhmm3"),ze(q,"xlink:href","#iconAdd"),g(J,"width","14px"),g(J,"height","14px"),r(J,"class","svelte-1plhmm3"),r(se,"class","action-btn svelte-1plhmm3"),r(le,"class","section-header svelte-1plhmm3"),r(Ce,"class","profile-container svelte-1plhmm3"),g(te,"margin-top","20px"),g(te,"display","flex"),g(te,"flex-direction","column"),ze(de,"xlink:href","#iconCalendar"),g(A,"width","18px"),g(A,"height","18px"),r(h,"class","section-title svelte-1plhmm3"),r(ce,"class","fn__flex-1 svelte-1plhmm3"),ze(ut,"xlink:href","#iconAdd"),g(je,"width","14px"),g(je,"height","14px"),r(je,"class","svelte-1plhmm3"),r($e,"class","action-btn svelte-1plhmm3"),g($e,"width","132px"),g($e,"justify-content","center"),r(be,"class","section-header svelte-1plhmm3"),r(qe,"class","profile-container svelte-1plhmm3"),g(ue,"margin-top","24px"),g(ue,"display","flex"),g(ue,"flex-direction","column"),ze(It,"xlink:href","#iconInfo"),g(ft,"width","16px"),g(ft,"height","16px"),g(fe,"font-weight","700"),g(fe,"color","var(--b3-theme-primary)"),g(fe,"display","flex"),g(fe,"align-items","center"),g(fe,"gap","8px"),g(fe,"margin-bottom","8px"),g(fe,"font-size","14px"),r(et,"class","svelte-1plhmm3"),r(tt,"class","svelte-1plhmm3"),r(nt,"class","svelte-1plhmm3"),r(lt,"class","svelte-1plhmm3"),r(Oe,"class","svelte-1plhmm3"),r(L,"class","info-footer svelte-1plhmm3"),r(n,"class","settings-container svelte-1plhmm3")},m(O,G){ye&&ye.m(O,G),ae(O,t,G),ae(O,n,G),i(n,l),i(l,o),i(o,s),i(s,c),i(o,u),i(o,_),i(l,m),i(l,v),i(l,k),i(l,f),i(f,b),i(b,w),i(f,S),i(f,z),i(l,U),i(l,D),i(D,N),i(N,E),i(D,I),i(D,x),i(l,K),i(l,M),i(M,R),i(M,a),i(M,C),i(C,W),i(l,H),we&&we.m(l,null),i(n,Z),i(n,te),i(te,le),i(le,ve),i(ve,ie),i(ie,V),i(ve,Me),i(ve,Te),i(le,Re),i(le,me),i(le,oe),i(le,se),i(se,J),i(J,q),i(se,Y),i(se,Ie),i(te,Ae),i(te,Ce);for(let ke=0;ke<ee.length;ke+=1)ee[ke]&&ee[ke].m(Ce,null);i(Ce,Ke),Ee&&Ee.m(Ce,null),i(n,Be),i(n,ue),i(ue,be),i(be,h),i(h,A),i(A,de),i(h,De),i(h,_e),i(be,We),i(be,ce),i(be,rt),i(be,$e),i($e,je),i(je,ut),i($e,dt),i($e,Ne),i(ue,Je),i(ue,qe);for(let ke=0;ke<Le.length;ke+=1)Le[ke]&&Le[ke].m(qe,null);i(n,X),i(n,L),i(L,fe),i(fe,ft),i(ft,It),i(fe,Ot),i(fe,Ft),i(L,Kt),i(L,Oe),i(Oe,et),i(et,At),i(et,Wt),i(et,Ht),i(Oe,zt),i(Oe,tt),i(tt,Ct),i(tt,Vt),i(tt,jt),i(Oe,qt),i(Oe,nt),i(nt,Dt),i(nt,Yt),i(nt,Xt),i(Oe,Gt),i(Oe,lt),i(lt,Nt),i(lt,Jt),i(lt,Qt),Et||(Zt=[F(f,"click",e[28]),F(D,"click",e[29]),F(M,"click",e[17]),F(se,"click",e[12]),F($e,"click",e[19])],Et=!0)},p(O,G){O[8]?ye?ye.p(O,G):(ye=gn(O),ye.c(),ye.m(t.parentNode,t)):ye&&(ye.d(1),ye=null),G[0]&4&&Ve(R,O[2]),G[0]&256&&Fe(M,"active",O[8]),O[8]?we?we.p(O,G):(we=vn(O),we.c(),we.m(l,null)):we&&(we.d(1),we=null),G[0]&26634&&(kt=pe(O[1]),ee=xt(ee,G,en,1,O,kt,Ge,Ce,$t,wn,Ke,hn)),O[1].length===0?Ee||(Ee=Sn(),Ee.c(),Ee.m(Ce,null)):Ee&&(Ee.d(1),Ee=null),G[0]&66324722&&(bt=pe(O[4]),Le=xt(Le,G,tn,1,O,bt,B,qe,$t,Mn,null,an))},i:Qe,o:Qe,d(O){O&&(ne(t),ne(n)),ye&&ye.d(O),we&&we.d();for(let G=0;G<ee.length;G+=1)ee[G].d();Ee&&Ee.d();for(let G=0;G<Le.length;G+=1)Le[G].d();Et=!1,Ue(Zt)}}}function ot(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function Rn(e,t){const n=`time-opt-${e}-${t}`,l=document.getElementById(n);l&&l.scrollIntoView({block:"center",behavior:"smooth"})}function Tl(e,t,n){let{plugin:l}=t,o=[],s="00:00",c=null,u=[],p=null,_=[],m={},v=!1;const k=Array.from({length:24},(h,A)=>A.toString().padStart(2,"0")),f=Array.from({length:60},(h,A)=>A.toString().padStart(2,"0"));cl(()=>{b(),l.config.profiles&&l.config.profiles.length===1&&n(3,c=l.config.profiles[0].id),I()});function b(){n(1,o=l.config.profiles||[]),n(2,s=l.config.archiveTime||"00:00"),n(4,u=l.config.templates||[])}async function w(){n(0,l.config.archiveTime=s,l),n(0,l.config.templates=u,l),l.saveData("config.json",l.config),b()}function S(){l.config.profiles||n(0,l.config.profiles=[],l);const h={id:ot(),name:T("defaultNewRuleName")+" "+(l.config.profiles.length+1),keyword:"",completedStatus:T("defaultCompleted"),archivedStatus:T("defaultArchived"),enabled:!0};n(0,l.config.profiles=[...l.config.profiles,h],l),w(),n(3,c=h.id),setTimeout(()=>{const A=document.querySelector(".profile-container");A&&(A.scrollTop=A.scrollHeight)},50)}function P(h){n(0,l.config.profiles=l.config.profiles.filter(A=>A.id!==h),l),w(),c===h&&n(3,c=null)}function z(h){c===h?n(3,c=null):n(3,c=h)}function U(h){const A=s.split(":");n(2,s=`${h}:${A[1]||"00"}`),w()}function D(h){const A=s.split(":");n(2,s=`${A[0]||"00"}:${h}`),w()}function N(){n(8,v=!v),v&&setTimeout(()=>{const[h,A]=s.split(":");Rn("h",h),Rn("m",A)},10)}function E(h){l.generateTemplate&&l.generateTemplate(h)}async function I(){if(!l.getNotebooks)return;const h=await l.getNotebooks();n(6,_=(h==null?void 0:h.notebooks)||[])}function $(){const h={id:ot(),name:T("templateNewName"),period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:T("templateTitleDefault"),sections:[{id:ot(),title:T("templateSectionTodo"),statuses:[]},{id:ot(),title:T("templateSectionDoing"),statuses:[]},{id:ot(),title:T("templateSectionDone"),statuses:[]}]};n(4,u=[...u,h]),w(),n(5,p=h.id)}function x(h){n(4,u=u.filter(A=>A.id!==h)),w(),p===h&&n(5,p=null)}function K(h){if(p===h)n(5,p=null);else{n(5,p=h);const A=u.find(de=>de.id===h);A&&R(A)}}function M(h,A){const de=h.ruleIds||[];h.ruleIds=de.includes(A)?de.filter(De=>De!==A):[...de,A],w(),R(h)}async function R(h){l.getStatusOptions&&n(7,m[h.id]=await l.getStatusOptions(h.ruleIds||[]),m)}function a(h){h.sections=[...h.sections||[],{id:ot(),title:T("templateSectionNew"),statuses:[]}],w()}function C(h,A){h.sections=(h.sections||[]).filter(de=>de.id!==A),w()}function W(h,A){const de=h.statuses||[];h.statuses=de.includes(A)?de.filter(De=>De!==A):[...de,A],w()}function H(h){rl.call(this,e,h)}const Z=()=>n(8,v=!1),te=()=>l.undoArchiveNow(),le=()=>l.archiveNow(),ve=h=>U(h),ie=h=>D(h);function V(h,A){h[A].enabled=this.checked,n(1,o)}const Me=h=>P(h.id),Se=h=>z(h.id);function Te(h,A){h[A].name=this.value,n(1,o)}function Re(h,A){h[A].keyword=this.value,n(1,o)}function me(h,A){h[A].completedStatus=this.value,n(1,o)}function oe(h,A){h[A].archivedStatus=this.value,n(1,o)}const se=h=>E(h.id),J=h=>x(h.id),q=h=>K(h.id);function Y(h,A){h[A].name=this.value,n(4,u)}function re(h,A){h[A].period=ln(this),n(4,u)}const Ie=(h,A)=>M(h,A.id);function Ae(h,A){h[A].notebookId=ln(this),n(4,u)}function Ce(h,A){h[A].pathTemplate=this.value,n(4,u)}function ee(h,A){h[A].clipboardOnlySections=this.checked,n(4,u)}function Ge(h,A){h[A].titleTemplate=this.value,n(4,u)}function Ke(h,A){h[A].title=this.value,n(4,u)}const Be=(h,A)=>W(h,A),ue=(h,A)=>C(h,A.id),be=h=>a(h);return e.$$set=h=>{"plugin"in h&&n(0,l=h.plugin)},[l,o,s,c,u,p,_,m,v,k,f,w,S,P,z,U,D,N,E,$,x,K,M,a,C,W,H,Z,te,le,ve,ie,V,Me,Se,Te,Re,me,oe,se,J,q,Y,re,Ie,Ae,Ce,ee,Ge,Ke,Be,ue,be]}class Il extends kl{constructor(t){super(),_l(this,t,Tl,Sl,ll,{plugin:0},null,[-1,-1,-1])}}function Ye(e){var t,n,l,o,s;if(!e)return"";if(Array.isArray(e))return e.map(c=>Ye(c)).filter(Boolean).join(", ");if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(e.content!==void 0)return e.content;if(((t=e.text)==null?void 0:t.content)!==void 0)return e.text.content;if(((n=e.block)==null?void 0:n.content)!==void 0)return e.block.content;if(((l=e.date)==null?void 0:l.content)!==void 0)return e.date.content;if(((o=e.mSelect)==null?void 0:o.length)>0)return e.mSelect.map(c=>c.content).join(", ");if(((s=e.select)==null?void 0:s.content)!==void 0)return e.select.content;for(const c in e)if(typeof e[c]=="object"&&e[c]!==null){const u=Ye(e[c]);if(u)return u}return""}function Al(e){if(!e)return 0;const t=String(e).trim();if(t.match(/^\d{4}-\d{2}-\d{2}/))return new Date(t.substring(0,10).replace(/-/g,"/")+" 00:00:00").getTime();if(t.length===14&&/^\d+$/.test(t))return new Date(t.substring(0,4),parseInt(t.substring(4,6),10)-1,t.substring(6,8),t.substring(8,10),t.substring(10,12),t.substring(12,14)).getTime();const n=parseInt(t,10);return t.length===10?n*1e3:n}function Ln(e){const t=Al(e);if(t&&!Number.isNaN(t))return t;const n=Date.parse(e);return Number.isNaN(n)?0:n}function Cl(e){if(!e||typeof e!="object")return"";if(typeof e.name=="string")return e.name;if(typeof e.title=="string")return e.title;if(typeof e.label=="string")return e.label;if(e.value){const t=Ye(e.value);if(t)return t}if(e.key){const t=Ye(e.key);if(t)return t;if(typeof e.key.name=="string")return e.key.name}return""}function St(e,t=""){let n=[];if(!e||typeof e!="object")return n;e.id&&(Array.isArray(e.cells)||Array.isArray(e.values))&&(t&&(e.__groupStatus=t),n.push(e));for(const l in e)if(Object.prototype.hasOwnProperty.call(e,l)){const o=e[l];Array.isArray(o)?l==="groups"?o.forEach(s=>{const c=Cl(s)||t;n=n.concat(St(s,c))}):o.forEach(s=>n=n.concat(St(s,t))):typeof o=="object"&&!["columns","fields","keyValues"].includes(l)&&(n=n.concat(St(o,t)))}return n}function Dl(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));return t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7)),Math.ceil(((t.getTime()-new Date(Date.UTC(t.getUTCFullYear(),0,1)).getTime())/864e5+1)/7)}function Kn(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function Bt(e=""){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F1E6}-\u{1F1FF}]/gu,"")}function $n(e){return Bt(String(e||"")).toLowerCase().trim()}function Pt(e){return String(e??"").replace(/'/g,"''")}function mt(e,t=0){var n;if(!e||t>4)return"";if(Array.isArray(e)){for(const l of e){const o=mt(l,t+1);if(o)return o}return""}if(typeof e!="object"){if(typeof e=="string"){const l=e.match(/\d{14}-[a-z0-9]{7}/i);if(l)return l[0]}return""}if((n=e.block)!=null&&n.id)return e.block.id;if(e.blockID)return e.blockID;if(e.blockId)return e.blockId;if(e.block_id)return e.block_id;if(e.refID)return e.refID;if(e.id&&typeof e.id=="string"&&e.id.length>=20)return e.id;for(const l of Object.keys(e)){const o=e[l];if(typeof o=="string"&&/block/i.test(l)){const c=o.match(/\d{14}-[a-z0-9]{7}/i);if(c)return c[0]}const s=mt(e[l],t+1);if(s)return s}return""}async function Nl(e){const t={},n=Array.from(new Set(e)).filter(Boolean),l=100;for(let o=0;o<n.length;o+=l){const s=n.slice(o,o+l).map(u=>`'${Pt(u)}'`).join(",");if(!s)continue;const c=await xe(`SELECT id, content FROM blocks WHERE id IN (${s})`);c&&c.length>0&&c.forEach(u=>{u!=null&&u.id&&(u==null?void 0:u.content)!==void 0&&(t[u.id]=u.content)})}return t}function El(e=""){return e.replace(/^###\s+/gm,"").replace(/^####\s+/gm,"").replace(/^#####\s+/gm,"").replace(/^\*\s\[\s\]\s/gm,"• ").replace(/^\*\s\[x\]\s/gi,"• ").trim()}function Ml(e=""){const t=e.split(`
`);let n="",l=!1;const o=()=>{l&&(n+="</ul>",l=!1)};for(const s of t){if(/^###\s+/.test(s)){o(),n+=`<h3>${s.replace(/^###\s+/,"")}</h3>`;continue}if(/^####\s+/.test(s)){o(),n+=`<h4>${s.replace(/^####\s+/,"")}</h4>`;continue}if(/^#####\s+/.test(s)){o(),n+=`<h5>${s.replace(/^#####\s+/,"")}</h5>`;continue}const c=s.match(/^\*\s\[x\]\s(.+)/i),u=s.match(/^\*\s\[\s\]\s(.+)/);if(c||u){l||(n+="<ul>",l=!0);const p=c?c[1]:u[1];n+=`<li><input type="checkbox"${!!c?" checked":""} disabled /> <span>${p}</span></li>`;continue}if(s.trim()===""){o();continue}o(),n+=`<p>${s}</p>`}return o(),`<div>${n}</div>`}function Rl(e,t){return t?e.split(`
`).filter(o=>!/^###\s/.test(o)&&!/^####\s/.test(o)).join(`
`).replace(/\n{3,}/g,`

`).trim():e}async function Ll(e,t,n){var c;const l=Bt(Rl(n,t.clipboardOnlySections)),o=El(l),s=Ml(l);try{typeof ClipboardItem<"u"&&((c=navigator.clipboard)!=null&&c.write)?await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([s],{type:"text/html"}),"text/plain":new Blob([o],{type:"text/plain"})})]):await navigator.clipboard.writeText(o);const p=(e.i18n||{}).reportCopied||"内容已复制到剪切板";_t(p)}catch(u){console.error("Copy to clipboard failed:",u)}}function $l(e,t){const n=new Date(e);return t==="day"?(n.setHours(0,0,0,0),n.getTime()):t==="week"?(n.setDate(n.getDate()-(n.getDay()||7)+1),n.setHours(0,0,0,0),n.getTime()):t==="month"?(n.setDate(1),n.setHours(0,0,0,0),n.getTime()):t==="year"?(n.setMonth(0,1),n.setHours(0,0,0,0),n.getTime()):0}function xl(e,t){const n=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),o=Dl(t).toString().padStart(2,"0"),s=Kn(t),c=e.period||"none";let u=`/日常记录/${n}/${l}/${s}`;return c==="week"?u=`/周报/${n}/${n}-W${o}`:c==="month"?u=`/月报/${n}/${n}-${l}`:c==="year"&&(u=`/年报/${n}`),e.pathTemplate?e.pathTemplate.replace("{YYYY}",String(n)).replace("{MM}",l).replace("{date}",s).replace("{WW}",o):u}async function Pl(e,t,n,l,o,s){var b,w;const c=xl(t,n),u=Pt(c),p=Pt(c.substring(1));let _=await xe(`SELECT id FROM blocks WHERE (hpath = '${u}' OR hpath = '${p}') AND type='d' LIMIT 1`),m=_&&_.length>0?_[0].id:"";if(!m){const S=await xn(),P=t.notebookId||((w=(b=S==null?void 0:S.notebooks)==null?void 0:b[0])==null?void 0:w.id);if(!P){Xe("未找到可用笔记本，请在设置中选择目标笔记本");return}m=await Xn(P,c+".sy",""),await new Promise(z=>setTimeout(z,600))}const k=(await xe(`SELECT id FROM blocks WHERE root_id = '${m}'`)||[]).map(S=>S.id).filter(S=>S&&S!==m);for(const S of k)await Jn(S);k.length>0&&await new Promise(S=>setTimeout(S,300));const f=await Gn("markdown",l,m);if(f&&f.length>0){for(const S of f)S!=null&&S.id&&await Qn(S.id,{memo:o});_t("报表已就绪")}}async function Ul(e,t){var k;const l=(((k=e.config)==null?void 0:k.profiles)||[]).find(f=>f.id===t);if(!(l!=null&&l.keyword))return{avId:"",viewId:"",profileName:""};const o=await xe(`SELECT id FROM blocks WHERE content LIKE '%${l.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)return{avId:"",viewId:"",profileName:""};const s=o[0].id,c=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${s}' AND type = 'av' LIMIT 1`);if(!c||c.length===0)return{avId:"",viewId:"",profileName:""};const u=c[0],p=u.markdown.match(/data-av-id="([^"]+)"/);if(!p)return{avId:"",viewId:"",profileName:""};const _=p[1],m=u.markdown.match(/data-view-id="([^"]+)"/),v=m?m[1]:_;return{avId:_,viewId:v,profileName:l.name||l.keyword||l.id}}async function Bl(e,t){try{const n=e.i18n||{},l=(w,S)=>n[w]||S,o=t.ruleIds||[];if(!o||o.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const s=[];for(const w of o){const S=await Ul(e,w);if(!S.avId)continue;const P=await Rt(S.avId,S.viewId||S.avId,2e3,1);P&&s.push({profileName:S.profileName,avData:P})}if(s.length===0){Xe(l("reportMissingKanban","请先选择至少一个归档规则"));return}const c=new Date,u=Kn(c),p=t.period||"none",_=$l(c,p);let m="报表 ({date})";p==="day"?m="日报 ({date})":p==="week"?m="周报 ({date})":p==="month"?m="月报 ({date})":p==="year"&&(m="年报 ({date})");const k=(t.titleTemplate||m).replace("{date}",u);let f=`### ${k}

`;for(const w of s){const S=w.avData,P=S.view||S,U=(P.columns||P.fields||[]).map(a=>{const C=(a==null?void 0:a.key)??a;return C?{id:C.id,name:C.name||"",type:C.type||""}:null}).filter(Boolean),D=a=>U.findIndex(C=>a.some(W=>W(C))),N=D([a=>a.name.includes("内容"),a=>a.name.toLowerCase().includes("content"),a=>a.type==="block"]);let E=D([a=>a.name.includes("状态"),a=>a.name.toLowerCase().includes("status")]);E===-1&&(E=U.findIndex(a=>{const C=String(a.type||"").toLowerCase();return C==="select"||C==="mselect"||C==="multiselect"||C==="singleselect"}));let I=D([a=>a.name.includes("更新时间"),a=>a.name.toLowerCase().includes("update"),a=>a.name.includes("更新"),a=>a.name.includes("修改")]);I===-1&&(I=D([a=>a.name.includes("完成"),a=>a.name.includes("结束"),a=>a.name.includes("归档"),a=>a.name.toLowerCase().includes("done")])),I===-1&&(I=D([a=>a.name.includes("时间"),a=>a.name.toLowerCase().includes("time"),a=>a.type==="date"])),console.log("[KanbanWorkflow][Report] columns:",U.map(a=>`${a.name}(${a.type||"unknown"})`)),console.log("[KanbanWorkflow][Report] idx:",{cIdx:N,sIdx:E,tIdx:I});const $=St(S).map(a=>{var Se,Te,Re,me;let C=a.cells||[],W=[];a.values&&(W=U.map(oe=>{const se=a.values.find(J=>J.keyID===oe.id);return se?se.value:null}));const H=(C||[]).map(oe=>Ye(oe)),Z=(W||[]).map(oe=>Ye(oe)),te=H.some(oe=>String(oe||"").trim()!==""),le=Z.some(oe=>String(oe||"").trim()!=="");!te&&le&&(C=W);const ve=C===W?Z:H,ie=N!==-1?C[N]:null,V=mt(ie)||mt(a==null?void 0:a.block)||mt(a),Me=((Se=a==null?void 0:a.block)==null?void 0:Se.content)||(a==null?void 0:a.content)||(a==null?void 0:a.name)||((Te=a==null?void 0:a.title)==null?void 0:Te.content)||(a==null?void 0:a.title)||((Re=a==null?void 0:a.text)==null?void 0:Re.content)||(a==null?void 0:a.text)||((me=a==null?void 0:a.value)==null?void 0:me.content)||"";return{id:a.id,cells:C,cellValues:ve,contentBlockId:V,contentFromRow:Me,rawPreview:a,updatedAt:a.updatedAt||a.updated||0,groupStatus:a.__groupStatus||""}}),x=await Nl($.map(a=>a.contentBlockId||"").filter(Boolean).concat($.map(a=>a.id||"").filter(a=>/\d{14}-[a-z0-9]{7}/i.test(a)))),K=(t.sections||[]).map(a=>({id:a.id,title:a.title,statusesRaw:(a.statuses||[]).map(C=>String(C)),statuses:(a.statuses||[]).map(C=>$n(C)).filter(Boolean),items:[]})),M=K.flatMap(a=>a.statuses).filter(Boolean);console.log("[KanbanWorkflow][Report] statusCandidates:",M),$.forEach((a,C)=>{var J;const W=a.cellValues||a.cells.map(q=>Ye(q));if(C===0){console.log("[KanbanWorkflow][Report] sampleRow:",W);const q=a.rawPreview||{};console.log("[KanbanWorkflow][Report] sampleRowKeys:",Object.keys(q)),!W.length&&!a.contentFromRow&&console.log("[KanbanWorkflow][Report] sampleRowRaw:",q)}let H=N!==-1?W[N]:"";!H&&a.contentFromRow&&(H=a.contentFromRow),!H&&a.contentBlockId&&x[a.contentBlockId]&&(H=x[a.contentBlockId]),H||(H=W.find((Y,re)=>re===E||re===I?!1:String(Y||"").trim()!=="")||""),H||(H=l("reportFallbackContent","无内容")),p==="week"&&(H=H.replace(/\b\d+(\.\d+)?\s*[hH]\b/gi,"").replace(/\((?:\d\.?)+[hH]\)/g,"").trim(),!H&&Array.isArray((J=a.cells)==null?void 0:J[N])&&a.cells[N].length>0&&(H=a.cells[N].map(q=>Ye(q)).join(", ")));let Z=E!==-1?W[E]:"";!Z&&a.groupStatus&&(Z=a.groupStatus),Z||(Z=W.find(Y=>{const re=String(Y||"").toLowerCase();return M.some(Ie=>re.includes(Ie))})||""),C===0&&console.log("[KanbanWorkflow][Report] sampleStatus:",Z);const te=I!==-1?W[I]:"",le=Ln(te),ve=Ln(a.updatedAt),ie=p!=="none"?le||ve||0:le||ve||Date.now(),V=$n(Z),Me=V.includes("已完成")||V.includes("done")||V.includes("完成")||V.includes("finish")||V.includes("ok"),Se=V.includes("归档")||V.includes("archived")||V.includes("存档")||V.includes("archive");if(p!=="none"&&(Me||Se)&&ie<_)return;const Re=`${Me?"* [x]":"* [ ]"} ${H}`.trim(),me=V.split(/[,，]/).map(q=>q.trim()).filter(Boolean);let se=K.filter(q=>q.statuses.length>0&&q.statuses.some(Y=>Y?V.includes(Y)?!0:me.some(re=>re.includes(Y)||Y.includes(re)):!1));if(se.length===0){const q=String(Z||"").toLowerCase();se=K.filter(Y=>(Y.statusesRaw||[]).some(re=>{const Ie=String(re||"").toLowerCase();return Ie?q.includes(Ie)||Ie.includes(q):!1}))}se.length!==0&&se.forEach(q=>q.items.push(Re))});const R=`${l("reportBoardTitle","看板")}: ${w.profileName}`;f+=`#### ${R}

`;for(const a of K)f+=`##### ${a.title}
`,a.items.length>0?f+=`${a.items.join(`
`)}

`:f+=`
`}const b=Bt(f);await Pl(e,t,c,b,`summary-${t.id}`,k),await Ll(e,t,b)}catch(n){console.error(n),Xe("生成过程中遇障")}}class Ol extends ht.Plugin{constructor(){super(...arguments);He(this,"timer");He(this,"isMobile");He(this,"config",{});He(this,"undoStack",[]);He(this,"MAX_UNDO_COUNT",30);He(this,"MAX_UNDO_DAYS",7)}async onload(){nl(this),console.log("Loading Kanban Workflow Plugin v0.1.0"),await this.loadAndNormalizeConfig();try{const o=await this.loadData("undo_history.json");o&&Array.isArray(o)&&(this.undoStack=o)}catch(o){console.error("Failed to load undo history",o)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板工作流",position:"right",callback:o=>{if(this.isMobile){this.showMobileMenu();return}let s;o&&o.currentTarget&&o.currentTarget.getBoundingClientRect?s=o.currentTarget.getBoundingClientRect():s=n.getBoundingClientRect();const c=new ht.Menu("kanban-archiver-menu");c.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(p=>{c.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${p.name}`,click:()=>{this.generateTemplate(p.id)}})}),c.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),c.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),c.open({x:s.left,y:s.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),(this.config.templates||[]).forEach(o=>{this.addCommand({langKey:`generateTemplate_${o.id}`,langText:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,hotkey:"",callback:()=>{this.generateTemplate(o.id)}})}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",templates:[],...n},this.ensureDefaultTemplates(),this.normalizeTemplates(),(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let l=!1;this.config.profiles.forEach(o=>{o.enabled===void 0&&(o.enabled=!0,l=!0)}),l&&this.saveData("config.json",this.config)}ensureDefaultTemplates(){(!this.config.templates||!Array.isArray(this.config.templates)||this.config.templates.length===0)&&(this.config.templates=[{id:this.generateUUID(),name:this.i18n.defaultDailyTemplate||"今日汇总",period:"day",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"日报 ({date})",sections:[{id:this.generateUUID(),title:"待办",statuses:["待办","todo","backlog","未开始"]},{id:this.generateUUID(),title:"进行中",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成",statuses:["已完成","done","完成","finish","ok","归档","archived"]}]},{id:this.generateUUID(),name:this.i18n.defaultWeeklyTemplate||"本周回顾",period:"week",ruleIds:[],notebookId:"",pathTemplate:"",clipboardOnlySections:!1,titleTemplate:"周报 ({date})",sections:[{id:this.generateUUID(),title:"当前工作",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成及归档 (本周)",statuses:["已完成","done","完成","finish","ok","归档","archived"]},{id:this.generateUUID(),title:"下周工作计划",statuses:["待办","todo","backlog","未开始"]}]}],this.saveData("config.json",this.config))}normalizeTemplates(){if(!Array.isArray(this.config.templates))return;let n=!1;this.config.templates.forEach(l=>{!l.period&&l.type&&(l.period=l.type==="weekly"?"week":"day",n=!0),l.period||(l.period="none",n=!0),l.sections||(l.sections=[],n=!0)}),n&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Workflow Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Workflow Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new ht.Dialog({title:this.i18n.settingTitle||"看板工作流设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{l.$destroy()}}),l=new Il({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new ht.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(o=>{n.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${o.name}`,click:()=>{this.generateTemplate(o.id)}})}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,l=n.getHours(),o=n.getMinutes(),s=l*60+o;let c=0,u=0;try{const m=this.config.archiveTime.split(":").map(Number);m.length===2&&!isNaN(m[0])&&!isNaN(m[1])&&(c=m[0],u=m[1])}catch{return}const p=c*60+u,_=n.toLocaleDateString();this.config.lastRunDate!==_&&s>=p&&(this.config.lastRunDate=_,this.saveData("config.json",this.config),this.archiveNow(!1))}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(l=>l.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(n=!0){if(!(n&&!window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？")))try{const l=await tl(this,n);if(l&&l.length>0)this.undoStack.push({date:new Date().getTime(),ids:l}),await this.saveUndoHistory();else{const o=this.i18n.archiveEmpty||"未发现可归档任务";_t(o)}}catch(l){console.error("Archive task error:",l)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await el(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}async generateTemplate(n){const l=(this.config.templates||[]).find(o=>o.id===n);l&&await Bl(this,l)}async getNotebooks(){return await xn()}async getStatusOptions(n){const l=this.config.profiles||[],o=new Set;for(const s of n){const c=l.find(b=>b.id===s);if(!(c!=null&&c.keyword))continue;const u=await xe(`SELECT id FROM blocks WHERE content LIKE '%${c.keyword}%' AND type = 'd' LIMIT 1`);if(!u||u.length===0)continue;const p=u[0].id,_=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${p}' AND type = 'av' LIMIT 1`);if(!_||_.length===0)continue;const v=_[0].markdown.match(/data-av-id="([^"]+)"/);if(!v)continue;const k=v[1],f=await Ut(k);if(f)for(const b of f)(b.type==="select"||b.type==="mSelect")&&b.options&&b.options.forEach(w=>{w!=null&&w.name&&o.add(w.name)})}return Array.from(o)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var l=Math.random()*16|0,o=n=="x"?l:l&3|8;return o.toString(16)})}}module.exports=Ol;
