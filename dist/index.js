"use strict";var Be=Object.defineProperty;var He=(t,e,n)=>e in t?Be(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var V=(t,e,n)=>He(t,typeof e!="symbol"?e+"":e,n);const ie=require("siyuan");async function te(t,e){let n=await ie.fetchSyncPost(t,e);return n.code===0?n.data:null}async function ce(t){return te("/api/query/sql",{stmt:t})}async function De(t,e=7e3){return te("/api/notification/pushMsg",{msg:t,timeout:e})}async function oe(t,e=7e3){return te("/api/notification/pushErrMsg",{msg:t,timeout:e})}async function Ce(t){return te("/api/av/getAttributeViewKeysByAvID",{avID:t})}async function he(t,e,n=9999999,i=1){return te("/api/av/renderAttributeView",{id:t,viewID:e,pageSize:n,page:i})}async function Re(t,e,n,i){return te("/api/av/setAttributeViewBlockAttr",{avID:t,keyID:e,itemID:n,value:i})}async function Oe(t,e,n,i,c=!1){var l,f,g;try{const a=e.keyword;console.log(`Starting Kanban status switch for profile "${e.name}": "${n}" -> "${i}"`);const d=await ce(`SELECT id FROM blocks WHERE content LIKE '%${a}%' AND type = 'd' LIMIT 1`);if(!d||d.length===0)return console.log(`Kanban doc not found for keyword: ${a}`),[];const h=d[0].id,u=await ce(`SELECT id, markdown FROM blocks WHERE root_id = '${h}' AND type = 'av' LIMIT 1`);if(!u||u.length===0)return c&&oe(`文档中未找到数据库视图 (Profile: ${e.name})`),[];const _=u[0],s=_.markdown.match(/data-av-id="([^"]+)"/);if(!s)return[];const b=s[1],A=await Ce(b);if(!A)return[];let w=null,C=null,R=null;for(const k of A)if((k.type==="select"||k.type==="mSelect")&&k.options){const o=k.options.find(q=>q.name===n),m=k.options.find(q=>q.name===i);if(o&&m){w=k,C=o,R=m;break}}if(!w)return c&&oe(`在 "${e.name}" 中未找到状态 "${n}" -> "${i}"`),[];const E=_.markdown.match(/data-view-id="([^"]+)"/);let H=E?E[1]:b,S=await he(b,H);const L=(k,o=0)=>{if(!k||o>5)return[];let m=[];const q=["rows","groups","blocks","children","items"];for(const U of q)if(Array.isArray(k[U]))for(const j of k[U])j.id&&Array.isArray(j.cells)?m.push(j):m=m.concat(L(j,o+1));return k.view&&(m=m.concat(L(k.view,o+1))),m};let v=L(S);if(v.length===0&&(S!=null&&S.views)){const k=S.views.find(o=>o.type==="table");k&&(S=await he(b,k.id),v=L(S))}if(v.length===0)return[];let N=(((l=S.view)==null?void 0:l.columns)||S.columns||[]).findIndex(k=>k.id===w.id),K=[],I=0;for(const k of v){let o=!1;if(N>=0&&k.cells&&k.cells[N]){const m=k.cells[N].value;m!=null&&m.mSelect?o=m.mSelect.some(q=>q.content===n):m!=null&&m.select&&(o=m.select.content===n)}else if(k.cells&&Array.isArray(k.cells))for(const m of k.cells){const q=m.value;if((f=q==null?void 0:q.mSelect)!=null&&f.some(U=>U.content===n)){o=!0;break}else if(((g=q==null?void 0:q.select)==null?void 0:g.content)===n){o=!0;break}}if(o){const m={mSelect:[{content:R.name,color:R.color}]};await Re(b,w.id,k.id,m),K.push(k.id),I++}}return I>0&&De(`[${e.name}] 已归档 ${I} 个任务`),K}catch(a){return console.error("Status switch failed:",a),c&&oe(`[${e.name}] 出错: `+a.message),[]}}async function Pe(t,e){if(!e||e.length===0)return!1;const n=t.config.profiles||[];let i=0;for(const c of n)try{const l=await ce(`SELECT id FROM blocks WHERE content LIKE '%${c.keyword}%' AND type = 'd' LIMIT 1`);if(!l||l.length===0)continue;const f=l[0].id,g=await ce(`SELECT id, markdown FROM blocks WHERE root_id = '${f}' AND type = 'av' LIMIT 1`);if(!g||g.length===0)continue;const d=g[0].markdown.match(/data-av-id="([^"]+)"/);if(!d)continue;const h=d[1],u=await Ce(h);if(!u)continue;let _=null,s=null;for(const A of u)if((A.type==="select"||A.type==="mSelect")&&A.options){const w=A.options.find(C=>C.name===c.completedStatus);if(w){_=A,s=w;break}}if(!_||!s)continue;const b={mSelect:[{content:s.name,color:s.color}]};for(const A of e)await Re(h,_.id,A,b);i+=e.length}catch(l){console.warn("Restore attempted failed for profile",c.name,l)}return i>0?(De("已尝试撤销恢复任务"),!0):!1}async function Fe(t,e=!1){const n=t.config.profiles||[];let i=[];if(n.length===0)return e&&oe("未配置任何归档规则，请在设置中添加"),[];for(const c of n){if(!c.keyword||c.enabled===!1)continue;const l=await Oe(t,c,c.completedStatus,c.archivedStatus,e);i=i.concat(l)}return i}function ee(){}function Le(t){return t()}function pe(){return Object.create(null)}function z(t){t.forEach(Le)}function Ue(t){return typeof t=="function"}function je(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Ve(t){return Object.keys(t).length===0}function r(t,e){t.appendChild(e)}function F(t,e,n){t.insertBefore(e,n||null)}function P(t){t.parentNode&&t.parentNode.removeChild(t)}function ge(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function y(t){return document.createElement(t)}function ve(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function ne(t){return document.createTextNode(t)}function T(){return ne(" ")}function $(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}function me(t){return function(e){return e.stopPropagation(),t.call(this,e)}}function p(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function We(t,e,n){t.setAttributeNS("http://www.w3.org/1999/xlink",e,n)}function Xe(t){return Array.from(t.childNodes)}function fe(t,e){e=""+e,t.data!==e&&(t.data=e)}function W(t,e){t.value=e??""}function D(t,e,n,i){n==null?t.style.removeProperty(e):t.style.setProperty(e,n,"")}function X(t,e,n){t.classList.toggle(e,!!n)}let se;function le(t){se=t}function ze(){if(!se)throw new Error("Function called outside component initialization");return se}function Ye(t){ze().$$.on_mount.push(t)}function Ge(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(i=>i.call(this,e))}const J=[],_e=[];let Z=[];const be=[],Je=Promise.resolve();let ae=!1;function Qe(){ae||(ae=!0,Je.then($e))}function ue(t){Z.push(t)}const re=new Set;let G=0;function $e(){if(G!==0)return;const t=se;do{try{for(;G<J.length;){const e=J[G];G++,le(e),Ze(e.$$)}}catch(e){throw J.length=0,G=0,e}for(le(null),J.length=0,G=0;_e.length;)_e.pop()();for(let e=0;e<Z.length;e+=1){const n=Z[e];re.has(n)||(re.add(n),n())}Z.length=0}while(J.length);for(;be.length;)be.pop()();ae=!1,re.clear(),le(t)}function Ze(t){if(t.fragment!==null){t.update(),z(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(ue)}}function et(t){const e=[],n=[];Z.forEach(i=>t.indexOf(i)===-1?e.push(i):n.push(i)),n.forEach(i=>i()),Z=e}const tt=new Set;function Ke(t,e){t&&t.i&&(tt.delete(t),t.i(e))}function Q(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function nt(t,e){t.d(1),e.delete(t.key)}function it(t,e,n,i,c,l,f,g,a,d,h,u){let _=t.length,s=l.length,b=_;const A={};for(;b--;)A[t[b].key]=b;const w=[],C=new Map,R=new Map,E=[];for(b=s;b--;){const v=u(c,l,b),M=n(v);let N=f.get(M);N?E.push(()=>N.p(v,e)):(N=d(M,v),N.c()),C.set(M,w[b]=N),M in A&&R.set(M,Math.abs(b-A[M]))}const H=new Set,S=new Set;function L(v){Ke(v,1),v.m(g,h),f.set(v.key,v),h=v.first,s--}for(;_&&s;){const v=w[s-1],M=t[_-1],N=v.key,K=M.key;v===M?(h=v.first,_--,s--):C.has(K)?!f.has(N)||H.has(N)?L(v):S.has(K)?_--:R.get(N)>R.get(K)?(S.add(N),L(v)):(H.add(K),_--):(a(M,f),_--)}for(;_--;){const v=t[_];C.has(v.key)||a(v,f)}for(;s;)L(w[s-1]);return z(E),w}function lt(t,e,n){const{fragment:i,after_update:c}=t.$$;i&&i.m(e,n),ue(()=>{const l=t.$$.on_mount.map(Le).filter(Ue);t.$$.on_destroy?t.$$.on_destroy.push(...l):z(l),t.$$.on_mount=[]}),c.forEach(ue)}function st(t,e){const n=t.$$;n.fragment!==null&&(et(n.after_update),z(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function ot(t,e){t.$$.dirty[0]===-1&&(J.push(t),Qe(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ct(t,e,n,i,c,l,f=null,g=[-1]){const a=se;le(t);const d=t.$$={fragment:null,ctx:[],props:l,update:ee,not_equal:c,bound:pe(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:pe(),dirty:g,skip_bound:!1,root:e.target||a.$$.root};f&&f(d.root);let h=!1;if(d.ctx=n?n(t,e.props||{},(u,_,...s)=>{const b=s.length?s[0]:_;return d.ctx&&c(d.ctx[u],d.ctx[u]=b)&&(!d.skip_bound&&d.bound[u]&&d.bound[u](b),h&&ot(t,u)),_}):[],d.update(),h=!0,z(d.before_update),d.fragment=i?i(d.ctx):!1,e.target){if(e.hydrate){const u=Xe(e.target);d.fragment&&d.fragment.l(u),u.forEach(P)}else d.fragment&&d.fragment.c();e.intro&&Ke(t.$$.fragment),lt(t,e.target,e.anchor),$e()}le(a)}class rt{constructor(){V(this,"$$");V(this,"$$set")}$destroy(){st(this,1),this.$destroy=ee}$on(e,n){if(!Ue(n))return ee;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(n),()=>{const c=i.indexOf(n);c!==-1&&i.splice(c,1)}}$set(e){this.$$set&&!Ve(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const at="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(at);function ke(t,e,n){const i=t.slice();return i[26]=e[n],i[27]=e,i[28]=n,i}function ye(t,e,n){const i=t.slice();return i[29]=e[n],i}function we(t,e,n){const i=t.slice();return i[32]=e[n],i}function Se(t){let e,n,i;return{c(){e=y("div"),p(e,"class","backdrop svelte-1nqb995")},m(c,l){F(c,e,l),n||(i=$(e,"click",t[15]),n=!0)},p:ee,d(c){c&&P(e),n=!1,i()}}}function Ae(t){let e,n,i,c,l,f,g=Q(t[4]),a=[];for(let u=0;u<g.length;u+=1)a[u]=qe(we(t,g,u));let d=Q(t[5]),h=[];for(let u=0;u<d.length;u+=1)h[u]=xe(ye(t,d,u));return{c(){e=y("div"),n=y("div");for(let u=0;u<a.length;u+=1)a[u].c();i=T(),c=y("div"),l=T(),f=y("div");for(let u=0;u<h.length;u+=1)h[u].c();p(n,"class","time-col svelte-1nqb995"),D(c,"width","1px"),D(c,"background","var(--b3-theme-surface-lighter)"),p(f,"class","time-col svelte-1nqb995"),p(e,"class","time-picker-popover svelte-1nqb995")},m(u,_){F(u,e,_),r(e,n);for(let s=0;s<a.length;s+=1)a[s]&&a[s].m(n,null);r(e,i),r(e,c),r(e,l),r(e,f);for(let s=0;s<h.length;s+=1)h[s]&&h[s].m(f,null)},p(u,_){if(_[0]&1042){g=Q(u[4]);let s;for(s=0;s<g.length;s+=1){const b=we(u,g,s);a[s]?a[s].p(b,_):(a[s]=qe(b),a[s].c(),a[s].m(n,null))}for(;s<a.length;s+=1)a[s].d(1);a.length=g.length}if(_[0]&2082){d=Q(u[5]);let s;for(s=0;s<d.length;s+=1){const b=ye(u,d,s);h[s]?h[s].p(b,_):(h[s]=xe(b),h[s].c(),h[s].m(f,null))}for(;s<h.length;s+=1)h[s].d(1);h.length=d.length}},d(u){u&&P(e),ge(a,u),ge(h,u)}}}function qe(t){let e,n=t[32]+"",i,c,l,f;function g(){return t[16](t[32])}return{c(){e=y("div"),i=ne(n),c=T(),p(e,"id",`time-opt-h-${t[32]}`),p(e,"class","time-opt svelte-1nqb995"),X(e,"selected",t[1].startsWith(t[32]))},m(a,d){F(a,e,d),r(e,i),r(e,c),l||(f=$(e,"click",g),l=!0)},p(a,d){t=a,d[0]&18&&X(e,"selected",t[1].startsWith(t[32]))},d(a){a&&P(e),l=!1,f()}}}function xe(t){let e,n=t[29]+"",i,c,l,f;function g(){return t[17](t[29])}return{c(){e=y("div"),i=ne(n),c=T(),p(e,"id",`time-opt-m-${t[29]}`),p(e,"class","time-opt svelte-1nqb995"),X(e,"selected",t[1].endsWith(t[29]))},m(a,d){F(a,e,d),r(e,i),r(e,c),l||(f=$(e,"click",g),l=!0)},p(a,d){t=a,d[0]&34&&X(e,"selected",t[1].endsWith(t[29]))},d(a){a&&P(e),l=!1,f()}}}function Me(t){let e,n=t[26].keyword+"",i;return{c(){e=y("span"),i=ne(n),p(e,"class","tag-preview svelte-1nqb995")},m(c,l){F(c,e,l),r(e,i)},p(c,l){l[0]&1&&n!==(n=c[26].keyword+"")&&fe(i,n)},d(c){c&&P(e)}}}function Te(t){let e,n,i,c,l,f,g,a,d,h,u,_,s,b,A,w,C,R,E,H,S,L,v;function M(){t[21].call(l,t[27],t[28])}function N(){t[22].call(h,t[27],t[28])}function K(){t[23].call(w,t[27],t[28])}function I(){t[24].call(S,t[27],t[28])}return{c(){e=y("div"),n=y("div"),i=y("div"),i.textContent="规则显示名称",c=T(),l=y("input"),f=T(),g=y("div"),a=y("div"),a.textContent="文档标题关键词",d=T(),h=y("input"),u=T(),_=y("div"),s=y("div"),b=y("div"),b.textContent="待归档状态 (源)",A=T(),w=y("input"),C=T(),R=y("div"),E=y("div"),E.textContent="目标归档状态",H=T(),S=y("input"),p(i,"class","input-label svelte-1nqb995"),p(l,"class","modern-input svelte-1nqb995"),p(l,"type","text"),p(l,"placeholder","例如：主工作项目看板"),p(n,"class","input-group svelte-1nqb995"),p(a,"class","input-label svelte-1nqb995"),p(h,"class","modern-input svelte-1nqb995"),p(h,"type","text"),p(h,"placeholder","输入包含在文档标题中的词，例如 '工作'"),p(g,"class","input-group svelte-1nqb995"),p(b,"class","input-label svelte-1nqb995"),p(w,"class","modern-input svelte-1nqb995"),p(w,"type","text"),p(w,"placeholder","已完成"),p(s,"class","input-group fn__flex-1 svelte-1nqb995"),p(E,"class","input-label svelte-1nqb995"),p(S,"class","modern-input svelte-1nqb995"),p(S,"type","text"),p(S,"placeholder","归档"),p(R,"class","input-group fn__flex-1 svelte-1nqb995"),p(_,"class","fn__flex svelte-1nqb995"),D(_,"gap","20px"),p(e,"class","card-content svelte-1nqb995")},m(k,o){F(k,e,o),r(e,n),r(n,i),r(n,c),r(n,l),W(l,t[26].name),r(e,f),r(e,g),r(g,a),r(g,d),r(g,h),W(h,t[26].keyword),r(e,u),r(e,_),r(_,s),r(s,b),r(s,A),r(s,w),W(w,t[26].completedStatus),r(_,C),r(_,R),r(R,E),r(R,H),r(R,S),W(S,t[26].archivedStatus),L||(v=[$(l,"input",M),$(l,"change",t[6]),$(h,"input",N),$(h,"change",t[6]),$(w,"input",K),$(w,"change",t[6]),$(S,"input",I),$(S,"change",t[6])],L=!0)},p(k,o){t=k,o[0]&1&&l.value!==t[26].name&&W(l,t[26].name),o[0]&1&&h.value!==t[26].keyword&&W(h,t[26].keyword),o[0]&1&&w.value!==t[26].completedStatus&&W(w,t[26].completedStatus),o[0]&1&&S.value!==t[26].archivedStatus&&W(S,t[26].archivedStatus)},d(k){k&&P(e),L=!1,z(v)}}}function Ie(t,e){let n,i,c,l,f,g,a=(e[26].name||"未命名规则")+"",d,h,u,_,s,b,A,w,C,R,E,H,S,L,v=e[26].keyword&&Me(e);function M(){e[18].call(b,e[27],e[28])}function N(){return e[19](e[26])}function K(){return e[20](e[26])}let I=e[2]===e[26].id&&Te(e);return{key:t,first:null,c(){n=y("div"),i=y("div"),c=y("div"),c.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',l=T(),f=y("div"),g=y("span"),d=ne(a),h=T(),v&&v.c(),u=T(),_=y("div"),s=y("label"),b=y("input"),A=T(),w=y("span"),w.innerHTML='<span class="switch-thumb svelte-1nqb995"></span>',R=T(),E=y("div"),E.innerHTML='<svg class="svelte-1nqb995"><use xlink:href="#iconTrashcan"></use></svg>',H=T(),I&&I.c(),p(c,"class","chevron svelte-1nqb995"),D(g,"font-weight","600"),D(g,"font-size","15px"),D(g,"color","var(--b3-theme-on-surface)"),p(f,"class","fn__flex-1 svelte-1nqb995"),D(f,"margin-left","14px"),D(f,"display","flex"),D(f,"align-items","center"),p(b,"class","switch-input svelte-1nqb995"),p(b,"type","checkbox"),p(w,"class","switch-track svelte-1nqb995"),p(s,"class","switch-container svelte-1nqb995"),p(s,"title",C=e[26].enabled?"已启用":"已禁用"),p(_,"class","fn__flex-center"),D(_,"margin-right","20px"),p(E,"class","icon-btn svelte-1nqb995"),p(E,"title","删除规则"),p(i,"class","card-header svelte-1nqb995"),p(n,"class","card svelte-1nqb995"),D(n,"opacity",e[26].enabled?1:.75),X(n,"expanded",e[2]===e[26].id),this.first=n},m(k,o){F(k,n,o),r(n,i),r(i,c),r(i,l),r(i,f),r(f,g),r(g,d),r(f,h),v&&v.m(f,null),r(i,u),r(i,_),r(_,s),r(s,b),b.checked=e[26].enabled,r(s,A),r(s,w),r(i,R),r(i,E),r(n,H),I&&I.m(n,null),S||(L=[$(b,"change",M),$(b,"change",e[6]),$(_,"click",me(e[14])),$(E,"click",me(N)),$(i,"click",K)],S=!0)},p(k,o){e=k,o[0]&1&&a!==(a=(e[26].name||"未命名规则")+"")&&fe(d,a),e[26].keyword?v?v.p(e,o):(v=Me(e),v.c(),v.m(f,null)):v&&(v.d(1),v=null),o[0]&1&&(b.checked=e[26].enabled),o[0]&1&&C!==(C=e[26].enabled?"已启用":"已禁用")&&p(s,"title",C),e[2]===e[26].id?I?I.p(e,o):(I=Te(e),I.c(),I.m(n,null)):I&&(I.d(1),I=null),o[0]&1&&D(n,"opacity",e[26].enabled?1:.75),o[0]&5&&X(n,"expanded",e[2]===e[26].id)},d(k){k&&P(n),v&&v.d(),I&&I.d(),S=!1,z(L)}}}function Ee(t){let e;return{c(){e=y("div"),e.textContent="暂时没有规则，请点击右上方按钮新建。",D(e,"text-align","center"),D(e,"padding","48px"),D(e,"color","var(--b3-theme-on-surface-light)"),D(e,"border","2px dashed var(--b3-border-color)"),D(e,"border-radius","16px")},m(n,i){F(n,e,i)},d(n){n&&P(e)}}}function ut(t){let e,n,i,c,l,f,g,a,d,h,u,_,s,b,A,w,C,R,E,H,S,L,v,M=[],N=new Map,K,I,k,o,m,q=t[3]&&Se(t),U=t[3]&&Ae(t),j=Q(t[0]);const de=x=>x[26].id;for(let x=0;x<j.length;x+=1){let B=ke(t,j,x),Y=de(B);N.set(Y,M[x]=Ie(Y,B))}let O=t[0].length===0&&Ee();return{c(){q&&q.c(),e=T(),n=y("div"),i=y("div"),c=y("div"),c.innerHTML=`<svg style="width:18px;height:18px"><use xlink:href="#iconCalendar"></use></svg>
            全局定时归档`,l=T(),f=y("div"),g=T(),a=y("div"),d=ne(t[1]),h=T(),u=ve("svg"),_=ve("use"),s=T(),U&&U.c(),b=T(),A=y("div"),w=y("div"),C=y("div"),C.innerHTML=`<svg style="width:18px;height:18px"><use xlink:href="#iconSettings"></use></svg>
                归档规则列表`,R=T(),E=y("div"),H=T(),S=y("button"),S.innerHTML=`<svg style="width:14px;height:14px" class="svelte-1nqb995"><use xlink:href="#iconAdd"></use></svg>
                新建规则`,L=T(),v=y("div");for(let x=0;x<M.length;x+=1)M[x].c();K=T(),O&&O.c(),I=T(),k=y("div"),k.innerHTML=`<div style="font-weight: 700; color: var(--b3-theme-primary); display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px;"><svg style="width:16px;height:16px;"><use xlink:href="#iconInfo"></use></svg>
            使用提示</div> <ul class="svelte-1nqb995"><li class="svelte-1nqb995"><strong>全局定时</strong>：所有“已启用”的规则都会在上方设定的时间点自动执行。</li> <li class="svelte-1nqb995"><strong>精准匹配</strong>：插件仅对标题包含“关键词”的文档生效。</li> <li class="svelte-1nqb995"><strong>状态映射</strong>：请确保属性视图（AV）中存在对应的状态选项名称。</li></ul>`,p(c,"class","section-title svelte-1nqb995"),p(f,"class","fn__flex-1 svelte-1nqb995"),We(_,"xlink:href","#iconClock"),D(u,"width","14px"),D(u,"height","14px"),D(u,"opacity","0.6"),p(a,"class","time-trigger svelte-1nqb995"),X(a,"active",t[3]),p(i,"class","section-header svelte-1nqb995"),p(C,"class","section-title svelte-1nqb995"),p(E,"class","fn__flex-1 svelte-1nqb995"),p(S,"class","action-btn svelte-1nqb995"),p(w,"class","section-header svelte-1nqb995"),p(v,"class","profile-container svelte-1nqb995"),D(A,"margin-top","20px"),D(A,"display","flex"),D(A,"flex-direction","column"),p(k,"class","info-footer svelte-1nqb995"),p(n,"class","settings-container svelte-1nqb995")},m(x,B){q&&q.m(x,B),F(x,e,B),F(x,n,B),r(n,i),r(i,c),r(i,l),r(i,f),r(i,g),r(i,a),r(a,d),r(a,h),r(a,u),r(u,_),r(i,s),U&&U.m(i,null),r(n,b),r(n,A),r(A,w),r(w,C),r(w,R),r(w,E),r(w,H),r(w,S),r(A,L),r(A,v);for(let Y=0;Y<M.length;Y+=1)M[Y]&&M[Y].m(v,null);r(v,K),O&&O.m(v,null),r(n,I),r(n,k),o||(m=[$(a,"click",t[12]),$(S,"click",t[7])],o=!0)},p(x,B){x[3]?q?q.p(x,B):(q=Se(x),q.c(),q.m(e.parentNode,e)):q&&(q.d(1),q=null),B[0]&2&&fe(d,x[1]),B[0]&8&&X(a,"active",x[3]),x[3]?U?U.p(x,B):(U=Ae(x),U.c(),U.m(i,null)):U&&(U.d(1),U=null),B[0]&837&&(j=Q(x[0]),M=it(M,B,de,1,x,j,N,v,nt,Ie,K,ke)),x[0].length===0?O||(O=Ee(),O.c(),O.m(v,null)):O&&(O.d(1),O=null)},i:ee,o:ee,d(x){x&&(P(e),P(n)),q&&q.d(x),U&&U.d();for(let B=0;B<M.length;B+=1)M[B].d();O&&O.d(),o=!1,z(m)}}}function ft(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0,n=t=="x"?e:e&3|8;return n.toString(16)})}function Ne(t,e){const n=`time-opt-${t}-${e}`,i=document.getElementById(n);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}function dt(t,e,n){let{plugin:i}=e,c=[],l="00:00",f=null,g=!1;const a=Array.from({length:24},(o,m)=>m.toString().padStart(2,"0")),d=Array.from({length:60},(o,m)=>m.toString().padStart(2,"0"));Ye(()=>{h(),i.config.profiles&&i.config.profiles.length===1&&n(2,f=i.config.profiles[0].id)});function h(){n(0,c=i.config.profiles||[]),n(1,l=i.config.archiveTime||"00:00")}async function u(){n(13,i.config.archiveTime=l,i),i.saveData("config.json",i.config),h()}function _(){i.config.profiles||n(13,i.config.profiles=[],i);const o={id:ft(),name:"新规则 "+(i.config.profiles.length+1),keyword:"",completedStatus:"已完成",archivedStatus:"归档",enabled:!0};n(13,i.config.profiles=[...i.config.profiles,o],i),u(),n(2,f=o.id),setTimeout(()=>{const m=document.querySelector(".profile-container");m&&(m.scrollTop=m.scrollHeight)},50)}function s(o){n(13,i.config.profiles=i.config.profiles.filter(m=>m.id!==o),i),u(),f===o&&n(2,f=null)}function b(o){f===o?n(2,f=null):n(2,f=o)}function A(o){const m=l.split(":");n(1,l=`${o}:${m[1]||"00"}`),u()}function w(o){const m=l.split(":");n(1,l=`${m[0]||"00"}:${o}`),u()}function C(){n(3,g=!g),g&&setTimeout(()=>{const[o,m]=l.split(":");Ne("h",o),Ne("m",m)},10)}function R(o){Ge.call(this,t,o)}const E=()=>n(3,g=!1),H=o=>A(o),S=o=>w(o);function L(o,m){o[m].enabled=this.checked,n(0,c)}const v=o=>s(o.id),M=o=>b(o.id);function N(o,m){o[m].name=this.value,n(0,c)}function K(o,m){o[m].keyword=this.value,n(0,c)}function I(o,m){o[m].completedStatus=this.value,n(0,c)}function k(o,m){o[m].archivedStatus=this.value,n(0,c)}return t.$$set=o=>{"plugin"in o&&n(13,i=o.plugin)},[c,l,f,g,a,d,u,_,s,b,A,w,C,i,R,E,H,S,L,v,M,N,K,I,k]}class ht extends rt{constructor(e){super(),ct(this,e,dt,ut,je,{plugin:13},null,[-1,-1])}}class pt extends ie.Plugin{constructor(){super(...arguments);V(this,"timer");V(this,"isMobile");V(this,"config",{});V(this,"undoStack",[]);V(this,"MAX_UNDO_COUNT",30);V(this,"MAX_UNDO_DAYS",7)}async onload(){console.log("Loading Kanban Archiver Plugin v0.3.0");const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",...n},(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:"默认规则",keyword:n.kanbanKeyword||"我的工作看板",completedStatus:n.completedStatus||"已完成",archivedStatus:n.archivedStatus||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:"我的规则",keyword:"我的工作看板",completedStatus:"已完成",archivedStatus:"归档",enabled:!0});let i=!1;this.config.profiles.forEach(l=>{l.enabled===void 0&&(l.enabled=!0,i=!0)}),i&&this.saveData("config.json",this.config);try{const l=await this.loadData("undo_history.json");l&&Array.isArray(l)&&(this.undoStack=l)}catch(l){console.error("Failed to load undo history",l)}const c=this.addTopBar({icon:"iconFiles",title:"看板自动归档",position:"right",callback:l=>{if(this.isMobile){this.showMobileMenu();return}let f;l&&l.currentTarget&&l.currentTarget.getBoundingClientRect?f=l.currentTarget.getBoundingClientRect():f=c.getBoundingClientRect();const g=new ie.Menu("kanban-archiver-menu");g.addItem({icon:"iconFiles",label:"立即归档",click:()=>{this.archiveNow()}}),g.addItem({icon:"iconUndo",label:`撤销归档 (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),g.addItem({icon:"iconSettings",label:"设置",click:()=>{this.openSetting()}}),g.open({x:f.left,y:f.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),this.initScheduler()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Archiver Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}openSetting(){const n=new ie.Dialog({title:"看板自动归档设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{i.$destroy()}}),i=new ht({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new ie.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:"立即归档",click:()=>{this.archiveNow()}}),n.addItem({icon:"iconUndo",label:`撤销归档 (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,i=n.getHours(),c=n.getMinutes(),l=i*60+c;let f=0,g=0;try{const h=this.config.archiveTime.split(":").map(Number);h.length===2&&!isNaN(h[0])&&!isNaN(h[1])&&(f=h[0],g=h[1])}catch{return}const a=f*60+g,d=n.toLocaleDateString();this.config.lastRunDate!==d&&l>=a&&(this.config.lastRunDate=d,this.saveData("config.json",this.config),this.archiveNow())}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(i=>i.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(){try{const n=await Fe(this,!0);n&&n.length>0&&(this.undoStack.push({date:new Date().getTime(),ids:n}),await this.saveUndoHistory())}catch(n){console.error("Archive task error:",n)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await Pe(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=Math.random()*16|0,c=n=="x"?i:i&3|8;return c.toString(16)})}}module.exports=pt;
