"use strict";var It=Object.defineProperty;var Ct=(e,t,n)=>t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var J=(e,t,n)=>Ct(e,typeof t!="symbol"?t+"":t,n);const be=require("siyuan");async function ge(e,t){let n=await be.fetchSyncPost(e,t);return n.code===0?n.data:null}async function Ae(e){return ge("/api/query/sql",{stmt:e})}async function bt(e,t=7e3){return ge("/api/notification/pushMsg",{msg:e,timeout:t})}async function ye(e,t=7e3){return ge("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function _t(e){return ge("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function et(e,t,n=9999999,i=1){return ge("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:i})}async function wt(e,t,n,i){return ge("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:i})}async function Dt(e,t,n,i,s=!1){var o,h,b;try{const u=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${i}"`);const p=await Ae(`SELECT id FROM blocks WHERE content LIKE '%${u}%' AND type = 'd' LIMIT 1`);if(!p||p.length===0)return console.log(`Kanban doc not found for keyword: ${u}`),[];const f=p[0].id,d=await Ae(`SELECT id, markdown FROM blocks WHERE root_id = '${f}' AND type = 'av' LIMIT 1`);if(!d||d.length===0)return s&&ye(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const m=d[0],c=m.markdown.match(/data-av-id="([^"]+)"/);if(!c)return[];const _=c[1],q=await _t(_);if(!q)return[];let S=null,L=null,I=null;for(const k of q)if((k.type==="select"||k.type==="mSelect")&&k.options){const A=k.options.find(w=>w.name===n),a=k.options.find(w=>w.name===i);if(A&&a){S=k,L=A,I=a;break}}if(!S)return s&&ye(`在 "${t.name}" 中未找到状态 "${n}" -> "${i}"`),[];const $=m.markdown.match(/data-view-id="([^"]+)"/);let B=$?$[1]:_,T=await et(_,B);const C=(k,A=0)=>{if(!k||A>5)return[];let a=[];const w=["rows","groups","blocks","children","items"];for(const ie of w)if(Array.isArray(k[ie]))for(const V of k[ie])V.id&&Array.isArray(V.cells)?a.push(V):a=a.concat(C(V,A+1));return k.view&&(a=a.concat(C(k.view,A+1))),a};let v=C(T);if(v.length===0&&(T!=null&&T.views)){const k=T.views.find(A=>A.type==="table");k&&(T=await et(_,k.id),v=C(T))}if(v.length===0)return[];let D=(((o=T.view)==null?void 0:o.columns)||T.columns||[]).findIndex(k=>k.id===S.id),P=[],E=0;for(const k of v){let A=!1;if(D>=0&&k.cells&&k.cells[D]){const a=k.cells[D].value;a!=null&&a.mSelect?A=a.mSelect.some(w=>w.content===n):a!=null&&a.select&&(A=a.select.content===n)}else if(k.cells&&Array.isArray(k.cells))for(const a of k.cells){const w=a.value;if((h=w==null?void 0:w.mSelect)!=null&&h.some(ie=>ie.content===n)){A=!0;break}else if(((b=w==null?void 0:w.select)==null?void 0:b.content)===n){A=!0;break}}if(A){const a={mSelect:[{content:I.name,color:I.color}]};await wt(_,S.id,k.id,a),P.push(k.id),E++}}return E>0&&bt(`[${t.name}] 已归档 ${E} 个任务`),P}catch(u){return console.error("Status switch failed:",u),s&&ye(`[${t.name}] 出错: `+u.message),[]}}async function Et(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let i=0;for(const s of n)try{const o=await Ae(`SELECT id FROM blocks WHERE content LIKE '%${s.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)continue;const h=o[0].id,b=await Ae(`SELECT id, markdown FROM blocks WHERE root_id = '${h}' AND type = 'av' LIMIT 1`);if(!b||b.length===0)continue;const p=b[0].markdown.match(/data-av-id="([^"]+)"/);if(!p)continue;const f=p[1],d=await _t(f);if(!d)continue;let m=null,c=null;for(const q of d)if((q.type==="select"||q.type==="mSelect")&&q.options){const S=q.options.find(L=>L.name===s.completedStatus);if(S){m=q,c=S;break}}if(!m||!c)continue;const _={mSelect:[{content:c.name,color:c.color}]};for(const q of t)await wt(f,m.id,q,_);i+=t.length}catch(o){console.warn("Restore attempted failed for profile",s.name,o)}return i>0?(bt("已尝试撤销恢复任务"),!0):!1}async function Rt(e,t=!1){const n=e.config.profiles||[];let i=[];if(n.length===0)return t&&ye("未配置任何归档规则，请在设置中添加"),[];for(const s of n){if(!s.keyword||s.enabled===!1)continue;const o=await Dt(e,s,s.completedStatus,s.archivedStatus,t);i=i.concat(o)}return i}let Se=null;function $t(e){Se=e}function M(e,t){let n=null;if(Se&&Se.i18n&&(n=Se.i18n),!n)try{const{i18n:o}=require("siyuan");n=o}catch(o){console.warn("无法获取i18n对象:",o)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let i=n;const s=e.split(".");for(const o of s)if(i&&typeof i=="object"&&o in i)i=i[o];else{i=void 0;break}return typeof i!="string"&&(console.warn("未找到i18n键:",e),i=e),i}function pe(){}function kt(e){return e()}function tt(){return Object.create(null)}function ne(e){e.forEach(kt)}function yt(e){return typeof e=="function"}function Lt(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Ut(e){return Object.keys(e).length===0}function l(e,t){e.appendChild(t)}function Y(e,t,n){e.insertBefore(t,n||null)}function z(e){e.parentNode&&e.parentNode.removeChild(e)}function nt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function g(e){return document.createElement(e)}function G(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function O(e){return document.createTextNode(e)}function x(){return O(" ")}function U(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function it(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function r(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function me(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function Pt(e){return Array.from(e.childNodes)}function $e(e,t){t=""+t,e.data!==t&&(e.data=t)}function ee(e,t){e.value=t??""}function y(e,t,n,i){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function te(e,t,n){e.classList.toggle(t,!!n)}let we;function _e(e){we=e}function Kt(){if(!we)throw new Error("Function called outside component initialization");return we}function Ot(e){Kt().$$.on_mount.push(e)}function Bt(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(i=>i.call(this,t))}const de=[],lt=[];let he=[];const st=[],jt=Promise.resolve();let Ee=!1;function Ht(){Ee||(Ee=!0,jt.then(St))}function Re(e){he.push(e)}const De=new Set;let ue=0;function St(){if(ue!==0)return;const e=we;do{try{for(;ue<de.length;){const t=de[ue];ue++,_e(t),Ft(t.$$)}}catch(t){throw de.length=0,ue=0,t}for(_e(null),de.length=0,ue=0;lt.length;)lt.pop()();for(let t=0;t<he.length;t+=1){const n=he[t];De.has(n)||(De.add(n),n())}he.length=0}while(de.length);for(;st.length;)st.pop()();Ee=!1,De.clear(),_e(e)}function Ft(e){if(e.fragment!==null){e.update(),ne(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Re)}}function Vt(e){const t=[],n=[];he.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),he=t}const Wt=new Set;function At(e,t){e&&e.i&&(Wt.delete(e),e.i(t))}function fe(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function zt(e,t){e.d(1),t.delete(e.key)}function Xt(e,t,n,i,s,o,h,b,u,p,f,d){let m=e.length,c=o.length,_=m;const q={};for(;_--;)q[e[_].key]=_;const S=[],L=new Map,I=new Map,$=[];for(_=c;_--;){const v=d(s,o,_),R=n(v);let D=h.get(R);D?$.push(()=>D.p(v,t)):(D=p(R,v),D.c()),L.set(R,S[_]=D),R in q&&I.set(R,Math.abs(_-q[R]))}const B=new Set,T=new Set;function C(v){At(v,1),v.m(b,f),h.set(v.key,v),f=v.first,c--}for(;m&&c;){const v=S[c-1],R=e[m-1],D=v.key,P=R.key;v===R?(f=v.first,m--,c--):L.has(P)?!h.has(D)||B.has(D)?C(v):T.has(P)?m--:I.get(D)>I.get(P)?(T.add(D),C(v)):(B.add(P),m--):(u(R,h),m--)}for(;m--;){const v=e[m];L.has(v.key)||u(v,h)}for(;c;)C(S[c-1]);return ne($),S}function Gt(e,t,n){const{fragment:i,after_update:s}=e.$$;i&&i.m(t,n),Re(()=>{const o=e.$$.on_mount.map(kt).filter(yt);e.$$.on_destroy?e.$$.on_destroy.push(...o):ne(o),e.$$.on_mount=[]}),s.forEach(Re)}function Yt(e,t){const n=e.$$;n.fragment!==null&&(Vt(n.after_update),ne(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Jt(e,t){e.$$.dirty[0]===-1&&(de.push(e),Ht(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function Qt(e,t,n,i,s,o,h=null,b=[-1]){const u=we;_e(e);const p=e.$$={fragment:null,ctx:[],props:o,update:pe,not_equal:s,bound:tt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(u?u.$$.context:[])),callbacks:tt(),dirty:b,skip_bound:!1,root:t.target||u.$$.root};h&&h(p.root);let f=!1;if(p.ctx=n?n(e,t.props||{},(d,m,...c)=>{const _=c.length?c[0]:m;return p.ctx&&s(p.ctx[d],p.ctx[d]=_)&&(!p.skip_bound&&p.bound[d]&&p.bound[d](_),f&&Jt(e,d)),m}):[],p.update(),f=!0,ne(p.before_update),p.fragment=i?i(p.ctx):!1,t.target){if(t.hydrate){const d=Pt(t.target);p.fragment&&p.fragment.l(d),d.forEach(z)}else p.fragment&&p.fragment.c();t.intro&&At(e.$$.fragment),Gt(e,t.target,t.anchor),St()}_e(u)}class Zt{constructor(){J(this,"$$");J(this,"$$set")}$destroy(){Yt(this,1),this.$destroy=pe}$on(t,n){if(!yt(n))return pe;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const s=i.indexOf(n);s!==-1&&i.splice(s,1)}}$set(t){this.$$set&&!Ut(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const en="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(en);function ot(e,t,n){const i=e.slice();return i[27]=t[n],i[28]=t,i[29]=n,i}function ct(e,t,n){const i=e.slice();return i[30]=t[n],i}function at(e,t,n){const i=e.slice();return i[33]=t[n],i}function rt(e){let t,n,i;return{c(){t=g("div"),r(t,"class","backdrop svelte-1nqb995")},m(s,o){Y(s,t,o),n||(i=U(t,"click",e[16]),n=!0)},p:pe,d(s){s&&z(t),n=!1,i()}}}function ut(e){let t,n,i,s,o,h,b=fe(e[4]),u=[];for(let d=0;d<b.length;d+=1)u[d]=dt(at(e,b,d));let p=fe(e[5]),f=[];for(let d=0;d<p.length;d+=1)f[d]=ft(ct(e,p,d));return{c(){t=g("div"),n=g("div");for(let d=0;d<u.length;d+=1)u[d].c();i=x(),s=g("div"),o=x(),h=g("div");for(let d=0;d<f.length;d+=1)f[d].c();r(n,"class","time-col svelte-1nqb995"),y(s,"width","1px"),y(s,"background","var(--b3-theme-surface-lighter)"),r(h,"class","time-col svelte-1nqb995"),r(t,"class","time-picker-popover svelte-1nqb995")},m(d,m){Y(d,t,m),l(t,n);for(let c=0;c<u.length;c+=1)u[c]&&u[c].m(n,null);l(t,i),l(t,s),l(t,o),l(t,h);for(let c=0;c<f.length;c+=1)f[c]&&f[c].m(h,null)},p(d,m){if(m[0]&2066){b=fe(d[4]);let c;for(c=0;c<b.length;c+=1){const _=at(d,b,c);u[c]?u[c].p(_,m):(u[c]=dt(_),u[c].c(),u[c].m(n,null))}for(;c<u.length;c+=1)u[c].d(1);u.length=b.length}if(m[0]&4130){p=fe(d[5]);let c;for(c=0;c<p.length;c+=1){const _=ct(d,p,c);f[c]?f[c].p(_,m):(f[c]=ft(_),f[c].c(),f[c].m(h,null))}for(;c<f.length;c+=1)f[c].d(1);f.length=p.length}},d(d){d&&z(t),nt(u,d),nt(f,d)}}}function dt(e){let t,n=e[33]+"",i,s,o,h;function b(){return e[17](e[33])}return{c(){t=g("div"),i=O(n),s=x(),r(t,"id",`time-opt-h-${e[33]}`),r(t,"class","time-opt svelte-1nqb995"),te(t,"selected",e[1].startsWith(e[33]))},m(u,p){Y(u,t,p),l(t,i),l(t,s),o||(h=U(t,"click",b),o=!0)},p(u,p){e=u,p[0]&18&&te(t,"selected",e[1].startsWith(e[33]))},d(u){u&&z(t),o=!1,h()}}}function ft(e){let t,n=e[30]+"",i,s,o,h;function b(){return e[18](e[30])}return{c(){t=g("div"),i=O(n),s=x(),r(t,"id",`time-opt-m-${e[30]}`),r(t,"class","time-opt svelte-1nqb995"),te(t,"selected",e[1].endsWith(e[30]))},m(u,p){Y(u,t,p),l(t,i),l(t,s),o||(h=U(t,"click",b),o=!0)},p(u,p){e=u,p[0]&34&&te(t,"selected",e[1].endsWith(e[30]))},d(u){u&&z(t),o=!1,h()}}}function ht(e){let t,n=e[27].keyword+"",i;return{c(){t=g("span"),i=O(n),r(t,"class","tag-preview svelte-1nqb995")},m(s,o){Y(s,t,o),l(t,i)},p(s,o){o[0]&1&&n!==(n=s[27].keyword+"")&&$e(i,n)},d(s){s&&z(t)}}}function pt(e){let t,n,i,s,o,h,b,u,p,f,d,m,c,_,q,S,L,I,$,B,T,C,v;function R(){e[22].call(o,e[28],e[29])}function D(){e[23].call(f,e[28],e[29])}function P(){e[24].call(S,e[28],e[29])}function E(){e[25].call(T,e[28],e[29])}return{c(){t=g("div"),n=g("div"),i=g("div"),i.textContent=`${M("ruleNameLabel")}`,s=x(),o=g("input"),h=x(),b=g("div"),u=g("div"),u.textContent=`${M("keywordLabel")}`,p=x(),f=g("input"),d=x(),m=g("div"),c=g("div"),_=g("div"),_.textContent=`${M("completedStatusLabel")}`,q=x(),S=g("input"),L=x(),I=g("div"),$=g("div"),$.textContent=`${M("archivedStatusLabel")}`,B=x(),T=g("input"),r(i,"class","input-label svelte-1nqb995"),r(o,"class","modern-input svelte-1nqb995"),r(o,"type","text"),r(o,"placeholder",M("ruleNamePlaceholder")),r(n,"class","input-group svelte-1nqb995"),r(u,"class","input-label svelte-1nqb995"),r(f,"class","modern-input svelte-1nqb995"),r(f,"type","text"),r(f,"placeholder",M("keywordPlaceholder")),r(b,"class","input-group svelte-1nqb995"),r(_,"class","input-label svelte-1nqb995"),r(S,"class","modern-input svelte-1nqb995"),r(S,"type","text"),r(S,"placeholder",M("completedStatusPlaceholder")),r(c,"class","input-group fn__flex-1 svelte-1nqb995"),r($,"class","input-label svelte-1nqb995"),r(T,"class","modern-input svelte-1nqb995"),r(T,"type","text"),r(T,"placeholder",M("archivedStatusPlaceholder")),r(I,"class","input-group fn__flex-1 svelte-1nqb995"),r(m,"class","fn__flex svelte-1nqb995"),y(m,"gap","20px"),r(t,"class","card-content svelte-1nqb995")},m(k,A){Y(k,t,A),l(t,n),l(n,i),l(n,s),l(n,o),ee(o,e[27].name),l(t,h),l(t,b),l(b,u),l(b,p),l(b,f),ee(f,e[27].keyword),l(t,d),l(t,m),l(m,c),l(c,_),l(c,q),l(c,S),ee(S,e[27].completedStatus),l(m,L),l(m,I),l(I,$),l(I,B),l(I,T),ee(T,e[27].archivedStatus),C||(v=[U(o,"input",R),U(o,"change",e[7]),U(f,"input",D),U(f,"change",e[7]),U(S,"input",P),U(S,"change",e[7]),U(T,"input",E),U(T,"change",e[7])],C=!0)},p(k,A){e=k,A[0]&1&&o.value!==e[27].name&&ee(o,e[27].name),A[0]&1&&f.value!==e[27].keyword&&ee(f,e[27].keyword),A[0]&1&&S.value!==e[27].completedStatus&&ee(S,e[27].completedStatus),A[0]&1&&T.value!==e[27].archivedStatus&&ee(T,e[27].archivedStatus)},d(k){k&&z(t),C=!1,ne(v)}}}function gt(e,t){let n,i,s,o,h,b,u=(t[27].name||M("unnamedRule"))+"",p,f,d,m,c,_,q,S,L,I,$,B,T,C,v=t[27].keyword&&ht(t);function R(){t[19].call(_,t[28],t[29])}function D(){return t[20](t[27])}function P(){return t[21](t[27])}let E=t[2]===t[27].id&&pt(t);return{key:e,first:null,c(){n=g("div"),i=g("div"),s=g("div"),s.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',o=x(),h=g("div"),b=g("span"),p=O(u),f=x(),v&&v.c(),d=x(),m=g("div"),c=g("label"),_=g("input"),q=x(),S=g("span"),S.innerHTML='<span class="switch-thumb svelte-1nqb995"></span>',I=x(),$=g("div"),$.innerHTML='<svg class="svelte-1nqb995"><use xlink:href="#iconTrashcan"></use></svg>',B=x(),E&&E.c(),r(s,"class","chevron svelte-1nqb995"),y(b,"font-weight","600"),y(b,"font-size","15px"),y(b,"color","var(--b3-theme-on-surface)"),r(h,"class","fn__flex-1 svelte-1nqb995"),y(h,"margin-left","14px"),y(h,"display","flex"),y(h,"align-items","center"),r(_,"class","switch-input svelte-1nqb995"),r(_,"type","checkbox"),r(S,"class","switch-track svelte-1nqb995"),r(c,"class","switch-container svelte-1nqb995"),r(c,"title",L=t[27].enabled?M("enabled"):M("disabled")),r(m,"class","fn__flex-center"),y(m,"margin-right","20px"),r($,"class","icon-btn svelte-1nqb995"),r($,"title",M("deleteRule")),r(i,"class","card-header svelte-1nqb995"),r(n,"class","card svelte-1nqb995"),y(n,"opacity",t[27].enabled?1:.75),te(n,"expanded",t[2]===t[27].id),this.first=n},m(k,A){Y(k,n,A),l(n,i),l(i,s),l(i,o),l(i,h),l(h,b),l(b,p),l(h,f),v&&v.m(h,null),l(i,d),l(i,m),l(m,c),l(c,_),_.checked=t[27].enabled,l(c,q),l(c,S),l(i,I),l(i,$),l(n,B),E&&E.m(n,null),T||(C=[U(_,"change",R),U(_,"change",t[7]),U(m,"click",it(t[15])),U($,"click",it(D)),U(i,"click",P)],T=!0)},p(k,A){t=k,A[0]&1&&u!==(u=(t[27].name||M("unnamedRule"))+"")&&$e(p,u),t[27].keyword?v?v.p(t,A):(v=ht(t),v.c(),v.m(h,null)):v&&(v.d(1),v=null),A[0]&1&&(_.checked=t[27].enabled),A[0]&1&&L!==(L=t[27].enabled?M("enabled"):M("disabled"))&&r(c,"title",L),t[2]===t[27].id?E?E.p(t,A):(E=pt(t),E.c(),E.m(n,null)):E&&(E.d(1),E=null),A[0]&1&&y(n,"opacity",t[27].enabled?1:.75),A[0]&5&&te(n,"expanded",t[2]===t[27].id)},d(k){k&&z(n),v&&v.d(),E&&E.d(),T=!1,ne(C)}}}function vt(e){let t;return{c(){t=g("div"),t.textContent=`${M("noRulesTip")}`,y(t,"text-align","center"),y(t,"padding","48px"),y(t,"color","var(--b3-theme-on-surface-light)"),y(t,"border","2px dashed var(--b3-border-color)"),y(t,"border-radius","16px")},m(n,i){Y(n,t,i)},d(n){n&&z(t)}}}function tn(e){let t,n,i,s,o,h,b,u=M("globalArchiveTime")+"",p,f,d,m,c,_,q,S,L,I,$,B,T,C,v,R,D,P,E,k=M("archiveRuleList")+"",A,a,w,ie,V,se,xe,Le,xt=M("addRule")+"",Ue,Pe,Q,X=[],Ke=new Map,qe,Oe,oe,W,ve,Te,Be,qt=M("usageTipTitle")+"",je,He,Z,ce,Me,Fe,Tt=M("usageTipGlobalDesc")+"",Ve,We,ae,Ne,ze,Mt=M("usageTipMatchDesc")+"",Xe,Ge,re,Ie,Ye,Nt=M("usageTipStatusDesc")+"",Je,Ce,Qe,j=e[3]&&rt(e),H=e[3]&&ut(e),ke=fe(e[0]);const Ze=N=>N[27].id;for(let N=0;N<ke.length;N+=1){let K=ot(e,ke,N),le=Ze(K);Ke.set(le,X[N]=gt(le,K))}let F=e[0].length===0&&vt();return{c(){j&&j.c(),t=x(),n=g("div"),i=g("div"),s=g("div"),o=G("svg"),h=G("use"),b=x(),p=O(u),f=x(),d=g("div"),m=x(),c=g("button"),c.textContent=`${M("refreshNow")}`,_=x(),q=g("div"),S=O(e[1]),L=x(),I=G("svg"),$=G("use"),B=x(),H&&H.c(),T=x(),C=g("div"),v=g("div"),R=g("div"),D=G("svg"),P=G("use"),E=x(),A=O(k),a=x(),w=g("div"),ie=x(),V=g("button"),se=G("svg"),xe=G("use"),Le=x(),Ue=O(xt),Pe=x(),Q=g("div");for(let N=0;N<X.length;N+=1)X[N].c();qe=x(),F&&F.c(),Oe=x(),oe=g("div"),W=g("div"),ve=G("svg"),Te=G("use"),Be=x(),je=O(qt),He=x(),Z=g("ul"),ce=g("li"),Me=g("strong"),Me.textContent=`${M("usageTipGlobal")}`,Fe=O("："),Ve=O(Tt),We=x(),ae=g("li"),Ne=g("strong"),Ne.textContent=`${M("usageTipMatch")}`,ze=O("："),Xe=O(Mt),Ge=x(),re=g("li"),Ie=g("strong"),Ie.textContent=`${M("usageTipStatus")}`,Ye=O("："),Je=O(Nt),me(h,"xlink:href","#iconCalendar"),y(o,"width","18px"),y(o,"height","18px"),r(s,"class","section-title svelte-1nqb995"),r(d,"class","fn__flex-1 svelte-1nqb995"),r(c,"class","action-btn svelte-1nqb995"),me($,"xlink:href","#iconClock"),y(I,"width","14px"),y(I,"height","14px"),y(I,"opacity","0.6"),r(q,"class","time-trigger svelte-1nqb995"),te(q,"active",e[3]),r(i,"class","section-header svelte-1nqb995"),me(P,"xlink:href","#iconSettings"),y(D,"width","18px"),y(D,"height","18px"),r(R,"class","section-title svelte-1nqb995"),r(w,"class","fn__flex-1 svelte-1nqb995"),me(xe,"xlink:href","#iconAdd"),y(se,"width","14px"),y(se,"height","14px"),r(se,"class","svelte-1nqb995"),r(V,"class","action-btn svelte-1nqb995"),r(v,"class","section-header svelte-1nqb995"),r(Q,"class","profile-container svelte-1nqb995"),y(C,"margin-top","20px"),y(C,"display","flex"),y(C,"flex-direction","column"),me(Te,"xlink:href","#iconInfo"),y(ve,"width","16px"),y(ve,"height","16px"),y(W,"font-weight","700"),y(W,"color","var(--b3-theme-primary)"),y(W,"display","flex"),y(W,"align-items","center"),y(W,"gap","8px"),y(W,"margin-bottom","8px"),y(W,"font-size","14px"),r(ce,"class","svelte-1nqb995"),r(ae,"class","svelte-1nqb995"),r(re,"class","svelte-1nqb995"),r(Z,"class","svelte-1nqb995"),r(oe,"class","info-footer svelte-1nqb995"),r(n,"class","settings-container svelte-1nqb995")},m(N,K){j&&j.m(N,K),Y(N,t,K),Y(N,n,K),l(n,i),l(i,s),l(s,o),l(o,h),l(s,b),l(s,p),l(i,f),l(i,d),l(i,m),l(i,c),l(i,_),l(i,q),l(q,S),l(q,L),l(q,I),l(I,$),l(i,B),H&&H.m(i,null),l(n,T),l(n,C),l(C,v),l(v,R),l(R,D),l(D,P),l(R,E),l(R,A),l(v,a),l(v,w),l(v,ie),l(v,V),l(V,se),l(se,xe),l(V,Le),l(V,Ue),l(C,Pe),l(C,Q);for(let le=0;le<X.length;le+=1)X[le]&&X[le].m(Q,null);l(Q,qe),F&&F.m(Q,null),l(n,Oe),l(n,oe),l(oe,W),l(W,ve),l(ve,Te),l(W,Be),l(W,je),l(oe,He),l(oe,Z),l(Z,ce),l(ce,Me),l(ce,Fe),l(ce,Ve),l(Z,We),l(Z,ae),l(ae,Ne),l(ae,ze),l(ae,Xe),l(Z,Ge),l(Z,re),l(re,Ie),l(re,Ye),l(re,Je),Ce||(Qe=[U(c,"click",e[6]),U(q,"click",e[13]),U(V,"click",e[8])],Ce=!0)},p(N,K){N[3]?j?j.p(N,K):(j=rt(N),j.c(),j.m(t.parentNode,t)):j&&(j.d(1),j=null),K[0]&2&&$e(S,N[1]),K[0]&8&&te(q,"active",N[3]),N[3]?H?H.p(N,K):(H=ut(N),H.c(),H.m(i,null)):H&&(H.d(1),H=null),K[0]&1669&&(ke=fe(N[0]),X=Xt(X,K,Ze,1,N,ke,Ke,Q,zt,gt,qe,ot)),N[0].length===0?F||(F=vt(),F.c(),F.m(Q,null)):F&&(F.d(1),F=null)},i:pe,o:pe,d(N){N&&(z(t),z(n)),j&&j.d(N),H&&H.d();for(let K=0;K<X.length;K+=1)X[K].d();F&&F.d(),Ce=!1,ne(Qe)}}}function nn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function mt(e,t){const n=`time-opt-${e}-${t}`,i=document.getElementById(n);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}function ln(e,t,n){let{plugin:i}=t,s=[],o="00:00",h=null,b=!1;const u=Array.from({length:24},(a,w)=>w.toString().padStart(2,"0")),p=Array.from({length:60},(a,w)=>w.toString().padStart(2,"0"));Ot(()=>{f(),i.config.profiles&&i.config.profiles.length===1&&n(2,h=i.config.profiles[0].id)});function f(){n(0,s=i.config.profiles||[]),n(1,o=i.config.archiveTime||"00:00")}async function d(){if(n(3,b=!1),i.reloadConfig)await i.reloadConfig();else{const a=await i.loadData("config.json");n(14,i.config={profiles:[],archiveTime:"00:00",lastRunDate:"",...a},i)}f()}async function m(){n(14,i.config.archiveTime=o,i),i.saveData("config.json",i.config),f()}function c(){i.config.profiles||n(14,i.config.profiles=[],i);const a={id:nn(),name:M("defaultNewRuleName")+" "+(i.config.profiles.length+1),keyword:"",completedStatus:M("defaultCompleted"),archivedStatus:M("defaultArchived"),enabled:!0};n(14,i.config.profiles=[...i.config.profiles,a],i),m(),n(2,h=a.id),setTimeout(()=>{const w=document.querySelector(".profile-container");w&&(w.scrollTop=w.scrollHeight)},50)}function _(a){n(14,i.config.profiles=i.config.profiles.filter(w=>w.id!==a),i),m(),h===a&&n(2,h=null)}function q(a){h===a?n(2,h=null):n(2,h=a)}function S(a){const w=o.split(":");n(1,o=`${a}:${w[1]||"00"}`),m()}function L(a){const w=o.split(":");n(1,o=`${w[0]||"00"}:${a}`),m()}function I(){n(3,b=!b),b&&setTimeout(()=>{const[a,w]=o.split(":");mt("h",a),mt("m",w)},10)}function $(a){Bt.call(this,e,a)}const B=()=>n(3,b=!1),T=a=>S(a),C=a=>L(a);function v(a,w){a[w].enabled=this.checked,n(0,s)}const R=a=>_(a.id),D=a=>q(a.id);function P(a,w){a[w].name=this.value,n(0,s)}function E(a,w){a[w].keyword=this.value,n(0,s)}function k(a,w){a[w].completedStatus=this.value,n(0,s)}function A(a,w){a[w].archivedStatus=this.value,n(0,s)}return e.$$set=a=>{"plugin"in a&&n(14,i=a.plugin)},[s,o,h,b,u,p,d,m,c,_,q,S,L,I,i,$,B,T,C,v,R,D,P,E,k,A]}class sn extends Zt{constructor(t){super(),Qt(this,t,ln,tn,Lt,{plugin:14},null,[-1,-1])}}class on extends be.Plugin{constructor(){super(...arguments);J(this,"timer");J(this,"isMobile");J(this,"config",{});J(this,"undoStack",[]);J(this,"MAX_UNDO_COUNT",30);J(this,"MAX_UNDO_DAYS",7)}async onload(){$t(this),console.log("Loading Kanban Archiver Plugin v0.3.20"),await this.loadAndNormalizeConfig();try{const i=await this.loadData("undo_history.json");i&&Array.isArray(i)&&(this.undoStack=i)}catch(i){console.error("Failed to load undo history",i)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板自动归档",position:"right",callback:i=>{if(this.isMobile){this.showMobileMenu();return}let s;i&&i.currentTarget&&i.currentTarget.getBoundingClientRect?s=i.currentTarget.getBoundingClientRect():s=n.getBoundingClientRect();const o=new be.Menu("kanban-archiver-menu");o.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),o.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),o.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),o.open({x:s.left,y:s.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",...n},(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let i=!1;this.config.profiles.forEach(s=>{s.enabled===void 0&&(s.enabled=!0,i=!0)}),i&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Archiver Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Archiver Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new be.Dialog({title:this.i18n.settingTitle||"看板自动归档设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{i.$destroy()}}),i=new sn({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new be.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},60*1e3)}checkAndRunArchive(){if(!this.config.archiveTime)return;const n=new Date,i=n.getHours(),s=n.getMinutes(),o=i*60+s;let h=0,b=0;try{const f=this.config.archiveTime.split(":").map(Number);f.length===2&&!isNaN(f[0])&&!isNaN(f[1])&&(h=f[0],b=f[1])}catch{return}const u=h*60+b,p=n.toLocaleDateString();this.config.lastRunDate!==p&&o>=u&&(this.config.lastRunDate=p,this.saveData("config.json",this.config),this.archiveNow())}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(i=>i.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(){try{const n=await Rt(this,!0);n&&n.length>0&&(this.undoStack.push({date:new Date().getTime(),ids:n}),await this.saveUndoHistory())}catch(n){console.error("Archive task error:",n)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await Et(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var i=Math.random()*16|0,s=n=="x"?i:i&3|8;return s.toString(16)})}}module.exports=on;
