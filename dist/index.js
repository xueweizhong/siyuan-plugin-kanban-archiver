"use strict";var Nn=Object.defineProperty;var En=(e,t,n)=>t in e?Nn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Qe=(e,t,n)=>En(e,typeof t!="symbol"?t+"":t,n);const yt=require("siyuan");async function We(e,t){let n=await yt.fetchSyncPost(e,t);return n.code===0?n.data:null}async function Tn(){const t=await We("/api/notebook/lsNotebooks","");try{t&&t.notebooks&&Array.isArray(t.notebooks)&&(t.notebooks=t.notebooks.filter(n=>n.closed===!1||n.closed===0||n.closed==="false"))}catch(n){console.error("Filter notebooks error:",n)}return t}async function Rn(e,t,n){return We("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:n})}async function $n(e,t,n){return We("/api/block/appendBlock",{dataType:e,data:t,parentID:n})}async function Ln(e){return We("/api/block/deleteBlock",{id:e})}async function Bn(e,t){return We("/api/attr/setBlockAttrs",{id:e,attrs:t})}async function xe(e){return We("/api/query/sql",{stmt:e})}async function bt(e,t=7e3){return We("/api/notification/pushMsg",{msg:e,timeout:t})}async function rt(e,t=7e3){return We("/api/notification/pushErrMsg",{msg:e,timeout:t})}async function $t(e){return We("/api/av/getAttributeViewKeysByAvID",{avID:e})}async function At(e,t,n=9999999,l=1){return We("/api/av/renderAttributeView",{id:e,viewID:t,pageSize:n,page:l})}async function Sn(e,t,n,l){return We("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,itemID:n,value:l})}async function Pn(e,t){return We("/api/av/getAttributeViewBoundBlockIDsByItemIDs",{avID:e,itemIDs:t})}async function Un(e,t,n,l,i=!1){var o,a,m;try{const _=t.keyword;console.log(`Starting Kanban status switch for profile "${t.name}": "${n}" -> "${l}"`);const p=await xe(`SELECT id FROM blocks WHERE content LIKE '%${_}%' AND type = 'd' LIMIT 1`);if(!p||p.length===0)return console.log(`Kanban doc not found for keyword: ${_}`),[];const c=p[0].id,k=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${c}' AND type = 'av' LIMIT 1`);if(!k||k.length===0)return i&&rt(`文档中未找到数据库视图 (Profile: ${t.name})`),[];const g=k[0],h=g.markdown.match(/data-av-id="([^"]+)"/);if(!h)return[];const w=h[1],v=await $t(w);if(!v)return[];let T=null,A=null,Q=null;for(const D of v)if((D.type==="select"||D.type==="mSelect")&&D.options){const O=D.options.find(M=>M.name===n),u=D.options.find(M=>M.name===l);if(O&&u){T=D,A=O,Q=u;break}}if(!T)return i&&rt(`在 "${t.name}" 中未找到状态 "${n}" -> "${l}"`),[];const F=g.markdown.match(/data-view-id="([^"]+)"/);let L=F?F[1]:w,j=await At(w,L);const B=(D,O=0)=>{if(!D||O>5)return[];let u=[];const M=["rows","groups","blocks","children","items"];for(const H of M)if(Array.isArray(D[H]))for(const N of D[H])N.id&&Array.isArray(N.cells)?u.push(N):u=u.concat(B(N,O+1));return D.view&&(u=u.concat(B(D.view,O+1))),u};let q=B(j);if(q.length===0&&(j!=null&&j.views)){const D=j.views.find(O=>O.type==="table");D&&(j=await At(w,D.id),q=B(j))}if(q.length===0)return[];let $=(((o=j.view)==null?void 0:o.columns)||j.columns||[]).findIndex(D=>D.id===T.id),P=[],x=0;for(const D of q){let O=!1;if($>=0&&D.cells&&D.cells[$]){const u=D.cells[$].value;u!=null&&u.mSelect?O=u.mSelect.some(M=>M.content===n):u!=null&&u.select&&(O=u.select.content===n)}else if(D.cells&&Array.isArray(D.cells))for(const u of D.cells){const M=u.value;if((a=M==null?void 0:M.mSelect)!=null&&a.some(H=>H.content===n)){O=!0;break}else if(((m=M==null?void 0:M.select)==null?void 0:m.content)===n){O=!0;break}}if(O){const u={mSelect:[{content:Q.name,color:Q.color}]};await Sn(w,T.id,D.id,u),P.push(D.id),x++}}return x>0&&bt(`[${t.name}] 已归档 ${x} 个任务`),P}catch(_){return console.error("Status switch failed:",_),i&&rt(`[${t.name}] 出错: `+_.message),[]}}async function On(e,t){if(!t||t.length===0)return!1;const n=e.config.profiles||[];let l=0;for(const i of n)try{const o=await xe(`SELECT id FROM blocks WHERE content LIKE '%${i.keyword}%' AND type = 'd' LIMIT 1`);if(!o||o.length===0)continue;const a=o[0].id,m=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${a}' AND type = 'av' LIMIT 1`);if(!m||m.length===0)continue;const p=m[0].markdown.match(/data-av-id="([^"]+)"/);if(!p)continue;const c=p[1],k=await $t(c);if(!k)continue;let g=null,h=null;for(const v of k)if((v.type==="select"||v.type==="mSelect")&&v.options){const T=v.options.find(A=>A.name===i.completedStatus);if(T){g=v,h=T;break}}if(!g||!h)continue;const w={mSelect:[{content:h.name,color:h.color}]};for(const v of t)await Sn(c,g.id,v,w);l+=t.length}catch(o){console.warn("Restore attempted failed for profile",i.name,o)}return l>0?(bt("已尝试撤销恢复任务"),!0):!1}async function Pt(e,t=!1,n){let l=e.config.profiles||[],i=[];if(l.length===0)return t&&rt("未配置任何归档规则，请在设置中添加"),[];Array.isArray(n)&&n.length>0&&(l=l.filter(o=>n.includes(o.id)));for(const o of l){if(!o.keyword||o.enabled===!1)continue;const a=await Un(e,o,o.completedStatus,o.archivedStatus,t);i=i.concat(a)}return i}let jt=null;function Kn(e){jt=e}function I(e,t){let n=null;if(jt&&jt.i18n&&(n=jt.i18n),!n)try{const{i18n:o}=require("siyuan");n=o}catch(o){console.warn("无法获取i18n对象:",o)}if(!n||typeof n!="object")return console.warn("i18n数据不可用，使用key作为后备:",e),e;let l=n;const i=e.split(".");for(const o of i)if(l&&typeof l=="object"&&o in l)l=l[o];else{l=void 0;break}return typeof l!="string"&&(console.warn("未找到i18n键:",e),l=e),l}function Ve(){}function jn(e){return e()}function Ut(){return Object.create(null)}function Pe(e){e.forEach(jn)}function qn(e){return typeof e=="function"}function Fn(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Wn(e){return Object.keys(e).length===0}function s(e,t){e.appendChild(t)}function ue(e,t,n){e.insertBefore(t,n||null)}function re(e){e.parentNode&&e.parentNode.removeChild(e)}function ft(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function d(e){return document.createElement(e)}function Re(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function ce(e){return document.createTextNode(e)}function y(){return ce(" ")}function Dn(){return ce("")}function R(e,t,n,l){return e.addEventListener(t,n,l),()=>e.removeEventListener(t,n,l)}function et(e){return function(t){return t.stopPropagation(),e.call(this,t)}}function r(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function at(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function _t(e){return e===""?null:+e}function Hn(e){return Array.from(e.childNodes)}function st(e,t){t=""+t,e.data!==t&&(e.data=t)}function G(e,t){e.value=t??""}function b(e,t,n,l){n==null?e.style.removeProperty(t):e.style.setProperty(t,n,"")}function ct(e,t,n){for(let l=0;l<e.options.length;l+=1){const i=e.options[l];if(i.__value===t){i.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function St(e){const t=e.querySelector(":checked");return t&&t.__value}function tt(e,t,n){e.classList.toggle(t,!!n)}let Tt;function It(e){Tt=e}function Vn(){if(!Tt)throw new Error("Function called outside component initialization");return Tt}function xn(e){Vn().$$.on_mount.push(e)}function Ot(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(l=>l.call(this,t))}const gt=[],Kt=[];let vt=[];const Ft=[],zn=Promise.resolve();let Ct=!1;function Yn(){Ct||(Ct=!0,zn.then(An))}function pt(e){vt.push(e)}const Dt=new Set;let ht=0;function An(){if(ht!==0)return;const e=Tt;do{try{for(;ht<gt.length;){const t=gt[ht];ht++,It(t),Xn(t.$$)}}catch(t){throw gt.length=0,ht=0,t}for(It(null),gt.length=0,ht=0;Kt.length;)Kt.pop()();for(let t=0;t<vt.length;t+=1){const n=vt[t];Dt.has(n)||(Dt.add(n),n())}vt.length=0}while(gt.length);for(;Ft.length;)Ft.pop()();Ct=!1,Dt.clear(),It(e)}function Xn(e){if(e.fragment!==null){e.update(),Pe(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(pt)}}function Gn(e){const t=[],n=[];vt.forEach(l=>e.indexOf(l)===-1?t.push(l):n.push(l)),n.forEach(l=>l()),vt=t}const Jn=new Set;function Cn(e,t){e&&e.i&&(Jn.delete(e),e.i(t))}function Te(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function Mt(e,t){e.d(1),t.delete(e.key)}function Nt(e,t,n,l,i,o,a,m,_,p,c,k){let g=e.length,h=o.length,w=g;const v={};for(;w--;)v[e[w].key]=w;const T=[],A=new Map,Q=new Map,F=[];for(w=h;w--;){const q=k(i,o,w),C=n(q);let $=a.get(C);$?F.push(()=>$.p(q,t)):($=p(C,q),$.c()),A.set(C,T[w]=$),C in v&&Q.set(C,Math.abs(w-v[C]))}const L=new Set,j=new Set;function B(q){Cn(q,1),q.m(m,c),a.set(q.key,q),c=q.first,h--}for(;g&&h;){const q=T[h-1],C=e[g-1],$=q.key,P=C.key;q===C?(c=q.first,g--,h--):A.has(P)?!a.has($)||L.has($)?B(q):j.has(P)?g--:Q.get($)>Q.get(P)?(j.add($),B(q)):(L.add(P),g--):(_(C,a),g--)}for(;g--;){const q=e[g];A.has(q.key)||_(q,a)}for(;h;)B(T[h-1]);return Pe(F),T}function Qn(e,t,n){const{fragment:l,after_update:i}=e.$$;l&&l.m(t,n),pt(()=>{const o=e.$$.on_mount.map(jn).filter(qn);e.$$.on_destroy?e.$$.on_destroy.push(...o):Pe(o),e.$$.on_mount=[]}),i.forEach(pt)}function Zn(e,t){const n=e.$$;n.fragment!==null&&(Gn(n.after_update),Pe(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function el(e,t){e.$$.dirty[0]===-1&&(gt.push(e),Yn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function tl(e,t,n,l,i,o,a=null,m=[-1]){const _=Tt;It(e);const p=e.$$={fragment:null,ctx:[],props:o,update:Ve,not_equal:i,bound:Ut(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(_?_.$$.context:[])),callbacks:Ut(),dirty:m,skip_bound:!1,root:t.target||_.$$.root};a&&a(p.root);let c=!1;if(p.ctx=n?n(e,t.props||{},(k,g,...h)=>{const w=h.length?h[0]:g;return p.ctx&&i(p.ctx[k],p.ctx[k]=w)&&(!p.skip_bound&&p.bound[k]&&p.bound[k](w),c&&el(e,k)),g}):[],p.update(),c=!0,Pe(p.before_update),p.fragment=l?l(p.ctx):!1,t.target){if(t.hydrate){const k=Hn(t.target);p.fragment&&p.fragment.l(k),k.forEach(re)}else p.fragment&&p.fragment.c();t.intro&&Cn(e.$$.fragment),Qn(e,t.target,t.anchor),An()}It(_)}class nl{constructor(){Qe(this,"$$");Qe(this,"$$set")}$destroy(){Zn(this,1),this.$destroy=Ve}$on(t,n){if(!qn(n))return Ve;const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(n),()=>{const i=l.indexOf(n);i!==-1&&l.splice(i,1)}}$set(t){this.$$set&&!Wn(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const ll="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ll);function Wt(e,t,n){const l=e.slice();return l[75]=t[n],l}function Ht(e,t,n){const l=e.slice();return l[78]=t[n],l}function Vt(e,t,n){const l=e.slice();return l[81]=t[n],l[82]=t,l[83]=n,l}function xt(e,t,n){const l=e.slice();return l[84]=t[n],l[85]=t,l[86]=n,l}function zt(e,t,n){const l=e.slice();return l[87]=t[n],l}function Yt(e,t,n){const l=e.slice();return l[87]=t[n],l}function Xt(e,t,n){const l=e.slice();return l[92]=t[n],l}function Gt(e,t,n){const l=e.slice();return l[95]=t[n],l}function Jt(e,t,n){const l=e.slice();return l[98]=t[n],l[99]=t,l[100]=n,l}function Qt(e,t,n){const l=e.slice();return l[101]=t[n],l}function Zt(e){let t,n,l;return{c(){t=d("div"),r(t,"class","backdrop svelte-kwj5pq")},m(i,o){ue(i,t,o),n||(l=R(t,"click",e[31]),n=!0)},p:Ve,d(i){i&&re(t),n=!1,l()}}}function en(e){let t,n=e[98].keyword+"",l;return{c(){t=d("span"),l=ce(n),r(t,"class","tag-preview svelte-kwj5pq")},m(i,o){ue(i,t,o),s(t,l)},p(i,o){o[0]&2&&n!==(n=i[98].keyword+"")&&st(l,n)},d(i){i&&re(t)}}}function tn(e){let t,n,l,i,o,a,m,_,p,c,k,g,h,w,v,T,A,Q,F,L,j,B,q,C,$,P,x,D,O,u,M,H,N,Z,ge,je,U,de,z,fe,ke,ee,me,J,Ae,Y,V,X=it(e[98])+"",se,oe,le,qe,Ue,ze,Se,He,be,we;function Oe(){e[37].call(o,e[99],e[100])}function Ce(){e[38].call(c,e[99],e[100])}function nt(){e[39].call(T,e[99],e[100])}function Me(){e[40].call(j,e[99],e[100])}function lt(){e[41].call(D,e[99],e[100])}function Ye(){return e[42](e[98])}function De(){e[43].call(U,e[99],e[100])}function $e(){return e[44](e[98])}function Xe(...ne){return e[45](e[98],...ne)}let ye=e[2]===e[98].id&&nn(),ve=e[98].schedule.mode==="weekly"&&ln(e),_e=e[98].schedule.mode==="monthly"&&on(e),ie=e[98].schedule.mode==="yearly"&&an(e);return{c(){var ne;t=d("div"),n=d("div"),l=d("div"),l.textContent=`${I("ruleNameLabel")}`,i=y(),o=d("input"),a=y(),m=d("div"),_=d("div"),_.textContent=`${I("keywordLabel")}`,p=y(),c=d("input"),k=y(),g=d("div"),h=d("div"),w=d("div"),w.textContent=`${I("completedStatusLabel")}`,v=y(),T=d("input"),A=y(),Q=d("div"),F=d("div"),F.textContent=`${I("archivedStatusLabel")}`,L=y(),j=d("input"),B=y(),q=d("div"),C=d("div"),C.textContent=`${I("scheduleSection")}`,$=y(),P=d("div"),x=d("label"),D=d("input"),O=y(),u=d("span"),u.innerHTML='<span class="switch-thumb svelte-kwj5pq"></span>',H=y(),N=d("div"),Z=d("div"),ge=d("div"),ge.textContent=`${I("scheduleMode")}`,je=y(),U=d("select"),de=d("option"),de.textContent=`${I("scheduleMode_daily")}`,z=d("option"),z.textContent=`${I("scheduleMode_weekly")}`,fe=d("option"),fe.textContent=`${I("scheduleMode_workday")}`,ke=d("option"),ke.textContent=`${I("scheduleMode_monthly")}`,ee=d("option"),ee.textContent=`${I("scheduleMode_yearly")}`,me=y(),J=d("div"),Ae=d("div"),Ae.textContent=`${I("scheduleTime")}`,Y=y(),V=d("div"),se=ce(X),oe=y(),le=Re("svg"),qe=Re("use"),Ue=y(),ye&&ye.c(),ze=y(),ve&&ve.c(),Se=y(),_e&&_e.c(),He=y(),ie&&ie.c(),r(l,"class","input-label svelte-kwj5pq"),r(o,"class","modern-input svelte-kwj5pq"),r(o,"type","text"),r(o,"placeholder",I("ruleNamePlaceholder")),r(n,"class","input-group svelte-kwj5pq"),r(_,"class","input-label svelte-kwj5pq"),r(c,"class","modern-input svelte-kwj5pq"),r(c,"type","text"),r(c,"placeholder",I("keywordPlaceholder")),r(m,"class","input-group svelte-kwj5pq"),r(w,"class","input-label svelte-kwj5pq"),r(T,"class","modern-input svelte-kwj5pq"),r(T,"type","text"),r(T,"placeholder",I("completedStatusPlaceholder")),r(h,"class","input-group fn__flex-1 svelte-kwj5pq"),r(F,"class","input-label svelte-kwj5pq"),r(j,"class","modern-input svelte-kwj5pq"),r(j,"type","text"),r(j,"placeholder",I("archivedStatusPlaceholder")),r(Q,"class","input-group fn__flex-1 svelte-kwj5pq"),r(g,"class","fn__flex svelte-kwj5pq"),b(g,"gap","20px"),r(C,"class","input-label svelte-kwj5pq"),r(D,"class","switch-input svelte-kwj5pq"),r(D,"type","checkbox"),r(u,"class","switch-track svelte-kwj5pq"),r(x,"class","switch-container svelte-kwj5pq"),r(x,"title",M=(ne=e[98].schedule)!=null&&ne.enabled?I("enabled"):I("disabled")),r(P,"class","fn__flex svelte-kwj5pq"),b(P,"gap","12px"),b(P,"flex-wrap","wrap"),b(P,"align-items","center"),r(ge,"class","input-label svelte-kwj5pq"),de.__value="daily",G(de,de.__value),z.__value="weekly",G(z,z.__value),fe.__value="workday",G(fe,fe.__value),ke.__value="monthly",G(ke,ke.__value),ee.__value="yearly",G(ee,ee.__value),r(U,"class","modern-input svelte-kwj5pq"),e[98].schedule.mode===void 0&&pt(De),r(Z,"class","input-group svelte-kwj5pq"),b(Z,"min-width","160px"),r(Ae,"class","input-label svelte-kwj5pq"),at(qe,"xlink:href","#iconClock"),b(le,"width","14px"),b(le,"height","14px"),b(le,"opacity","0.6"),r(V,"class","time-trigger svelte-kwj5pq"),tt(V,"active",e[2]===e[98].id),r(J,"class","input-group svelte-kwj5pq"),b(J,"min-width","140px"),r(N,"class","fn__flex svelte-kwj5pq"),b(N,"gap","12px"),b(N,"flex-wrap","wrap"),b(N,"margin-top","8px"),r(q,"class","input-group svelte-kwj5pq"),r(t,"class","card-content svelte-kwj5pq")},m(ne,te){ue(ne,t,te),s(t,n),s(n,l),s(n,i),s(n,o),G(o,e[98].name),s(t,a),s(t,m),s(m,_),s(m,p),s(m,c),G(c,e[98].keyword),s(t,k),s(t,g),s(g,h),s(h,w),s(h,v),s(h,T),G(T,e[98].completedStatus),s(g,A),s(g,Q),s(Q,F),s(Q,L),s(Q,j),G(j,e[98].archivedStatus),s(t,B),s(t,q),s(q,C),s(q,$),s(q,P),s(P,x),s(x,D),D.checked=e[98].schedule.enabled,s(x,O),s(x,u),s(q,H),s(q,N),s(N,Z),s(Z,ge),s(Z,je),s(Z,U),s(U,de),s(U,z),s(U,fe),s(U,ke),s(U,ee),ct(U,e[98].schedule.mode,!0),s(N,me),s(N,J),s(J,Ae),s(J,Y),s(J,V),s(V,se),s(V,oe),s(V,le),s(le,qe),s(J,Ue),ye&&ye.m(J,null),s(N,ze),ve&&ve.m(N,null),s(N,Se),_e&&_e.m(N,null),s(N,He),ie&&ie.m(N,null),be||(we=[R(o,"input",Oe),R(o,"change",e[13]),R(c,"input",Ce),R(c,"change",e[13]),R(T,"input",nt),R(T,"change",e[13]),R(j,"input",Me),R(j,"change",e[13]),R(D,"change",lt),R(D,"change",Ye),R(U,"change",De),R(U,"change",$e),R(V,"click",et(Xe))],be=!0)},p(ne,te){var Ke;e=ne,te[0]&2&&o.value!==e[98].name&&G(o,e[98].name),te[0]&2&&c.value!==e[98].keyword&&G(c,e[98].keyword),te[0]&2&&T.value!==e[98].completedStatus&&G(T,e[98].completedStatus),te[0]&2&&j.value!==e[98].archivedStatus&&G(j,e[98].archivedStatus),te[0]&2&&(D.checked=e[98].schedule.enabled),te[0]&2&&M!==(M=(Ke=e[98].schedule)!=null&&Ke.enabled?I("enabled"):I("disabled"))&&r(x,"title",M),te[0]&2&&ct(U,e[98].schedule.mode),te[0]&2&&X!==(X=it(e[98])+"")&&st(se,X),te[0]&6&&tt(V,"active",e[2]===e[98].id),e[2]===e[98].id?ye||(ye=nn(),ye.c(),ye.m(J,null)):ye&&(ye.d(1),ye=null),e[98].schedule.mode==="weekly"?ve?ve.p(e,te):(ve=ln(e),ve.c(),ve.m(N,Se)):ve&&(ve.d(1),ve=null),e[98].schedule.mode==="monthly"?_e?_e.p(e,te):(_e=on(e),_e.c(),_e.m(N,He)):_e&&(_e.d(1),_e=null),e[98].schedule.mode==="yearly"?ie?ie.p(e,te):(ie=an(e),ie.c(),ie.m(N,null)):ie&&(ie.d(1),ie=null)},d(ne){ne&&re(t),ye&&ye.d(),ve&&ve.d(),_e&&_e.d(),ie&&ie.d(),be=!1,Pe(we)}}}function nn(e){return{c:Ve,m:Ve,d:Ve}}function ln(e){let t,n,l,i,o,a,m=Te(e[12]),_=[];for(let k=0;k<m.length;k+=1)_[k]=sn(Qt(e,m,k));function p(){e[46].call(i,e[99],e[100])}function c(){return e[47](e[98])}return{c(){t=d("div"),n=d("div"),n.textContent=`${I("scheduleWeekday")}`,l=y(),i=d("select");for(let k=0;k<_.length;k+=1)_[k].c();r(n,"class","input-label svelte-kwj5pq"),r(i,"class","modern-input svelte-kwj5pq"),e[98].schedule.weekday===void 0&&pt(p),r(t,"class","input-group svelte-kwj5pq"),b(t,"min-width","140px")},m(k,g){ue(k,t,g),s(t,n),s(t,l),s(t,i);for(let h=0;h<_.length;h+=1)_[h]&&_[h].m(i,null);ct(i,e[98].schedule.weekday,!0),o||(a=[R(i,"change",p),R(i,"change",c)],o=!0)},p(k,g){if(e=k,g[0]&4096){m=Te(e[12]);let h;for(h=0;h<m.length;h+=1){const w=Qt(e,m,h);_[h]?_[h].p(w,g):(_[h]=sn(w),_[h].c(),_[h].m(i,null))}for(;h<_.length;h+=1)_[h].d(1);_.length=m.length}g[0]&2&&ct(i,e[98].schedule.weekday)},d(k){k&&re(t),ft(_,k),o=!1,Pe(a)}}}function sn(e){let t,n=I(`weekday_${e[101].value}`)+"",l;return{c(){t=d("option"),l=ce(n),t.__value=e[101].value,G(t,t.__value)},m(i,o){ue(i,t,o),s(t,l)},p:Ve,d(i){i&&re(t)}}}function on(e){let t,n,l,i,o,a;function m(){e[48].call(i,e[99],e[100])}function _(){return e[49](e[98])}return{c(){t=d("div"),n=d("div"),n.textContent=`${I("scheduleMonthday")}`,l=y(),i=d("input"),r(n,"class","input-label svelte-kwj5pq"),r(i,"class","modern-input svelte-kwj5pq"),r(i,"type","number"),r(i,"min","1"),r(i,"max","31"),r(t,"class","input-group svelte-kwj5pq"),b(t,"min-width","140px")},m(p,c){ue(p,t,c),s(t,n),s(t,l),s(t,i),G(i,e[98].schedule.monthday),o||(a=[R(i,"input",m),R(i,"change",_)],o=!0)},p(p,c){e=p,c[0]&2&&_t(i.value)!==e[98].schedule.monthday&&G(i,e[98].schedule.monthday)},d(p){p&&re(t),o=!1,Pe(a)}}}function an(e){let t,n,l,i,o,a,m,_,p,c,k;function g(){e[50].call(i,e[99],e[100])}function h(){return e[51](e[98])}function w(){e[52].call(p,e[99],e[100])}function v(){return e[53](e[98])}return{c(){t=d("div"),n=d("div"),n.textContent=`${I("scheduleMonth")}`,l=y(),i=d("input"),o=y(),a=d("div"),m=d("div"),m.textContent=`${I("scheduleMonthday")}`,_=y(),p=d("input"),r(n,"class","input-label svelte-kwj5pq"),r(i,"class","modern-input svelte-kwj5pq"),r(i,"type","number"),r(i,"min","1"),r(i,"max","12"),r(t,"class","input-group svelte-kwj5pq"),b(t,"min-width","140px"),r(m,"class","input-label svelte-kwj5pq"),r(p,"class","modern-input svelte-kwj5pq"),r(p,"type","number"),r(p,"min","1"),r(p,"max","31"),r(a,"class","input-group svelte-kwj5pq"),b(a,"min-width","140px")},m(T,A){ue(T,t,A),s(t,n),s(t,l),s(t,i),G(i,e[98].schedule.month),ue(T,o,A),ue(T,a,A),s(a,m),s(a,_),s(a,p),G(p,e[98].schedule.monthday),c||(k=[R(i,"input",g),R(i,"change",h),R(p,"input",w),R(p,"change",v)],c=!0)},p(T,A){e=T,A[0]&2&&_t(i.value)!==e[98].schedule.month&&G(i,e[98].schedule.month),A[0]&2&&_t(p.value)!==e[98].schedule.monthday&&G(p,e[98].schedule.monthday)},d(T){T&&(re(t),re(o),re(a)),c=!1,Pe(k)}}}function cn(e,t){let n,l,i,o,a,m,_=(t[98].name||I("unnamedRule"))+"",p,c,k,g,h,w,v,T,A,Q,F,L,j,B,q,C,$=I("undoArchive")+"",P,x,D,O,u,M,H=I("archiveNow")+"",N,Z,ge,je,U=t[98].keyword&&en(t);function de(){t[32].call(w,t[99],t[100])}function z(){return t[33](t[98])}function fe(){return t[35](t[98])}function ke(){return t[36](t[98])}let ee=t[3]===t[98].id&&tn(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),i=d("div"),i.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',o=y(),a=d("div"),m=d("span"),p=ce(_),c=y(),U&&U.c(),k=y(),g=d("div"),h=d("label"),w=d("input"),v=y(),T=d("span"),T.innerHTML='<span class="switch-thumb svelte-kwj5pq"></span>',Q=y(),F=d("div"),F.innerHTML='<svg class="svelte-kwj5pq"><use xlink:href="#iconTrashcan"></use></svg>',L=y(),j=d("button"),B=Re("svg"),q=Re("use"),C=y(),P=ce($),x=y(),D=d("button"),O=Re("svg"),u=Re("use"),M=y(),N=ce(H),Z=y(),ee&&ee.c(),r(i,"class","chevron svelte-kwj5pq"),b(m,"font-weight","600"),b(m,"font-size","15px"),b(m,"color","var(--b3-theme-on-surface)"),r(a,"class","fn__flex-1 svelte-kwj5pq"),b(a,"margin-left","14px"),b(a,"display","flex"),b(a,"align-items","center"),r(w,"class","switch-input svelte-kwj5pq"),r(w,"type","checkbox"),r(T,"class","switch-track svelte-kwj5pq"),r(h,"class","switch-container svelte-kwj5pq"),r(h,"title",A=t[98].enabled?I("enabled"):I("disabled")),r(g,"class","fn__flex-center"),b(g,"margin-right","20px"),r(F,"class","icon-btn svelte-kwj5pq"),r(F,"title",I("deleteRule")),at(q,"xlink:href","#iconUndo"),b(B,"width","12px"),b(B,"height","12px"),r(B,"class","svelte-kwj5pq"),r(j,"class","action-btn svelte-kwj5pq"),b(j,"height","28px"),b(j,"padding","0 12px"),b(j,"margin-right","8px"),b(j,"background-color","transparent"),b(j,"color","var(--b3-theme-on-surface)"),b(j,"box-shadow","none"),b(j,"border","1px solid var(--b3-theme-surface-lighter)"),at(u,"xlink:href","#iconFiles"),b(O,"width","12px"),b(O,"height","12px"),r(O,"class","svelte-kwj5pq"),r(D,"class","action-btn svelte-kwj5pq"),b(D,"height","28px"),b(D,"padding","0 12px"),b(D,"margin-right","8px"),r(l,"class","card-header svelte-kwj5pq"),r(n,"class","card svelte-kwj5pq"),b(n,"opacity",t[98].enabled?1:.75),tt(n,"expanded",t[3]===t[98].id),this.first=n},m(me,J){ue(me,n,J),s(n,l),s(l,i),s(l,o),s(l,a),s(a,m),s(m,p),s(a,c),U&&U.m(a,null),s(l,k),s(l,g),s(g,h),s(h,w),w.checked=t[98].enabled,s(h,v),s(h,T),s(l,Q),s(l,F),s(l,L),s(l,j),s(j,B),s(B,q),s(j,C),s(j,P),s(l,x),s(l,D),s(D,O),s(O,u),s(D,M),s(D,N),s(n,Z),ee&&ee.m(n,null),ge||(je=[R(w,"change",de),R(w,"change",t[13]),R(g,"click",et(t[30])),R(F,"click",et(z)),R(j,"click",et(t[34])),R(D,"click",et(fe)),R(l,"click",ke)],ge=!0)},p(me,J){t=me,J[0]&2&&_!==(_=(t[98].name||I("unnamedRule"))+"")&&st(p,_),t[98].keyword?U?U.p(t,J):(U=en(t),U.c(),U.m(a,null)):U&&(U.d(1),U=null),J[0]&2&&(w.checked=t[98].enabled),J[0]&2&&A!==(A=t[98].enabled?I("enabled"):I("disabled"))&&r(h,"title",A),t[3]===t[98].id?ee?ee.p(t,J):(ee=tn(t),ee.c(),ee.m(n,null)):ee&&(ee.d(1),ee=null),J[0]&2&&b(n,"opacity",t[98].enabled?1:.75),J[0]&10&&tt(n,"expanded",t[3]===t[98].id)},d(me){me&&re(n),U&&U.d(),ee&&ee.d(),ge=!1,Pe(je)}}}function rn(e){let t;return{c(){t=d("div"),t.textContent=`${I("noRulesTip")}`,b(t,"text-align","center"),b(t,"padding","48px"),b(t,"color","var(--b3-theme-on-surface-light)"),b(t,"border","2px dashed var(--b3-border-color)"),b(t,"border-radius","16px")},m(n,l){ue(n,t,l)},d(n){n&&re(t)}}}function un(e){let t,n,l,i,o,a,m,_,p,c,k,g,h,w,v,T,A,Q,F,L,j,B,q,C,$,P,x,D,O,u,M,H,N,Z,ge,je,U,de,z,fe,ke,ee,me,J,Ae,Y,V,X,se,oe,le,qe,Ue,ze,Se,He,be,we,Oe,Ce,nt,Me=[],lt=new Map,Ye,De,$e,Xe,ye;function ve(){e[57].call(o,e[82],e[83])}function _e(){e[58].call(c,e[82],e[83])}let ie=Te(e[1]),ne=[];for(let W=0;W<ie.length;W+=1)ne[W]=dn(Gt(e,ie,W));let te=e[1].length===0&&fn(),Ke=Te(e[6]),Ie=[];for(let W=0;W<Ke.length;W+=1)Ie[W]=pn(Xt(e,Ke,W));function ut(){e[60].call(P,e[82],e[83])}function f(){e[61].call(H,e[82],e[83])}function S(){e[62].call(de,e[82],e[83])}function he(){e[63].call(V,e[82],e[83])}function Fe(){e[64].call(Se,e[82],e[83])}function dt(W,ae){return(W[7][W[81].id]||[]).length===0?sl:il}let Ge=dt(e),Ne=Ge(e),ot=Te(e[81].sections);const wt=W=>W[84].id;for(let W=0;W<ot.length;W+=1){let ae=xt(e,ot,W),E=wt(ae);lt.set(E,Me[W]=gn(E,ae))}function Ee(){return e[68](e[81])}return{c(){t=d("div"),n=d("div"),l=d("div"),l.textContent=`${I("templateNameLabel")}`,i=y(),o=d("input"),a=y(),m=d("div"),_=d("div"),_.textContent=`${I("templatePeriodLabel")}`,p=y(),c=d("select"),k=d("option"),k.textContent=`${I("templatePeriod_none")}`,g=d("option"),g.textContent=`${I("templatePeriod_day")}`,h=d("option"),h.textContent=`${I("templatePeriod_week")}`,w=d("option"),w.textContent=`${I("templatePeriod_month")}`,v=d("option"),v.textContent=`${I("templatePeriod_year")}`,T=y(),A=d("div"),Q=d("div"),Q.textContent=`${I("templateRuleLabel")}`,F=y(),L=d("div");for(let W=0;W<ne.length;W+=1)ne[W].c();j=y(),te&&te.c(),B=y(),q=d("div"),C=d("div"),C.textContent=`${I("templateNotebookLabel")}`,$=y(),P=d("select"),x=d("option"),x.textContent=`${I("templateNotebookAuto")}`;for(let W=0;W<Ie.length;W+=1)Ie[W].c();D=y(),O=d("div"),u=d("div"),u.textContent=`${I("templatePathLabel")}`,M=y(),H=d("input"),N=y(),Z=d("div"),ge=d("div"),ge.textContent=`${I("templateAppendMode")}`,je=y(),U=d("label"),de=d("input"),z=y(),fe=d("span"),fe.innerHTML='<span class="switch-thumb svelte-kwj5pq"></span>',ee=y(),me=d("div"),J=d("div"),J.textContent=`${I("reportClipboardOnlySections")}`,Ae=y(),Y=d("label"),V=d("input"),X=y(),se=d("span"),se.innerHTML='<span class="switch-thumb svelte-kwj5pq"></span>',le=y(),qe=d("div"),Ue=d("div"),Ue.textContent=`${I("templateTitleLabel")}`,ze=y(),Se=d("input"),He=y(),be=d("div"),we=d("div"),we.textContent=`${I("templateSectionList")}`,Oe=y(),Ce=d("div"),Ne.c(),nt=y();for(let W=0;W<Me.length;W+=1)Me[W].c();Ye=y(),De=d("div"),$e=d("button"),$e.textContent=`${I("templateSectionAdd")}`,r(l,"class","input-label svelte-kwj5pq"),r(o,"class","modern-input svelte-kwj5pq"),r(o,"type","text"),r(n,"class","input-group svelte-kwj5pq"),r(_,"class","input-label svelte-kwj5pq"),k.__value="none",G(k,k.__value),g.__value="day",G(g,g.__value),h.__value="week",G(h,h.__value),w.__value="month",G(w,w.__value),v.__value="year",G(v,v.__value),r(c,"class","modern-input svelte-kwj5pq"),e[81].period===void 0&&pt(_e),r(m,"class","input-group svelte-kwj5pq"),r(Q,"class","input-label svelte-kwj5pq"),r(L,"class","fn__flex svelte-kwj5pq"),b(L,"flex-wrap","wrap"),b(L,"gap","12px"),r(A,"class","input-group svelte-kwj5pq"),r(C,"class","input-label svelte-kwj5pq"),x.__value="",G(x,x.__value),r(P,"class","modern-input svelte-kwj5pq"),e[81].notebookId===void 0&&pt(ut),r(q,"class","input-group svelte-kwj5pq"),r(u,"class","input-label svelte-kwj5pq"),r(H,"class","modern-input svelte-kwj5pq"),r(H,"type","text"),r(H,"placeholder",I("templatePathPlaceholder")),r(O,"class","input-group svelte-kwj5pq"),r(ge,"class","input-label svelte-kwj5pq"),r(de,"class","switch-input svelte-kwj5pq"),r(de,"type","checkbox"),r(fe,"class","switch-track svelte-kwj5pq"),r(U,"class","switch-container svelte-kwj5pq"),r(U,"title",ke=e[81].appendMode?I("enabled"):I("disabled")),r(Z,"class","input-group svelte-kwj5pq"),r(J,"class","input-label svelte-kwj5pq"),r(V,"class","switch-input svelte-kwj5pq"),r(V,"type","checkbox"),r(se,"class","switch-track svelte-kwj5pq"),r(Y,"class","switch-container svelte-kwj5pq"),r(Y,"title",oe=e[81].clipboardOnlySections?I("enabled"):I("disabled")),r(me,"class","input-group svelte-kwj5pq"),r(Ue,"class","input-label svelte-kwj5pq"),r(Se,"class","modern-input svelte-kwj5pq"),r(Se,"type","text"),r(Se,"placeholder",I("templateTitlePlaceholder")),r(qe,"class","input-group svelte-kwj5pq"),r(we,"class","input-label svelte-kwj5pq"),r(Ce,"class","fn__flex svelte-kwj5pq"),b(Ce,"flex-wrap","wrap"),b(Ce,"gap","8px"),b(Ce,"margin-bottom","8px"),r($e,"class","action-btn svelte-kwj5pq"),b($e,"width","132px"),b($e,"justify-content","center"),r(De,"class","fn__flex svelte-kwj5pq"),b(De,"justify-content","flex-start"),r(be,"class","input-group svelte-kwj5pq"),r(t,"class","card-content svelte-kwj5pq")},m(W,ae){ue(W,t,ae),s(t,n),s(n,l),s(n,i),s(n,o),G(o,e[81].name),s(t,a),s(t,m),s(m,_),s(m,p),s(m,c),s(c,k),s(c,g),s(c,h),s(c,w),s(c,v),ct(c,e[81].period,!0),s(t,T),s(t,A),s(A,Q),s(A,F),s(A,L);for(let E=0;E<ne.length;E+=1)ne[E]&&ne[E].m(L,null);s(L,j),te&&te.m(L,null),s(t,B),s(t,q),s(q,C),s(q,$),s(q,P),s(P,x);for(let E=0;E<Ie.length;E+=1)Ie[E]&&Ie[E].m(P,null);ct(P,e[81].notebookId,!0),s(t,D),s(t,O),s(O,u),s(O,M),s(O,H),G(H,e[81].pathTemplate),s(t,N),s(t,Z),s(Z,ge),s(Z,je),s(Z,U),s(U,de),de.checked=e[81].appendMode,s(U,z),s(U,fe),s(t,ee),s(t,me),s(me,J),s(me,Ae),s(me,Y),s(Y,V),V.checked=e[81].clipboardOnlySections,s(Y,X),s(Y,se),s(t,le),s(t,qe),s(qe,Ue),s(qe,ze),s(qe,Se),G(Se,e[81].titleTemplate),s(t,He),s(t,be),s(be,we),s(be,Oe),s(be,Ce),Ne.m(Ce,null),s(be,nt);for(let E=0;E<Me.length;E+=1)Me[E]&&Me[E].m(be,null);s(be,Ye),s(be,De),s(De,$e),Xe||(ye=[R(o,"input",ve),R(o,"change",e[13]),R(c,"change",_e),R(c,"change",e[13]),R(P,"change",ut),R(P,"change",e[13]),R(H,"input",f),R(H,"change",e[13]),R(de,"change",S),R(de,"change",e[13]),R(V,"change",he),R(V,"change",e[13]),R(Se,"input",Fe),R(Se,"change",e[13]),R($e,"click",Ee)],Xe=!0)},p(W,ae){if(e=W,ae[0]&16&&o.value!==e[81].name&&G(o,e[81].name),ae[0]&16&&ct(c,e[81].period),ae[0]&33554450){ie=Te(e[1]);let E;for(E=0;E<ie.length;E+=1){const Je=Gt(e,ie,E);ne[E]?ne[E].p(Je,ae):(ne[E]=dn(Je),ne[E].c(),ne[E].m(L,j))}for(;E<ne.length;E+=1)ne[E].d(1);ne.length=ie.length}if(e[1].length===0?te||(te=fn(),te.c(),te.m(L,null)):te&&(te.d(1),te=null),ae[0]&64){Ke=Te(e[6]);let E;for(E=0;E<Ke.length;E+=1){const Je=Xt(e,Ke,E);Ie[E]?Ie[E].p(Je,ae):(Ie[E]=pn(Je),Ie[E].c(),Ie[E].m(P,null))}for(;E<Ie.length;E+=1)Ie[E].d(1);Ie.length=Ke.length}ae[0]&16&&ct(P,e[81].notebookId),ae[0]&16&&H.value!==e[81].pathTemplate&&G(H,e[81].pathTemplate),ae[0]&16&&(de.checked=e[81].appendMode),ae[0]&16&&ke!==(ke=e[81].appendMode?I("enabled"):I("disabled"))&&r(U,"title",ke),ae[0]&16&&(V.checked=e[81].clipboardOnlySections),ae[0]&16&&oe!==(oe=e[81].clipboardOnlySections?I("enabled"):I("disabled"))&&r(Y,"title",oe),ae[0]&16&&Se.value!==e[81].titleTemplate&&G(Se,e[81].titleTemplate),Ge===(Ge=dt(e))&&Ne?Ne.p(e,ae):(Ne.d(1),Ne=Ge(e),Ne&&(Ne.c(),Ne.m(Ce,null))),ae[0]&402661520&&(ot=Te(e[81].sections),Me=Nt(Me,ae,wt,1,e,ot,lt,be,Mt,gn,Ye,xt))},d(W){W&&re(t),ft(ne,W),te&&te.d(),ft(Ie,W),Ne.d();for(let ae=0;ae<Me.length;ae+=1)Me[ae].d();Xe=!1,Pe(ye)}}}function dn(e){let t,n,l,i,o,a=(e[95].name||e[95].keyword||e[95].id)+"",m,_,p;function c(){return e[59](e[81],e[95])}return{c(){var k;t=d("label"),n=d("input"),i=y(),o=d("span"),m=ce(a),r(n,"type","checkbox"),n.checked=l=(k=e[81].ruleIds)==null?void 0:k.includes(e[95].id),b(o,"font-size","13px"),r(t,"class","fn__flex svelte-kwj5pq"),b(t,"align-items","center"),b(t,"gap","6px"),b(t,"padding","6px 10px"),b(t,"border","1px solid var(--b3-border-color)"),b(t,"border-radius","999px"),b(t,"background","var(--b3-theme-background)")},m(k,g){ue(k,t,g),s(t,n),s(t,i),s(t,o),s(o,m),_||(p=R(n,"change",c),_=!0)},p(k,g){var h;e=k,g[0]&18&&l!==(l=(h=e[81].ruleIds)==null?void 0:h.includes(e[95].id))&&(n.checked=l),g[0]&2&&a!==(a=(e[95].name||e[95].keyword||e[95].id)+"")&&st(m,a)},d(k){k&&re(t),_=!1,p()}}}function fn(e){let t;return{c(){t=d("div"),t.textContent=`${I("reportNoProfileTip")}`,b(t,"font-size","13px"),b(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){ue(n,t,l)},d(n){n&&re(t)}}}function pn(e){let t,n=e[92].name+"",l,i;return{c(){t=d("option"),l=ce(n),t.__value=i=e[92].id,G(t,t.__value)},m(o,a){ue(o,t,a),s(t,l)},p(o,a){a[0]&64&&n!==(n=o[92].name+"")&&st(l,n),a[0]&64&&i!==(i=o[92].id)&&(t.__value=i,G(t,t.__value))},d(o){o&&re(t)}}}function il(e){let t,n=Te(e[7][e[81].id]),l=[];for(let i=0;i<n.length;i+=1)l[i]=hn(Yt(e,n,i));return{c(){for(let i=0;i<l.length;i+=1)l[i].c();t=Dn()},m(i,o){for(let a=0;a<l.length;a+=1)l[a]&&l[a].m(i,o);ue(i,t,o)},p(i,o){if(o[0]&144){n=Te(i[7][i[81].id]);let a;for(a=0;a<n.length;a+=1){const m=Yt(i,n,a);l[a]?l[a].p(m,o):(l[a]=hn(m),l[a].c(),l[a].m(t.parentNode,t))}for(;a<l.length;a+=1)l[a].d(1);l.length=n.length}},d(i){i&&re(t),ft(l,i)}}}function sl(e){let t;return{c(){t=d("div"),t.textContent=`${I("templateStatusEmpty")}`,b(t,"font-size","13px"),b(t,"color","var(--b3-theme-on-surface-light)")},m(n,l){ue(n,t,l)},p:Ve,d(n){n&&re(t)}}}function hn(e){let t,n=e[87]+"",l;return{c(){t=d("span"),l=ce(n),r(t,"class","tag-preview svelte-kwj5pq")},m(i,o){ue(i,t,o),s(t,l)},p(i,o){o[0]&144&&n!==(n=i[87]+"")&&st(l,n)},d(i){i&&re(t)}}}function mn(e){let t,n,l,i,o,a=e[87]+"",m,_,p,c;function k(){return e[66](e[84],e[87])}return{c(){t=d("label"),n=d("input"),i=y(),o=d("span"),m=ce(a),_=y(),r(n,"class","dot-check svelte-kwj5pq"),r(n,"type","checkbox"),n.checked=l=(e[84].statuses||[]).includes(e[87]),b(o,"font-size","12px"),r(t,"class","fn__flex status-dot svelte-kwj5pq"),b(t,"align-items","center"),b(t,"gap","6px"),b(t,"padding","4px 8px"),b(t,"border","1px solid var(--b3-border-color)"),b(t,"border-radius","999px"),b(t,"background","var(--b3-theme-background)")},m(g,h){ue(g,t,h),s(t,n),s(t,i),s(t,o),s(o,m),s(t,_),p||(c=R(n,"change",k),p=!0)},p(g,h){e=g,h[0]&144&&l!==(l=(e[84].statuses||[]).includes(e[87]))&&(n.checked=l),h[0]&144&&a!==(a=e[87]+"")&&st(m,a)},d(g){g&&re(t),p=!1,c()}}}function gn(e,t){let n,l,i,o,a,m,_,p,c,k,g,h,w,v,T,A;function Q(){t[65].call(m,t[85],t[86])}let F=Te(t[7][t[81].id]||[]),L=[];for(let B=0;B<F.length;B+=1)L[B]=mn(zt(t,F,B));function j(){return t[67](t[81],t[84])}return{key:e,first:null,c(){n=d("div"),l=d("div"),i=d("div"),o=d("div"),o.textContent=`${I("templateSectionTitleLabel")}`,a=y(),m=d("input"),_=y(),p=d("div"),c=d("div"),c.textContent=`${I("templateSectionStatusLabel")}`,k=y(),g=d("div");for(let B=0;B<L.length;B+=1)L[B].c();h=y(),w=d("div"),v=d("div"),v.innerHTML='<svg class="svelte-kwj5pq"><use xlink:href="#iconTrashcan"></use></svg>',r(o,"class","input-label svelte-kwj5pq"),r(m,"class","modern-input svelte-kwj5pq"),r(m,"type","text"),r(i,"class","input-group svelte-kwj5pq"),r(c,"class","input-label svelte-kwj5pq"),r(g,"class","fn__flex svelte-kwj5pq"),b(g,"flex-wrap","wrap"),b(g,"gap","10px"),r(p,"class","input-group svelte-kwj5pq"),r(v,"class","icon-btn svelte-kwj5pq"),r(v,"title",I("templateSectionDelete")),r(w,"class","fn__flex svelte-kwj5pq"),b(w,"justify-content","flex-end"),r(l,"class","card-content svelte-kwj5pq"),r(n,"class","card svelte-kwj5pq"),b(n,"margin-bottom","12px"),this.first=n},m(B,q){ue(B,n,q),s(n,l),s(l,i),s(i,o),s(i,a),s(i,m),G(m,t[84].title),s(l,_),s(l,p),s(p,c),s(p,k),s(p,g);for(let C=0;C<L.length;C+=1)L[C]&&L[C].m(g,null);s(l,h),s(l,w),s(w,v),T||(A=[R(m,"input",Q),R(m,"change",t[13]),R(v,"click",j)],T=!0)},p(B,q){if(t=B,q[0]&16&&m.value!==t[84].title&&G(m,t[84].title),q[0]&268435600){F=Te(t[7][t[81].id]||[]);let C;for(C=0;C<F.length;C+=1){const $=zt(t,F,C);L[C]?L[C].p($,q):(L[C]=mn($),L[C].c(),L[C].m(g,null))}for(;C<L.length;C+=1)L[C].d(1);L.length=F.length}},d(B){B&&re(n),ft(L,B),T=!1,Pe(A)}}}function kn(e,t){let n,l,i,o,a,m,_=t[81].name+"",p,c,k,g=I(`templatePeriod_${t[81].period||"none"}`)+"",h,w,v,T,A,Q,F,L,j;function B(){return t[54](t[81])}function q(){return t[55](t[81])}function C(){return t[56](t[81])}let $=t[5]===t[81].id&&un(t);return{key:e,first:null,c(){n=d("div"),l=d("div"),i=d("div"),i.innerHTML='<svg style="width:12px;height:12px"><use xlink:href="#iconRight"></use></svg>',o=y(),a=d("div"),m=d("span"),p=ce(_),c=y(),k=d("span"),h=ce(g),w=y(),v=d("button"),v.textContent=`${I("templateGenerate")}`,T=y(),A=d("div"),A.innerHTML='<svg class="svelte-kwj5pq"><use xlink:href="#iconTrashcan"></use></svg>',Q=y(),$&&$.c(),F=y(),r(i,"class","chevron svelte-kwj5pq"),b(m,"font-weight","600"),b(m,"font-size","15px"),b(m,"color","var(--b3-theme-on-surface)"),r(k,"class","tag-preview svelte-kwj5pq"),r(a,"class","fn__flex-1 svelte-kwj5pq"),b(a,"margin-left","14px"),b(a,"display","flex"),b(a,"align-items","center"),r(v,"class","action-btn svelte-kwj5pq"),b(v,"height","28px"),b(v,"padding","0 12px"),b(v,"margin-right","8px"),r(A,"class","icon-btn svelte-kwj5pq"),r(A,"title",I("deleteRule")),r(l,"class","card-header svelte-kwj5pq"),r(n,"class","card svelte-kwj5pq"),tt(n,"expanded",t[5]===t[81].id),this.first=n},m(P,x){ue(P,n,x),s(n,l),s(l,i),s(l,o),s(l,a),s(a,m),s(m,p),s(a,c),s(a,k),s(k,h),s(l,w),s(l,v),s(l,T),s(l,A),s(n,Q),$&&$.m(n,null),s(n,F),L||(j=[R(v,"click",et(B)),R(A,"click",et(q)),R(l,"click",C)],L=!0)},p(P,x){t=P,x[0]&16&&_!==(_=t[81].name+"")&&st(p,_),x[0]&16&&g!==(g=I(`templatePeriod_${t[81].period||"none"}`)+"")&&st(h,g),t[5]===t[81].id?$?$.p(t,x):($=un(t),$.c(),$.m(n,F)):$&&($.d(1),$=null),x[0]&48&&tt(n,"expanded",t[5]===t[81].id)},d(P){P&&re(n),$&&$.d(),L=!1,Pe(j)}}}function _n(e){let t,n,l,i,o,a,m,_,p=Te(e[10]),c=[];for(let h=0;h<p.length;h+=1)c[h]=vn(Ht(e,p,h));let k=Te(e[11]),g=[];for(let h=0;h<k.length;h+=1)g[h]=bn(Wt(e,k,h));return{c(){t=d("div"),n=d("div");for(let h=0;h<c.length;h+=1)c[h].c();l=y(),i=d("div"),o=y(),a=d("div");for(let h=0;h<g.length;h+=1)g[h].c();r(n,"class","time-col svelte-kwj5pq"),b(i,"width","1px"),b(i,"background","var(--b3-theme-surface-lighter)"),r(a,"class","time-col svelte-kwj5pq"),r(t,"class","time-picker-popover svelte-kwj5pq"),r(t,"style",e[8])},m(h,w){ue(h,t,w),s(t,n);for(let v=0;v<c.length;v+=1)c[v]&&c[v].m(n,null);s(t,l),s(t,i),s(t,o),s(t,a);for(let v=0;v<g.length;v+=1)g[v]&&g[v].m(a,null);m||(_=R(t,"click",et(e[29])),m=!0)},p(h,w){if(w[0]&263680){p=Te(h[10]);let v;for(v=0;v<p.length;v+=1){const T=Ht(h,p,v);c[v]?c[v].p(T,w):(c[v]=vn(T),c[v].c(),c[v].m(n,null))}for(;v<c.length;v+=1)c[v].d(1);c.length=p.length}if(w[0]&526848){k=Te(h[11]);let v;for(v=0;v<k.length;v+=1){const T=Wt(h,k,v);g[v]?g[v].p(T,w):(g[v]=bn(T),g[v].c(),g[v].m(a,null))}for(;v<g.length;v+=1)g[v].d(1);g.length=k.length}w[0]&256&&r(t,"style",h[8])},d(h){h&&re(t),ft(c,h),ft(g,h),m=!1,_()}}}function vn(e){let t,n=e[78]+"",l,i,o,a,m;function _(){return e[69](e[78])}return{c(){t=d("div"),l=ce(n),i=y(),r(t,"id",o=`time-opt-h-${e[78]}-${e[9].id}`),r(t,"class","time-opt svelte-kwj5pq"),tt(t,"selected",it(e[9]).startsWith(e[78]))},m(p,c){ue(p,t,c),s(t,l),s(t,i),a||(m=R(t,"click",et(_)),a=!0)},p(p,c){e=p,c[0]&512&&o!==(o=`time-opt-h-${e[78]}-${e[9].id}`)&&r(t,"id",o),c[0]&1536&&tt(t,"selected",it(e[9]).startsWith(e[78]))},d(p){p&&re(t),a=!1,m()}}}function bn(e){let t,n=e[75]+"",l,i,o,a,m;function _(){return e[70](e[75])}return{c(){t=d("div"),l=ce(n),i=y(),r(t,"id",o=`time-opt-m-${e[75]}-${e[9].id}`),r(t,"class","time-opt svelte-kwj5pq"),tt(t,"selected",it(e[9]).endsWith(e[75]))},m(p,c){ue(p,t,c),s(t,l),s(t,i),a||(m=R(t,"click",et(_)),a=!0)},p(p,c){e=p,c[0]&512&&o!==(o=`time-opt-m-${e[75]}-${e[9].id}`)&&r(t,"id",o),c[0]&2560&&tt(t,"selected",it(e[9]).endsWith(e[75]))},d(p){p&&re(t),a=!1,m()}}}function ol(e){let t,n,l,i,o,a,m,_,p,c,k=I("archiveRuleList")+"",g,h,w,v,T,A,Q,F,L=I("addRule")+"",j,B,q,C=[],$=new Map,P,x,D,O,u,M,H,N,Z=I("templateListTitle")+"",ge,je,U,de,z,fe,ke,ee,me=I("templateAdd")+"",J,Ae,Y,V=[],X=new Map,se,oe,le,qe,Ue,ze,Se=I("usageTipTitle")+"",He,be,we,Oe,Ce,nt,Me=I("usageTipGlobalDesc")+"",lt,Ye,De,$e,Xe,ye=I("usageTipMatchDesc")+"",ve,_e,ie,ne,te,Ke=I("usageTipStatusDesc")+"",Ie,ut,f,S,he,Fe=I("usageTipReportDesc")+"",dt,Ge,Ne,ot,wt,Ee=e[2]&&Zt(e),W=Te(e[1]);const ae=K=>K[98].id;for(let K=0;K<W.length;K+=1){let pe=Jt(e,W,K),Le=ae(pe);$.set(Le,C[K]=cn(Le,pe))}let E=e[1].length===0&&rn(),Je=Te(e[4]);const Bt=K=>K[81].id;for(let K=0;K<Je.length;K+=1){let pe=Vt(e,Je,K),Le=Bt(pe);X.set(Le,V[K]=kn(Le,pe))}let Be=e[2]&&e[9]&&_n(e);return{c(){Ee&&Ee.c(),t=y(),n=d("div"),l=d("div"),l.innerHTML='<div class="fn__flex-1 svelte-kwj5pq"></div>',i=y(),o=d("div"),a=d("div"),m=d("div"),_=Re("svg"),p=Re("use"),c=y(),g=ce(k),h=y(),w=d("div"),v=y(),T=d("button"),A=Re("svg"),Q=Re("use"),F=y(),j=ce(L),B=y(),q=d("div");for(let K=0;K<C.length;K+=1)C[K].c();P=y(),E&&E.c(),x=y(),D=d("div"),O=d("div"),u=d("div"),M=Re("svg"),H=Re("use"),N=y(),ge=ce(Z),je=y(),U=d("div"),de=y(),z=d("button"),fe=Re("svg"),ke=Re("use"),ee=y(),J=ce(me),Ae=y(),Y=d("div");for(let K=0;K<V.length;K+=1)V[K].c();se=y(),oe=d("div"),le=d("div"),qe=Re("svg"),Ue=Re("use"),ze=y(),He=ce(Se),be=y(),we=d("ul"),Oe=d("li"),Ce=d("strong"),Ce.textContent=`${I("usageTipGlobal")}`,nt=ce("："),lt=ce(Me),Ye=y(),De=d("li"),$e=d("strong"),$e.textContent=`${I("usageTipMatch")}`,Xe=ce("："),ve=ce(ye),_e=y(),ie=d("li"),ne=d("strong"),ne.textContent=`${I("usageTipStatus")}`,te=ce("："),Ie=ce(Ke),ut=y(),f=d("li"),S=d("strong"),S.textContent=`${I("usageTipReport")}`,he=ce("："),dt=ce(Fe),Ge=y(),Be&&Be.c(),Ne=Dn(),r(l,"class","section-header svelte-kwj5pq"),at(p,"xlink:href","#iconSettings"),b(_,"width","18px"),b(_,"height","18px"),r(m,"class","section-title svelte-kwj5pq"),r(w,"class","fn__flex-1 svelte-kwj5pq"),at(Q,"xlink:href","#iconAdd"),b(A,"width","14px"),b(A,"height","14px"),r(A,"class","svelte-kwj5pq"),r(T,"class","action-btn svelte-kwj5pq"),r(a,"class","section-header svelte-kwj5pq"),r(q,"class","profile-container svelte-kwj5pq"),b(o,"margin-top","20px"),b(o,"display","flex"),b(o,"flex-direction","column"),at(H,"xlink:href","#iconCalendar"),b(M,"width","18px"),b(M,"height","18px"),r(u,"class","section-title svelte-kwj5pq"),r(U,"class","fn__flex-1 svelte-kwj5pq"),at(ke,"xlink:href","#iconAdd"),b(fe,"width","14px"),b(fe,"height","14px"),r(fe,"class","svelte-kwj5pq"),r(z,"class","action-btn svelte-kwj5pq"),b(z,"width","132px"),b(z,"justify-content","center"),r(O,"class","section-header svelte-kwj5pq"),r(Y,"class","profile-container svelte-kwj5pq"),b(D,"margin-top","24px"),b(D,"display","flex"),b(D,"flex-direction","column"),at(Ue,"xlink:href","#iconInfo"),b(qe,"width","16px"),b(qe,"height","16px"),b(le,"font-weight","700"),b(le,"color","var(--b3-theme-primary)"),b(le,"display","flex"),b(le,"align-items","center"),b(le,"gap","8px"),b(le,"margin-bottom","8px"),b(le,"font-size","14px"),r(Oe,"class","svelte-kwj5pq"),r(De,"class","svelte-kwj5pq"),r(ie,"class","svelte-kwj5pq"),r(f,"class","svelte-kwj5pq"),r(we,"class","svelte-kwj5pq"),r(oe,"class","info-footer svelte-kwj5pq"),r(n,"class","settings-container svelte-kwj5pq")},m(K,pe){Ee&&Ee.m(K,pe),ue(K,t,pe),ue(K,n,pe),s(n,l),s(n,i),s(n,o),s(o,a),s(a,m),s(m,_),s(_,p),s(m,c),s(m,g),s(a,h),s(a,w),s(a,v),s(a,T),s(T,A),s(A,Q),s(T,F),s(T,j),s(o,B),s(o,q);for(let Le=0;Le<C.length;Le+=1)C[Le]&&C[Le].m(q,null);s(q,P),E&&E.m(q,null),s(n,x),s(n,D),s(D,O),s(O,u),s(u,M),s(M,H),s(u,N),s(u,ge),s(O,je),s(O,U),s(O,de),s(O,z),s(z,fe),s(fe,ke),s(z,ee),s(z,J),s(D,Ae),s(D,Y);for(let Le=0;Le<V.length;Le+=1)V[Le]&&V[Le].m(Y,null);s(n,se),s(n,oe),s(oe,le),s(le,qe),s(qe,Ue),s(le,ze),s(le,He),s(oe,be),s(oe,we),s(we,Oe),s(Oe,Ce),s(Oe,nt),s(Oe,lt),s(we,Ye),s(we,De),s(De,$e),s(De,Xe),s(De,ve),s(we,_e),s(we,ie),s(ie,ne),s(ie,te),s(ie,Ie),s(we,ut),s(we,f),s(f,S),s(f,he),s(f,dt),ue(K,Ge,pe),Be&&Be.m(K,pe),ue(K,Ne,pe),ot||(wt=[R(T,"click",e[14]),R(z,"click",e[22])],ot=!0)},p(K,pe){K[2]?Ee?Ee.p(K,pe):(Ee=Zt(K),Ee.c(),Ee.m(t.parentNode,t)):Ee&&(Ee.d(1),Ee=null),pe[0]&1290255&&(W=Te(K[1]),C=Nt(C,pe,ae,1,K,W,$,q,Mt,cn,P,Jt)),K[1].length===0?E||(E=rn(),E.c(),E.m(q,null)):E&&(E.d(1),E=null),pe[0]&530587890&&(Je=Te(K[4]),V=Nt(V,pe,Bt,1,K,Je,X,Y,Mt,kn,null,Vt)),K[2]&&K[9]?Be?Be.p(K,pe):(Be=_n(K),Be.c(),Be.m(Ne.parentNode,Ne)):Be&&(Be.d(1),Be=null)},i:Ve,o:Ve,d(K){K&&(re(t),re(n),re(Ge),re(Ne)),Ee&&Ee.d(K);for(let pe=0;pe<C.length;pe+=1)C[pe].d();E&&E.d();for(let pe=0;pe<V.length;pe+=1)V[pe].d();Be&&Be.d(K),ot=!1,Pe(wt)}}}function mt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function Et(e){return e.schedule||(e.schedule={enabled:!0,mode:"daily",time:"00:00",weekday:1,monthday:1,month:1,nextRunAt:0}),e.schedule}function it(e){return Et(e).time||"00:00"}function wn(e,t,n){const l=`time-opt-${e}-${t}-${n}`,i=document.getElementById(l);i&&i.scrollIntoView({block:"center",behavior:"smooth"})}function al(e,t,n){let{plugin:l}=t,i=[],o=null,a=[],m=null,_=[],p={},c=null,k="",g=null;const h=Array.from({length:24},(f,S)=>S.toString().padStart(2,"0")),w=Array.from({length:60},(f,S)=>S.toString().padStart(2,"0")),v=[{value:1,label:"Mon"},{value:2,label:"Tue"},{value:3,label:"Wed"},{value:4,label:"Thu"},{value:5,label:"Fri"},{value:6,label:"Sat"},{value:7,label:"Sun"}];xn(()=>{T(),l.config.profiles&&l.config.profiles.length===1&&n(3,o=l.config.profiles[0].id),P()});function T(){n(1,i=l.config.profiles||[]),i.forEach(f=>Et(f)),n(4,a=l.config.templates||[])}async function A(){n(0,l.config.templates=a,l),l.saveData("config.json",l.config),T()}function Q(){l.config.profiles||n(0,l.config.profiles=[],l);const f={id:mt(),name:I("defaultNewRuleName")+" "+(l.config.profiles.length+1),keyword:"",completedStatus:I("defaultCompleted"),archivedStatus:I("defaultArchived"),enabled:!0};n(0,l.config.profiles=[...l.config.profiles,f],l),A(),n(3,o=f.id),setTimeout(()=>{const S=document.querySelector(".profile-container");S&&(S.scrollTop=S.scrollHeight)},50)}function F(f){n(0,l.config.profiles=l.config.profiles.filter(S=>S.id!==f),l),A(),o===f&&n(3,o=null)}function L(f){o===f?n(3,o=null):n(3,o=f)}function j(f,S,he){const Fe=Et(f);Fe[S]=he,Fe.nextRunAt=0,A()}function B(f,S){const he=it(f).split(":");j(f,"time",`${S}:${he[1]||"00"}`)}function q(f,S){const he=it(f).split(":");j(f,"time",`${he[0]||"00"}:${S}`)}function C(f,S){if(n(2,c=c===f?null:f),c&&(S!=null&&S.currentTarget)){const he=S.currentTarget.getBoundingClientRect();n(8,k=`position: fixed; top: ${he.bottom+8}px; left: ${he.left}px;`),setTimeout(()=>{const[Fe,dt]=it(i.find(Ge=>Ge.id===f)||{schedule:{time:"00:00"}}).split(":");wn("h",Fe,f),wn("m",dt,f)},10)}}function $(f){l.generateTemplate&&l.generateTemplate(f)}async function P(){if(!l.getNotebooks)return;const f=await l.getNotebooks();n(6,_=(f==null?void 0:f.notebooks)||[])}function x(){const f={id:mt(),name:I("templateNewName"),period:"day",ruleIds:[],notebookId:"",pathTemplate:"",appendMode:!1,clipboardOnlySections:!1,titleTemplate:I("templateTitleDefault"),sections:[{id:mt(),title:I("templateSectionTodo"),statuses:[]},{id:mt(),title:I("templateSectionDoing"),statuses:[]},{id:mt(),title:I("templateSectionDone"),statuses:[]}]};n(4,a=[...a,f]),A(),n(5,m=f.id)}function D(f){n(4,a=a.filter(S=>S.id!==f)),A(),m===f&&n(5,m=null)}function O(f){if(m===f)n(5,m=null);else{n(5,m=f);const S=a.find(he=>he.id===f);S&&M(S)}}function u(f,S){const he=f.ruleIds||[];f.ruleIds=he.includes(S)?he.filter(Fe=>Fe!==S):[...he,S],A(),M(f)}async function M(f){l.getStatusOptions&&n(7,p[f.id]=await l.getStatusOptions(f.ruleIds||[]),p)}function H(f){f.sections=[...f.sections||[],{id:mt(),title:I("templateSectionNew"),statuses:[]}],A()}function N(f,S){f.sections=(f.sections||[]).filter(he=>he.id!==S),A()}function Z(f,S){const he=f.statuses||[];f.statuses=he.includes(S)?he.filter(Fe=>Fe!==S):[...he,S],A()}function ge(f){Ot.call(this,e,f)}function je(f){Ot.call(this,e,f)}const U=()=>n(2,c=null);function de(f,S){f[S].enabled=this.checked,n(1,i)}const z=f=>F(f.id),fe=()=>l.undoArchiveNow(),ke=f=>l.archiveProfileNow(f.id),ee=f=>L(f.id);function me(f,S){f[S].name=this.value,n(1,i)}function J(f,S){f[S].keyword=this.value,n(1,i)}function Ae(f,S){f[S].completedStatus=this.value,n(1,i)}function Y(f,S){f[S].archivedStatus=this.value,n(1,i)}function V(f,S){f[S].schedule.enabled=this.checked,n(1,i)}const X=f=>j(f,"enabled",f.schedule.enabled);function se(f,S){f[S].schedule.mode=St(this),n(1,i)}const oe=f=>j(f,"mode",f.schedule.mode),le=(f,S)=>C(f.id,S);function qe(f,S){f[S].schedule.weekday=St(this),n(1,i)}const Ue=f=>j(f,"weekday",f.schedule.weekday);function ze(f,S){f[S].schedule.monthday=_t(this.value),n(1,i)}const Se=f=>j(f,"monthday",f.schedule.monthday);function He(f,S){f[S].schedule.month=_t(this.value),n(1,i)}const be=f=>j(f,"month",f.schedule.month);function we(f,S){f[S].schedule.monthday=_t(this.value),n(1,i)}const Oe=f=>j(f,"monthday",f.schedule.monthday),Ce=f=>$(f.id),nt=f=>D(f.id),Me=f=>O(f.id);function lt(f,S){f[S].name=this.value,n(4,a)}function Ye(f,S){f[S].period=St(this),n(4,a)}const De=(f,S)=>u(f,S.id);function $e(f,S){f[S].notebookId=St(this),n(4,a)}function Xe(f,S){f[S].pathTemplate=this.value,n(4,a)}function ye(f,S){f[S].appendMode=this.checked,n(4,a)}function ve(f,S){f[S].clipboardOnlySections=this.checked,n(4,a)}function _e(f,S){f[S].titleTemplate=this.value,n(4,a)}function ie(f,S){f[S].title=this.value,n(4,a)}const ne=(f,S)=>Z(f,S),te=(f,S)=>N(f,S.id),Ke=f=>H(f),Ie=f=>B(g,f),ut=f=>q(g,f);return e.$$set=f=>{"plugin"in f&&n(0,l=f.plugin)},e.$$.update=()=>{e.$$.dirty[0]&6&&n(9,g=c?i.find(f=>f.id===c):null)},[l,i,c,o,a,m,_,p,k,g,h,w,v,A,Q,F,L,j,B,q,C,$,x,D,O,u,H,N,Z,ge,je,U,de,z,fe,ke,ee,me,J,Ae,Y,V,X,se,oe,le,qe,Ue,ze,Se,He,be,we,Oe,Ce,nt,Me,lt,Ye,De,$e,Xe,ye,ve,_e,ie,ne,te,Ke,Ie,ut]}class cl extends nl{constructor(t){super(),tl(this,t,al,ol,Fn,{plugin:0},null,[-1,-1,-1,-1])}}function Ze(e){var t,n,l,i,o;if(!e)return"";if(Array.isArray(e))return e.map(a=>Ze(a)).filter(Boolean).join(", ");if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(e.content!==void 0)return e.content;if(((t=e.text)==null?void 0:t.content)!==void 0)return e.text.content;if(((n=e.block)==null?void 0:n.content)!==void 0)return e.block.content;if(((l=e.date)==null?void 0:l.content)!==void 0)return e.date.content;if(((i=e.mSelect)==null?void 0:i.length)>0)return e.mSelect.map(a=>a.content).join(", ");if(((o=e.select)==null?void 0:o.content)!==void 0)return e.select.content;for(const a in e)if(typeof e[a]=="object"&&e[a]!==null){const m=Ze(e[a]);if(m)return m}return""}function rl(e){if(!e)return 0;const t=String(e).trim();if(t.match(/^\d{4}-\d{2}-\d{2}/))return new Date(t.substring(0,10).replace(/-/g,"/")+" 00:00:00").getTime();if(t.length===14&&/^\d+$/.test(t))return new Date(t.substring(0,4),parseInt(t.substring(4,6),10)-1,t.substring(6,8),t.substring(8,10),t.substring(10,12),t.substring(12,14)).getTime();const n=parseInt(t,10);return t.length===10?n*1e3:n}function yn(e){const t=rl(e);if(t&&!Number.isNaN(t))return t;const n=Date.parse(e);return Number.isNaN(n)?0:n}function ul(e){if(!e||typeof e!="object")return"";if(typeof e.name=="string")return e.name;if(typeof e.title=="string")return e.title;if(typeof e.label=="string")return e.label;if(e.value){const t=Ze(e.value);if(t)return t}if(e.key){const t=Ze(e.key);if(t)return t;if(typeof e.key.name=="string")return e.key.name}return""}function qt(e,t=""){let n=[];if(!e||typeof e!="object")return n;e.id&&(Array.isArray(e.cells)||Array.isArray(e.values))&&(t&&(e.__groupStatus=t),n.push(e));for(const l in e)if(Object.prototype.hasOwnProperty.call(e,l)){const i=e[l];Array.isArray(i)?l==="groups"?i.forEach(o=>{const a=ul(o)||t;n=n.concat(qt(o,a))}):i.forEach(o=>n=n.concat(qt(o,t))):typeof i=="object"&&!["columns","fields","keyValues"].includes(l)&&(n=n.concat(qt(i,t)))}return n}function dl(e){const t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()));return t.setUTCDate(t.getUTCDate()+4-(t.getUTCDay()||7)),Math.ceil(((t.getTime()-new Date(Date.UTC(t.getUTCFullYear(),0,1)).getTime())/864e5+1)/7)}function Mn(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function Lt(e=""){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F1E6}-\u{1F1FF}]/gu,"")}function In(e){return Lt(String(e||"")).toLowerCase().trim()}function Rt(e){return String(e??"").replace(/'/g,"''")}function kt(e,t=0){var n;if(!e||t>4)return"";if(Array.isArray(e)){for(const l of e){const i=kt(l,t+1);if(i)return i}return""}if(typeof e!="object"){if(typeof e=="string"){const l=e.match(/\d{14}-[a-z0-9]{7}/i);if(l)return l[0]}return""}if((n=e.block)!=null&&n.id)return e.block.id;if(e.blockID)return e.blockID;if(e.blockId)return e.blockId;if(e.block_id)return e.block_id;if(e.refID)return e.refID;if(e.id&&typeof e.id=="string"&&e.id.length>=20)return e.id;for(const l of Object.keys(e)){const i=e[l];if(typeof i=="string"&&/block/i.test(l)){const a=i.match(/\d{14}-[a-z0-9]{7}/i);if(a)return a[0]}const o=kt(e[l],t+1);if(o)return o}return""}async function fl(e){const t={},n=Array.from(new Set(e)).filter(Boolean),l=100;for(let i=0;i<n.length;i+=l){const o=n.slice(i,i+l).map(m=>`'${Rt(m)}'`).join(",");if(!o)continue;const a=await xe(`SELECT id, content FROM blocks WHERE id IN (${o})`);a&&a.length>0&&a.forEach(m=>{m!=null&&m.id&&(m==null?void 0:m.content)!==void 0&&(t[m.id]=m.content)})}return t}async function pl(e,t){var o,a;const n={},l=Array.from(new Set(t)).filter(Boolean),i=100;for(let m=0;m<l.length;m+=i){const _=l.slice(m,m+i);if(_.length===0)continue;const p=await Pn(e,_);Array.isArray(p)?p.forEach(c=>{c!=null&&c.itemID&&(c!=null&&c.blockID)&&(n[c.itemID]=c.blockID),c!=null&&c.itemId&&(c!=null&&c.blockId)&&(n[c.itemId]=c.blockId),c!=null&&c.id&&(c!=null&&c.blockID)&&(n[c.id]=c.blockID)}):Array.isArray(p==null?void 0:p.data)?p.data.forEach(c=>{c!=null&&c.itemID&&(c!=null&&c.blockID)&&(n[c.itemID]=c.blockID),c!=null&&c.itemId&&(c!=null&&c.blockId)&&(n[c.itemId]=c.blockId),c!=null&&c.id&&(c!=null&&c.blockID)&&(n[c.id]=c.blockID)}):p!=null&&p.blockIDs&&Array.isArray(p.blockIDs)&&Array.isArray(p.itemIDs)?p.itemIDs.forEach((c,k)=>{const g=p.blockIDs[k];c&&g&&(n[c]=g)}):(o=p==null?void 0:p.data)!=null&&o.blockIDs&&Array.isArray(p.data.blockIDs)&&Array.isArray(p.data.itemIDs)?p.data.itemIDs.forEach((c,k)=>{const g=p.data.blockIDs[k];c&&g&&(n[c]=g)}):(a=p==null?void 0:p.data)!=null&&a.blockIDs&&Array.isArray(p.data.blockIDs)&&Array.isArray(p.data.itemId)&&p.data.itemId.forEach((c,k)=>{const g=p.data.blockIDs[k];c&&g&&(n[c]=g)})}return n}function hl(e=""){return e.replace(/^###\s+/gm,"").replace(/^####\s+/gm,"").replace(/^#####\s+/gm,"").replace(/^\*\s\[\s\]\s/gm,"• ").replace(/^\*\s\[x\]\s/gi,"• ").trim()}function ml(e=""){const t=e.split(`
`);let n="",l=!1;const i=()=>{l&&(n+="</ul>",l=!1)};for(const o of t){if(/^###\s+/.test(o)){i(),n+=`<h3>${o.replace(/^###\s+/,"")}</h3>`;continue}if(/^####\s+/.test(o)){i(),n+=`<h4>${o.replace(/^####\s+/,"")}</h4>`;continue}if(/^#####\s+/.test(o)){i(),n+=`<h5>${o.replace(/^#####\s+/,"")}</h5>`;continue}const a=o.match(/^\*\s\[x\]\s(.+)/i),m=o.match(/^\*\s\[\s\]\s(.+)/);if(a||m){l||(n+="<ul>",l=!0);const _=a?a[1]:m[1];n+=`<li><input type="checkbox"${!!a?" checked":""} disabled /> <span>${_}</span></li>`;continue}if(o.trim()===""){i();continue}i(),n+=`<p>${o}</p>`}return i(),`<div>${n}</div>`}function gl(e,t){return t?e.split(`
`).filter(i=>!/^###\s/.test(i)&&!/^####\s/.test(i)).join(`
`).replace(/\n{3,}/g,`

`).trim():e}async function kl(e,t,n){var a;const l=Lt(gl(n,t.clipboardOnlySections)),i=hl(l),o=ml(l);try{typeof ClipboardItem<"u"&&((a=navigator.clipboard)!=null&&a.write)?await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([o],{type:"text/html"}),"text/plain":new Blob([i],{type:"text/plain"})})]):await navigator.clipboard.writeText(i);const _=(e.i18n||{}).reportCopied||"内容已复制到剪切板";bt(_)}catch(m){console.error("Copy to clipboard failed:",m)}}function _l(e,t){const n=new Date(e);return t==="day"?(n.setHours(0,0,0,0),n.getTime()):t==="week"?(n.setDate(n.getDate()-(n.getDay()||7)+1),n.setHours(0,0,0,0),n.getTime()):t==="month"?(n.setDate(1),n.setHours(0,0,0,0),n.getTime()):t==="year"?(n.setMonth(0,1),n.setHours(0,0,0,0),n.getTime()):0}function vl(e,t){const n=t.getFullYear(),l=(t.getMonth()+1).toString().padStart(2,"0"),i=dl(t).toString().padStart(2,"0"),o=Mn(t),a=e.period||"none";let m=`/日常记录/${n}/${l}/${o}`;return a==="week"?m=`/周报/${n}/${n}-W${i}`:a==="month"?m=`/月报/${n}/${n}-${l}`:a==="year"&&(m=`/年报/${n}`),e.pathTemplate?e.pathTemplate.replace("{YYYY}",String(n)).replace("{MM}",l).replace("{date}",o).replace("{WW}",i):m}async function bl(e,t,n,l,i,o){var g,h;const a=vl(t,n),m=Rt(a),_=Rt(a.substring(1));let p=await xe(`SELECT id FROM blocks WHERE (hpath = '${m}' OR hpath = '${_}') AND type='d' LIMIT 1`),c=p&&p.length>0?p[0].id:"";if(!c){const w=await Tn(),v=t.notebookId||((h=(g=w==null?void 0:w.notebooks)==null?void 0:g[0])==null?void 0:h.id);if(!v){rt("未找到可用笔记本，请在设置中选择目标笔记本");return}c=await Rn(v,a+".sy",""),await new Promise(T=>setTimeout(T,600))}if(!t.appendMode){const v=(await xe(`SELECT id FROM blocks WHERE root_id = '${c}'`)||[]).map(T=>T.id).filter(T=>T&&T!==c);for(const T of v)await Ln(T);v.length>0&&await new Promise(T=>setTimeout(T,300))}const k=await $n("markdown",l,c);if(k&&k.length>0){for(const w of k)w!=null&&w.id&&await Bn(w.id,{memo:i});bt("报表已就绪")}}async function wl(e,t){var g;const l=(((g=e.config)==null?void 0:g.profiles)||[]).find(h=>h.id===t);if(!(l!=null&&l.keyword))return{avId:"",viewId:"",profileName:""};const i=await xe(`SELECT id FROM blocks WHERE content LIKE '%${l.keyword}%' AND type = 'd' LIMIT 1`);if(!i||i.length===0)return{avId:"",viewId:"",profileName:""};const o=i[0].id,a=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${o}' AND type = 'av' LIMIT 1`);if(!a||a.length===0)return{avId:"",viewId:"",profileName:""};const m=a[0],_=m.markdown.match(/data-av-id="([^"]+)"/);if(!_)return{avId:"",viewId:"",profileName:""};const p=_[1],c=m.markdown.match(/data-view-id="([^"]+)"/),k=c?c[1]:p;return{avId:p,viewId:k,profileName:l.name||l.keyword||l.id}}async function yl(e,t){try{const n=e.i18n||{},l=(v,T)=>n[v]||T,i=t.ruleIds||[];if(!i||i.length===0){rt(l("reportMissingKanban","请先选择至少一个归档规则"));return}const o=[];for(const v of i){const T=await wl(e,v);if(!T.avId)continue;const A=await At(T.avId,T.viewId||T.avId,2e3,1);A&&o.push({profileName:T.profileName,avData:A,avId:T.avId})}if(o.length===0){rt(l("reportMissingKanban","请先选择至少一个归档规则"));return}const a=new Date,m=Mn(a),_=t.period||"none",p=_l(a,_);let c="报表 ({date})";_==="day"?c="日报 ({date})":_==="week"?c="周报 ({date})":_==="month"?c="月报 ({date})":_==="year"&&(c="年报 ({date})");const g=(t.titleTemplate||c).replace("{date}",m);let h=`### ${g}

`;for(const v of o){const T=v.avData,A=T.view||T,F=(A.columns||A.fields||[]).map(u=>{const M=(u==null?void 0:u.key)??u;return M?{id:M.id,name:M.name||"",type:M.type||""}:null}).filter(Boolean),L=u=>F.findIndex(M=>u.some(H=>H(M))),j=L([u=>u.name.includes("内容"),u=>u.name.toLowerCase().includes("content"),u=>u.type==="block"]);let B=L([u=>u.name.includes("状态"),u=>u.name.toLowerCase().includes("status")]);B===-1&&(B=F.findIndex(u=>{const M=String(u.type||"").toLowerCase();return M==="select"||M==="mselect"||M==="multiselect"||M==="singleselect"}));let q=L([u=>u.name.includes("更新时间"),u=>u.name.toLowerCase().includes("update"),u=>u.name.includes("更新"),u=>u.name.includes("修改")]);q===-1&&(q=L([u=>u.name.includes("完成"),u=>u.name.includes("结束"),u=>u.name.includes("归档"),u=>u.name.toLowerCase().includes("done")])),q===-1&&(q=L([u=>u.name.includes("时间"),u=>u.name.toLowerCase().includes("time"),u=>u.type==="date"])),console.log("[KanbanWorkflow][Report] columns:",F.map(u=>`${u.name}(${u.type||"unknown"})`)),console.log("[KanbanWorkflow][Report] idx:",{cIdx:j,sIdx:B,tIdx:q});const C=qt(T).map(u=>{var ee,me,J,Ae;let M=u.cells||[],H=[],N=null;u.values&&(H=F.map(Y=>{var X;const V=u.values.find(se=>{var oe;return se.keyID===Y.id||((oe=se==null?void 0:se.value)==null?void 0:oe.keyID)===Y.id});return j!==-1&&Y.id===((X=F[j])==null?void 0:X.id)&&(N=(V==null?void 0:V.value)??null),V?V.value:null}));const Z=(M||[]).map(Y=>Ze(Y)),ge=(H||[]).map(Y=>Ze(Y)),je=Z.some(Y=>String(Y||"").trim()!==""),U=ge.some(Y=>String(Y||"").trim()!=="");!je&&U&&(M=H);const de=M===H?ge:Z,z=j!==-1?M[j]:null,fe=kt(z)||kt(N)||kt(u==null?void 0:u.block)||kt(u),ke=((ee=u==null?void 0:u.block)==null?void 0:ee.content)||(u==null?void 0:u.content)||(u==null?void 0:u.name)||((me=u==null?void 0:u.title)==null?void 0:me.content)||(u==null?void 0:u.title)||((J=u==null?void 0:u.text)==null?void 0:J.content)||(u==null?void 0:u.text)||((Ae=u==null?void 0:u.value)==null?void 0:Ae.content)||(N?Ze(N):"")||"";return{id:u.id,cells:M,cellValues:de,contentBlockId:fe,contentFromRow:ke,contentValueObj:N,rawPreview:u,updatedAt:u.updatedAt||u.updated||0,groupStatus:u.__groupStatus||""}}),$=await pl(v.avId,C.map(u=>u.id||"").filter(Boolean)),P=await fl(C.map(u=>u.contentBlockId||"").filter(Boolean).concat(Object.values($))),x=(t.sections||[]).map(u=>({id:u.id,title:u.title,statusesRaw:(u.statuses||[]).map(M=>String(M)),statuses:(u.statuses||[]).map(M=>In(M)).filter(Boolean),items:[]})),D=x.flatMap(u=>u.statuses).filter(Boolean);console.log("[KanbanWorkflow][Report] statusCandidates:",D),C.forEach((u,M)=>{var V;const H=u.cellValues||u.cells.map(X=>Ze(X));if(M===0){console.log("[KanbanWorkflow][Report] sampleRow:",H);const X=u.rawPreview||{};console.log("[KanbanWorkflow][Report] sampleRowKeys:",Object.keys(X)),!H.length&&!u.contentFromRow&&console.log("[KanbanWorkflow][Report] sampleRowRaw:",X),!u.contentFromRow&&u.contentBlockId&&console.log("[KanbanWorkflow][Report] sampleContentBlockId:",u.contentBlockId),u.contentValueObj&&(console.log("[KanbanWorkflow][Report] sampleContentValueObj:",u.contentValueObj),console.log("[KanbanWorkflow][Report] sampleContentValueExtract:",Ze(u.contentValueObj))),u.id&&$[u.id]&&console.log("[KanbanWorkflow][Report] sampleItemToBlock:",u.id,"->",$[u.id]),X.values&&(console.log("[KanbanWorkflow][Report] sampleRowValues:",X.values),console.log("[KanbanWorkflow][Report] sampleColumns:",F))}let N=j!==-1?H[j]:"";!N&&u.contentFromRow&&(N=u.contentFromRow),!N&&u.contentBlockId&&$[u.contentBlockId]&&P[$[u.contentBlockId]]&&(N=P[$[u.contentBlockId]]),!N&&u.contentBlockId&&P[u.contentBlockId]&&(N=P[u.contentBlockId]),!N&&u.id&&$[u.id]&&P[$[u.id]]&&(N=P[$[u.id]]),N||(N=H.find((se,oe)=>oe===B||oe===q?!1:String(se||"").trim()!=="")||""),N||(N=l("reportFallbackContent","无内容")),_==="week"&&(N=N.replace(/\b\d+(\.\d+)?\s*[hH]\b/gi,"").replace(/\((?:\d\.?)+[hH]\)/g,"").trim(),!N&&Array.isArray((V=u.cells)==null?void 0:V[j])&&u.cells[j].length>0&&(N=u.cells[j].map(X=>Ze(X)).join(", ")));let Z=B!==-1?H[B]:"";!Z&&u.groupStatus&&(Z=u.groupStatus),Z||(Z=H.find(se=>{const oe=String(se||"").toLowerCase();return D.some(le=>oe.includes(le))})||""),M===0&&console.log("[KanbanWorkflow][Report] sampleStatus:",Z);const ge=q!==-1?H[q]:"",je=yn(ge),U=yn(u.updatedAt),de=_!=="none"?je||U||0:je||U||Date.now(),z=In(Z),fe=z.includes("已完成")||z.includes("done")||z.includes("完成")||z.includes("finish")||z.includes("ok"),ke=z.includes("归档")||z.includes("archived")||z.includes("存档")||z.includes("archive");if(_!=="none"&&(fe||ke)&&de<p)return;const me=`${fe?"* [x]":"* [ ]"} ${N}`.trim(),J=z.split(/[,，]/).map(X=>X.trim()).filter(Boolean);let Y=x.filter(X=>X.statuses.length>0&&X.statuses.some(se=>se?z.includes(se)?!0:J.some(oe=>oe.includes(se)||se.includes(oe)):!1));if(Y.length===0){const X=String(Z||"").toLowerCase();Y=x.filter(se=>(se.statusesRaw||[]).some(oe=>{const le=String(oe||"").toLowerCase();return le?X.includes(le)||le.includes(X):!1}))}Y.length!==0&&Y.forEach(X=>X.items.push(me))});const O=`${l("reportBoardTitle","看板")}: ${v.profileName}`;h+=`#### ${O}

`;for(const u of x)h+=`##### ${u.title}
`,u.items.length>0?h+=`${u.items.join(`
`)}

`:h+=`
`}const w=Lt(h);await bl(e,t,a,w,`summary-${t.id}`,g),await kl(e,t,w)}catch(n){console.error(n),rt("生成过程中遇障")}}class Il extends yt.Plugin{constructor(){super(...arguments);Qe(this,"timer");Qe(this,"isMobile");Qe(this,"config",{});Qe(this,"undoStack",[]);Qe(this,"MAX_UNDO_COUNT",30);Qe(this,"MAX_UNDO_DAYS",7);Qe(this,"SCHEDULE_CHECK_INTERVAL",60*1e3)}async onload(){Kn(this),console.log("Loading Kanban Workflow Plugin v0.1.0"),await this.loadAndNormalizeConfig();try{const i=await this.loadData("undo_history.json");i&&Array.isArray(i)&&(this.undoStack=i)}catch(i){console.error("Failed to load undo history",i)}const n=this.addTopBar({icon:"iconFiles",title:this.i18n.pluginName||"看板工作流",position:"right",callback:i=>{if(this.isMobile){this.showMobileMenu();return}let o;i&&i.currentTarget&&i.currentTarget.getBoundingClientRect?o=i.currentTarget.getBoundingClientRect():o=n.getBoundingClientRect();const a=new yt.Menu("kanban-archiver-menu");a.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(_=>{a.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${_.name}`,click:()=>{this.generateTemplate(_.id)}})}),a.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),a.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),a.open({x:o.left,y:o.bottom,isLeft:!0})}});this.addCommand({langKey:"openSettings",langText:this.i18n.cmdOpenSettings||"打开设置",hotkey:"",callback:()=>{this.openSetting()}}),this.addCommand({langKey:"archiveNow",langText:this.i18n.cmdArchiveNow||"立即归档看板任务",hotkey:"",callback:()=>{this.archiveNow()}}),this.addCommand({langKey:"undoArchiveNow",langText:this.i18n.cmdUndoArchive||"撤销归档（最近一次）",hotkey:"",callback:()=>{this.undoArchiveNow()}}),(this.config.templates||[]).forEach(i=>{this.addCommand({langKey:`generateTemplate_${i.id}`,langText:`${this.i18n.generateTemplatePrefix||"生成"}：${i.name}`,hotkey:"",callback:()=>{this.generateTemplate(i.id)}})}),this.initScheduler()}async loadAndNormalizeConfig(){const n=await this.loadData("config.json");this.config={profiles:[],archiveTime:"00:00",lastRunDate:"",templates:[],...n},this.ensureDefaultTemplates(),this.normalizeTemplates(),(!this.config.profiles||!Array.isArray(this.config.profiles))&&(this.config.profiles=[]),n&&(n.kanbanKeyword||n.completedStatus)&&this.config.profiles.length===0?(console.log("Migrating legacy config to Profile 1..."),this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultRuleName||"默认规则",keyword:n.kanbanKeyword||this.i18n.defaultKeyword||"我的工作看板",completedStatus:n.completedStatus||this.i18n.defaultCompleted||"已完成",archivedStatus:n.archivedStatus||this.i18n.defaultArchived||"归档",enabled:!0}),delete this.config.kanbanKeyword,delete this.config.completedStatus,delete this.config.archivedStatus,this.saveData("config.json",this.config)):this.config.profiles.length===0&&this.config.profiles.push({id:this.generateUUID(),name:this.i18n.defaultMyRule||"我的规则",keyword:this.i18n.defaultKeyword||"我的工作看板",completedStatus:this.i18n.defaultCompleted||"已完成",archivedStatus:this.i18n.defaultArchived||"归档",enabled:!0});let l=!1;this.config.profiles.forEach(i=>{i.enabled===void 0&&(i.enabled=!0,l=!0),i.schedule||(i.schedule=this.createDefaultSchedule(),l=!0)}),n&&n.archiveTime&&this.config.profiles.length>0&&(this.config.profiles.forEach(i=>{i.schedule&&(i.schedule.mode=i.schedule.mode||"daily",i.schedule.time=i.schedule.time||n.archiveTime||"00:00",i.schedule.enabled=i.schedule.enabled!==void 0?i.schedule.enabled:!0,i.schedule.nextRunAt||(i.schedule.nextRunAt=0))}),l=!0),l&&this.saveData("config.json",this.config)}ensureDefaultTemplates(){(!this.config.templates||!Array.isArray(this.config.templates)||this.config.templates.length===0)&&(this.config.templates=[{id:this.generateUUID(),name:this.i18n.defaultDailyTemplate||"今日汇总",period:"day",ruleIds:[],notebookId:"",pathTemplate:"",appendMode:!1,clipboardOnlySections:!1,titleTemplate:"日报 ({date})",sections:[{id:this.generateUUID(),title:"待办",statuses:["待办","todo","backlog","未开始"]},{id:this.generateUUID(),title:"进行中",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成",statuses:["已完成","done","完成","finish","ok","归档","archived"]}]},{id:this.generateUUID(),name:this.i18n.defaultWeeklyTemplate||"本周回顾",period:"week",ruleIds:[],notebookId:"",pathTemplate:"",appendMode:!1,clipboardOnlySections:!1,titleTemplate:"周报 ({date})",sections:[{id:this.generateUUID(),title:"当前工作",statuses:["进行中","doing","inprogress"]},{id:this.generateUUID(),title:"已完成及归档 (本周)",statuses:["已完成","done","完成","finish","ok","归档","archived"]},{id:this.generateUUID(),title:"下周工作计划",statuses:["待办","todo","backlog","未开始"]}]}],this.saveData("config.json",this.config))}normalizeTemplates(){if(!Array.isArray(this.config.templates))return;let n=!1;this.config.templates.forEach(l=>{!l.period&&l.type&&(l.period=l.type==="weekly"?"week":"day",n=!0),l.period||(l.period="none",n=!0),l.appendMode===void 0&&(l.appendMode=!1,n=!0),l.sections||(l.sections=[],n=!0)}),n&&this.saveData("config.json",this.config)}async reloadConfig(){await this.loadAndNormalizeConfig()}onLayoutReady(){this.isMobile=this.app.isMobile}onunload(){console.log("Unloading Kanban Workflow Plugin"),this.timer&&(clearInterval(this.timer),this.timer=null)}uninstall(){console.log("Uninstalling Kanban Workflow Plugin"),this.removeData("config.json"),this.removeData("undo_history.json")}openSetting(){const n=new yt.Dialog({title:this.i18n.settingTitle||"看板工作流设置",content:"<div id='kanban-archiver-settings' style='height: 100%;'></div>",width:"70vw",height:"80vh",destroyCallback:()=>{l.$destroy()}}),l=new cl({target:n.element.querySelector("#kanban-archiver-settings"),props:{plugin:this}})}showMobileMenu(){const n=new yt.Menu("kanban-archiver-menu");n.addItem({icon:"iconFiles",label:this.i18n.archiveNow||"立即归档",click:()=>{this.archiveNow()}}),(this.config.templates||[]).forEach(i=>{n.addItem({icon:"iconCalendar",label:`${this.i18n.generateTemplatePrefix||"生成"}：${i.name}`,click:()=>{this.generateTemplate(i.id)}})}),n.addItem({icon:"iconUndo",label:`${this.i18n.undoArchive||"撤销归档"} (${this.undoStack.length})`,disabled:this.undoStack.length===0,click:()=>{this.undoArchiveNow()}}),n.addItem({icon:"iconSettings",label:this.i18n.settings||"设置",click:()=>{this.openSetting()}}),n.fullscreen()}initScheduler(){console.log("Initializing Kanban Scheduler..."),this.checkAndRunArchive(),this.timer=setInterval(()=>{this.checkAndRunArchive()},this.SCHEDULE_CHECK_INTERVAL)}checkAndRunArchive(){const n=this.config.profiles||[];if(n.length===0)return;const l=new Date;let i=!1;n.forEach(o=>{if(!(o!=null&&o.enabled))return;o.schedule||(o.schedule=this.createDefaultSchedule(),i=!0);const a=o.schedule;a.enabled&&((!a.nextRunAt||Number.isNaN(a.nextRunAt))&&(a.nextRunAt=this.computeNextRunAt(a,l).getTime(),i=!0),l.getTime()>=a.nextRunAt&&(this.archiveNow(!1),a.lastRun=l.toISOString().slice(0,10),a.nextRunAt=this.computeNextRunAt(a,l,!0).getTime(),i=!0))}),i&&this.saveData("config.json",this.config)}createDefaultSchedule(){return{enabled:!0,mode:"daily",time:"00:00",weekday:1,monthday:1,month:1,lastRun:"",nextRunAt:0}}parseTime(n){const l=String(n||"00:00").split(":").map(Number),i=isNaN(l[0])?0:l[0],o=isNaN(l[1])?0:l[1];return{h:i,m:o}}clampDay(n,l,i){const o=new Date(n,l+1,0).getDate();return Math.min(Math.max(1,i),o)}computeNextRunAt(n,l,i=!1){const{h:o,m:a}=this.parseTime(n.time),m=n.mode||"daily",_=new Date(l),p=k=>(k.setHours(o,a,0,0),k);if(m==="daily"){const k=p(new Date(_));return(i||k.getTime()<=l.getTime())&&k.setDate(k.getDate()+1),k}if(m==="workday"){const k=p(new Date(_)),g=w=>w.getDay()>=1&&w.getDay()<=5;if(!i&&g(k)&&k.getTime()>l.getTime())return k;let h=new Date(k);do h.setDate(h.getDate()+1),p(h);while(!g(h));return h}if(m==="weekly"){const k=Number(n.weekday||1),g=_.getDay()===0?7:_.getDay();let h=(k-g+7)%7;const w=p(new Date(_));return h===0&&(i||w.getTime()<=l.getTime())&&(h=7),w.setDate(w.getDate()+h),w}if(m==="monthly"){const k=Number(n.monthday||1);let g=_.getFullYear(),h=_.getMonth(),w=this.clampDay(g,h,k),v=p(new Date(g,h,w));return(i||v.getTime()<=l.getTime())&&(h+=1,h>11&&(h=0,g+=1),w=this.clampDay(g,h,k),v=p(new Date(g,h,w))),v}if(m==="yearly"){const k=Number(n.month||1)-1,g=Number(n.monthday||1);let h=_.getFullYear(),w=this.clampDay(h,k,g),v=p(new Date(h,k,w));return(i||v.getTime()<=l.getTime())&&(h+=1,w=this.clampDay(h,k,g),v=p(new Date(h,k,w))),v}const c=p(new Date(_));return c.getTime()<=l.getTime()&&c.setDate(c.getDate()+1),c}async saveUndoHistory(){this.undoStack.length>this.MAX_UNDO_COUNT&&(this.undoStack=this.undoStack.slice(this.undoStack.length-this.MAX_UNDO_COUNT));const n=new Date().getTime()-this.MAX_UNDO_DAYS*24*60*60*1e3;this.undoStack=this.undoStack.filter(l=>l.date>n),await this.saveData("undo_history.json",this.undoStack)}async archiveNow(n=!0){if(!(n&&!window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？")))try{const l=await Pt(this,n);if(l&&l.length>0)this.undoStack.push({date:new Date().getTime(),ids:l}),await this.saveUndoHistory();else{const i=this.i18n.archiveEmpty||"未发现可归档任务";bt(i)}}catch(l){console.error("Archive task error:",l)}}async archiveProfileNow(n,l=!0){if(n&&!(l&&!window.confirm(this.i18n.confirmArchiveNow||"确认立即归档当前规则对应的任务？")))try{const i=await Pt(this,l,[n]);if(i&&i.length>0)this.undoStack.push({date:new Date().getTime(),ids:i}),await this.saveUndoHistory();else{const o=this.i18n.archiveEmpty||"未发现可归档任务";bt(o)}}catch(i){console.error("Archive task error:",i)}}async undoArchiveNow(){if(this.undoStack.length!==0)try{const n=this.undoStack.pop();this.saveUndoHistory(),n&&n.ids&&n.ids.length>0&&await On(this,n.ids)}catch(n){console.error("Undo archive task error:",n)}}async generateTemplate(n){const l=(this.config.templates||[]).find(i=>i.id===n);l&&await yl(this,l)}async getNotebooks(){return await Tn()}async getStatusOptions(n){const l=this.config.profiles||[],i=new Set;for(const o of n){const a=l.find(w=>w.id===o);if(!(a!=null&&a.keyword))continue;const m=await xe(`SELECT id FROM blocks WHERE content LIKE '%${a.keyword}%' AND type = 'd' LIMIT 1`);if(!m||m.length===0)continue;const _=m[0].id,p=await xe(`SELECT id, markdown FROM blocks WHERE root_id = '${_}' AND type = 'av' LIMIT 1`);if(!p||p.length===0)continue;const k=p[0].markdown.match(/data-av-id="([^"]+)"/);if(!k)continue;const g=k[1],h=await $t(g);if(h)for(const w of h)(w.type==="select"||w.type==="mSelect")&&w.options&&w.options.forEach(v=>{v!=null&&v.name&&i.add(v.name)})}return Array.from(i)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var l=Math.random()*16|0,i=n=="x"?l:l&3|8;return i.toString(16)})}}module.exports=Il;
